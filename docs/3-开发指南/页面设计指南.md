# 页面设计指南

在 Next.js App Router 中创建页面、理解路由、管理布局、实现动态路由和 SEO 优化。

---

## 快速概览

```
App Router 文件结构:

src/app/
├── [lang]/                           # 国际化动态参数
│   ├── layout.tsx                    # 根布局
│   ├── page.tsx                      # / 首页
│   ├── dashboard/
│   │   ├── layout.tsx                # /dashboard 布局
│   │   ├── page.tsx                  # /dashboard 页面
│   │   └── [id]/                     # 动态路由
│   │       └── page.tsx              # /dashboard/123
│   └── blog/
│       ├── page.tsx                  # /blog 列表
│       └── [slug]/
│           └── page.tsx              # /blog/my-post
└── api/                              # API 路由
    └── ...
```

**关键特性:**
- 基于文件系统路由（直观）
- 嵌套布局（DRY）
- 动态路由（灵活）
- 特殊文件（error, not-found, loading）

---

## 基础页面

### 最简单的页面

```typescript
// src/app/[lang]/page.tsx
export default function Home() {
  return (
    <main>
      <h1>欢迎来到 MkSaaS Blog</h1>
    </main>
  )
}
```

---

### 与数据库交互的页面

```typescript
// src/app/[lang]/dashboard/page.tsx
import { auth } from '@/lib/auth'
import { db } from '@/db'
import { redirect } from 'next/navigation'

export default async function DashboardPage() {
  // 1. 获取用户会话
  const session = await auth()

  // 2. 权限检查：未登录用户重定向
  if (!session?.user) {
    redirect(`/auth/login`)
  }

  // 3. 获取数据
  const userStats = await db.query.user.findFirst({
    where: eq(user.id, session.user.id),
  })

  // 4. 渲染 UI
  return (
    <div>
      <h1>仪表板</h1>
      <p>欢迎, {userStats?.name}</p>
      <div className="grid grid-cols-3 gap-4">
        <StatCard title="总用户" value={userStats?.totalViews || 0} />
        <StatCard title="订阅" value={userStats?.subscription || 'Free'} />
        <StatCard title="积分" value={userStats?.credits || 0} />
      </div>
    </div>
  )
}

function StatCard({ title, value }: { title: string; value: string | number }) {
  return (
    <div className="p-6 bg-white rounded-lg shadow">
      <p className="text-gray-500">{title}</p>
      <p className="text-2xl font-bold">{value}</p>
    </div>
  )
}
```

---

## 动态路由

### 单个动态参数

```typescript
// src/app/[lang]/blog/[slug]/page.tsx
import { notFound } from 'next/navigation'
import { db } from '@/db'
import { post } from '@/db/schema'
import { eq } from 'drizzle-orm'

interface BlogPostPageProps {
  params: {
    lang: string
    slug: string
  }
}

export default async function BlogPostPage({ params }: BlogPostPageProps) {
  const { lang, slug } = params

  // 1. 查询数据库
  const article = await db.query.post.findFirst({
    where: eq(post.slug, slug),
  })

  // 2. 404 处理
  if (!article) {
    notFound()
  }

  return (
    <article>
      <h1>{article.title}</h1>
      <p className="text-gray-500">{new Date(article.createdAt).toLocaleDateString()}</p>
      <div className="prose">{article.content}</div>
    </article>
  )
}
```

---

### Catch-all 路由

```typescript
// src/app/[lang]/docs/[...slug]/page.tsx
// 匹配: /docs/intro, /docs/guide/setup, /docs/guide/deploy/production

interface DocPageProps {
  params: {
    lang: string
    slug: string[] // slug 是数组
  }
}

export default async function DocPage({ params }: DocPageProps) {
  const { lang, slug } = params
  const docPath = slug.join('/') // 'guide/setup'

  // 查询对应的文档
  const doc = await db.query.doc.findFirst({
    where: eq(doc.path, docPath),
  })

  if (!doc) {
    notFound()
  }

  return (
    <div>
      <h1>{doc.title}</h1>
      <div className="prose">{doc.content}</div>
    </div>
  )
}
```

---

## 生成静态参数

```typescript
// src/app/[lang]/blog/[slug]/page.tsx
import { db } from '@/db'

/**
 * 生成静态路由
 * 用于预构建常访问的页面
 */
export async function generateStaticParams() {
  const posts = await db.query.post.findMany({
    limit: 100,
  })

  return posts.map((post) => ({
    lang: 'en', // 为英文生成页面
    slug: post.slug,
  }))
}

export default async function BlogPostPage({ params }) {
  // ...
}
```

---

## 布局系统

### 根布局

```typescript
// src/app/[lang]/layout.tsx
import { getMessages } from 'next-intl/server'
import { NextIntlClientProvider } from 'next-intl'
import { i18n } from '@/config/i18n'
import { notFound } from 'next/navigation'

interface RootLayoutProps {
  children: React.ReactNode
  params: { lang: string }
}

export function generateStaticParams() {
  return i18n.locales.map((locale) => ({ lang: locale }))
}

export default async function RootLayout({
  children,
  params: { lang },
}: RootLayoutProps) {
  // 1. 验证语言
  if (!i18n.locales.includes(lang as never)) {
    notFound()
  }

  // 2. 获取翻译
  const messages = await getMessages(lang)

  // 3. 渲染
  return (
    <html lang={lang}>
      <head>
        <meta charSet="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
      </head>
      <body>
        <NextIntlClientProvider messages={messages} locale={lang}>
          <div className="min-h-screen flex flex-col">
            <Header />
            <main className="flex-1">{children}</main>
            <Footer />
          </div>
        </NextIntlClientProvider>
      </body>
    </html>
  )
}

function Header() {
  return (
    <header className="bg-white shadow">
      <nav className="max-w-7xl mx-auto px-4 py-4">
        {/* 导航内容 */}
      </nav>
    </header>
  )
}

function Footer() {
  return (
    <footer className="bg-gray-900 text-white py-8">
      {/* 页脚内容 */}
    </footer>
  )
}
```

---

### 嵌套布局

```typescript
// src/app/[lang]/dashboard/layout.tsx
import { Sidebar } from '@/components/dashboard/sidebar'

interface DashboardLayoutProps {
  children: React.ReactNode
}

export default function DashboardLayout({ children }: DashboardLayoutProps) {
  return (
    <div className="flex">
      <Sidebar />
      <main className="flex-1 p-8">{children}</main>
    </div>
  )
}
```

```typescript
// src/app/[lang]/dashboard/page.tsx
// 继承 dashboard layout

export default function DashboardPage() {
  return (
    <div>
      <h1>仪表板</h1>
      {/* 内容会被 DashboardLayout 包裹 */}
    </div>
  )
}
```

**布局继承树:**
```
Root Layout (/app/[lang]/layout.tsx)
  ├─ Dashboard Layout (/app/[lang]/dashboard/layout.tsx)
  │   ├─ Dashboard Page (/app/[lang]/dashboard/page.tsx)
  │   └─ Settings Page (/app/[lang]/dashboard/settings/page.tsx)
  └─ Blog Layout (如果有)
      ├─ Blog List Page (/app/[lang]/blog/page.tsx)
      └─ Blog Post Page (/app/[lang]/blog/[slug]/page.tsx)
```

---

## SEO 和元数据

### 静态元数据

```typescript
// src/app/[lang]/page.tsx
import { Metadata } from 'next'

export const metadata: Metadata = {
  title: '欢迎来到 MkSaaS Blog',
  description: '完整的 SaaS 应用文档和示例',
  keywords: ['saas', 'blog', 'documentation'],
  openGraph: {
    type: 'website',
    locale: 'zh_CN',
    url: 'https://mksaasblog.com',
    title: '欢迎来到 MkSaaS Blog',
    description: '完整的 SaaS 应用文档和示例',
    images: [
      {
        url: 'https://mksaasblog.com/og-image.png',
        width: 1200,
        height: 630,
      },
    ],
  },
}

export default function HomePage() {
  return <h1>首页</h1>
}
```

---

### 动态元数据

```typescript
// src/app/[lang]/blog/[slug]/page.tsx
import { Metadata } from 'next'
import { db } from '@/db'

interface BlogPostPageProps {
  params: {
    lang: string
    slug: string
  }
}

/**
 * 为动态页面生成元数据
 * 用于 SEO 优化
 */
export async function generateMetadata({
  params,
}: BlogPostPageProps): Promise<Metadata> {
  const { slug } = params

  const article = await db.query.post.findFirst({
    where: eq(post.slug, slug),
  })

  if (!article) {
    return {
      title: '文章不存在',
    }
  }

  return {
    title: article.title,
    description: article.excerpt || article.content.substring(0, 160),
    keywords: article.tags,
    openGraph: {
      type: 'article',
      title: article.title,
      description: article.excerpt,
      publishedTime: new Date(article.createdAt).toISOString(),
      authors: [article.author],
      images: [
        {
          url: article.coverImage || '/default-og.png',
          width: 1200,
          height: 630,
        },
      ],
    },
  }
}

export default async function BlogPostPage({ params }: BlogPostPageProps) {
  // ...
}
```

---

## 错误处理

### 404 页面

```typescript
// src/app/[lang]/not-found.tsx
import { Link } from 'next-intl'

export default function NotFound() {
  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-6xl font-bold">404</h1>
      <p className="text-xl mt-4">页面不存在</p>
      <Link href="/" className="mt-8 px-6 py-2 bg-blue-500 text-white rounded">
        返回首页
      </Link>
    </div>
  )
}
```

---

### 错误页面

```typescript
// src/app/[lang]/error.tsx
'use client'

import { useEffect } from 'react'

export default function Error({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // 记录错误
    console.error('页面错误:', error)
  }, [error])

  return (
    <div className="flex flex-col items-center justify-center min-h-screen">
      <h1 className="text-4xl font-bold">出错了</h1>
      <p className="text-lg mt-4">{error.message}</p>
      <button
        onClick={() => reset()}
        className="mt-8 px-6 py-2 bg-blue-500 text-white rounded"
      >
        重试
      </button>
    </div>
  )
}
```

---

## 加载状态

### Loading UI

```typescript
// src/app/[lang]/dashboard/loading.tsx
export default function Loading() {
  return (
    <div className="space-y-4">
      <div className="h-12 bg-gray-200 rounded animate-pulse" />
      <div className="h-96 bg-gray-200 rounded animate-pulse" />
    </div>
  )
}
```

```typescript
// src/app/[lang]/dashboard/page.tsx
export default async function DashboardPage() {
  // Suspense 边界会显示 loading.tsx
  const data = await fetch('...', { next: { revalidate: 3600 } })

  return <div>数据: {data}</div>
}
```

---

### 带 Suspense 的选择性加载

```typescript
// src/app/[lang]/dashboard/page.tsx
import { Suspense } from 'react'

function StatsSkeleton() {
  return <div className="h-24 bg-gray-200 rounded animate-pulse" />
}

async function Stats() {
  const stats = await fetchStats()
  return <div>{stats}</div>
}

async function Chart() {
  const data = await fetchChartData()
  return <div>{data}</div>
}

export default function DashboardPage() {
  return (
    <div>
      <h1>仪表板</h1>

      {/* Stats 加载中显示骨架屏 */}
      <Suspense fallback={<StatsSkeleton />}>
        <Stats />
      </Suspense>

      {/* Chart 可以独立加载 */}
      <Suspense fallback={<div>图表加载中...</div>}>
        <Chart />
      </Suspense>
    </div>
  )
}
```

---

## 分页实现

```typescript
// src/app/[lang]/blog/page.tsx
import { Pagination } from '@/components/pagination'

interface BlogListPageProps {
  searchParams: { page?: string }
  params: { lang: string }
}

export default async function BlogListPage({
  searchParams,
  params,
}: BlogListPageProps) {
  const page = parseInt(searchParams.page || '1')
  const limit = 10

  // 1. 获取总数
  const allPosts = await db.query.post.findMany()
  const total = allPosts.length
  const pages = Math.ceil(total / limit)

  // 2. 获取当前页数据
  const offset = (page - 1) * limit
  const posts = await db.query.post.findMany({
    limit,
    offset,
    orderBy: (post) => desc(post.createdAt),
  })

  // 3. 渲染
  return (
    <div>
      <h1>博客文章</h1>

      <div className="space-y-4">
        {posts.map((post) => (
          <PostCard key={post.id} post={post} lang={params.lang} />
        ))}
      </div>

      {/* 分页组件 */}
      <Pagination
        currentPage={page}
        totalPages={pages}
        baseUrl={`/${params.lang}/blog`}
      />
    </div>
  )
}

function PostCard({ post, lang }: { post: Post; lang: string }) {
  return (
    <div className="p-4 border rounded hover:shadow-lg transition">
      <h2 className="text-xl font-bold">{post.title}</h2>
      <p className="text-gray-600">{post.excerpt}</p>
      <a
        href={`/${lang}/blog/${post.slug}`}
        className="text-blue-500 hover:underline"
      >
        阅读更多
      </a>
    </div>
  )
}
```

```typescript
// src/components/pagination.tsx
'use client'

import Link from 'next/link'

interface PaginationProps {
  currentPage: number
  totalPages: number
  baseUrl: string
}

export function Pagination({
  currentPage,
  totalPages,
  baseUrl,
}: PaginationProps) {
  return (
    <div className="flex justify-center gap-2 mt-8">
      {/* 上一页 */}
      {currentPage > 1 && (
        <Link
          href={`${baseUrl}?page=${currentPage - 1}`}
          className="px-4 py-2 border rounded hover:bg-gray-100"
        >
          上一页
        </Link>
      )}

      {/* 页码 */}
      {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
        <Link
          key={page}
          href={`${baseUrl}?page=${page}`}
          className={`px-4 py-2 border rounded ${
            page === currentPage
              ? 'bg-blue-500 text-white'
              : 'hover:bg-gray-100'
          }`}
        >
          {page}
        </Link>
      ))}

      {/* 下一页 */}
      {currentPage < totalPages && (
        <Link
          href={`${baseUrl}?page=${currentPage + 1}`}
          className="px-4 py-2 border rounded hover:bg-gray-100"
        >
          下一页
        </Link>
      )}
    </div>
  )
}
```

---

## ISR (增量静态再生)

```typescript
// src/app/[lang]/blog/[slug]/page.tsx

/**
 * 定义重新验证时间
 * 页面将在 3600 秒 (1小时) 后重新生成
 */
export const revalidate = 3600

export default async function BlogPostPage({ params }) {
  const article = await db.query.post.findFirst({
    where: eq(post.slug, params.slug),
  })

  return (
    <article>
      <h1>{article.title}</h1>
      <div className="prose">{article.content}</div>
    </article>
  )
}
```

**工作原理:**
1. 构建时生成 HTML
2. 1 小时内用户访问返回缓存页面
3. 1 小时后下一个用户请求触发重新生成
4. 新页面生成期间仍返回旧页面（后台更新）

---

## 常见问题

### Q: 什么时候使用 Server Component?

**A:** 默认总是使用 Server Component，除非需要：
- React hooks (useState, useEffect)
- 用户交互 (onClick, onChange)
- 浏览器 API (localStorage, window)

### Q: 如何在动态路由中处理特殊字符?

**A:** 使用 URL 编码和解码：

```typescript
// slug: my-post%20with%20spaces
const decodedSlug = decodeURIComponent(slug)
```

### Q: 如何实现 SEO 友好的国际化页面?

**A:** 在元数据中添加 hreflang：

```typescript
export const metadata: Metadata = {
  alternates: {
    canonical: 'https://example.com/en/blog/my-post',
    languages: {
      'en-US': 'https://example.com/en/blog/my-post',
      'zh-CN': 'https://example.com/zh/blog/my-post',
    },
  },
}
```

---

## 总结

✅ **基本页面** - 创建简单的 UI
✅ **动态路由** - 处理参数化 URL
✅ **布局系统** - 共享结构和导航
✅ **SEO 优化** - 元数据和 hreflang
✅ **错误处理** - 404 和异常
✅ **加载状态** - 骨架屏和 Suspense
✅ **分页** - 列表和导航

---

**相关文档:**
- [组件设计指南](./组件设计指南.md)
- [Server Actions 详解](./Server Actions详解.md)

**最后更新:** 2025-11-18
