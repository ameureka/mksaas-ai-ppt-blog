# 组件设计指南

创建可复用、可维护的 React 组件。包括 Server Component、Client Component、组件模式和性能优化。

---

## 组件类型

### Server Component（默认）

```typescript
// src/components/UserCard.tsx
import { db } from '@/db'

/**
 * Server Component
 * - 在服务器上执行
 * - 可以直接访问数据库
 * - 无法使用 React hooks
 */
export async function UserCard({ userId }: { userId: string }) {
  const user = await db.query.user.findFirst({
    where: eq(user.id, userId),
  })

  if (!user) return null

  return (
    <div className="p-4 bg-white rounded shadow">
      <h3 className="font-bold">{user.name}</h3>
      <p className="text-gray-600">{user.email}</p>
    </div>
  )
}
```

**何时使用:**
- ✅ 获取数据（数据库查询）
- ✅ 访问敏感信息（API 密钥）
- ✅ 大规模计算
- ✅ 保留依赖在服务器端

**优点:**
- 数据库访问
- 无 JS 传输（更快）
- 安全（隐藏实现细节）

---

### Client Component

```typescript
'use client'

import { useState } from 'react'

/**
 * Client Component
 * - 在浏览器上执行
 * - 可以使用 React hooks
 * - 需要序列化的数据
 */
interface UserCardProps {
  user: {
    id: string
    name: string
    email: string
  }
}

export function UserCard({ user }: UserCardProps) {
  const [isExpanded, setIsExpanded] = useState(false)

  return (
    <div className="p-4 bg-white rounded shadow">
      <button
        onClick={() => setIsExpanded(!isExpanded)}
        className="font-bold cursor-pointer"
      >
        {user.name}
      </button>
      {isExpanded && <p className="text-gray-600 mt-2">{user.email}</p>}
    </div>
  )
}
```

**何时使用:**
- ✅ 用户交互（按钮点击、输入）
- ✅ React hooks（useState, useEffect）
- ✅ 浏览器 API（localStorage）
- ✅ 状态管理

**缺点:**
- 包含在 JS bundle 中
- 无法直接访问服务器资源

---

## 组件模式

### 展示组件（Presentational）

```typescript
// src/components/ui/Button.tsx
'use client'

interface ButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'danger'
  size?: 'sm' | 'md' | 'lg'
  isLoading?: boolean
}

export function Button({
  variant = 'primary',
  size = 'md',
  isLoading = false,
  children,
  disabled,
  ...props
}: ButtonProps) {
  const variantClasses = {
    primary: 'bg-blue-500 text-white hover:bg-blue-600',
    secondary: 'bg-gray-200 text-gray-800 hover:bg-gray-300',
    danger: 'bg-red-500 text-white hover:bg-red-600',
  }

  const sizeClasses = {
    sm: 'px-3 py-1 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg',
  }

  return (
    <button
      className={`
        rounded font-medium transition
        disabled:opacity-50 disabled:cursor-not-allowed
        ${variantClasses[variant]}
        ${sizeClasses[size]}
      `}
      disabled={disabled || isLoading}
      {...props}
    >
      {isLoading ? '加载中...' : children}
    </button>
  )
}
```

**特点:**
- 纯 UI，无业务逻辑
- 可配置性强（props）
- 易于测试和重用
- 可用于 Storybook

---

### 容器组件（Container）

```typescript
'use client'

import { useState, useEffect } from 'react'
import { fetchUserPosts } from '@/actions/post'
import { PostList } from './PostList'
import { Button } from '@/components/ui/Button'

/**
 * 容器组件处理：
 * - 数据获取
 * - 状态管理
 * - 业务逻辑
 */
export function UserPostsContainer({ userId }: { userId: string }) {
  const [posts, setPosts] = useState([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    loadPosts()
  }, [userId])

  async function loadPosts() {
    try {
      setLoading(true)
      const result = await fetchUserPosts(userId)
      setPosts(result)
    } catch (err) {
      setError('加载失败')
    } finally {
      setLoading(false)
    }
  }

  if (loading) return <div>加载中...</div>
  if (error) return <div className="text-red-500">{error}</div>

  return (
    <div>
      <PostList posts={posts} />
      <Button onClick={loadPosts}>刷新</Button>
    </div>
  )
}

// 展示组件只接收数据
function PostList({ posts }: { posts: Post[] }) {
  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id} className="p-4 border-b">
          <h3 className="font-bold">{post.title}</h3>
        </li>
      ))}
    </ul>
  )
}
```

**特点:**
- 处理数据和逻辑
- 分离关注点
- 展示组件专注 UI

---

## 组件组合（Composition）

### 使用 children

```typescript
// src/components/Card.tsx
interface CardProps {
  title: string
  children: React.ReactNode
}

export function Card({ title, children }: CardProps) {
  return (
    <div className="p-6 bg-white rounded-lg shadow">
      <h2 className="text-xl font-bold mb-4">{title}</h2>
      {children}
    </div>
  )
}

// 使用
export function Example() {
  return (
    <Card title="用户信息">
      <p>名字: John</p>
      <p>邮箱: john@example.com</p>
    </Card>
  )
}
```

---

### Polymorphic Components（多态）

```typescript
// src/components/Box.tsx
import React from 'react'

interface BoxProps extends React.HTMLAttributes<HTMLDivElement> {
  as?: React.ElementType
  children?: React.ReactNode
}

/**
 * 多态组件：可以渲染为任何 HTML 元素
 */
export const Box = React.forwardRef<HTMLDivElement, BoxProps>(
  ({ as: Component = 'div', className, ...props }, ref) => (
    <Component
      ref={ref}
      className={`p-4 bg-white rounded shadow ${className || ''}`}
      {...props}
    />
  )
)

Box.displayName = 'Box'

// 使用
export function Example() {
  return (
    <>
      <Box>作为 div</Box>
      <Box as="section">作为 section</Box>
      <Box as="article">作为 article</Box>
    </>
  )
}
```

---

## 类型安全

### 定义组件 Props

```typescript
// ✅ 好的做法：使用 interface
interface TextProps {
  size?: 'sm' | 'md' | 'lg'
  weight?: 'light' | 'normal' | 'bold'
  color?: string
  children: React.ReactNode
}

export function Text({
  size = 'md',
  weight = 'normal',
  color = 'black',
  children,
}: TextProps) {
  return (
    <span
      style={{
        fontSize: size === 'sm' ? '0.875rem' : size === 'lg' ? '1.25rem' : '1rem',
        fontWeight: weight,
        color,
      }}
    >
      {children}
    </span>
  )
}

// ✅ 扩展 HTML 属性
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary'
}

export function Button({ variant = 'primary', ...props }: ButtonProps) {
  return <button {...props} />
}
```

---

## 性能优化

### React.memo

```typescript
// 避免不必要的重新渲染
interface PostItemProps {
  post: Post
  onClick: (id: string) => void
}

export const PostItem = React.memo(function PostItem({
  post,
  onClick,
}: PostItemProps) {
  return (
    <div onClick={() => onClick(post.id)} className="p-4 border-b cursor-pointer">
      <h3>{post.title}</h3>
    </div>
  )
})

PostItem.displayName = 'PostItem'
```

---

### useMemo

```typescript
'use client'

import { useMemo } from 'react'

interface PostListProps {
  posts: Post[]
  sortBy?: 'date' | 'title'
}

export function PostList({ posts, sortBy = 'date' }: PostListProps) {
  // 只在 posts 或 sortBy 改变时重新排序
  const sortedPosts = useMemo(() => {
    return [...posts].sort((a, b) => {
      if (sortBy === 'date') {
        return b.createdAt.getTime() - a.createdAt.getTime()
      }
      return a.title.localeCompare(b.title)
    })
  }, [posts, sortBy])

  return (
    <ul>
      {sortedPosts.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

---

### useCallback

```typescript
'use client'

import { useCallback } from 'react'

interface SearchProps {
  onSearch: (query: string) => void
}

export function Search({ onSearch }: SearchProps) {
  // 避免每次渲染时创建新函数
  const handleSearch = useCallback(
    (e: React.ChangeEvent<HTMLInputElement>) => {
      onSearch(e.target.value)
    },
    [onSearch]
  )

  return <input onChange={handleSearch} placeholder="搜索..." />
}
```

---

## 可访问性 (a11y)

```typescript
/**
 * 可访问的按钮组件
 */
interface AccessibleButtonProps
  extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  ariaLabel?: string
  ariaDescribedBy?: string
}

export function AccessibleButton({
  ariaLabel,
  ariaDescribedBy,
  children,
  ...props
}: AccessibleButtonProps) {
  return (
    <button
      aria-label={ariaLabel}
      aria-describedby={ariaDescribedBy}
      className="px-4 py-2 bg-blue-500 text-white rounded focus:outline-none focus:ring-2 focus:ring-blue-300"
      {...props}
    >
      {children}
    </button>
  )
}

/**
 * 可访问的表单标签
 */
export function FormField({
  id,
  label,
  error,
  children,
}: {
  id: string
  label: string
  error?: string
  children: React.ReactNode
}) {
  return (
    <div className="mb-4">
      <label htmlFor={id} className="block font-medium mb-2">
        {label}
        {error && <span className="text-red-500"> *</span>}
      </label>
      {children}
      {error && (
        <p id={`${id}-error`} className="text-red-500 text-sm mt-1" role="alert">
          {error}
        </p>
      )}
    </div>
  )
}
```

---

## 条件渲染

```typescript
// ✅ 使用三元运算符
export function Status({ isActive }: { isActive: boolean }) {
  return <span>{isActive ? '活跃' : '非活跃'}</span>
}

// ✅ 使用逻辑与
export function RequireAuth({ isAuth, children }: { isAuth: boolean; children: React.ReactNode }) {
  return isAuth && children
}

// ❌ 避免在 JSX 中直接使用 if
export function BadExample({ data }: { data: unknown }) {
  // 错误！
  // if (!data) return null
  // return <div>{data}</div>

  // ✅ 正确
  return <>{data && <div>{data}</div>}</>
}
```

---

## 常见模式

### 受控组件

```typescript
'use client'

import { useState } from 'react'

export function ControlledInput() {
  const [value, setValue] = useState('')

  return (
    <div>
      <input
        type="text"
        value={value}
        onChange={(e) => setValue(e.target.value)}
        placeholder="输入..."
      />
      <p>当前值: {value}</p>
    </div>
  )
}
```

---

### Render Props

```typescript
interface DataFetcherProps {
  url: string
  children: (data: any, loading: boolean, error: Error | null) => React.ReactNode
}

export function DataFetcher({ url, children }: DataFetcherProps) {
  const [data, setData] = useState(null)
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<Error | null>(null)

  // ... fetch logic

  return <>{children(data, loading, error)}</>
}

// 使用
<DataFetcher url="/api/users">
  {(data, loading, error) => (
    <>
      {loading && <div>加载中...</div>}
      {error && <div>错误: {error.message}</div>}
      {data && <div>{data.name}</div>}
    </>
  )}
</DataFetcher>
```

---

## 目录结构

```
src/components/
├── ui/                           # 无业务逻辑的基础组件
│   ├── Button.tsx
│   ├── Card.tsx
│   ├── Modal.tsx
│   └── Input.tsx
├── layout/                        # 页面布局组件
│   ├── Header.tsx
│   ├── Sidebar.tsx
│   └── Footer.tsx
├── features/                      # 功能相关的复合组件
│   ├── user/
│   │   ├── UserCard.tsx          # 展示组件
│   │   └── UserForm.tsx          # 容器组件
│   ├── post/
│   │   ├── PostList.tsx
│   │   └── PostItem.tsx
│   └── payment/
│       ├── PricingCard.tsx
│       └── CheckoutForm.tsx
└── common/                        # 通用业务组件
    ├── LoadingSpinner.tsx
    ├── ErrorBoundary.tsx
    └── ConfirmDialog.tsx
```

---

## 总结

✅ **Server Components** - 默认选择，数据库访问
✅ **Client Components** - 交互和 hooks
✅ **展示组件** - 可复用，易测试
✅ **容器组件** - 数据和逻辑
✅ **性能优化** - memo, useMemo, useCallback
✅ **可访问性** - ARIA 属性和语义 HTML
✅ **组件复合** - 灵活和可扩展

---

**相关文档:**
- [页面设计指南](./页面设计指南.md)
- [自定义Hooks](./自定义Hooks.md)

**最后更新:** 2025-11-18
