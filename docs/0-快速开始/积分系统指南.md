# ğŸ’° ç§¯åˆ†ç³»ç»ŸæŒ‡å— | Credits System Guide

æœ¬æŒ‡å—å¸®åŠ©ä½ äº†è§£é¡¹ç›®ä¸­çš„ç§¯åˆ†ç³»ç»Ÿï¼ŒåŒ…æ‹¬å¦‚ä½•æŸ¥çœ‹ã€ç®¡ç†å’Œé…ç½®ç§¯åˆ†åŠŸèƒ½ã€‚

---

## ğŸ“Š ç§¯åˆ†ç³»ç»Ÿæ¦‚è§ˆ

### ä»€ä¹ˆæ˜¯ç§¯åˆ†ç³»ç»Ÿï¼Ÿ

ç§¯åˆ†ç³»ç»Ÿæ˜¯ä¸€ç§è®¡è´¹æ¨¡å¼ï¼Œç”¨æˆ·é€šè¿‡è´­ä¹°æˆ–è·èµ ç§¯åˆ†æ¥ä½¿ç”¨åº”ç”¨çš„ä»˜è´¹åŠŸèƒ½ã€‚

**ä½¿ç”¨åœºæ™¯**:
- AI åŠŸèƒ½è°ƒç”¨ï¼ˆæ¯æ¬¡æ¶ˆè€— X ç§¯åˆ†ï¼‰
- å›¾ç‰‡ç”Ÿæˆï¼ˆæ¯å¼ æ¶ˆè€— X ç§¯åˆ†ï¼‰
- API è°ƒç”¨ï¼ˆæ¯æ¬¡æ¶ˆè€— X ç§¯åˆ†ï¼‰
- é«˜çº§åŠŸèƒ½ä½¿ç”¨

---

## ğŸ” å¦‚ä½•æŸ¥çœ‹ç§¯åˆ†

### 1. ç”¨æˆ·ç§¯åˆ†é¡µé¢

**è®¿é—®è·¯å¾„**: `/settings/credits`

**å®Œæ•´ URL**: `http://localhost:3005/settings/credits`

**åŠŸèƒ½**:
- âœ… æŸ¥çœ‹å½“å‰ç§¯åˆ†ä½™é¢
- âœ… æŸ¥çœ‹ç§¯åˆ†æœ‰æ•ˆæœŸ
- âœ… æŸ¥çœ‹ç§¯åˆ†äº¤æ˜“å†å²
- âœ… è´­ä¹°ç§¯åˆ†åŒ…

### 2. ä»ªè¡¨æ¿å¿«é€ŸæŸ¥çœ‹

**è®¿é—®è·¯å¾„**: `/dashboard`

åœ¨ä»ªè¡¨æ¿é¡µé¢é€šå¸¸ä¼šæ˜¾ç¤ºï¼š
- å½“å‰ç§¯åˆ†ä½™é¢
- æœ¬æœˆä½¿ç”¨æƒ…å†µ
- ç§¯åˆ†åˆ°æœŸæé†’

---

## âš™ï¸ ç§¯åˆ†ç³»ç»Ÿé…ç½®

### å½“å‰é…ç½®çŠ¶æ€

æ ¹æ® `src/config/website.tsx` æ–‡ä»¶ï¼š

```typescript
credits: {
  enableCredits: false,  // âš ï¸ ç§¯åˆ†ç³»ç»Ÿå½“å‰æ˜¯ç¦ç”¨çš„
  enablePackagesForFreePlan: false,
  registerGiftCredits: {
    enable: true,
    amount: 50,
    expireDays: 30,
  },
  // ...
}
```

### ğŸ”´ é‡è¦æç¤º

**ç§¯åˆ†ç³»ç»Ÿå½“å‰æ˜¯ç¦ç”¨çŠ¶æ€ï¼**

å¦‚æœä½ è®¿é—® `/settings/credits`ï¼Œä¼šè¢«é‡å®šå‘åˆ° `/settings/billing`ã€‚

---

## ğŸš€ å¦‚ä½•å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ

### Step 1: ä¿®æ”¹é…ç½®æ–‡ä»¶

ç¼–è¾‘ `src/config/website.tsx`ï¼š

```typescript
credits: {
  enableCredits: true,  // æ”¹ä¸º true
  enablePackagesForFreePlan: false,  // æ˜¯å¦å…è®¸å…è´¹ç”¨æˆ·è´­ä¹°ç§¯åˆ†åŒ…
  registerGiftCredits: {
    enable: true,        // æ³¨å†Œèµ é€ç§¯åˆ†
    amount: 50,          // èµ é€æ•°é‡
    expireDays: 30,      // æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰
  },
  packages: {
    // ç§¯åˆ†åŒ…é…ç½®...
  },
}
```

### Step 2: é‡å¯å¼€å‘æœåŠ¡å™¨

```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
pnpm dev
```

### Step 3: è®¿é—®ç§¯åˆ†é¡µé¢

```
http://localhost:3005/settings/credits
```

---

## ğŸ’³ ç§¯åˆ†åŒ…é…ç½®

### é»˜è®¤ç§¯åˆ†åŒ…

é¡¹ç›®é¢„é…ç½®äº† 4 ä¸ªç§¯åˆ†åŒ…ï¼š

#### 1. Basic åŸºç¡€åŒ…
```typescript
{
  id: 'basic',
  amount: 100,           // 100 ç§¯åˆ†
  expireDays: 30,        // 30 å¤©æœ‰æ•ˆæœŸ
  price: {
    priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_BASIC,
    amount: 990,         // $9.90
    currency: 'USD',
  },
}
```

#### 2. Standard æ ‡å‡†åŒ…ï¼ˆæ¨èï¼‰
```typescript
{
  id: 'standard',
  popular: true,         // æ ‡è®°ä¸ºæ¨è
  amount: 200,           // 200 ç§¯åˆ†
  expireDays: 30,
  price: {
    priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD,
    amount: 1490,        // $14.90
    currency: 'USD',
  },
}
```

#### 3. Premium é«˜çº§åŒ…
```typescript
{
  id: 'premium',
  amount: 500,           // 500 ç§¯åˆ†
  expireDays: 30,
  price: {
    priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_PREMIUM,
    amount: 3990,        // $39.90
    currency: 'USD',
  },
}
```

#### 4. Enterprise ä¼ä¸šåŒ…
```typescript
{
  id: 'enterprise',
  amount: 1000,          // 1000 ç§¯åˆ†
  expireDays: 30,
  price: {
    priceId: process.env.NEXT_PUBLIC_STRIPE_PRICE_CREDITS_ENTERPRISE,
    amount: 7990,        // $79.90
    currency: 'USD',
  },
}
```

---

## ğŸ å…è´¹ç§¯åˆ†è·å–æ–¹å¼

### 1. æ³¨å†Œèµ é€

**é…ç½®**:
```typescript
registerGiftCredits: {
  enable: true,
  amount: 50,          // æ³¨å†Œèµ é€ 50 ç§¯åˆ†
  expireDays: 30,      // 30 å¤©æœ‰æ•ˆæœŸ
}
```

**è§¦å‘æ—¶æœº**: ç”¨æˆ·å®Œæˆæ³¨å†Œåè‡ªåŠ¨è·å¾—

### 2. è®¢é˜…è®¡åˆ’èµ é€

#### Free è®¡åˆ’
```typescript
free: {
  credits: {
    enable: true,
    amount: 50,        // æ¯æœˆ 50 ç§¯åˆ†
    expireDays: 30,
  },
}
```

#### Pro è®¡åˆ’
```typescript
pro: {
  credits: {
    enable: true,
    amount: 1000,      // æ¯æœˆ 1000 ç§¯åˆ†
    expireDays: 30,
  },
}
```

#### Lifetime è®¡åˆ’
```typescript
lifetime: {
  credits: {
    enable: true,
    amount: 1000,      // æ¯æœˆ 1000 ç§¯åˆ†
    expireDays: 30,
  },
}
```

---

## ğŸ“‚ ç§¯åˆ†ç³»ç»Ÿæ–‡ä»¶ç»“æ„

### æ•°æ®åº“ Schema

```typescript
// src/db/schema.ts

// ç”¨æˆ·ç§¯åˆ†è¡¨
export const userCredit = pgTable('user_credit', {
  id: text('id').primaryKey(),
  userId: text('userId').notNull(),
  balance: integer('balance').default(0),  // å½“å‰ä½™é¢
  totalEarned: integer('totalEarned').default(0),
  totalSpent: integer('totalSpent').default(0),
  createdAt: timestamp('createdAt').defaultNow(),
  updatedAt: timestamp('updatedAt').defaultNow(),
});

// ç§¯åˆ†äº¤æ˜“è®°å½•è¡¨
export const creditTransaction = pgTable('credit_transaction', {
  id: text('id').primaryKey(),
  userId: text('userId').notNull(),
  amount: integer('amount').notNull(),     // ç§¯åˆ†æ•°é‡ï¼ˆæ­£æ•°=è·å¾—ï¼Œè´Ÿæ•°=æ¶ˆè€—ï¼‰
  type: text('type').notNull(),            // äº¤æ˜“ç±»å‹
  description: text('description'),
  expiresAt: timestamp('expiresAt'),       // è¿‡æœŸæ—¶é—´
  createdAt: timestamp('createdAt').defaultNow(),
});
```

### ç»„ä»¶æ–‡ä»¶

```
src/components/settings/credits/
â”œâ”€â”€ credits-page-client.tsx        # ç§¯åˆ†é¡µé¢ä¸»ç»„ä»¶
â”œâ”€â”€ credits-card.tsx               # ç§¯åˆ†ä½™é¢å¡ç‰‡
â”œâ”€â”€ credit-packages.tsx            # ç§¯åˆ†åŒ…åˆ—è¡¨
â”œâ”€â”€ credit-checkout-button.tsx    # è´­ä¹°æŒ‰é’®
â”œâ”€â”€ credit-transactions-table.tsx # äº¤æ˜“å†å²è¡¨æ ¼
â””â”€â”€ credit-detail-viewer.tsx      # äº¤æ˜“è¯¦æƒ…æŸ¥çœ‹å™¨
```

### Server Actions

```
src/actions/credits.ts             # ç§¯åˆ†ç›¸å…³çš„æœåŠ¡å™¨æ“ä½œ
src/credits/credits.ts             # ç§¯åˆ†ä¸šåŠ¡é€»è¾‘
```

---

## ğŸ”§ ç§¯åˆ†æ“ä½œ API

### 1. æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†

```typescript
import { getUserCredits } from '@/actions/credits';

const credits = await getUserCredits(userId);
// è¿”å›: { balance, totalEarned, totalSpent, ... }
```

### 2. æ·»åŠ ç§¯åˆ†

```typescript
import { addCredits } from '@/credits/credits';

await addCredits({
  userId: 'user-id',
  amount: 100,
  type: 'purchase',
  description: 'è´­ä¹°ç§¯åˆ†åŒ…',
  expireDays: 30,
});
```

### 3. æ¶ˆè€—ç§¯åˆ†

```typescript
import { consumeCredits } from '@/credits/credits';

await consumeCredits({
  userId: 'user-id',
  amount: 10,
  type: 'ai_generation',
  description: 'AI å›¾ç‰‡ç”Ÿæˆ',
});
```

### 4. æŸ¥è¯¢äº¤æ˜“å†å²

```typescript
import { getCreditTransactions } from '@/actions/credits';

const transactions = await getCreditTransactions({
  userId: 'user-id',
  page: 1,
  pageSize: 10,
});
```

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åœ¨åŠŸèƒ½ä¸­æ¶ˆè€—ç§¯åˆ†

```typescript
// src/app/api/generate-image/route.ts
import { consumeCredits } from '@/credits/credits';
import { getSession } from '@/lib/server';

export async function POST(request: Request) {
  const session = await getSession();
  if (!session) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  const credits = await getUserCredits(session.user.id);
  const requiredCredits = 10;

  if (credits.balance < requiredCredits) {
    return Response.json(
      { error: 'ç§¯åˆ†ä¸è¶³' },
      { status: 400 }
    );
  }

  // æ‰§è¡ŒåŠŸèƒ½...
  const result = await generateImage(/* ... */);

  // æ¶ˆè€—ç§¯åˆ†
  await consumeCredits({
    userId: session.user.id,
    amount: requiredCredits,
    type: 'image_generation',
    description: 'ç”Ÿæˆå›¾ç‰‡',
  });

  return Response.json({ result });
}
```

### ç¤ºä¾‹ 2: æ˜¾ç¤ºç§¯åˆ†ä½™é¢

```typescript
// src/components/dashboard/credits-widget.tsx
'use client';

import { useCredits } from '@/hooks/use-credits';

export function CreditsWidget() {
  const { data: credits, isLoading } = useCredits();

  if (isLoading) return <div>åŠ è½½ä¸­...</div>;

  return (
    <div className="p-4 border rounded-lg">
      <h3 className="text-lg font-semibold">ç§¯åˆ†ä½™é¢</h3>
      <p className="text-3xl font-bold">{credits?.balance || 0}</p>
      <p className="text-sm text-muted-foreground">
        æœ¬æœˆå·²ä½¿ç”¨: {credits?.totalSpent || 0}
      </p>
    </div>
  );
}
```

---

## ğŸ¯ å¿«é€Ÿå¯ç”¨ç§¯åˆ†ç³»ç»Ÿ

### å®Œæ•´æ­¥éª¤

1. **ä¿®æ”¹é…ç½®**
   ```typescript
   // src/config/website.tsx
   credits: {
     enableCredits: true,  // å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ
   }
   ```

2. **é…ç½® Stripe ä»·æ ¼ ID**ï¼ˆå¦‚æœéœ€è¦è´­ä¹°åŠŸèƒ½ï¼‰
   ```bash
   # .env.local
   NEXT_PUBLIC_STRIPE_PRICE_CREDITS_BASIC="price_xxx"
   NEXT_PUBLIC_STRIPE_PRICE_CREDITS_STANDARD="price_xxx"
   NEXT_PUBLIC_STRIPE_PRICE_CREDITS_PREMIUM="price_xxx"
   NEXT_PUBLIC_STRIPE_PRICE_CREDITS_ENTERPRISE="price_xxx"
   ```

3. **é‡å¯æœåŠ¡å™¨**
   ```bash
   pnpm dev
   ```

4. **è®¿é—®ç§¯åˆ†é¡µé¢**
   ```
   http://localhost:3005/settings/credits
   ```

5. **æµ‹è¯•åŠŸèƒ½**
   - æŸ¥çœ‹ç§¯åˆ†ä½™é¢
   - æŸ¥çœ‹äº¤æ˜“å†å²
   - æµ‹è¯•è´­ä¹°æµç¨‹ï¼ˆéœ€è¦ Stripe é…ç½®ï¼‰

---

## ğŸ“Š ç®¡ç†å‘˜åŠŸèƒ½

### æ‰‹åŠ¨ç»™ç”¨æˆ·æ·»åŠ ç§¯åˆ†

åˆ›å»ºè„šæœ¬ `scripts/add-credits.ts`ï¼š

```typescript
import { addCredits } from '@/credits/credits';

async function giveCredits(email: string, amount: number) {
  // æŸ¥æ‰¾ç”¨æˆ·
  const user = await db.query.user.findFirst({
    where: eq(user.email, email),
  });

  if (!user) {
    console.error('ç”¨æˆ·ä¸å­˜åœ¨');
    return;
  }

  // æ·»åŠ ç§¯åˆ†
  await addCredits({
    userId: user.id,
    amount: amount,
    type: 'admin_gift',
    description: 'ç®¡ç†å‘˜èµ é€',
    expireDays: 30,
  });

  console.log(`âœ… å·²ç»™ ${email} æ·»åŠ  ${amount} ç§¯åˆ†`);
}

// ä½¿ç”¨
giveCredits('user@example.com', 100);
```

è¿è¡Œï¼š
```bash
pnpm tsx scripts/add-credits.ts
```

---

## ğŸ” è°ƒè¯•å’Œç›‘æ§

### æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†

```sql
-- æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„ç§¯åˆ†
SELECT 
  u.email,
  uc.balance,
  uc.totalEarned,
  uc.totalSpent
FROM "user" u
LEFT JOIN user_credit uc ON u.id = uc.userId;
```

### æŸ¥çœ‹ç§¯åˆ†äº¤æ˜“è®°å½•

```sql
-- æŸ¥çœ‹æœ€è¿‘çš„ç§¯åˆ†äº¤æ˜“
SELECT 
  u.email,
  ct.amount,
  ct.type,
  ct.description,
  ct.createdAt
FROM credit_transaction ct
JOIN "user" u ON ct.userId = u.id
ORDER BY ct.createdAt DESC
LIMIT 20;
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **[æœ€å°åŒ–é…ç½®æŒ‡å—](./æœ€å°åŒ–é…ç½®æŒ‡å—.md)** - ç¯å¢ƒé…ç½®
- **[ç®¡ç†ç•Œé¢å’Œç»„ä»¶æŒ‡å—](./ç®¡ç†ç•Œé¢å’Œç»„ä»¶æŒ‡å—.md)** - ç®¡ç†åŠŸèƒ½
- **[æ”¯ä»˜ç³»ç»Ÿæ–‡æ¡£](../../PAYMENT.md)** - Stripe é›†æˆ

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè®¿é—® /settings/credits è¢«é‡å®šå‘ï¼Ÿ

**A**: ç§¯åˆ†ç³»ç»Ÿè¢«ç¦ç”¨äº†ã€‚éœ€è¦åœ¨ `src/config/website.tsx` ä¸­è®¾ç½®ï¼š
```typescript
credits: {
  enableCredits: true,
}
```

### Q2: å¦‚ä½•ä¿®æ”¹ç§¯åˆ†åŒ…ä»·æ ¼ï¼Ÿ

**A**: ç¼–è¾‘ `src/config/website.tsx` ä¸­çš„ `credits.packages` é…ç½®ã€‚

### Q3: ç§¯åˆ†ä¼šè¿‡æœŸå—ï¼Ÿ

**A**: æ˜¯çš„ï¼Œæ¯ä¸ªç§¯åˆ†éƒ½æœ‰ `expiresAt` å­—æ®µã€‚é»˜è®¤é…ç½®æ˜¯ 30 å¤©ã€‚

### Q4: å¦‚ä½•æŸ¥çœ‹æŸä¸ªç”¨æˆ·çš„ç§¯åˆ†ï¼Ÿ

**A**: ä½¿ç”¨ Drizzle Studio æˆ– SQL æŸ¥è¯¢ï¼š
```bash
pnpm db:studio
```

### Q5: å¦‚ä½•æµ‹è¯•ç§¯åˆ†åŠŸèƒ½ï¼Ÿ

**A**: 
1. å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ
2. ä½¿ç”¨è„šæœ¬ç»™è‡ªå·±æ·»åŠ æµ‹è¯•ç§¯åˆ†
3. åœ¨åŠŸèƒ½ä¸­é›†æˆç§¯åˆ†æ¶ˆè€—é€»è¾‘
4. æµ‹è¯•è´­ä¹°æµç¨‹ï¼ˆéœ€è¦ Stripe æµ‹è¯•æ¨¡å¼ï¼‰

---

**å‡†å¤‡å¥½ä½¿ç”¨ç§¯åˆ†ç³»ç»Ÿäº†å—ï¼ŸğŸš€**

æŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤å¯ç”¨ç§¯åˆ†åŠŸèƒ½ï¼Œå¼€å§‹æ„å»ºä½ çš„è®¡è´¹ç³»ç»Ÿï¼

**æœ€åæ›´æ–°**: 2025-11-24
