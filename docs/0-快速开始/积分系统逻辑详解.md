# ğŸ’¡ ç§¯åˆ†ç³»ç»Ÿé€»è¾‘è¯¦è§£ | Credits System Logic Explained

æœ¬æ–‡æ¡£è¯¦ç»†è§£é‡Šç§¯åˆ†ç³»ç»Ÿçš„å¯åŠ¨ã€è®¾ç½®å’Œå®Œæ•´ä¸šåŠ¡é€»è¾‘ã€‚

---

## ğŸ¯ ç§¯åˆ†ç³»ç»Ÿæ ¸å¿ƒæ¦‚å¿µ

### ä»€ä¹ˆæ˜¯ç§¯åˆ†ï¼Ÿ

ç§¯åˆ†æ˜¯ç”¨æˆ·åœ¨åº”ç”¨ä¸­ä½¿ç”¨ä»˜è´¹åŠŸèƒ½çš„"è´§å¸"ã€‚ç”¨æˆ·é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å¾—ç§¯åˆ†ï¼š
- æ³¨å†Œèµ é€
- è®¢é˜…è®¡åˆ’ï¼ˆæ¯æœˆè‡ªåŠ¨å‘æ”¾ï¼‰
- è´­ä¹°ç§¯åˆ†åŒ…
- ç®¡ç†å‘˜æ‰‹åŠ¨èµ é€

### ç§¯åˆ†çš„ç‰¹ç‚¹

1. **æœ‰è¿‡æœŸæ—¶é—´** - æ¯ç¬”ç§¯åˆ†éƒ½æœ‰æœ‰æ•ˆæœŸï¼ˆé»˜è®¤ 30 å¤©ï¼‰
2. **FIFO æ¶ˆè€—** - å…ˆè·å¾—çš„ç§¯åˆ†å…ˆè¢«æ¶ˆè€—ï¼ˆå…ˆè¿›å…ˆå‡ºï¼‰
3. **å¯è¿½è¸ª** - æ¯ç¬”äº¤æ˜“éƒ½æœ‰è¯¦ç»†è®°å½•
4. **ä½™é¢ç®¡ç†** - å®æ—¶æ›´æ–°ç”¨æˆ·ç§¯åˆ†ä½™é¢

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### 1. ç”¨æˆ·ç§¯åˆ†è¡¨ (`user_credit`)

å­˜å‚¨æ¯ä¸ªç”¨æˆ·çš„ç§¯åˆ†ä½™é¢ï¼š

```typescript
{
  id: string;              // ä¸»é”®
  userId: string;          // ç”¨æˆ· ID
  currentCredits: number;  // å½“å‰ç§¯åˆ†ä½™é¢ â­
  createdAt: Date;         // åˆ›å»ºæ—¶é—´
  updatedAt: Date;         // æ›´æ–°æ—¶é—´
}
```

**å…³é”®å­—æ®µ**:
- `currentCredits`: ç”¨æˆ·å½“å‰å¯ç”¨çš„ç§¯åˆ†æ€»æ•°

### 2. ç§¯åˆ†äº¤æ˜“è¡¨ (`credit_transaction`)

è®°å½•æ‰€æœ‰ç§¯åˆ†çš„è·å¾—å’Œæ¶ˆè€—ï¼š

```typescript
{
  id: string;                        // äº¤æ˜“ ID
  userId: string;                    // ç”¨æˆ· ID
  type: string;                      // äº¤æ˜“ç±»å‹ â­
  amount: number;                    // ç§¯åˆ†æ•°é‡ï¼ˆæ­£æ•°=è·å¾—ï¼Œè´Ÿæ•°=æ¶ˆè€—ï¼‰â­
  remainingAmount: number | null;    // å‰©ä½™å¯ç”¨ç§¯åˆ† â­
  description: string;               // äº¤æ˜“æè¿°
  paymentId: string | null;          // å…³è”çš„æ”¯ä»˜ ID
  expirationDate: Date | null;       // è¿‡æœŸæ—¶é—´ â­
  expirationDateProcessedAt: Date;   // è¿‡æœŸå¤„ç†æ—¶é—´
  createdAt: Date;                   // åˆ›å»ºæ—¶é—´
  updatedAt: Date;                   // æ›´æ–°æ—¶é—´
}
```

**å…³é”®å­—æ®µ**:
- `type`: äº¤æ˜“ç±»å‹ï¼ˆæ³¨å†Œã€è´­ä¹°ã€æ¶ˆè€—ç­‰ï¼‰
- `amount`: æ­£æ•°è¡¨ç¤ºè·å¾—ï¼Œè´Ÿæ•°è¡¨ç¤ºæ¶ˆè€—
- `remainingAmount`: è¿™ç¬”ç§¯åˆ†è¿˜å‰©å¤šå°‘ï¼ˆç”¨äº FIFO æ¶ˆè€—ï¼‰
- `expirationDate`: è¿™ç¬”ç§¯åˆ†ä»€ä¹ˆæ—¶å€™è¿‡æœŸ

---

## ğŸ”„ ç§¯åˆ†äº¤æ˜“ç±»å‹

### è·å¾—ç§¯åˆ†çš„ç±»å‹

```typescript
enum CREDIT_TRANSACTION_TYPE {
  REGISTER_GIFT = 'REGISTER_GIFT',              // æ³¨å†Œèµ é€
  MONTHLY_REFRESH = 'MONTHLY_REFRESH',          // å…è´¹ç”¨æˆ·æ¯æœˆåˆ·æ–°
  SUBSCRIPTION_RENEWAL = 'SUBSCRIPTION_RENEWAL', // è®¢é˜…ç»­è´¹
  LIFETIME_MONTHLY = 'LIFETIME_MONTHLY',        // ç»ˆèº«ä¼šå‘˜æ¯æœˆå‘æ”¾
  PURCHASE_PACKAGE = 'PURCHASE_PACKAGE',        // è´­ä¹°ç§¯åˆ†åŒ…
}
```

### æ¶ˆè€—ç§¯åˆ†çš„ç±»å‹

```typescript
enum CREDIT_TRANSACTION_TYPE {
  USAGE = 'USAGE',                              // ä½¿ç”¨åŠŸèƒ½æ¶ˆè€—
  EXPIRE = 'EXPIRE',                            // ç§¯åˆ†è¿‡æœŸ
}
```

---

## ğŸš€ ç§¯åˆ†ç³»ç»Ÿå¯åŠ¨æµç¨‹

### 1. ç³»ç»Ÿåˆå§‹åŒ–

å½“ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨è§¦å‘ï¼š

```typescript
// src/lib/auth.ts - onCreateUser é’©å­

async function onCreateUser(user: User) {
  // 1. æ·»åŠ æ³¨å†Œèµ é€ç§¯åˆ†
  if (websiteConfig.credits.registerGiftCredits.enable) {
    await addRegisterGiftCredits(user.id);
    // ç»“æœ: ç”¨æˆ·è·å¾— 50 ç§¯åˆ†ï¼Œ30 å¤©æœ‰æ•ˆæœŸ
  }

  // 2. æ·»åŠ å…è´¹è®¡åˆ’æ¯æœˆç§¯åˆ†
  if (websiteConfig.credits.enableCredits) {
    const freePlan = pricePlans.find(plan => plan.isFree);
    if (freePlan?.credits?.enable) {
      await addMonthlyFreeCredits(user.id, freePlan.id);
      // ç»“æœ: ç”¨æˆ·è·å¾— 50 ç§¯åˆ†ï¼Œ30 å¤©æœ‰æ•ˆæœŸ
    }
  }
}
```

**æµç¨‹å›¾**:
```
ç”¨æˆ·æ³¨å†Œ
  â†“
æ£€æŸ¥é…ç½®: registerGiftCredits.enable = true?
  â†“ æ˜¯
è°ƒç”¨ addRegisterGiftCredits()
  â†“
1. æ£€æŸ¥æ˜¯å¦å·²é¢†å–è¿‡æ³¨å†Œç§¯åˆ†
  â†“ æœªé¢†å–
2. æ’å…¥ credit_transaction è®°å½•
   - type: REGISTER_GIFT
   - amount: 50
   - remainingAmount: 50
   - expirationDate: 30å¤©å
  â†“
3. æ›´æ–° user_credit è¡¨
   - currentCredits: 0 + 50 = 50
  â†“
å®Œæˆï¼ç”¨æˆ·è·å¾— 50 ç§¯åˆ†
```

### 2. é…ç½®å¯ç”¨

åœ¨ `src/config/website.tsx` ä¸­ï¼š

```typescript
credits: {
  enableCredits: true,  // â­ ä¸»å¼€å…³
  enablePackagesForFreePlan: false,
  registerGiftCredits: {
    enable: true,       // å¯ç”¨æ³¨å†Œèµ é€
    amount: 50,         // èµ é€æ•°é‡
    expireDays: 30,     // æœ‰æ•ˆæœŸ
  },
}
```

---

## ğŸ’° ç§¯åˆ†è·å¾—é€»è¾‘

### åœºæ™¯ 1: æ³¨å†Œèµ é€ç§¯åˆ†

**è§¦å‘æ—¶æœº**: ç”¨æˆ·å®Œæˆæ³¨å†Œ

**å‡½æ•°**: `addRegisterGiftCredits(userId)`

**é€»è¾‘**:
```typescript
async function addRegisterGiftCredits(userId: string) {
  // 1. æ£€æŸ¥æ˜¯å¦å·²é¢†å–
  const existing = await db
    .select()
    .from(creditTransaction)
    .where(
      and(
        eq(creditTransaction.userId, userId),
        eq(creditTransaction.type, 'REGISTER_GIFT')
      )
    );

  // 2. å¦‚æœæœªé¢†å–ï¼Œæ·»åŠ ç§¯åˆ†
  if (existing.length === 0) {
    await addCredits({
      userId,
      amount: 50,
      type: 'REGISTER_GIFT',
      description: 'Register gift credits: 50',
      expireDays: 30,
    });
  }
}
```

**æ•°æ®åº“å˜åŒ–**:
```sql
-- credit_transaction è¡¨æ–°å¢è®°å½•
INSERT INTO credit_transaction VALUES (
  id: 'uuid-1',
  userId: 'user-123',
  type: 'REGISTER_GIFT',
  amount: 50,
  remainingAmount: 50,  -- åˆå§‹æ—¶å…¨éƒ¨å¯ç”¨
  description: 'Register gift credits: 50',
  expirationDate: '2025-12-24',  -- 30å¤©å
  createdAt: '2025-11-24'
);

-- user_credit è¡¨æ›´æ–°
UPDATE user_credit 
SET currentCredits = 50 
WHERE userId = 'user-123';
```

---

### åœºæ™¯ 2: æ¯æœˆè‡ªåŠ¨å‘æ”¾ç§¯åˆ†

**è§¦å‘æ—¶æœº**: 
- ç”¨æˆ·ç™»å½•æ—¶æ£€æŸ¥
- å®šæ—¶ä»»åŠ¡ï¼ˆCron Jobï¼‰

**å‡½æ•°**: `addMonthlyFreeCredits(userId, planId)`

**é€»è¾‘**:
```typescript
async function addMonthlyFreeCredits(userId: string, planId: string) {
  // 1. æ£€æŸ¥è®¡åˆ’é…ç½®
  const plan = findPlanByPlanId(planId);
  if (!plan?.credits?.enable) return;

  // 2. æ£€æŸ¥æœ¬æœˆæ˜¯å¦å·²å‘æ”¾
  const canAdd = await canAddCreditsByType(
    userId,
    'MONTHLY_REFRESH'
  );

  // 3. å¦‚æœæ˜¯æ–°æœˆä»½ï¼Œå‘æ”¾ç§¯åˆ†
  if (canAdd) {
    await addCredits({
      userId,
      amount: plan.credits.amount,  // 50
      type: 'MONTHLY_REFRESH',
      description: `Free monthly credits: 50 for 2025-11`,
      expireDays: 30,
    });
  }
}
```

**æœˆä»½æ£€æŸ¥é€»è¾‘**:
```typescript
async function canAddCreditsByType(userId: string, creditType: string) {
  const now = new Date();
  const currentMonth = now.getMonth();      // 10 (11æœˆ)
  const currentYear = now.getFullYear();    // 2025

  // æŸ¥è¯¢æœ¬æœˆæ˜¯å¦å·²æœ‰è¯¥ç±»å‹çš„äº¤æ˜“
  const existing = await db
    .select()
    .from(creditTransaction)
    .where(
      and(
        eq(creditTransaction.userId, userId),
        eq(creditTransaction.type, creditType),
        sql`EXTRACT(MONTH FROM ${creditTransaction.createdAt}) = ${currentMonth + 1}`,
        sql`EXTRACT(YEAR FROM ${creditTransaction.createdAt}) = ${currentYear}`
      )
    );

  return existing.length === 0;  // æ²¡æœ‰è®°å½• = å¯ä»¥å‘æ”¾
}
```

---

### åœºæ™¯ 3: è´­ä¹°ç§¯åˆ†åŒ…

**è§¦å‘æ—¶æœº**: ç”¨æˆ·é€šè¿‡ Stripe è´­ä¹°ç§¯åˆ†åŒ…

**æµç¨‹**:
```
ç”¨æˆ·ç‚¹å‡»è´­ä¹°
  â†“
è·³è½¬åˆ° Stripe æ”¯ä»˜é¡µé¢
  â†“
æ”¯ä»˜æˆåŠŸ
  â†“
Stripe Webhook å›è°ƒ
  â†“
src/app/api/webhooks/stripe/route.ts
  â†“
å¤„ç† checkout.session.completed äº‹ä»¶
  â†“
è°ƒç”¨ addCredits()
  â†“
ç§¯åˆ†åˆ°è´¦
```

**ä»£ç ç¤ºä¾‹**:
```typescript
// Stripe Webhook å¤„ç†
case 'checkout.session.completed': {
  const session = event.data.object;
  const priceId = session.line_items?.data[0]?.price?.id;
  
  // æŸ¥æ‰¾ç§¯åˆ†åŒ…é…ç½®
  const package = findCreditPackageByPriceId(priceId);
  
  if (package) {
    await addCredits({
      userId: session.metadata.userId,
      amount: package.amount,        // 100, 200, 500, 1000
      type: 'PURCHASE_PACKAGE',
      description: `Purchase ${package.id} package`,
      paymentId: session.payment_intent,
      expireDays: package.expireDays, // 30
    });
  }
  break;
}
```

---

## ğŸ”¥ ç§¯åˆ†æ¶ˆè€—é€»è¾‘ï¼ˆFIFOï¼‰

### æ ¸å¿ƒåŸç†

**FIFO (First In, First Out)**: å…ˆè·å¾—çš„ç§¯åˆ†å…ˆè¢«æ¶ˆè€—

**ä¸ºä»€ä¹ˆç”¨ FIFOï¼Ÿ**
- ç¡®ä¿å¿«è¿‡æœŸçš„ç§¯åˆ†å…ˆè¢«ä½¿ç”¨
- é¿å…ç§¯åˆ†æµªè´¹
- ç¬¦åˆç”¨æˆ·é¢„æœŸ

### æ¶ˆè€—æµç¨‹

**å‡½æ•°**: `consumeCredits({ userId, amount, description })`

**è¯¦ç»†é€»è¾‘**:

```typescript
async function consumeCredits({
  userId,
  amount,      // éœ€è¦æ¶ˆè€— 10 ç§¯åˆ†
  description
}) {
  // 1. æ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿ
  const balance = await getUserCredits(userId);
  if (balance < amount) {
    throw new Error('Insufficient credits');
  }

  // 2. è·å–æ‰€æœ‰å¯ç”¨çš„ç§¯åˆ†è®°å½•ï¼ˆæŒ‰è¿‡æœŸæ—¶é—´æ’åºï¼‰
  const transactions = await db
    .select()
    .from(creditTransaction)
    .where(
      and(
        eq(creditTransaction.userId, userId),
        // æ’é™¤æ¶ˆè€—å’Œè¿‡æœŸè®°å½•
        not(eq(creditTransaction.type, 'USAGE')),
        not(eq(creditTransaction.type, 'EXPIRE')),
        // åªè¦è¿˜æœ‰å‰©ä½™çš„
        gt(creditTransaction.remainingAmount, 0),
        // åªè¦æœªè¿‡æœŸçš„
        or(
          isNull(creditTransaction.expirationDate),
          gt(creditTransaction.expirationDate, now)
        )
      )
    )
    .orderBy(
      asc(creditTransaction.expirationDate),  // å…ˆè¿‡æœŸçš„å…ˆç”¨
      asc(creditTransaction.createdAt)        // åŒæ—¶è¿‡æœŸçš„ï¼Œå…ˆè·å¾—çš„å…ˆç”¨
    );

  // 3. FIFO æ¶ˆè€—
  let remainingToDeduct = amount;  // è¿˜éœ€è¦æ‰£é™¤ 10 ç§¯åˆ†
  
  for (const transaction of transactions) {
    if (remainingToDeduct <= 0) break;
    
    const available = transaction.remainingAmount;  // è¿™ç¬”æœ‰ 50 ç§¯åˆ†
    const deduct = Math.min(available, remainingToDeduct);  // æ‰£ 10
    
    // æ›´æ–°è¿™ç¬”äº¤æ˜“çš„å‰©ä½™ç§¯åˆ†
    await db
      .update(creditTransaction)
      .set({
        remainingAmount: available - deduct,  // 50 - 10 = 40
        updatedAt: new Date(),
      })
      .where(eq(creditTransaction.id, transaction.id));
    
    remainingToDeduct -= deduct;  // 10 - 10 = 0ï¼Œå®Œæˆ
  }

  // 4. æ›´æ–°ç”¨æˆ·æ€»ä½™é¢
  await db
    .update(userCredit)
    .set({
      currentCredits: balance - amount,  // 50 - 10 = 40
      updatedAt: new Date(),
    })
    .where(eq(userCredit.userId, userId));

  // 5. è®°å½•æ¶ˆè€—æ—¥å¿—
  await saveCreditTransaction({
    userId,
    type: 'USAGE',
    amount: -amount,  // è´Ÿæ•°è¡¨ç¤ºæ¶ˆè€—
    description,
  });
}
```

### æ¶ˆè€—ç¤ºä¾‹

**åœºæ™¯**: ç”¨æˆ·æœ‰ 3 ç¬”ç§¯åˆ†ï¼Œéœ€è¦æ¶ˆè€— 80 ç§¯åˆ†

**åˆå§‹çŠ¶æ€**:
```
Transaction 1: 50 ç§¯åˆ†ï¼Œè¿‡æœŸæ—¶é—´ 2025-12-01
Transaction 2: 30 ç§¯åˆ†ï¼Œè¿‡æœŸæ—¶é—´ 2025-12-15
Transaction 3: 100 ç§¯åˆ†ï¼Œè¿‡æœŸæ—¶é—´ 2025-12-30
æ€»ä½™é¢: 180 ç§¯åˆ†
```

**æ¶ˆè€— 80 ç§¯åˆ†å**:
```
Transaction 1: 0 ç§¯åˆ†ï¼ˆå…¨éƒ¨ç”¨å®Œï¼‰
Transaction 2: 0 ç§¯åˆ†ï¼ˆå…¨éƒ¨ç”¨å®Œï¼‰
Transaction 3: 70 ç§¯åˆ†ï¼ˆå‰©ä½™ï¼‰
æ€»ä½™é¢: 70 ç§¯åˆ†

è®¡ç®—: 50 + 30 = 80ï¼Œæ­£å¥½ç”¨å®Œå‰ä¸¤ç¬”
```

---

## â° ç§¯åˆ†è¿‡æœŸé€»è¾‘

### è¿‡æœŸå¤„ç†

**è§¦å‘æ—¶æœº**: å®šæ—¶ä»»åŠ¡ï¼ˆCron Jobï¼‰

**å‡½æ•°**: `processExpiredCredits(userId)`

**é€»è¾‘**:
```typescript
async function processExpiredCredits(userId: string) {
  const now = new Date();
  
  // 1. æŸ¥æ‰¾æ‰€æœ‰è¿‡æœŸä½†æœªå¤„ç†çš„ç§¯åˆ†
  const transactions = await db
    .select()
    .from(creditTransaction)
    .where(
      and(
        eq(creditTransaction.userId, userId),
        not(eq(creditTransaction.type, 'USAGE')),
        not(eq(creditTransaction.type, 'EXPIRE')),
        not(isNull(creditTransaction.expirationDate)),
        isNull(creditTransaction.expirationDateProcessedAt),
        gt(creditTransaction.remainingAmount, 0)
      )
    );

  let expiredTotal = 0;

  // 2. å¤„ç†æ¯ç¬”è¿‡æœŸçš„ç§¯åˆ†
  for (const transaction of transactions) {
    if (isAfter(now, transaction.expirationDate)) {
      const remain = transaction.remainingAmount;
      expiredTotal += remain;
      
      // æ ‡è®°ä¸ºå·²å¤„ç†
      await db
        .update(creditTransaction)
        .set({
          remainingAmount: 0,
          expirationDateProcessedAt: now,
          updatedAt: now,
        })
        .where(eq(creditTransaction.id, transaction.id));
    }
  }

  // 3. æ‰£é™¤æ€»ä½™é¢
  if (expiredTotal > 0) {
    const balance = await getUserCredits(userId);
    await db
      .update(userCredit)
      .set({
        currentCredits: Math.max(0, balance - expiredTotal),
        updatedAt: now,
      })
      .where(eq(userCredit.userId, userId));

    // 4. è®°å½•è¿‡æœŸæ—¥å¿—
    await saveCreditTransaction({
      userId,
      type: 'EXPIRE',
      amount: -expiredTotal,
      description: `Expire credits: ${expiredTotal}`,
    });
  }
}
```

---

## ğŸ¯ å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: AI å›¾ç‰‡ç”Ÿæˆæ¶ˆè€—ç§¯åˆ†

```typescript
// src/app/api/generate-image/route.ts

export async function POST(request: Request) {
  const session = await getSession();
  const userId = session.user.id;
  
  // 1. æ£€æŸ¥ç§¯åˆ†æ˜¯å¦è¶³å¤Ÿ
  const requiredCredits = 10;
  const hasEnough = await hasEnoughCredits({
    userId,
    requiredCredits,
  });
  
  if (!hasEnough) {
    return Response.json(
      { error: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·è´­ä¹°ç§¯åˆ†åŒ…' },
      { status: 400 }
    );
  }

  // 2. æ‰§è¡Œ AI ç”Ÿæˆ
  const result = await generateImage(prompt);

  // 3. æ¶ˆè€—ç§¯åˆ†
  await consumeCredits({
    userId,
    amount: requiredCredits,
    description: 'AI å›¾ç‰‡ç”Ÿæˆ',
  });

  return Response.json({ result });
}
```

### ç¤ºä¾‹ 2: æ˜¾ç¤ºç§¯åˆ†ä½™é¢

```typescript
// src/components/dashboard/credits-widget.tsx

'use client';

import { useQuery } from '@tanstack/react-query';
import { getUserCreditsAction } from '@/actions/credits';

export function CreditsWidget() {
  const { data: balance } = useQuery({
    queryKey: ['user-credits'],
    queryFn: () => getUserCreditsAction(),
  });

  return (
    <div className="p-4 border rounded-lg">
      <h3>ç§¯åˆ†ä½™é¢</h3>
      <p className="text-3xl font-bold">{balance || 0}</p>
    </div>
  );
}
```

### ç¤ºä¾‹ 3: è´­ä¹°ç§¯åˆ†åŒ…

```typescript
// src/components/settings/credits/credit-checkout-button.tsx

'use client';

export function CreditCheckoutButton({ packageId }: Props) {
  const handlePurchase = async () => {
    // 1. åˆ›å»º Stripe Checkout Session
    const session = await createCheckoutSession({
      priceId: package.price.priceId,
      successUrl: '/settings/credits?success=true',
      cancelUrl: '/settings/credits?canceled=true',
    });

    // 2. è·³è½¬åˆ° Stripe æ”¯ä»˜é¡µé¢
    window.location.href = session.url;
  };

  return (
    <Button onClick={handlePurchase}>
      è´­ä¹° {package.amount} ç§¯åˆ†
    </Button>
  );
}
```

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

### ç”¨æˆ·æ³¨å†Œåˆ°ä½¿ç”¨ç§¯åˆ†çš„å®Œæ•´æµç¨‹

```
ç”¨æˆ·æ³¨å†Œ
  â†“
è§¦å‘ onCreateUser é’©å­
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ³¨å†Œèµ é€ 50 ç§¯åˆ†              â”‚
â”‚    - type: REGISTER_GIFT        â”‚
â”‚    - amount: 50                 â”‚
â”‚    - remainingAmount: 50        â”‚
â”‚    - expirationDate: 30å¤©å     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å…è´¹è®¡åˆ’æ¯æœˆ 50 ç§¯åˆ†          â”‚
â”‚    - type: MONTHLY_REFRESH      â”‚
â”‚    - amount: 50                 â”‚
â”‚    - remainingAmount: 50        â”‚
â”‚    - expirationDate: 30å¤©å     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
user_credit è¡¨æ›´æ–°
  - currentCredits: 100
  â†“
ç”¨æˆ·ç™»å½•ï¼Œè®¿é—® /dashboard
  â†“
æ˜¾ç¤º: "ç§¯åˆ†ä½™é¢: 100"
  â†“
ç”¨æˆ·ä½¿ç”¨ AI åŠŸèƒ½
  â†“
è°ƒç”¨ consumeCredits(userId, 10, 'AIç”Ÿæˆ')
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FIFO æ¶ˆè€—é€»è¾‘:                   â”‚
â”‚ 1. æ‰¾åˆ°æœ€æ—©è¿‡æœŸçš„ç§¯åˆ†            â”‚
â”‚ 2. Transaction 1 å‰©ä½™: 50 â†’ 40  â”‚
â”‚ 3. æ€»ä½™é¢: 100 â†’ 90             â”‚
â”‚ 4. è®°å½• USAGE æ—¥å¿—              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ˜¾ç¤º: "ç§¯åˆ†ä½™é¢: 90"
  â†“
30å¤©åï¼Œå®šæ—¶ä»»åŠ¡è¿è¡Œ
  â†“
processExpiredCredits()
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿‡æœŸå¤„ç†:                        â”‚
â”‚ 1. Transaction 1 è¿‡æœŸ: 40 ç§¯åˆ†  â”‚
â”‚ 2. æ€»ä½™é¢: 90 â†’ 50              â”‚
â”‚ 3. è®°å½• EXPIRE æ—¥å¿—             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ˜¾ç¤º: "ç§¯åˆ†ä½™é¢: 50"
```

---

## ğŸ› ï¸ ç®¡ç†å‘˜æ“ä½œ

### æ‰‹åŠ¨ç»™ç”¨æˆ·æ·»åŠ ç§¯åˆ†

```typescript
// scripts/add-credits.ts

import { addCredits } from '@/credits/credits';
import { getDb } from '@/db';
import { user } from '@/db/schema';
import { eq } from 'drizzle-orm';

async function giveCredits(email: string, amount: number) {
  const db = await getDb();
  
  // æŸ¥æ‰¾ç”¨æˆ·
  const userRecord = await db
    .select()
    .from(user)
    .where(eq(user.email, email))
    .limit(1);

  if (!userRecord[0]) {
    console.error('ç”¨æˆ·ä¸å­˜åœ¨');
    return;
  }

  // æ·»åŠ ç§¯åˆ†
  await addCredits({
    userId: userRecord[0].id,
    amount: amount,
    type: 'ADMIN_GIFT',
    description: `ç®¡ç†å‘˜èµ é€ ${amount} ç§¯åˆ†`,
    expireDays: 30,
  });

  console.log(`âœ… å·²ç»™ ${email} æ·»åŠ  ${amount} ç§¯åˆ†`);
}

// ä½¿ç”¨
giveCredits('user@example.com', 100);
```

è¿è¡Œ:
```bash
pnpm tsx scripts/add-credits.ts
```

---

## ğŸ“š æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ**: ä¿®æ”¹ `src/config/website.tsx` ä¸­çš„ `enableCredits: true`

2. **ç§¯åˆ†è·å¾—æ–¹å¼**:
   - æ³¨å†Œèµ é€ï¼ˆä¸€æ¬¡æ€§ï¼‰
   - æ¯æœˆè‡ªåŠ¨å‘æ”¾ï¼ˆæŒ‰è®¡åˆ’ï¼‰
   - è´­ä¹°ç§¯åˆ†åŒ…ï¼ˆStripeï¼‰
   - ç®¡ç†å‘˜æ‰‹åŠ¨èµ é€

3. **ç§¯åˆ†æ¶ˆè€—**: FIFO åŸåˆ™ï¼Œå…ˆè¿‡æœŸçš„å…ˆç”¨

4. **ç§¯åˆ†è¿‡æœŸ**: å®šæ—¶ä»»åŠ¡è‡ªåŠ¨å¤„ç†

5. **æ•°æ®è¿½è¸ª**: æ‰€æœ‰äº¤æ˜“éƒ½æœ‰è¯¦ç»†è®°å½•

### å…³é”®å‡½æ•°

- `addCredits()` - æ·»åŠ ç§¯åˆ†
- `consumeCredits()` - æ¶ˆè€—ç§¯åˆ†
- `getUserCredits()` - æŸ¥è¯¢ä½™é¢
- `hasEnoughCredits()` - æ£€æŸ¥æ˜¯å¦è¶³å¤Ÿ
- `processExpiredCredits()` - å¤„ç†è¿‡æœŸ

---

**ç°åœ¨ä½ å®Œå…¨ç†è§£ç§¯åˆ†ç³»ç»Ÿçš„é€»è¾‘äº†ï¼ğŸ‰**

å¯ä»¥å¼€å§‹é›†æˆåˆ°ä½ çš„åŠŸèƒ½ä¸­äº†ã€‚

**æœ€åæ›´æ–°**: 2025-11-24
