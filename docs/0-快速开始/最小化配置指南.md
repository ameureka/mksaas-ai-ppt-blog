# 🚀 最小化配置指南 | Minimal Configuration Guide

本指南帮助你用**最少的配置**快速上线一个可用的 SaaS 应用。

---

## 📋 配置优先级

### 🔴 必需配置（3 项）- 没有这些无法运行

```bash
# 1. 应用基础 URL | Application Base URL
NEXT_PUBLIC_BASE_URL="https://yourdomain.com"
# 开发环境 | Development: http://localhost:3005
# 生产环境 | Production: https://yourdomain.com

# 2. 数据库连接 | Database Connection
DATABASE_URL="postgresql://user:password@host:5432/dbname"
# 用于存储所有用户数据、内容、订单等
# Used for storing all user data, content, orders, etc.

# 3. 身份认证密钥 | Authentication Secret
BETTER_AUTH_SECRET="your-random-secret-key-here"
# 生成方法 | Generate with: openssl rand -base64 32
# 用于 JWT token 签名和会话管理
# Used for JWT token signing and session management
```

**配置这 3 项后，应用可以启动，但用户无法登录。**

---

### 🟡 强烈推荐配置（2-3 项）- 基础功能必需

```bash
# 4. OAuth 登录（至少配置一个）| OAuth Login (at least one)
# 选项 A: GitHub OAuth
GITHUB_CLIENT_ID="your-github-client-id"
GITHUB_CLIENT_SECRET="your-github-client-secret"
# 获取方式 | Get from: https://github.com/settings/developers

# 选项 B: Google OAuth
GOOGLE_CLIENT_ID="your-google-client-id"
GOOGLE_CLIENT_SECRET="your-google-client-secret"
# 获取方式 | Get from: https://console.cloud.google.com/apis/credentials

# 5. 邮件服务（推荐）| Email Service (Recommended)
RESEND_API_KEY="re_your_api_key"
# 用于发送欢迎邮件、密码重置、通知等
# Used for welcome emails, password reset, notifications, etc.
# 获取方式 | Get from: https://resend.com/api-keys
```

**配置这些后，用户可以注册、登录、接收邮件通知。**

---

### 🟢 按需配置 - 根据业务功能选择

#### 💳 如果需要支付功能 | If Payment is Required

```bash
# Stripe 支付配置 | Stripe Payment Configuration
STRIPE_SECRET_KEY="sk_live_xxx"  # 生产环境 | Production
# 或 | or
STRIPE_SECRET_KEY="sk_test_xxx"  # 测试环境 | Testing

STRIPE_WEBHOOK_SECRET="whsec_xxx"
# 获取方式 | Get from: https://dashboard.stripe.com

# 产品价格 ID（至少配置一个）| Product Price IDs (at least one)
NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY="price_xxx"
NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY="price_xxx"
NEXT_PUBLIC_STRIPE_PRICE_LIFETIME="price_xxx"
```

#### 📦 如果需要文件上传 | If File Upload is Required

```bash
# 存储服务配置（Cloudflare R2 或 S3）| Storage Service (Cloudflare R2 or S3)
STORAGE_REGION="auto"
STORAGE_BUCKET_NAME="your-bucket-name"
STORAGE_ACCESS_KEY_ID="your-access-key"
STORAGE_SECRET_ACCESS_KEY="your-secret-key"
STORAGE_ENDPOINT="https://xxx.r2.cloudflarestorage.com"
STORAGE_PUBLIC_URL="https://your-cdn-domain.com"
# 获取方式 | Get from: https://dash.cloudflare.com/r2
```

#### 🤖 如果需要 AI 功能 | If AI Features are Required

```bash
# AI 服务配置（选择你需要的）| AI Service Configuration (choose what you need)
OPENAI_API_KEY="sk-xxx"              # OpenAI GPT
DEEPSEEK_API_KEY="xxx"               # DeepSeek
GOOGLE_GENERATIVE_AI_API_KEY="xxx"  # Google Gemini
OPENROUTER_API_KEY="xxx"             # OpenRouter (多模型 | Multi-model)
```

---

### ⚪ 可以完全忽略的配置 | Optional Configurations

以下配置都是**增强功能**，不影响核心业务运行：

```bash
# ❌ 数据分析工具 | Analytics Tools
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=""
NEXT_PUBLIC_UMAMI_WEBSITE_ID=""
NEXT_PUBLIC_POSTHOG_KEY=""
NEXT_PUBLIC_PLAUSIBLE_DOMAIN=""
NEXT_PUBLIC_AHREFS_WEBSITE_ID=""
NEXT_PUBLIC_SELINE_TOKEN=""
NEXT_PUBLIC_DATAFAST_WEBSITE_ID=""
NEXT_PUBLIC_CLARITY_PROJECT_ID=""
NEXT_PUBLIC_OPENPANEL_CLIENT_ID=""

# ❌ 通知服务 | Notification Services
DISCORD_WEBHOOK_URL=""
FEISHU_WEBHOOK_URL=""

# ❌ 联盟营销 | Affiliate Marketing
NEXT_PUBLIC_AFFILIATE_AFFONSO_ID=""
NEXT_PUBLIC_AFFILIATE_PROMOTEKIT_ID=""

# ❌ 验证码 | Captcha
NEXT_PUBLIC_TURNSTILE_SITE_KEY=""
TURNSTILE_SECRET_KEY=""

# ❌ 在线客服 | Live Chat
NEXT_PUBLIC_CRISP_WEBSITE_ID=""

# ❌ 定时任务认证 | Cron Jobs Auth
CRON_JOBS_USERNAME=""
CRON_JOBS_PASSWORD=""

# ❌ 网页分析器 | Web Scraper
FIRECRAWL_API_KEY=""

# ❌ 订阅通讯 | Newsletter
RESEND_AUDIENCE_ID=""

# ❌ 其他配置 | Other Configs
DISABLE_IMAGE_OPTIMIZATION=false
NEXT_PUBLIC_DEMO_WEBSITE=false
```

---

## 🎯 三种配置方案

### 方案 1: 最小开发环境（本地测试）

**目标**: 快速启动，本地开发测试

```bash
# .env.local
NEXT_PUBLIC_BASE_URL="http://localhost:3005"
DATABASE_URL="postgresql://postgres:password@localhost:5432/mksaas"
BETTER_AUTH_SECRET="dev-secret-at-least-32-characters-long"
GITHUB_CLIENT_ID="your-dev-github-id"
GITHUB_CLIENT_SECRET="your-dev-github-secret"
```

**功能**: ✅ 启动应用 ✅ 用户登录 ❌ 邮件通知 ❌ 支付功能

---

### 方案 2: 基础生产环境（MVP 上线）

**目标**: 最小可用产品，支持用户注册登录和基础功能

```bash
# .env.production
NEXT_PUBLIC_BASE_URL="https://yourdomain.com"
DATABASE_URL="postgresql://user:password@prod-host:5432/mksaas"
BETTER_AUTH_SECRET="<strong-random-key-from-vault>"

# OAuth 登录
GITHUB_CLIENT_ID="your-prod-github-id"
GITHUB_CLIENT_SECRET="your-prod-github-secret"
GOOGLE_CLIENT_ID="your-google-id"
GOOGLE_CLIENT_SECRET="your-google-secret"

# 邮件服务
RESEND_API_KEY="re_live_xxx"
```

**功能**: ✅ 完整认证 ✅ 邮件通知 ✅ 用户管理 ❌ 支付功能 ❌ 文件上传

**适合**: 内测版本、免费产品、社区项目

---

### 方案 3: 完整生产环境（商业化）

**目标**: 完整功能，支持付费订阅

```bash
# .env.production
NEXT_PUBLIC_BASE_URL="https://yourdomain.com"
DATABASE_URL="postgresql://user:password@prod-host:5432/mksaas"
BETTER_AUTH_SECRET="<strong-random-key>"

# OAuth 登录
GITHUB_CLIENT_ID="xxx"
GITHUB_CLIENT_SECRET="xxx"
GOOGLE_CLIENT_ID="xxx"
GOOGLE_CLIENT_SECRET="xxx"

# 邮件服务
RESEND_API_KEY="re_live_xxx"

# 支付系统
STRIPE_SECRET_KEY="sk_live_xxx"
STRIPE_WEBHOOK_SECRET="whsec_xxx"
NEXT_PUBLIC_STRIPE_PRICE_PRO_MONTHLY="price_xxx"
NEXT_PUBLIC_STRIPE_PRICE_PRO_YEARLY="price_xxx"

# 存储服务（如果需要）
STORAGE_REGION="auto"
STORAGE_BUCKET_NAME="your-bucket"
STORAGE_ACCESS_KEY_ID="xxx"
STORAGE_SECRET_ACCESS_KEY="xxx"
STORAGE_ENDPOINT="https://xxx.r2.cloudflarestorage.com"
STORAGE_PUBLIC_URL="https://cdn.yourdomain.com"

# AI 功能（如果需要）
OPENAI_API_KEY="sk-xxx"

# 数据分析（可选）
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID="G-xxx"
```

**功能**: ✅ 所有核心功能 ✅ 支付订阅 ✅ 文件上传 ✅ AI 功能

**适合**: 正式商业化产品

---

## 📝 快速配置步骤

### Step 1: 复制配置文件

```bash
cp env.example .env.local
```

### Step 2: 配置必需项（3 项）

```bash
# 编辑 .env.local
nano .env.local

# 或使用你喜欢的编辑器
code .env.local
```

填写：
1. `NEXT_PUBLIC_BASE_URL`
2. `DATABASE_URL`
3. `BETTER_AUTH_SECRET`（使用 `openssl rand -base64 32` 生成）

### Step 3: 配置 OAuth（至少 1 个）

选择 GitHub 或 Google，按照下面的指南获取密钥：

#### GitHub OAuth 配置

1. 访问 https://github.com/settings/developers
2. 点击 "New OAuth App"
3. 填写信息：
   - Application name: `Your App Name`
   - Homepage URL: `https://yourdomain.com`
   - Authorization callback URL: `https://yourdomain.com/api/auth/callback/github`
4. 复制 `Client ID` 和 `Client Secret`

#### Google OAuth 配置

1. 访问 https://console.cloud.google.com/apis/credentials
2. 创建新项目（如果没有）
3. 点击 "Create Credentials" → "OAuth client ID"
4. 选择 "Web application"
5. 添加授权重定向 URI: `https://yourdomain.com/api/auth/callback/google`
6. 复制 `Client ID` 和 `Client Secret`

### Step 4: 配置邮件服务（推荐）

1. 访问 https://resend.com
2. 注册账号
3. 验证域名（或使用测试域名）
4. 创建 API Key
5. 复制到 `RESEND_API_KEY`

### Step 5: 初始化数据库

```bash
# 推送数据库 schema
pnpm db:push

# 或运行迁移
pnpm db:migrate
```

### Step 6: 启动应用

```bash
# 开发环境
pnpm dev

# 生产环境
pnpm build
pnpm start
```

### Step 7: 测试功能

1. 访问 `http://localhost:3005`（开发）或 `https://yourdomain.com`（生产）
2. 点击 "Sign Up" 或 "Login"
3. 使用 GitHub/Google 登录
4. 检查是否收到欢迎邮件（如果配置了 Resend）

---

## 🔧 常见问题

### Q1: 数据库连接失败？

**检查清单**:
- ✅ 数据库服务是否运行？`pg_isready`
- ✅ 连接字符串格式正确？`postgresql://user:password@host:5432/dbname`
- ✅ 用户名和密码正确？
- ✅ 数据库已创建？`createdb mksaas`
- ✅ 防火墙允许连接？

### Q2: OAuth 登录失败？

**检查清单**:
- ✅ Client ID 和 Secret 正确？
- ✅ 回调 URL 配置正确？必须完全匹配
- ✅ OAuth 应用已启用？
- ✅ 域名可以访问？（生产环境）

### Q3: 邮件发送失败？

**检查清单**:
- ✅ Resend API Key 正确？
- ✅ 域名已验证？（生产环境）
- ✅ 发件人邮箱配置正确？
- ✅ 检查 Resend 控制台的日志

### Q4: 如何测试支付功能？

**使用 Stripe 测试模式**:
1. 使用 `sk_test_xxx` 密钥
2. 使用测试卡号: `4242 4242 4242 4242`
3. 任意未来日期和 CVC
4. 查看 Stripe Dashboard 的测试数据

### Q5: 生产环境如何管理密钥？

**推荐方案**:
- ✅ 使用环境变量（Vercel/Railway 等平台）
- ✅ 使用密钥管理服务（AWS Secrets Manager, 1Password）
- ✅ 不要提交 `.env.local` 到 Git
- ✅ 使用 `.env.example` 作为模板
- ✅ 定期轮换密钥

---

## 🚀 部署到生产环境

### Vercel 部署（推荐）

```bash
# 1. 安装 Vercel CLI
npm i -g vercel

# 2. 登录
vercel login

# 3. 部署
vercel

# 4. 在 Vercel Dashboard 配置环境变量
# https://vercel.com/your-project/settings/environment-variables
```

### 环境变量配置

在 Vercel Dashboard 中添加所有必需的环境变量：
1. 进入项目设置
2. 点击 "Environment Variables"
3. 逐个添加变量
4. 选择环境（Production/Preview/Development）
5. 保存并重新部署

---

## 📚 相关文档

- **[环境变量完整参考](../6-参考文档和部署指南/环境变量参考.md)** - 所有变量的详细说明
- **[部署指南](../6-参考文档和部署指南/部署指南.md)** - 完整的部署流程
- **[常用命令](./常用命令.md)** - 开发命令参考
- **[FAQ](./FAQ.md)** - 常见问题解答

---

## ✅ 配置检查清单

使用这个清单确保你的配置完整：

### 最小配置（必需）
- [ ] `NEXT_PUBLIC_BASE_URL` 已配置
- [ ] `DATABASE_URL` 已配置
- [ ] `BETTER_AUTH_SECRET` 已生成并配置
- [ ] 数据库已初始化（`pnpm db:push`）

### 基础功能（推荐）
- [ ] GitHub OAuth 或 Google OAuth 已配置
- [ ] OAuth 回调 URL 正确
- [ ] Resend API Key 已配置
- [ ] 邮件发送测试通过

### 商业功能（按需）
- [ ] Stripe 密钥已配置
- [ ] Stripe Webhook 已设置
- [ ] 产品价格 ID 已配置
- [ ] 支付测试通过

### 生产环境（上线前）
- [ ] 所有密钥使用生产环境版本
- [ ] 域名已配置并可访问
- [ ] SSL 证书已配置
- [ ] 数据库备份已设置
- [ ] 监控和日志已配置

---

## 💡 最佳实践

### 开发环境
- ✅ 使用 `.env.local` 存储本地配置
- ✅ 使用测试密钥（Stripe `sk_test_xxx`）
- ✅ 可以禁用邮件验证加快测试
- ✅ 使用本地数据库

### 生产环境
- ✅ 使用强随机密钥（32+ 字符）
- ✅ 使用生产密钥（Stripe `sk_live_xxx`）
- ✅ 启用所有安全功能
- ✅ 使用托管数据库（带备份）
- ✅ 配置监控和告警
- ✅ 定期轮换密钥

### 安全建议
- ❌ 不要在代码中硬编码密钥
- ❌ 不要提交 `.env.local` 到 Git
- ❌ 不要在日志中打印密钥
- ❌ 不要在客户端暴露服务器密钥
- ❌ 不要在多个环境重用密钥
- ❌ 不要通过不安全渠道分享密钥

---

**准备好了吗？开始配置你的应用吧！🚀**

如有问题，查看 [FAQ](./FAQ.md) 或联系团队。

**最后更新**: 2025-11-24
