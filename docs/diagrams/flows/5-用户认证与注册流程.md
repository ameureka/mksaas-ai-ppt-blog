# 5-6. ç”¨æˆ·è®¤è¯ä¸æ³¨å†Œæµç¨‹

## 5. ç”¨æˆ·æ³¨å†Œå®Œæ•´æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ“ ç”¨æˆ·æ³¨å†Œå®Œæ•´æµç¨‹ (Registration Flow)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼€å§‹
  â”‚
  â–¼
ç”¨æˆ·è®¿é—® /auth/register
  â”‚
  â”œâ”€ æ˜¯å¦å·²ç™»å½•? â”€æ˜¯â”€â–º é‡å®šå‘åˆ° /dashboard
  â”‚
  â””â”€å¦
    â”‚
    â–¼
  æ˜¾ç¤ºæ³¨å†Œè¡¨å•
    â”‚
    â”œâ”€ é‚®ç®±è¾“å…¥æ¡†
    â”œâ”€ å¯†ç è¾“å…¥æ¡†
    â”œâ”€ ç¡®è®¤å¯†ç è¾“å…¥æ¡†
    â”œâ”€ ç”¨æˆ·åè¾“å…¥æ¡† (å¯é€‰)
    â”œâ”€ éªŒè¯ç  (å¦‚æœå¯ç”¨)
    â”œâ”€ ç¤¾äº¤ç™»å½•é€‰é¡¹ (Google, GitHub)
    â””â”€ æäº¤æŒ‰é’®
    â”‚
    â–¼
  ç”¨æˆ·è¾“å…¥ä¿¡æ¯ â†’ ç‚¹å‡» "Sign Up" æŒ‰é’®
    â”‚
    â–¼
  æœ¬åœ°è¡¨å•éªŒè¯ (React Hook Form)
    â”‚
    â”œâ”€ é‚®ç®±æ ¼å¼æ£€æŸ¥
    â”œâ”€ å¯†ç é•¿åº¦ (â‰¥8 å­—ç¬¦)
    â”œâ”€ å¯†ç ç¡®è®¤åŒ¹é…
    â””â”€ å¦‚æœéªŒè¯å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯æç¤º â†’ è¿”å›è¡¨å•
    â”‚
    â–¼
  Zod Schema éªŒè¯
    â”‚
    â”œâ”€ z.string().email() â†’ é‚®ç®±æœ‰æ•ˆæ€§
    â”œâ”€ z.string().min(8) â†’ å¯†ç é•¿åº¦
    â””â”€ éªŒè¯å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯ â†’ è¿”å›
    â”‚
    â–¼
  è°ƒç”¨ Server Action: signUpAction()
    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            (Server-side Processing)          â”‚
                                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
  1ï¸âƒ£ éªŒè¯é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    â”‚
    â”œâ”€ æŸ¥è¯¢æ•°æ®åº“
    â”‚  SELECT * FROM user WHERE email = ?
    â”‚
    â”œâ”€ å¦‚æœå­˜åœ¨ â†’ æŠ›å‡ºé”™è¯¯ "Email already registered"
    â”‚  è¿”å›åˆ°å®¢æˆ·ç«¯ â†’ æ˜¾ç¤ºé”™è¯¯æç¤º
    â”‚
    â””â”€ å¦‚æœä¸å­˜åœ¨ â†’ ç»§ç»­
    â”‚
    â–¼
  2ï¸âƒ£ éªŒè¯éªŒè¯ç  (å¦‚æœå¯ç”¨)
    â”‚
    â”œâ”€ è°ƒç”¨ Turnstile/reCAPTCHA éªŒè¯
    â”‚
    â”œâ”€ éªŒè¯å¤±è´¥ â†’ è¿”å›é”™è¯¯
    â”‚
    â””â”€ æˆåŠŸ â†’ ç»§ç»­
    â”‚
    â–¼
  3ï¸âƒ£ å“ˆå¸Œå¯†ç 
    â”‚
    â”œâ”€ ä½¿ç”¨ bcrypt æˆ– argon2 åŠ å¯†
    â”œâ”€ hash = await hashPassword(password)
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  4ï¸âƒ£ åˆ›å»ºç”¨æˆ·è®°å½•
    â”‚
    â”œâ”€ INSERT INTO user (id, email, name, emailVerified, role, createdAt)
    â”‚  VALUES (generateId(), email, name, false, 'user', now())
    â”‚
    â”œâ”€ è·å–æ–°ç”¨æˆ· ID
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  5ï¸âƒ£ åˆ›å»ºè´¦æˆ·è®°å½• (Email/Password)
    â”‚
    â”œâ”€ INSERT INTO account (userId, providerId, password)
    â”‚  VALUES (userId, 'email', hashedPassword)
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  6ï¸âƒ£ åˆå§‹åŒ–ç§¯åˆ†ç³»ç»Ÿ
    â”‚
    â”œâ”€ CREATE userCredit
    â”‚  INSERT INTO userCredit (userId, currentCredits, lastRefreshAt)
    â”‚  VALUES (userId, 0, now())
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  7ï¸âƒ£ åˆ†é…æ³¨å†Œèµ é€
    â”‚
    â”œâ”€ INSERT INTO creditTransaction
    â”‚  â”œâ”€ userId: userId
    â”‚  â”œâ”€ type: 'REGISTER_GIFT'
    â”‚  â”œâ”€ amount: 50
    â”‚  â”œâ”€ description: 'æ³¨å†Œèµ é€'
    â”‚  â”œâ”€ expirationDate: now() + 30 days
    â”‚  â””â”€ createdAt: now()
    â”‚
    â”œâ”€ UPDATE userCredit SET currentCredits = 50
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  8ï¸âƒ£ å‘é€é‚®ä»¶éªŒè¯
    â”‚
    â”œâ”€ åˆ›å»ºéªŒè¯ä»¤ç‰Œ
    â”‚  â””â”€ INSERT INTO verification (identifier, value, expiresAt)
    â”‚
    â”œâ”€ å‘é€é‚®ä»¶
    â”‚  â””â”€ sendEmail({
    â”‚       to: email,
    â”‚       template: 'verifyEmail',
    â”‚       context: { verificationLink: ... }
    â”‚     })
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  9ï¸âƒ£ è‡ªåŠ¨è®¢é˜…é‚®ä»¶åˆ—è¡¨ (å¦‚æœå¯ç”¨)
    â”‚
    â”œâ”€ è°ƒç”¨ Resend API æˆ– newsletter æœåŠ¡
    â”‚  â””â”€ addToNewsletter(email)
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  ğŸ”Ÿ è¿”å›æˆåŠŸå“åº”åˆ°å®¢æˆ·ç«¯
    â”‚
    â””â”€ { success: true, redirectUrl: '/auth/verify-email' }
    â”‚
    (Return to Client-side)
    â”‚
    â–¼
  æ˜¾ç¤º "æ£€æŸ¥ä½ çš„é‚®ç®±" æç¤º
    â”‚
    â”œâ”€ ç”¨æˆ·è®¿é—®é‚®ç®±
    â”‚
    â””â”€ ç‚¹å‡»éªŒè¯é“¾æ¥
    â”‚
    â–¼
  éªŒè¯é‚®ä»¶é“¾æ¥å¤„ç†
    â”‚
    â”œâ”€ é“¾æ¥: /verify-email?token=xxx&email=user@example.com
    â”‚
    â–¼
  1ï¸âƒ£ éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
    â”‚
    â”œâ”€ æŸ¥è¯¢ verification è¡¨
    â”‚  â””â”€ SELECT * WHERE identifier = email AND value = token
    â”‚
    â”œâ”€ æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
    â”‚  â””â”€ IF expiresAt < now() â†’ ä»¤ç‰Œå·²è¿‡æœŸ
    â”‚
    â””â”€ å¦‚æœæœ‰æ•ˆ â†’ ç»§ç»­
    â”‚
    â–¼
  2ï¸âƒ£ æ›´æ–°ç”¨æˆ·é‚®ç®±éªŒè¯çŠ¶æ€
    â”‚
    â”œâ”€ UPDATE user SET emailVerified = true WHERE email = ?
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  3ï¸âƒ£ åˆ é™¤éªŒè¯ä»¤ç‰Œ
    â”‚
    â”œâ”€ DELETE FROM verification WHERE value = token
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  4ï¸âƒ£ åˆ›å»ºä¼šè¯å¹¶ç™»å½•
    â”‚
    â”œâ”€ INSERT INTO session (userId, token, expiresAt, ...)
    â”‚  â””â”€ expiresAt: now() + 7 days
    â”‚
    â”œâ”€ è®¾ç½® Cookie
    â”‚  â””â”€ Set-Cookie: authToken=xxx; Secure; HttpOnly
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  5ï¸âƒ£ é‡å®šå‘åˆ°ä»ªè¡¨æ¿
    â”‚
    â””â”€ redirect('/dashboard')
    â”‚
    â–¼
  âœ… æ³¨å†ŒæˆåŠŸï¼
    â”‚
    â””â”€ ç”¨æˆ·å·²ç™»å½•ï¼Œæ˜¾ç¤ºä»ªè¡¨æ¿

æ³¨å†Œæµç¨‹æ€»ç»“:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

å¤±è´¥æƒ…å†µå¤„ç†:

âŒ é‚®ç®±å·²å­˜åœ¨
   â†’ "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ä½¿ç”¨å…¶ä»–é‚®ç®±æˆ–ç‚¹å‡»å¿˜è®°å¯†ç "

âŒ å¯†ç ä¸ç¬¦åˆè¦æ±‚
   â†’ "å¯†ç é•¿åº¦è‡³å°‘ 8 ä¸ªå­—ç¬¦"

âŒ éªŒè¯ç å¤±è´¥
   â†’ "éªŒè¯ç éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•"

âŒ æœåŠ¡å™¨é”™è¯¯
   â†’ "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"

âŒ é‚®ä»¶å‘é€å¤±è´¥
   â†’ "é‚®ä»¶å‘é€å¤±è´¥ï¼Œä½†è´¦æˆ·å·²åˆ›å»ºï¼Œè¯·æ£€æŸ¥åƒåœ¾ç®±æˆ–é‡æ–°å‘é€éªŒè¯é‚®ä»¶"

âŒ éªŒè¯é‚®ä»¶è¿‡æœŸ
   â†’ "éªŒè¯é“¾æ¥å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ³¨å†Œæˆ–ç‚¹å‡»é‡æ–°å‘é€éªŒè¯é‚®ä»¶"
```

## 6. ç”¨æˆ·ç™»å½•æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ğŸ” ç”¨æˆ·ç™»å½•å®Œæ•´æµç¨‹ (Login Flow)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¼€å§‹
  â”‚
  â–¼
ç”¨æˆ·è®¿é—® /auth/login
  â”‚
  â”œâ”€ æ˜¯å¦å·²ç™»å½•? â”€æ˜¯â”€â–º é‡å®šå‘åˆ° /dashboard
  â”‚
  â””â”€å¦
    â”‚
    â–¼
  æ˜¾ç¤ºç™»å½•è¡¨å•
    â”‚
    â”œâ”€ é‚®ç®±/ç”¨æˆ·åè¾“å…¥æ¡†
    â”œâ”€ å¯†ç è¾“å…¥æ¡† (å¯è§†æ€§åˆ‡æ¢)
    â”œâ”€ è®°ä½æˆ‘å¤é€‰æ¡† (å¯é€‰)
    â”œâ”€ éªŒè¯ç  (å¦‚æœå¯ç”¨)
    â”œâ”€ ç¤¾äº¤ç™»å½•é€‰é¡¹ (Google, GitHub)
    â”œâ”€ "å¿˜è®°å¯†ç ?" é“¾æ¥
    â””â”€ "æ²¡æœ‰è´¦æˆ·? æ³¨å†Œ" é“¾æ¥
    â”‚
    â–¼
  â”Œâ”€ ç”¨æˆ·é€‰æ‹©ç™»å½•æ–¹å¼ â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚                   â”‚                 â”‚
è·¯çº¿A:            è·¯çº¿B:            è·¯çº¿C:
é‚®ç®±/å¯†ç           Google OAuth      GitHub OAuth
  â”‚                 â”‚                 â”‚
  â–¼                 â–¼                 â–¼
(è§ä¸‹æ–¹)          (è§ OAuth)        (è§ OAuth)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è·¯çº¿ A: é‚®ç®±/å¯†ç ç™»å½•
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æˆ·è¾“å…¥é‚®ç®± + å¯†ç  â†’ ç‚¹å‡» "Sign In"
  â”‚
  â–¼
æœ¬åœ°è¡¨å•éªŒè¯
  â”‚
  â”œâ”€ é‚®ç®±ä¸ä¸ºç©º
  â”œâ”€ å¯†ç ä¸ä¸ºç©º
  â””â”€ å¦‚æœéªŒè¯å¤±è´¥ â†’ æ˜¾ç¤ºé”™è¯¯ â†’ è¿”å›
  â”‚
  â–¼
è°ƒç”¨ Client è®¤è¯æ–¹æ³•
  â”‚
  â””â”€ authClient.signIn.email({
       email: 'user@example.com',
       password: 'password123'
     })
  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        (Server-side: /api/auth)   â”‚
                                   â”‚
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
1ï¸âƒ£ éªŒè¯é‚®ç®±æ˜¯å¦å­˜åœ¨
  â”‚
  â”œâ”€ SELECT * FROM user WHERE email = ?
  â”‚
  â”œâ”€ å¦‚æœä¸å­˜åœ¨ â†’ è¿”å›é”™è¯¯ "Email or password incorrect"
  â”‚  (ä¸è¦æš´éœ²ç”¨æˆ·ä¸å­˜åœ¨ä¿¡æ¯)
  â”‚
  â””â”€ å¦‚æœå­˜åœ¨ â†’ ç»§ç»­
  â”‚
  â–¼
2ï¸âƒ£ è·å–è´¦æˆ·å’Œå¯†ç å“ˆå¸Œ
  â”‚
  â”œâ”€ SELECT * FROM account WHERE userId = ? AND providerId = 'email'
  â”‚
  â”œâ”€ è·å– passwordHash
  â”‚
  â””â”€ ç»§ç»­
  â”‚
  â–¼
3ï¸âƒ£ éªŒè¯å¯†ç 
  â”‚
  â”œâ”€ await bcrypt.compare(inputPassword, storedHash)
  â”‚
  â”œâ”€ å¦‚æœä¸åŒ¹é… â†’ è¿”å›é”™è¯¯ "Email or password incorrect"
  â”‚
  â””â”€ å¦‚æœåŒ¹é… â†’ ç»§ç»­
  â”‚
  â–¼
4ï¸âƒ£ æ£€æŸ¥ç”¨æˆ·çŠ¶æ€
  â”‚
  â”œâ”€ ç”¨æˆ·æ˜¯å¦è¢«ç¦ç”¨? (user.banned)
  â”‚  â””â”€ å¦‚æœæ˜¯ â†’ è¿”å›é”™è¯¯ "User account has been banned"
  â”‚              æ˜¾ç¤ºç¦ç”¨åŸå› 
  â”‚
  â”œâ”€ é‚®ç®±æ˜¯å¦å·²éªŒè¯? (user.emailVerified)
  â”‚  â””â”€ å¦‚æœå¦ â†’ è¿”å›è­¦å‘Š "Please verify your email first"
  â”‚               æä¾›é‡æ–°å‘é€éªŒè¯é‚®ä»¶é€‰é¡¹
  â”‚
  â””â”€ å¦‚æœéƒ½é€šè¿‡ â†’ ç»§ç»­
  â”‚
  â–¼
5ï¸âƒ£ åˆ›å»ºä¼šè¯
  â”‚
  â”œâ”€ ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
  â”‚  â””â”€ const token = generateSecureToken()
  â”‚
  â”œâ”€ ä¿å­˜åˆ°æ•°æ®åº“
  â”‚  â””â”€ INSERT INTO session (
  â”‚       id, userId, token, expiresAt,
  â”‚       ipAddress, userAgent, createdAt
  â”‚     ) VALUES (...)
  â”‚
  â””â”€ ç»§ç»­
  â”‚
  â–¼
6ï¸âƒ£ è®¾ç½®è®¤è¯ Cookie
  â”‚
  â”œâ”€ Set-Cookie: betterAuth=<token>; Secure; HttpOnly; SameSite=Lax
  â”œâ”€ è¿‡æœŸæ—¶é—´: 7 å¤©
  â”‚
  â””â”€ ç»§ç»­
  â”‚
  â–¼
7ï¸âƒ£ è¿”å›æˆåŠŸå“åº”
  â”‚
  â””â”€ {
       success: true,
       user: {
         id, email, name, image, role
       }
     }
  â”‚
  (Return to Client)
  â”‚
  â–¼
æ›´æ–°å®¢æˆ·ç«¯ä¼šè¯çŠ¶æ€
  â”‚
  â”œâ”€ React Query ç¼“å­˜ç”¨æˆ·ä¿¡æ¯
  â”œâ”€ é¡µé¢é‡æ–°æ¸²æŸ“
  â”‚
  â””â”€ ç»§ç»­
  â”‚
  â–¼
é‡å®šå‘åˆ°ä»ªè¡¨æ¿
  â”‚
  â””â”€ window.location.href = '/dashboard'
  â”‚
  â–¼
âœ… ç™»å½•æˆåŠŸï¼


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è·¯çº¿ B & C: OAuth ç™»å½• (Google / GitHub)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç”¨æˆ·ç‚¹å‡» "Sign in with Google" / "Sign in with GitHub"
  â”‚
  â–¼
è§¦å‘ OAuth æµç¨‹
  â”‚
  â””â”€ authClient.signIn.social({
       provider: 'google', // æˆ– 'github'
       callbackURL: '/dashboard'
     })
  â”‚
  â–¼
é‡å®šå‘åˆ° OAuth æä¾›å•†
  â”‚
  â”œâ”€ https://accounts.google.com/o/oauth2/v2/auth?...
  â”‚  æˆ–
  â”‚  https://github.com/login/oauth/authorize?...
  â”‚
  â””â”€ ä¼ é€’å‚æ•°:
     â”œâ”€ client_id: åº”ç”¨ ID
     â”œâ”€ redirect_uri: http://app.com/api/auth/callback/google
     â”œâ”€ scope: ['email', 'profile']
     â””â”€ state: é˜² CSRF ä»¤ç‰Œ
  â”‚
  â–¼
ç”¨æˆ·åœ¨ OAuth æä¾›å•†å¤„æˆæƒ
  â”‚
  â”œâ”€ çœ‹åˆ°æƒé™è¯·æ±‚
  â”‚  â”œâ”€ è®¿é—®æ‚¨çš„ç”µå­é‚®ä»¶
  â”‚  â”œâ”€ è®¿é—®æ‚¨çš„ä¸ªäººèµ„æ–™
  â”‚  â””â”€ ...
  â”‚
  â”œâ”€ ç‚¹å‡» "Allow" / "æˆæƒ"
  â”‚
  â””â”€ è¿”å›åˆ°åº”ç”¨çš„ callback URL
  â”‚
  â–¼
OAuth Callback å¤„ç†
  â”‚
  â”œâ”€ URL: /api/auth/callback/google?code=xxx&state=yyy
  â”‚
  â””â”€ Better Auth è‡ªåŠ¨å¤„ç†
    â”‚
    â–¼
  1ï¸âƒ£ éªŒè¯ state ä»¤ç‰Œ (é˜² CSRF)
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  2ï¸âƒ£ ç”¨æˆæƒç äº¤æ¢è®¿é—®ä»¤ç‰Œ
    â”‚
    â”œâ”€ POST https://oauth2.googleapis.com/token
    â”‚  â”œâ”€ code: xxx
    â”‚  â”œâ”€ client_id: ...
    â”‚  â””â”€ client_secret: ...
    â”‚
    â”œâ”€ è·å¾—: accessToken, refreshToken, idToken
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  3ï¸âƒ£ è·å–ç”¨æˆ·ä¿¡æ¯
    â”‚
    â”œâ”€ ä½¿ç”¨ accessToken è°ƒç”¨ Google API
    â”‚  â””â”€ GET https://www.googleapis.com/oauth2/v2/userinfo
    â”‚
    â”œâ”€ è·å¾—: email, name, picture
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  4ï¸âƒ£ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
    â”‚
    â”œâ”€ SELECT * FROM user WHERE email = ?
    â”‚
    â”œâ”€ å¦‚æœå­˜åœ¨:
    â”‚  â”œâ”€ æ£€æŸ¥æ˜¯å¦æœ‰è¯¥ OAuth account
    â”‚  â”‚  â””â”€ SELECT * FROM account WHERE userId = ? AND providerId = 'google'
    â”‚  â”‚
    â”‚  â”œâ”€ å¦‚æœæ²¡æœ‰ account è®°å½•:
    â”‚  â”‚  â””â”€ åˆ›å»º account è®°å½• (OAuth è´¦å·å…³è”)
    â”‚  â”‚
    â”‚  â””â”€ è¿”å›æ—¢æœ‰ç”¨æˆ·
    â”‚
    â”œâ”€ å¦‚æœä¸å­˜åœ¨:
    â”‚  â”œâ”€ åˆ›å»ºæ–°ç”¨æˆ·
    â”‚  â”‚  â””â”€ INSERT INTO user (id, email, name, image, emailVerified=true, ...)
    â”‚  â”‚
    â”‚  â”œâ”€ åˆ›å»º account è®°å½•
    â”‚  â”‚  â””â”€ INSERT INTO account (userId, providerId='google', accountId, ...)
    â”‚  â”‚
    â”‚  â”œâ”€ åˆå§‹åŒ– userCredit
    â”‚  â”‚  â””â”€ INSERT INTO userCredit (userId, currentCredits=0)
    â”‚  â”‚
    â”‚  â”œâ”€ åˆ†é…æ³¨å†Œèµ é€
    â”‚  â”‚  â””â”€ INSERT INTO creditTransaction (type='REGISTER_GIFT', amount=50, ...)
    â”‚  â”‚
    â”‚  â”œâ”€ è‡ªåŠ¨è®¢é˜…é‚®ä»¶åˆ—è¡¨ (å¦‚æœå¯ç”¨)
    â”‚  â”‚
    â”‚  â””â”€ è¿”å›æ–°ç”¨æˆ·
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  5ï¸âƒ£ åˆ›å»ºä¼šè¯
    â”‚
    â”œâ”€ ç”Ÿæˆä»¤ç‰Œ
    â”‚
    â”œâ”€ INSERT INTO session (userId, token, expiresAt, ...)
    â”‚
    â””â”€ ç»§ç»­
    â”‚
    â–¼
  6ï¸âƒ£ è®¾ç½® Cookie
    â”‚
    â””â”€ Set-Cookie: betterAuth=<token>; ...
    â”‚
    â–¼
  7ï¸âƒ£ é‡å®šå‘å›åº”ç”¨
    â”‚
    â””â”€ redirect('/dashboard')
    â”‚
    â–¼
âœ… OAuth ç™»å½•æˆåŠŸï¼
  â”‚
  â””â”€ ç”¨æˆ·å·²åˆ›å»ºæˆ–å·²ç™»å½•ï¼Œæ˜¾ç¤ºä»ªè¡¨æ¿


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é”™è¯¯å¤„ç†
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®
   â†’ "é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®"
   â†’ ä¸è¦å‘Šè¯‰ç”¨æˆ·å“ªä¸ªå­—æ®µæœ‰é—®é¢˜

âŒ é‚®ç®±æœªéªŒè¯
   â†’ "è¯·å…ˆéªŒè¯æ‚¨çš„é‚®ç®±"
   â†’ "é‡æ–°å‘é€éªŒè¯é‚®ä»¶"

âŒ ç”¨æˆ·è¢«ç¦ç”¨
   â†’ "æ‚¨çš„è´¦æˆ·å·²è¢«ç¦ç”¨"
   â†’ "ç¦ç”¨åŸå› : {banReason}"
   â†’ "ç¦ç”¨æœ‰æ•ˆæœŸè‡³: {banExpires}"

âŒ OAuth å¤±è´¥
   â†’ "OAuth ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•"
   â†’ "è¯·å…è®¸åº”ç”¨è®¿é—®æ‚¨çš„ä¸ªäººèµ„æ–™"

âŒ ä¼šè¯åˆ›å»ºå¤±è´¥
   â†’ "ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•"

âŒ æœåŠ¡å™¨é”™è¯¯
   â†’ "æœåŠ¡å™¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•"
```

---

**å…³é”®å®‰å…¨ç‚¹**:
- å¯†ç æ€»æ˜¯å“ˆå¸Œå­˜å‚¨ï¼Œæ°¸ä¸æ˜æ–‡
- é”™è¯¯ä¿¡æ¯ä¸æš´éœ²å…·ä½“çš„ç”¨æˆ·å­˜åœ¨æƒ…å†µï¼ˆéƒ½è¯´"é‚®ç®±æˆ–å¯†ç é”™è¯¯"ï¼‰
- OAuth è¿‡ç¨‹ä¸­éªŒè¯ state ä»¤ç‰Œé˜²æ­¢ CSRF æ”»å‡»
- ä¼šè¯ Cookie ä½¿ç”¨ HttpOnly å’Œ Secure æ ‡å¿—
- é‚®ç®±éªŒè¯å’Œ OAuth éƒ½è‡ªåŠ¨æ¿€æ´»é‚®ç®±éªŒè¯çŠ¶æ€
