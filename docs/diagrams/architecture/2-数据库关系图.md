# 2. æ•°æ®åº“å…³ç³»å›¾ (Entity-Relationship Diagram)

## æ ¸å¿ƒè¡¨ç»“æ„å’Œå…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ğŸ—„ï¸ PostgreSQL æ•°æ®åº“ç»“æ„                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ğŸ‘¤ user              â”‚  (ç”¨æˆ·è¡¨ - æ ¸å¿ƒ)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PK â”‚ id: String               â”‚
â”‚    â”‚ email: String (UNIQUE)   â”‚
â”‚    â”‚ emailVerified: Boolean   â”‚
â”‚    â”‚ name: String             â”‚
â”‚    â”‚ image: String            â”‚
â”‚    â”‚ role: 'user'|'admin'     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    â”‚ banned: Boolean          â”‚           â”‚
â”‚    â”‚ banReason: String        â”‚           â”‚ è§’è‰²ç®¡ç†
â”‚    â”‚ banExpires: DateTime     â”‚           â”‚
â”‚    â”‚ customerId: String (FK)â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Stripe Customer ID
â”‚    â”‚ createdAt: DateTime      â”‚
â”‚    â”‚ updatedAt: DateTime      â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚ INDEX: id, email, role,      â”‚
â”‚        customerId, banned    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ (1 user : N sessions)
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    ğŸ”‘ session          â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ PK â”‚ id: String        â”‚
        â”‚ FK â”‚ userId: Stringâ—„â”€â”€â”€â”¼â”€ (references user.id)
        â”‚    â”‚ token: String     â”‚
        â”‚    â”‚ expiresAt: Date   â”‚
        â”‚    â”‚ ipAddress: String â”‚
        â”‚    â”‚ userAgent: String â”‚
        â”‚    â”‚ createdAt: Date   â”‚
        â”‚    â”‚ updatedAt: Date   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        INDEX: token, userId

             â”‚
             â”‚ (1 user : N accounts)
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    ğŸ”— account          â”‚  (OAuth æˆ– Password)
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ PK â”‚ id: String        â”‚
        â”‚ FK â”‚ userId: Stringâ—„â”€â”€â”€â”¼â”€ (references user.id)
        â”‚    â”‚ providerId: Stringâ”‚  'email'|'google'|'github'
        â”‚    â”‚ accountId: String â”‚  OAuth æä¾›å•†çš„è´¦æˆ· ID
        â”‚    â”‚ password: String  â”‚  ä»…ç”¨äº Email/Password (å“ˆå¸Œ)
        â”‚    â”‚ accessToken: Stringâ”‚ OAuth è®¿é—®ä»¤ç‰Œ
        â”‚    â”‚ refreshToken: Str â”‚  OAuth åˆ·æ–°ä»¤ç‰Œ
        â”‚    â”‚ scope: String     â”‚  OAuth æƒé™èŒƒå›´
        â”‚    â”‚ createdAt: Date   â”‚
        â”‚    â”‚ updatedAt: Date   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        INDEX: userId, providerId,
               accountId


             â”‚
             â”‚ (1 user : N payments)
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         ğŸ’³ payment                 â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ PK â”‚ id: String                    â”‚
        â”‚ FK â”‚ userId: Stringâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ (references user.id)
        â”‚    â”‚ customerId: Stringâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ (Stripe customer)
        â”‚    â”‚ priceId: String               â”‚  Stripe price ID
        â”‚    â”‚ type: 'subscription'|'one_time'
        â”‚    â”‚ scene: 'lifetime'|'subscription'|'credit'
        â”‚    â”‚ subscriptionId: String        â”‚  Stripe subscription ID
        â”‚    â”‚ sessionId: String             â”‚  Checkout session ID
        â”‚    â”‚ invoiceId: String             â”‚  Invoice ID
        â”‚    â”‚ status: 'pending'|'paid'|...  â”‚
        â”‚    â”‚ paid: Boolean                 â”‚
        â”‚    â”‚ interval: 'month'|'year'|null â”‚
        â”‚    â”‚ periodStart: DateTime         â”‚  è®¢é˜…å‘¨æœŸå¼€å§‹
        â”‚    â”‚ periodEnd: DateTime           â”‚  è®¢é˜…å‘¨æœŸç»“æŸ
        â”‚    â”‚ cancelAtPeriodEnd: Boolean    â”‚
        â”‚    â”‚ trialStart: DateTime          â”‚
        â”‚    â”‚ trialEnd: DateTime            â”‚
        â”‚    â”‚ createdAt: DateTime           â”‚
        â”‚    â”‚ updatedAt: DateTime           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        INDEX: userId, type, scene, status,
               subscriptionId, invoiceId,
               customerId


             â”‚
             â”‚ (1 user : 1 userCredit)
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      ğŸ’° userCredit             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ PK â”‚ id: String                â”‚
        â”‚ FK â”‚ userId: String (UNIQUE)â—„â”€â”€â”¼â”€ (references user.id)
        â”‚    â”‚ currentCredits: Integer   â”‚  å½“å‰å¯ç”¨ç§¯åˆ†
        â”‚    â”‚ lastRefreshAt: DateTime   â”‚  æœ€ååˆ·æ–°æ—¶é—´
        â”‚    â”‚ createdAt: DateTime       â”‚
        â”‚    â”‚ updatedAt: DateTime       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        INDEX: userId


             â”‚
             â”‚ (1 user : N creditTransactions)
             â”‚ (1 payment â†’ N creditTransactions)
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      ğŸ“ creditTransaction              â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚ PK â”‚ id: String                       â”‚
        â”‚ FK â”‚ userId: Stringâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€ (references user.id)
        â”‚ FK â”‚ paymentId: String                â”‚  (optional, references payment.id)
        â”‚    â”‚ type: ENUM                       â”‚
        â”‚    â”‚   - MONTHLY_REFRESH              â”‚
        â”‚    â”‚   - REGISTER_GIFT                â”‚
        â”‚    â”‚   - PURCHASE_PACKAGE             â”‚
        â”‚    â”‚   - SUBSCRIPTION_RENEWAL         â”‚
        â”‚    â”‚   - LIFETIME_MONTHLY             â”‚
        â”‚    â”‚   - USAGE                        â”‚
        â”‚    â”‚   - EXPIRE                       â”‚
        â”‚    â”‚                                  â”‚
        â”‚    â”‚ description: String              â”‚
        â”‚    â”‚ amount: Integer                  â”‚
        â”‚    â”‚   (+) è·å¾—ç§¯åˆ†                    â”‚
        â”‚    â”‚   (-) æ¶ˆè€—ç§¯åˆ†                    â”‚
        â”‚    â”‚                                  â”‚
        â”‚    â”‚ remainingAmount: Integer         â”‚
        â”‚    â”‚ expirationDate: DateTime         â”‚  null = æ°¸ä¸è¿‡æœŸ
        â”‚    â”‚ expirationDateProcessedAt: Date  â”‚
        â”‚    â”‚ createdAt: DateTime              â”‚
        â”‚    â”‚ updatedAt: DateTime              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        INDEX: userId, type, paymentId,
               expirationDate


å…¶ä»–è¡¨:
    â”œâ”€ verification (é‚®ä»¶éªŒè¯ä»¤ç‰Œ)
    â”‚  â”œâ”€ id (PK)
    â”‚  â”œâ”€ identifier (é‚®ç®±)
    â”‚  â”œâ”€ value (ä»¤ç‰Œ)
    â”‚  â””â”€ expiresAt
    â”‚
    â””â”€ twoFactor (å¤šå› ç´ è®¤è¯ - å¯é€‰)
       â”œâ”€ id (PK)
       â””â”€ ...
```

## è¡¨å…³ç³»å›¾ (ER å›¾)

```
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚    user     â”‚
                         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚             â”‚              â”‚
            (1:N) â”‚        (1:N)â”‚          (1:1)â”‚
                  â”‚             â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  session  â”‚  â”‚  account   â”‚  â”‚  userCredit    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                         (1:N)â”‚
                              â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚    payment      â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                         (1:N)â”‚
                              â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ creditTransaction   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å…³é”®çº¦æŸå’Œè§„åˆ™

### ç”¨æˆ·è¡¨ (user)
```
çº¦æŸ:
  â”œâ”€ email: UNIQUE, NOT NULL
  â”œâ”€ role: é»˜è®¤å€¼ 'user'
  â”œâ”€ customerId: å…³è” Stripe å®¢æˆ·
  â”‚  â””â”€ åŒä¸€ç”¨æˆ·åªèƒ½æœ‰ä¸€ä¸ª customerId
  â”‚
  â””â”€ ç¦ç”¨çŠ¶æ€ (Banning):
     â”œâ”€ banned: true/false
     â”œâ”€ banReason: ç¦ç”¨åŸå› 
     â””â”€ banExpires: ç¦ç”¨è¿‡æœŸæ—¶é—´ (å¦‚æœä¸º nullï¼Œåˆ™æ°¸ä¹…ç¦ç”¨)

è§¦å‘äº‹ä»¶:
  â”œâ”€ åˆ›å»ºç”¨æˆ·æ—¶ â†’ åˆ›å»º userCredit è®°å½•
  â”œâ”€ åˆ›å»ºç”¨æˆ·æ—¶ â†’ è‡ªåŠ¨è®¢é˜…é‚®ä»¶åˆ—è¡¨ (å¦‚æœå¯ç”¨)
  â””â”€ ç”¨æˆ·è¢«ç¦ç”¨ â†’ æ‰€æœ‰æ´»è·ƒä¼šè¯å¤±æ•ˆ
```

### æ”¯ä»˜è¡¨ (payment)
```
çº¦æŸ:
  â”œâ”€ type: 'subscription' | 'one_time'
  â”œâ”€ scene: 'lifetime' | 'subscription' | 'credit'
  â”‚
  â”œâ”€ åœºæ™¯å¯¹åº”:
  â”‚  â”œâ”€ type='subscription' + scene='subscription' â†’ æœˆ/å¹´è®¢é˜…
  â”‚  â”œâ”€ type='one_time' + scene='lifetime' â†’ ä¸€æ¬¡æ€§ç»ˆèº«ä»˜æ¬¾
  â”‚  â””â”€ type='one_time' + scene='credit' â†’ ä¸€æ¬¡æ€§ç§¯åˆ†è´­ä¹°
  â”‚
  â”œâ”€ priceId: Stripe ä»·æ ¼ ID (æ¥è‡ª website.tsx é…ç½®)
  â”‚  â”œâ”€ STRIPE_PRICE_PRO_MONTHLY
  â”‚  â”œâ”€ STRIPE_PRICE_PRO_YEARLY
  â”‚  â”œâ”€ STRIPE_PRICE_LIFETIME
  â”‚  â””â”€ STRIPE_PRICE_CREDIT_* (ç§¯åˆ†åŒ…)
  â”‚
  â”œâ”€ subscriptionId: ä»…å½“ type='subscription' æ—¶
  â”‚
  â””â”€ è®¢é˜…å‘¨æœŸ (ä»…å½“ type='subscription' æ—¶):
     â”œâ”€ periodStart: å‘¨æœŸå¼€å§‹æ—¥æœŸ
     â”œâ”€ periodEnd: å‘¨æœŸç»“æŸæ—¥æœŸ
     â”œâ”€ interval: 'month' | 'year'
     â””â”€ cancelAtPeriodEnd: åœ¨å‘¨æœŸæœ«å–æ¶ˆ

çŠ¶æ€è½¬å˜:
  pending â†’ paid â†’ (active/trial) â†’ canceled/expired
```

### ç§¯åˆ†è¡¨ (userCredit & creditTransaction)
```
userCredit:
  â”œâ”€ currentCredits: å½“å‰å®é™…å¯ç”¨ç§¯åˆ†
  â”‚  â””â”€ = âˆ‘(æ‰€æœ‰ amount) - âˆ‘(å·²è¿‡æœŸçš„ amount)
  â”‚
  â””â”€ lastRefreshAt: æœ€åä¸€æ¬¡è‡ªåŠ¨åˆ·æ–°æ—¶é—´
     â””â”€ ç”¨äºè¿½è¸ªæœˆåº¦åˆ·æ–°

creditTransaction:
  â”œâ”€ type å¯¹åº”çš„ä¸šåŠ¡:
  â”‚  â”œâ”€ REGISTER_GIFT: æ³¨å†Œæ—¶èµ é€ (e.g., +50)
  â”‚  â”œâ”€ MONTHLY_REFRESH: å…è´¹ç”¨æˆ·æœˆåº¦åˆ·æ–° (e.g., +50)
  â”‚  â”œâ”€ SUBSCRIPTION_RENEWAL: è®¢é˜…ç»­æœŸ (e.g., +1000)
  â”‚  â”œâ”€ LIFETIME_MONTHLY: ç»ˆèº«ç”¨æˆ·æœˆåº¦ (e.g., +1000)
  â”‚  â”œâ”€ PURCHASE_PACKAGE: ç”¨æˆ·è´­ä¹°ç§¯åˆ†åŒ… (e.g., +500)
  â”‚  â”œâ”€ USAGE: ç”¨æˆ·ä½¿ç”¨åŠŸèƒ½ (e.g., -50)
  â”‚  â””â”€ EXPIRE: ç§¯åˆ†è¿‡æœŸ (e.g., -50)
  â”‚
  â”œâ”€ expirationDate:
  â”‚  â”œâ”€ æ³¨å†Œèµ é€: 30 å¤©åè¿‡æœŸ
  â”‚  â”œâ”€ æœˆåº¦ç§¯åˆ†: 30 å¤©åè¿‡æœŸ
  â”‚  â”œâ”€ ç»ˆèº«ç§¯åˆ†: null (æ°¸ä¸è¿‡æœŸ)
  â”‚  â””â”€ è´­ä¹°ç§¯åˆ†: æ°¸ä¸è¿‡æœŸ (null)
  â”‚
  â””â”€ amount:
     â”œâ”€ æ­£æ•° (+50) = è·å¾—ç§¯åˆ†
     â”œâ”€ è´Ÿæ•° (-50) = æ¶ˆè€—æˆ–è¿‡æœŸ
     â””â”€ remainingAmount = æ­¤äº¤æ˜“åçš„ä½™é¢
```

## ç´¢å¼•ç­–ç•¥

```
é«˜é¢‘æŸ¥è¯¢ç´¢å¼•:
â”œâ”€ user
â”‚  â”œâ”€ PRIMARY KEY (id)
â”‚  â”œâ”€ UNIQUE (email)          # ç™»å½•æŸ¥è¯¢
â”‚  â”œâ”€ INDEX (customerId)      # Stripe webhook
â”‚  â”œâ”€ INDEX (role)            # æƒé™æ£€æŸ¥
â”‚  â””â”€ INDEX (banned)          # ç¦ç”¨çŠ¶æ€æ£€æŸ¥
â”‚
â”œâ”€ session
â”‚  â”œâ”€ PRIMARY KEY (id)
â”‚  â”œâ”€ UNIQUE (token)          # ä¼šè¯éªŒè¯
â”‚  â””â”€ INDEX (userId)          # ç”¨æˆ·æ‰€æœ‰ä¼šè¯
â”‚
â”œâ”€ payment
â”‚  â”œâ”€ PRIMARY KEY (id)
â”‚  â”œâ”€ INDEX (userId, createdAt)  # ç”¨æˆ·å†å²
â”‚  â”œâ”€ INDEX (subscriptionId)     # Stripe webhook
â”‚  â”œâ”€ INDEX (status)             # æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
â”‚  â””â”€ INDEX (scene)              # åœºæ™¯è¿‡æ»¤
â”‚
â”œâ”€ userCredit
â”‚  â”œâ”€ PRIMARY KEY (id)
â”‚  â””â”€ UNIQUE (userId)        # æŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†
â”‚
â””â”€ creditTransaction
   â”œâ”€ PRIMARY KEY (id)
   â”œâ”€ INDEX (userId, createdAt DESC)  # ç”¨æˆ·äº¤æ˜“å†å²
   â”œâ”€ INDEX (expirationDate)          # è¿‡æœŸå¤„ç†æŸ¥è¯¢
   â””â”€ INDEX (paymentId)               # å…³è”æ”¯ä»˜æŸ¥è¯¢
```

## äº‹åŠ¡å¤„ç†å…³é”®ç‚¹

```
åŸå­æ“ä½œ (Atomic):

1. æ‰£ç§¯åˆ†æ“ä½œ:
   BEGIN;
   SELECT currentCredits FROM userCredit WHERE userId = ? FOR UPDATE;
   IF currentCredits >= amount:
     INSERT INTO creditTransaction (...);
     UPDATE userCredit SET currentCredits = currentCredits - amount;
   ELSE:
     ROLLBACK; -- ä½™é¢ä¸è¶³
   COMMIT;

2. æ”¯ä»˜æˆåŠŸå¤„ç†:
   BEGIN;
   UPDATE payment SET status='paid' WHERE id=?;
   INSERT INTO creditTransaction (...);
   UPDATE userCredit SET currentCredits=...;
   COMMIT;
   -- å¦‚æœä»»ä½•æ­¥éª¤å¤±è´¥ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»š

3. ç§¯åˆ†è¿‡æœŸå¤„ç†:
   BEGIN;
   SELECT id, amount FROM creditTransaction
     WHERE expirationDate <= NOW() AND expirationDateProcessedAt IS NULL;
   FOR EACH transaction:
     INSERT INTO creditTransaction (type='EXPIRE', amount=-amount);
     UPDATE creditTransaction SET expirationDateProcessedAt=NOW();
   UPDATE userCredit SET currentCredits=...;
   COMMIT;
```

---

**å…³é”®è¦ç‚¹**:
- ç”¨æˆ·è¡¨æ˜¯æ‰€æœ‰æ•°æ®çš„æ ¸å¿ƒï¼Œæ‰€æœ‰å…¶ä»–è¡¨éƒ½é€šè¿‡ userId å…³è”
- æ”¯ä»˜å’Œç§¯åˆ†æ˜¯ç‹¬ç«‹ä½†ç›¸å…³çš„ç³»ç»Ÿï¼Œé€šè¿‡ paymentId å…³è”
- çº¦æŸå’Œç´¢å¼•ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’ŒæŸ¥è¯¢æ€§èƒ½
- æ‰€æœ‰è´§å¸å€¼å’Œç§¯åˆ†å€¼éƒ½ä½¿ç”¨æ•´æ•°ï¼ˆä»¥åˆ†ä¸ºå•ä½ï¼‰ï¼Œé¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
