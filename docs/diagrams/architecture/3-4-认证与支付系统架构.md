# 3-4. è®¤è¯ä¸æ”¯ä»˜ç³»ç»Ÿæ¶æ„

## 3. è®¤è¯ç³»ç»Ÿæ¶æ„ (Authentication Architecture)

### å®Œæ•´çš„è®¤è¯æµç¨‹ç³»ç»Ÿ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ğŸ” Better Auth è®¤è¯ç³»ç»Ÿ                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚   æµè§ˆå™¨å®¢æˆ·ç«¯     â”‚
                        â”‚ (Frontend App)    â”‚
                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚            â”‚            â”‚
              (Method 1)   (Method 2)   (Method 3)
              é‚®ç®±/å¯†ç       Google       GitHub
                    â”‚            â”‚            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
        â”‚ Sign In     â”‚  â”‚ OAuth   â”‚  â”‚ OAuth     â”‚
        â”‚ Form        â”‚  â”‚ Flow    â”‚  â”‚ Flow      â”‚
        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
               â”‚                â”‚           â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ Better Auth      â”‚
                        â”‚ API Endpoint     â”‚
                        â”‚ /api/auth/[...all]
                        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚                       â”‚
   (Route A)            (Route B)              (Route C)
   Email/Password       Google OAuth           GitHub OAuth
        â”‚                       â”‚                       â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ 1. éªŒè¯å‡­è¯ â”‚      â”‚ 1. é‡å®šå‘åˆ° â”‚       â”‚ 1. é‡å®šå‘åˆ° â”‚
   â”‚    emailPassâ”‚      â”‚    Google   â”‚       â”‚    GitHub   â”‚
   â”‚            â”‚      â”‚    OAuth    â”‚       â”‚    OAuth    â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ 2. æ•°æ®åº“æŸ¥ â”‚      â”‚ 2. ç”¨æˆ·æˆæƒ â”‚       â”‚ 2. ç”¨æˆ·æˆæƒ â”‚
   â”‚    è¯¢ç”¨æˆ·   â”‚      â”‚    å…è®¸è®¿é—® â”‚       â”‚    å…è®¸è®¿é—® â”‚
   â”‚    (account)â”‚      â”‚            â”‚       â”‚            â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                      â”‚                      â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ 3. éªŒè¯å¯†ç  â”‚      â”‚ 3. OAuth    â”‚       â”‚ 3. OAuth   â”‚
   â”‚    (hash    â”‚      â”‚    callback â”‚       â”‚    callbackâ”‚
   â”‚    compare) â”‚      â”‚    with codeâ”‚       â”‚    with code
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
        â”‚                      â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚ ç”¨æˆ·éªŒè¯æˆåŠŸ    â”‚
                        â”‚ (æˆ–åˆ›å»ºæ–°ç”¨æˆ·)  â”‚
                        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ åˆ›å»ºä¼šè¯ (Session)  â”‚
                    â”‚ ä¿å­˜åˆ°æ•°æ®åº“        â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚              â”‚              â”‚
       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
       â”‚ åˆ›å»ºä¼šè¯ â”‚  â”‚ ä¿å­˜ä¼šè¯ â”‚  â”‚ è®¾ç½®    â”‚
       â”‚ Cookie  â”‚  â”‚ åˆ°æ•°æ®åº“ â”‚  â”‚ Cookie  â”‚
       â”‚ (secure)â”‚  â”‚ (session â”‚  â”‚ (http- â”‚
       â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚  table)  â”‚  â”‚ only) â”‚
            â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
            â”‚                        â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ è¿”å›åˆ°å®¢æˆ·ç«¯    â”‚
                  â”‚ é‡å®šå‘åˆ°ä¸»é¡µ    â”‚
                  â”‚ (/dashboard)    â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Better Auth é…ç½®è¯¦è§£

```
src/lib/auth.ts é…ç½®:

export const auth = betterAuth({
  database: {
    provider: 'postgres',        // PostgreSQL æ•°æ®åº“
    url: process.env.DATABASE_URL // æ•°æ®åº“è¿æ¥ä¸²
  },

  plugins: [
    admin({                       // ç®¡ç†å‘˜æ’ä»¶
      impersonationSessionDuration: 24 * 60 * 60  // 24å°æ—¶
    })
  ],

  providers: [
    google({
      clientId: process.env.GOOGLE_CLIENT_ID,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET,
      allowDangerousEmailAccountLinking: false
    }),
    github({
      clientId: process.env.GITHUB_CLIENT_ID,
      clientSecret: process.env.GITHUB_CLIENT_SECRET
    })
  ],

  emailAndPassword: {
    enabled: true,               // å¯ç”¨é‚®ç®±/å¯†ç ç™»å½•
    minPasswordLength: 8,
    // é‚®ä»¶éªŒè¯é…ç½®
    sendResetPassword: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        template: 'resetPassword',
        context: { resetLink: url }
      })
    }
  },

  emailVerification: {
    sendVerificationEmail: async ({ user, url }) => {
      await sendEmail({
        to: user.email,
        template: 'verifyEmail',
        context: { verificationLink: url }
      })
    }
  },

  hooks: {
    after: [
      {
        matcher: (context) => context.path === '/sign-up/email',
        handler: async (context) => {
          // ç”¨æˆ·æ³¨å†Œåçš„é’©å­
          const { user } = context.data

          // 1. è‡ªåŠ¨åˆ›å»º userCredit è®°å½•
          await db.insert(userCredit).values({
            userId: user.id,
            currentCredits: 0
          })

          // 2. åˆ†é…æ³¨å†Œèµ é€
          await creditTransaction.create({
            userId: user.id,
            type: 'REGISTER_GIFT',
            amount: 50,
            expirationDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000)
          })

          // 3. è‡ªåŠ¨è®¢é˜…é‚®ä»¶åˆ—è¡¨ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if (config.newsletter.autoSubscribeAfterSignUp) {
            await newsletterSubscribe({ email: user.email })
          }
        }
      }
    ]
  },

  session: {
    expiresIn: 60 * 60 * 24 * 7,   // 7 å¤©è¿‡æœŸ
    updateAge: 60 * 60 * 24         // æ¯å¤©æ›´æ–°
  },

  advanced: {
    useSecureCookies: true,        // HTTPS ç”Ÿäº§ç¯å¢ƒ
    disableCSRFProtection: false   // å¯ç”¨ CSRF ä¿æŠ¤
  }
})
```

### è®¤è¯å®¢æˆ·ç«¯ (Client-side)

```
src/lib/auth-client.ts:

export const authClient = createAuthClient({
  baseURL: process.env.NEXT_PUBLIC_APP_URL,
  plugins: [
    inferAdditionalFields()  // æ¨æ–­é¢å¤–å­—æ®µ
  ]
})

// ä½¿ç”¨æ–¹å¼:

// 1. ç™»å½•
const { data, error } = await authClient.signIn.email({
  email: 'user@example.com',
  password: 'password123'
})

// 2. æ³¨å†Œ
const { data, error } = await authClient.signUp.email({
  email: 'user@example.com',
  password: 'password123',
  name: 'User Name'
})

// 3. ç¤¾äº¤ç™»å½•
const { data, error } = await authClient.signIn.social({
  provider: 'google', // 'google' | 'github'
  callbackURL: '/dashboard'
})

// 4. è·å–ä¼šè¯
const { data: session } = await authClient.getSession()

// 5. ç™»å‡º
await authClient.signOut()

// 6. é‡ç½®å¯†ç 
await authClient.resetPassword({
  email: 'user@example.com'
})

// 7. Hook æ–¹å¼ (React)
const { data: session } = useSession()
const { signOut } = useAuthActions()
```

### ä¼šè¯éªŒè¯ä¸­é—´ä»¶

```
src/middleware.ts:

export const middleware = async (request: NextRequest) => {
  const pathname = request.nextUrl.pathname

  // è·å–ä¼šè¯
  const session = await auth.api.getSession({
    headers: request.headers
  })

  // å—ä¿æŠ¤è·¯ç”±æ£€æŸ¥
  if (pathname.startsWith('/protected') || pathname.startsWith('/dashboard')) {
    if (!session?.user) {
      // é‡å®šå‘åˆ°ç™»å½•é¡µ
      return NextResponse.redirect(
        new URL(`/auth/login?callbackUrl=${pathname}`, request.url)
      )
    }

    // æ£€æŸ¥ç¦ç”¨çŠ¶æ€
    if (session.user.banned) {
      return NextResponse.redirect(new URL('/auth/error?error=banned', request.url))
    }
  }

  // ç®¡ç†å‘˜è·¯ç”±æ£€æŸ¥
  if (pathname.startsWith('/admin')) {
    if (session?.user?.role !== 'admin') {
      return NextResponse.redirect(new URL('/', request.url))
    }
  }

  return NextResponse.next()
}

export const config = {
  matcher: ['/dashboard/:path*', '/admin/:path*', '/settings/:path*']
}
```

---

## 4. æ”¯ä»˜ç³»ç»Ÿæ¶æ„ (Payment Architecture)

### Stripe é›†æˆæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ğŸ’³ Stripe æ”¯ä»˜ç³»ç»Ÿæµç¨‹                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å®¢æˆ·ç«¯                          æœåŠ¡å™¨                         Stripe
   â”‚                              â”‚                             â”‚
   â”‚ ç”¨æˆ·ç‚¹å‡»"å‡çº§"               â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚                              â”‚                             â”‚
   â”‚                    1. createCheckoutSession()              â”‚
   â”‚                              â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                              â”‚ å‚æ•°:                        â”‚
   â”‚                              â”‚ â”œâ”€ customerId               â”‚
   â”‚                              â”‚ â”œâ”€ priceId                 â”‚
   â”‚                              â”‚ â”œâ”€ successUrl              â”‚
   â”‚                              â”‚ â””â”€ cancelUrl               â”‚
   â”‚                              â”‚                             â”‚
   â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                              â”‚ è¿”å›:                        â”‚
   â”‚                              â”‚ â””â”€ checkoutSession.url      â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 2. é‡å®šå‘åˆ° Stripe Checkout  â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 3. ç”¨æˆ·è¾“å…¥å¡ç‰‡ä¿¡æ¯           â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
   â”‚                              â”‚                             â”‚
   â”‚ 4. Stripe å¤„ç†æ”¯ä»˜            â”‚                             â”‚
   â”‚                              â”‚                    æ”¯ä»˜æˆåŠŸ  â”‚
   â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                              â”‚ event:                      â”‚
   â”‚                              â”‚ checkout.session.completed  â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 5. Webhook é€šçŸ¥              â”‚                             â”‚
   â”‚                              â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
   â”‚                          Webhook                           â”‚
   â”‚                          Listener                          â”‚
   â”‚                              â”‚                             â”‚
   â”‚                     6. éªŒè¯ Webhook                        â”‚
   â”‚                     (éªŒè¯ç­¾å)                              â”‚
   â”‚                              â”‚                             â”‚
   â”‚                     7. å¤„ç†æ”¯ä»˜å®Œæˆäº‹ä»¶                     â”‚
   â”‚                        (è§ä¸‹æ–¹)                             â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 6. é‡å®šå‘å›åº”ç”¨               â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚ /payment?session_id=...      â”‚                             â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 7. æ£€æŸ¥æ”¯ä»˜çŠ¶æ€               â”‚                             â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                             â”‚
   â”‚  checkPaymentCompletion()    â”‚                             â”‚
   â”‚                              â”‚                             â”‚
   â”‚ 8. æ”¯ä»˜æˆåŠŸï¼                 â”‚                             â”‚
   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                             â”‚
   â”‚ é‡å®šå‘åˆ° /dashboard          â”‚                             â”‚
```

### Stripe æ”¯ä»˜å·¥ä½œæµ

```
æ”¯ä»˜åœºæ™¯ A: Pro æœˆåº¦è®¢é˜… ($9.99/æœˆ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. åˆ›å»º Checkout Session
   â”œâ”€ priceId: STRIPE_PRICE_PRO_MONTHLY
   â”œâ”€ scene: 'subscription'
   â”œâ”€ type: 'subscription'
   â””â”€ subscription metadata: { plan: 'pro-monthly' }

2. æ”¯ä»˜å®Œæˆäº‹ä»¶ (checkout.session.completed)
   â”œâ”€ åˆ›å»º payment è®°å½•
   â”‚  â”œâ”€ status: 'paid'
   â”‚  â”œâ”€ subscriptionId: sub_123...
   â”‚  â”œâ”€ interval: 'month'
   â”‚  â””â”€ periodStart/End: è‡ªåŠ¨è®¾ç½®
   â”‚
   â””â”€ åˆ†é…ç§¯åˆ†
      â”œâ”€ åˆ›å»º creditTransaction
      â”‚  â”œâ”€ type: 'SUBSCRIPTION_RENEWAL'
      â”‚  â”œâ”€ amount: +1000
      â”‚  â””â”€ expirationDate: 30 å¤©å
      â”‚
      â””â”€ æ›´æ–° userCredit.currentCredits

3. å®šæœŸç»­æœŸ (invoice.payment_succeeded)
   â”œâ”€ è‡ªåŠ¨æ›´æ–° periodStart/End
   â”œâ”€ è‡ªåŠ¨åˆ†é…æ–°çš„ç§¯åˆ†
   â””â”€ å‘é€ç»­æœŸé€šçŸ¥é‚®ä»¶

4. å–æ¶ˆè®¢é˜… (customer.subscription.deleted)
   â”œâ”€ æ›´æ–° payment.status: 'canceled'
   â”œâ”€ ç”¨æˆ·é™çº§åˆ° Free è®¡åˆ’
   â””â”€ æœªä½¿ç”¨çš„ç§¯åˆ†ç»§ç»­ä¿ç•™


æ”¯ä»˜åœºæ™¯ B: ç»ˆèº«è®¡åˆ’ ($199 ä¸€æ¬¡æ€§)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. åˆ›å»º Checkout Session
   â”œâ”€ priceId: STRIPE_PRICE_LIFETIME
   â”œâ”€ scene: 'lifetime'
   â”œâ”€ type: 'one_time'
   â””â”€ éé‡å¤è´­ä¹°æ£€æŸ¥: å¦‚æœå·²æœ‰ç»ˆèº«ï¼Œæ‹’ç»

2. æ”¯ä»˜å®Œæˆäº‹ä»¶ (checkout.session.completed)
   â”œâ”€ åˆ›å»º payment è®°å½•
   â”‚  â”œâ”€ status: 'paid'
   â”‚  â”œâ”€ subscriptionId: null
   â”‚  â””â”€ interval: null
   â”‚
   â””â”€ åˆ†é…ç§¯åˆ†
      â”œâ”€ åˆ›å»º creditTransaction
      â”‚  â”œâ”€ type: 'LIFETIME_MONTHLY'
      â”‚  â”œâ”€ amount: +1000
      â”‚  â””â”€ expirationDate: null (æ°¸ä¸è¿‡æœŸ)
      â”‚
      â””â”€ æ›´æ–° userCredit.currentCredits

3. æœˆåº¦è‡ªåŠ¨ç§¯åˆ† (æ¯æœˆå¤„ç†ä¸€æ¬¡)
   â”œâ”€ æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç»ˆèº«è®¡åˆ’
   â”œâ”€ åˆ›å»ºæ–°çš„ creditTransaction
   â”‚  â”œâ”€ type: 'LIFETIME_MONTHLY'
   â”‚  â”œâ”€ amount: +1000
   â”‚  â””â”€ expirationDate: null
   â”‚
   â””â”€ æ›´æ–° userCredit.currentCredits


æ”¯ä»˜åœºæ™¯ C: ç§¯åˆ†åŒ…è´­ä¹° ($9.99 â†’ +500 ç§¯åˆ†)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. åˆ›å»º Checkout Session
   â”œâ”€ priceId: STRIPE_PRICE_CREDIT_500
   â”œâ”€ scene: 'credit'
   â”œâ”€ type: 'one_time'
   â””â”€ åŒ…å¤§å°: 500 ç§¯åˆ†

2. æ”¯ä»˜å®Œæˆäº‹ä»¶ (checkout.session.completed)
   â”œâ”€ åˆ›å»º payment è®°å½•
   â”‚  â”œâ”€ status: 'paid'
   â”‚  â”œâ”€ scene: 'credit'
   â”‚  â””â”€ subscriptionId: null
   â”‚
   â””â”€ åˆ†é…ç§¯åˆ†
      â”œâ”€ åˆ›å»º creditTransaction
      â”‚  â”œâ”€ type: 'PURCHASE_PACKAGE'
      â”‚  â”œâ”€ amount: +500
      â”‚  â””â”€ expirationDate: null (ä¸è¿‡æœŸ)
      â”‚
      â””â”€ æ›´æ–° userCredit.currentCredits
```

### Stripe Webhook å¤„ç†

```
src/app/api/webhooks/stripe/route.ts:

export async function POST(request: Request) {
  const signature = request.headers.get('stripe-signature')
  const body = await request.text()

  // éªŒè¯ webhook ç­¾å
  let event: Stripe.Event
  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    )
  } catch (err) {
    return NextResponse.json({ error: 'Invalid signature' }, { status: 400 })
  }

  // å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹
  switch (event.type) {
    case 'checkout.session.completed': {
      const session = event.data.object as Stripe.Checkout.Session

      // æŸ¥æ‰¾æ”¯ä»˜è®°å½•
      const payment = await db.query.payment.findFirst({
        where: eq(paymentTable.sessionId, session.id)
      })

      if (!payment) {
        // é¦–æ¬¡å®Œæˆï¼Œéœ€è¦åˆ›å»ºè®°å½•
        await handleCheckoutSessionCompleted(session)
      }
      break
    }

    case 'invoice.payment_succeeded': {
      const invoice = event.data.object as Stripe.Invoice
      // å¤„ç†è®¢é˜…ç»­æœŸ
      await handleInvoicePaymentSucceeded(invoice)
      break
    }

    case 'customer.subscription.deleted': {
      const subscription = event.data.object as Stripe.Subscription
      // å¤„ç†å–æ¶ˆè®¢é˜…
      await handleSubscriptionDeleted(subscription)
      break
    }

    case 'customer.subscription.updated': {
      const subscription = event.data.object as Stripe.Subscription
      // å¤„ç†è®¢é˜…æ›´æ–°
      await handleSubscriptionUpdated(subscription)
      break
    }

    default:
      console.log(`Unhandled event type: ${event.type}`)
  }

  return NextResponse.json({ received: true })
}
```

### æ”¯ä»˜ Server Action

```
src/actions/create-checkout-session.ts:

export const createCheckoutSessionAction = userActionClient
  .schema(z.object({
    priceId: z.string(),
    redirectUrl: z.string().optional()
  }))
  .action(async ({ parsedInput: { priceId, redirectUrl }, ctx }) => {
    // 1. éªŒè¯ç”¨æˆ·
    const user = ctx.user
    if (!user?.email) throw new Error('User not authenticated')

    // 2. è·å–æˆ–åˆ›å»º Stripe Customer
    let customerId = user.customerId
    if (!customerId) {
      const customer = await stripe.customers.create({
        email: user.email,
        name: user.name
      })
      customerId = customer.id

      // ä¿å­˜ customerId åˆ°æ•°æ®åº“
      await db.update(userTable)
        .set({ customerId })
        .where(eq(userTable.id, user.id))
    }

    // 3. æ£€æŸ¥é‡å¤è´­ä¹° (ä»…é™ç»ˆèº«è®¡åˆ’)
    const plan = getAllPricePlans().find(p => p.priceId === priceId)
    if (plan?.type === 'one_time' && plan.scene === 'lifetime') {
      const existing = await db.query.payment.findFirst({
        where: and(
          eq(paymentTable.userId, user.id),
          eq(paymentTable.scene, 'lifetime')
        )
      })
      if (existing) {
        throw new Error('User already has lifetime plan')
      }
    }

    // 4. åˆ›å»º Checkout Session
    const session = await stripe.checkout.sessions.create({
      customer: customerId,
      payment_method_types: ['card'],
      mode: plan?.type === 'subscription' ? 'subscription' : 'payment',
      line_items: [
        {
          price: priceId,
          quantity: 1
        }
      ],
      success_url: redirectUrl || `${process.env.NEXT_PUBLIC_APP_URL}/dashboard`,
      cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/pricing`,
      billing_address_collection: 'auto',
      customer_email: user.email
    })

    // 5. ä¿å­˜åˆ°æ•°æ®åº“ (å¾…æ”¯ä»˜)
    await db.insert(paymentTable).values({
      userId: user.id,
      customerId,
      priceId,
      type: plan?.type,
      scene: plan?.scene,
      sessionId: session.id,
      status: 'pending'
    })

    return { redirectUrl: session.url }
  })
```

---

**å…³é”®è¦ç‚¹**:
- Better Auth å¤„ç†ç”¨æˆ·è®¤è¯ï¼Œæ”¯æŒé‚®ç®±/å¯†ç å’Œ OAuth
- Stripe å¤„ç†æ‰€æœ‰æ”¯ä»˜å¤„ç†ï¼Œé€šè¿‡ Webhook å¼‚æ­¥é€šçŸ¥
- æ”¯ä»˜æµç¨‹åˆ†ä¸ºä¸‰ä¸ªåœºæ™¯ï¼šè®¢é˜…ã€ç»ˆèº«ã€ç§¯åˆ†åŒ…
- æ‰€æœ‰å…³é”®æ“ä½œéƒ½åœ¨ Server Action ä¸­å®Œæˆï¼Œç¡®ä¿å®‰å…¨æ€§
