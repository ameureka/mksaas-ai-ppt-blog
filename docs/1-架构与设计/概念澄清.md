# æ¦‚å¿µæ¾„æ¸…

å¯¹ mk-saas-blog ä¸­ä½¿ç”¨çš„æ ¸å¿ƒæ¦‚å¿µã€æœ¯è¯­å’ŒæŠ€æœ¯çš„æ·±å…¥è§£é‡Šã€‚

---

## ğŸ“Œ æ ¸å¿ƒæŠ€æœ¯æ¦‚å¿µ

### Server Actions

**å®šä¹‰:** åœ¨ Next.js ä¸­å®šä¹‰çš„æœåŠ¡å™¨ç«¯å‡½æ•°ï¼Œå¯ä»¥ä»å®¢æˆ·ç«¯ç›´æ¥è°ƒç”¨ï¼Œæ— éœ€åˆ›å»º API ç«¯ç‚¹ã€‚

```typescript
'use server'

export async function updateUserName(newName: string) {
  // è¿™æ®µä»£ç åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
  const session = await auth()
  await db.update(user).set({ name: newName }).where(eq(user.id, session.user.id))
}

// åœ¨å®¢æˆ·ç«¯è°ƒç”¨
'use client'
export function UserForm() {
  const handleSubmit = async () => {
    await updateUserName('æ–°åå­—') // è‡ªåŠ¨å‘é€åˆ°æœåŠ¡å™¨
  }
}
```

**å…³é”®ç‰¹æ€§:**
- âœ… è‡ªåŠ¨ CSRF é˜²æŠ¤
- âœ… ç±»å‹å®‰å…¨
- âœ… è‡ªåŠ¨åºåˆ—åŒ–/ååºåˆ—åŒ–
- âœ… é”™è¯¯å¤„ç†
- âŒ ä¸èƒ½æš´éœ²ä¸ºå…¬å¼€ API

**æœ€ä½³å®è·µ:**
1. å§‹ç»ˆåœ¨ `'use server'` directive ä¸­å®šä¹‰
2. éªŒè¯å’Œæˆæƒå¿…ä¸å¯å°‘
3. ä¸è¦åœ¨ Server Action ä¸­å¤„ç†å¯†é’¥
4. è¿”å›åºåˆ—åŒ–å‹å¥½çš„æ•°æ®

---

### Server Components vs Client Components

| ç‰¹æ€§ | Server Component | Client Component |
|------|-----------------|-----------------|
| å®šä¹‰ | é»˜è®¤ | `'use client'` directive |
| æ‰§è¡Œä½ç½® | æœåŠ¡å™¨ | æµè§ˆå™¨ |
| è®¿é—®æ•°æ®åº“ | âœ… ç›´æ¥è®¿é—® | âŒ é€šè¿‡ API |
| ä½¿ç”¨ hooks | âŒ ä»… `use` | âœ… æ‰€æœ‰ hooks |
| è®¿é—®å¯†é’¥ | âœ… å®‰å…¨ | âŒ æš´éœ²äºæµè§ˆå™¨ |
| åŒ…å¤§å° | âœ… é›¶ JS | âŒ åŒ…å«åœ¨ bundle |
| çŠ¶æ€ç®¡ç† | âŒ æ— çŠ¶æ€ | âœ… useState, Zustand |

```typescript
// Server Component (é»˜è®¤)
async function ProductList() {
  const products = await db.query.product.findMany()
  return <div>{products.map(p => <Product key={p.id} {...p} />)}</div>
}

// Client Component
'use client'
function ProductCart({ products }: { products: Product[] }) {
  const [items, setItems] = useState<Product[]>([])
  return <div>...</div>
}
```

**é€‰æ‹©æŒ‡å—:**
- éœ€è¦æ•°æ®åº“è®¿é—®? â†’ Server Component
- éœ€è¦äº¤äº’? â†’ Client Component
- éœ€è¦å¯†é’¥? â†’ Server Component
- éœ€è¦ React hooks? â†’ Client Component

---

### Next.js App Router

**å®šä¹‰:** Next.js 15 çš„æ–°è·¯ç”±ç³»ç»Ÿï¼ŒåŸºäºæ–‡ä»¶ç³»ç»Ÿçš„è·¯ç”±ï¼Œæ”¯æŒåµŒå¥—å¸ƒå±€å’Œå¹¶è¡Œè·¯ç”±ã€‚

```
src/app/
â”œâ”€â”€ layout.tsx              # æ ¹å¸ƒå±€
â”œâ”€â”€ page.tsx                # / é¡µé¢
â”œâ”€â”€ dashboard/
â”‚   â”œâ”€â”€ layout.tsx          # /dashboard å¸ƒå±€
â”‚   â”œâ”€â”€ page.tsx            # /dashboard é¡µé¢
â”‚   â””â”€â”€ settings/
â”‚       â”œâ”€â”€ layout.tsx      # /dashboard/settings å¸ƒå±€
â”‚       â””â”€â”€ page.tsx        # /dashboard/settings é¡µé¢
â””â”€â”€ blog/
    â”œâ”€â”€ page.tsx            # /blog é¡µé¢
    â”œâ”€â”€ [slug]/
    â”‚   â””â”€â”€ page.tsx        # /blog/my-post (åŠ¨æ€è·¯ç”±)
    â””â”€â”€ [...slug]/
        â””â”€â”€ page.tsx        # /blog/2024/11/my-post (catch-all)
```

**å…³é”®ç‰¹æ€§:**
- åŸºäºæ–‡ä»¶ç³»ç»Ÿ (ç›´è§‚)
- åµŒå¥—å¸ƒå±€ (DRY)
- ç‰¹æ®Šæ–‡ä»¶: `layout.tsx`, `page.tsx`, `error.tsx`, `not-found.tsx`
- åŠ¨æ€è·¯ç”±: `[id]`, `[...slug]`
- å¹¶è¡Œè·¯ç”±: `@slot`

---

### Drizzle ORM

**å®šä¹‰:** ç±»å‹å®‰å…¨çš„ ORMï¼Œç”Ÿæˆ SQLï¼Œç”¨äº TypeScript å¼€å‘è€…ã€‚

```typescript
// 1. å®šä¹‰ Schema
const user = pgTable('user', {
  id: text('id').primaryKey(),
  email: text('email').notNull(),
})

// 2. æ¨å¯¼ç±»å‹
type User = typeof user.$inferSelect
type NewUser = typeof user.$inferInsert

// 3. æ‰§è¡ŒæŸ¥è¯¢
const users: User[] = await db.select().from(user)
const created: User = (await db.insert(user).values(newData))[0]

// 4. è¿”å›ç±»å‹å®‰å…¨çš„ç»“æœ
```

**vs Prisma:**
| ç‰¹æ€§ | Drizzle | Prisma |
|------|---------|--------|
| è¿è¡Œæ—¶ | æ—  | æœ‰ | ç”Ÿæˆçš„ SQL | å¯è§ä¸”ä¼˜åŒ– | æŠ½è±¡ |
| æŸ¥è¯¢æ–¹å¼ | SQL/ORM æ··ç”¨ | ORM é£æ ¼ |
| æ–‡ä»¶å¤§å° | å° | å¤§ |
| æ€§èƒ½ | ä¼˜ç§€ | è‰¯å¥½ |
| å­¦ä¹ æ›²çº¿ | é™¡å³­ | å¹³ç¼“ |

---

### Better Auth

**å®šä¹‰:** ç°ä»£åŒ–çš„èº«ä»½éªŒè¯åº“ï¼Œæ”¯æŒå¤šç§è®¤è¯ç­–ç•¥ï¼Œæ— éœ€æ•°æ®åº“è¿ç§»ã€‚

```typescript
// åŸºæœ¬è®¾ç½®
export const auth = betterAuth({
  database: {
    db: drizzleClient, // PostgreSQL
  },
  socialProviders: {
    google: {
      clientId: process.env.AUTH_GOOGLE_ID,
      clientSecret: process.env.AUTH_GOOGLE_SECRET,
    },
    github: {
      clientId: process.env.AUTH_GITHUB_ID,
      clientSecret: process.env.AUTH_GITHUB_SECRET,
    },
  },
  plugins: [
    admin(), // ç®¡ç†å‘˜åŠŸèƒ½
  ],
})

// è·å–ä¼šè¯
const session = await auth.api.getSession({ headers: request.headers })

// OAuth ç™»å½•
const { url } = await auth.api.signInSocial({
  provider: 'google',
  redirect: '/dashboard',
})
```

**è®¤è¯æµç¨‹:**
1. ç”¨æˆ·ç‚¹å‡»"ç”¨ Google ç™»å½•"
2. é‡å®šå‘åˆ° Google OAuth é¡µé¢
3. ç”¨æˆ·æˆæƒ
4. è¿”å› auth code
5. Better Auth äº¤æ¢ token
6. åˆ›å»º/æ›´æ–°ç”¨æˆ·
7. åˆ›å»º session

---

### Zustand

**å®šä¹‰:** è½»é‡çº§çš„çŠ¶æ€ç®¡ç†åº“ï¼Œç”¨äºå®¢æˆ·ç«¯ UI çŠ¶æ€ç®¡ç†ã€‚

```typescript
'use client'

import { create } from 'zustand'

// å®šä¹‰ store
interface UIStore {
  sidebarOpen: boolean
  toggleSidebar: () => void
  setTheme: (theme: 'light' | 'dark') => void
  theme: 'light' | 'dark'
}

export const useUIStore = create<UIStore>((set) => ({
  sidebarOpen: true,
  theme: 'light',
  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
  setTheme: (theme) => set({ theme }),
}))

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export function Sidebar() {
  const { sidebarOpen, toggleSidebar } = useUIStore()
  return (
    <aside className={sidebarOpen ? 'block' : 'hidden'}>
      <button onClick={toggleSidebar}>æ”¶èµ·</button>
    </aside>
  )
}
```

**vs Redux:**
| ç‰¹æ€§ | Zustand | Redux |
|------|---------|-------|
| åŒ…å¤§å° | ~900B | ~12KB |
| å­¦ä¹ æ›²çº¿ | ç®€å• | å¤æ‚ |
| æ ·æ¿ä»£ç  | å°‘ | å¤š |
| å¼‚æ­¥å¤„ç† | ç®€å• | ä¸­é—´ä»¶ |
| DevTools | åŸºç¡€ | å®Œæ•´ |

---

## ğŸ” å®‰å…¨æ¦‚å¿µ

### CSRF é˜²æŠ¤

**é—®é¢˜:**
```
æ”»å‡»è€…ç½‘ç«™
  â†“
è¯±å¯¼ç”¨æˆ·è®¿é—®
  â†“
åœ¨åå°å‘ä½ çš„ç½‘ç«™å‘é€è¯·æ±‚
  â†“
ä½¿ç”¨ç”¨æˆ·çš„ cookieï¼Œå†’å……ç”¨æˆ·æ“ä½œ
```

**è§£å†³æ–¹æ¡ˆ:**
```
Server Action è‡ªåŠ¨æ·»åŠ  CSRF token
æ¯ä¸ªè¡¨å•éƒ½æœ‰éšè—çš„ token
æäº¤æ—¶éªŒè¯ token
åªæœ‰åŒ¹é…çš„è¯·æ±‚æ‰è¢«æ¥å—
```

---

### ä¼šè¯ç®¡ç†

```typescript
// åˆ›å»ºä¼šè¯
const session = await auth.api.createSession({
  userId: user.id,
})

// éªŒè¯ä¼šè¯
const session = await auth.api.getSession({ headers: request.headers })

// åˆ é™¤ä¼šè¯ (ç™»å‡º)
await auth.api.signOut()

// ä¼šè¯å­˜å‚¨åœ¨ Cookie ä¸­
// å±æ€§: Secure (HTTPS), HttpOnly (JS æ— æ³•è®¿é—®), SameSite=Strict
```

---

### æƒé™æ£€æŸ¥ä¸‰å±‚

```
Layer 1: èº«ä»½éªŒè¯ (Authentication)
  â†“ ä½ æ˜¯è°?
const session = await auth()
if (!session) throw new Error('æœªç™»å½•')

Layer 2: èµ„æºæ‰€æœ‰æƒ (Resource Ownership)
  â†“ è¿™æ˜¯ä½ çš„èµ„æºå—?
const resource = await db.query.post.findFirst({
  where: eq(post.id, postId),
})
if (resource.userId !== session.user.id) throw new Error('æ— æƒé™')

Layer 3: è§’è‰²/æƒé™ (Role-based Authorization)
  â†“ ä½ æœ‰æƒé™æ‰§è¡Œæ­¤æ“ä½œå—?
if (session.user.role !== 'admin') throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™')
```

---

## ğŸ”„ æ•°æ®æµæ¦‚å¿µ

### æŸ¥è¯¢æµ (Fetching Data)

```
Component æŒ‚è½½
  â†“
React Query useQuery hook
  â†“
è°ƒç”¨ Server Action
  â†“
Server Action æŸ¥è¯¢æ•°æ®åº“
  â†“
è¿”å›æ•°æ®ç»™ React Query
  â†“
ç¼“å­˜ç»“æœ
  â†“
ç»„ä»¶é‡æ–°æ¸²æŸ“
  â†“
æ˜¾ç¤ºæ•°æ®
```

### å˜æ›´æµ (Modifying Data)

```
ç”¨æˆ·æäº¤è¡¨å•
  â†“
è°ƒç”¨ Server Action
  â†“
éªŒè¯è¾“å…¥ (Zod)
  â†“
æ£€æŸ¥æƒé™
  â†“
ä¿®æ”¹æ•°æ®åº“
  â†“
è¿”å›ç»“æœ
  â†“
React Query é‡æ–°éªŒè¯
  â†“
ç»„ä»¶è‡ªåŠ¨æ›´æ–°
```

---

## ğŸ“Š æ€§èƒ½æ¦‚å¿µ

### Hydration

```typescript
// SSR (Server-Side Rendering)
æœåŠ¡å™¨ç”Ÿæˆ HTML
  â†“
å‘é€åˆ°æµè§ˆå™¨
  â†“
æµè§ˆå™¨æ˜¾ç¤º HTML (å¯è§ä½†ä¸å¯äº¤äº’)
  â†“
React åˆå§‹åŒ– (Hydration)
  â†“
é™„åŠ äº‹ä»¶ç›‘å¬å™¨
  â†“
é¡µé¢å˜æˆå¯äº¤äº’
```

**Hydration Mismatch é”™è¯¯:**
```
æœåŠ¡å™¨æ¸²æŸ“çš„ HTML ä¸å®¢æˆ·ç«¯ä¸åŒ¹é…
â†’ React ä¼šé‡æ–°æ¸²æŸ“
â†’ é—ªçƒæˆ–ä¸åŒ¹é…
â†’ é¿å…: ä½¿ç”¨ useEffect å¤„ç†æµè§ˆå™¨ä¸“æœ‰é€»è¾‘
```

### ISR (Incremental Static Regeneration)

```typescript
export const revalidate = 3600 // 1 å°æ—¶

export default async function BlogPage() {
  const posts = await db.query.post.findMany()
  return <PostList posts={posts} />
}
```

**å·¥ä½œåŸç†:**
1. æ„å»ºæ—¶ç”Ÿæˆé¦–æ¬¡é™æ€é¡µé¢
2. ç”¨æˆ·è®¿é—®æ—¶è¿”å›ç¼“å­˜çš„é¡µé¢
3. 1 å°æ—¶åè‡ªåŠ¨é‡æ–°ç”Ÿæˆ
4. æ–°è¯·æ±‚è§¦å‘åå°é‡æ–°ç”Ÿæˆ

---

## ğŸ¯ å…³é”®æœ¯è¯­è¯æ±‡è¡¨

| æœ¯è¯­ | å®šä¹‰ | ä¾‹å­ |
|------|------|------|
| **RPC** | Remote Procedure Call | Server Action åœ¨æœ¬è´¨ä¸Šæ˜¯ RPC |
| **SSR** | Server-Side Rendering | åœ¨æœåŠ¡å™¨æ¸²æŸ“ HTML |
| **CSR** | Client-Side Rendering | åœ¨æµè§ˆå™¨æ¸²æŸ“ HTML |
| **Serialization** | å¯¹è±¡ â†’ JSON | `JSON.stringify()` |
| **Deserialization** | JSON â†’ å¯¹è±¡ | `JSON.parse()` |
| **Middleware** | è¯·æ±‚æ‹¦æˆªå™¨ | æ—¥å¿—è®°å½•ã€è®¤è¯æ£€æŸ¥ |
| **Polymorphic** | å¤šæ€ | ä¸åŒå½¢çŠ¶çš„ç»„ä»¶ |
| **Reconciliation** | React å¯¹æ¯”ç®—æ³• | Diff å’Œ patch |
| **Memoization** | ç¼“å­˜è®¡ç®—ç»“æœ | `React.memo`, `useMemo` |

---

## ğŸš€ æœ€ä½³å®è·µæ€»ç»“

**Server Actions:**
- å§‹ç»ˆéªŒè¯è¾“å…¥
- æ£€æŸ¥æƒé™
- ä½¿ç”¨ try-catch å¤„ç†é”™è¯¯
- è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æ¶ˆæ¯

**ç»„ä»¶:**
- ä¼˜å…ˆä½¿ç”¨ Server Components
- Client Components ä»…ç”¨äºäº¤äº’
- åˆ†ç¦»å±•ç¤ºå’Œå®¹å™¨ç»„ä»¶

**æ•°æ®åº“:**
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ (é˜²æ­¢ SQL æ³¨å…¥)
- æ·»åŠ é€‚å½“çš„ç´¢å¼•
- åˆç†ä½¿ç”¨å…³è”

**ç±»å‹:**
- å¯¼å‡ºæ‰€æœ‰ types
- ä½¿ç”¨ `satisfies` ç¡®ä¿ç±»å‹
- é¿å… `any`

---

**ç›¸å…³æ–‡æ¡£:**
- [äº”å±‚æ¶æ„è¯¦è§£](./äº”å±‚æ¶æ„è¯¦è§£.md)
- [è®¾è®¡æ€æƒ³å’Œæ¨¡å¼](./è®¾è®¡æ€æƒ³å’Œæ¨¡å¼.md)

**æœ€åæ›´æ–°:** 2025-11-18
