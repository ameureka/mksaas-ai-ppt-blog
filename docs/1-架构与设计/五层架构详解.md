# äº”å±‚æ¶æ„è¯¦è§£

æ·±å…¥ç†è§£ mk-saas-blog çš„äº”å±‚åˆ†å±‚æ¶æ„ã€æ¯å±‚çš„èŒè´£å’Œå±‚çº§ä¹‹é—´çš„é€šä¿¡æœºåˆ¶ã€‚

---

## ğŸ“‹ ç›®å½•

- [æ¶æ„å…¨æ™¯](#æ¶æ„å…¨æ™¯)
- [ç¬¬ä¸€å±‚ï¼šç”¨æˆ·ç•Œé¢å±‚](#ç¬¬ä¸€å±‚ç”¨æˆ·ç•Œé¢å±‚)
- [ç¬¬äºŒå±‚ï¼šç»„ä»¶å±‚](#ç¬¬äºŒå±‚ç»„ä»¶å±‚)
- [ç¬¬ä¸‰å±‚ï¼šæœåŠ¡å±‚](#ç¬¬ä¸‰å±‚æœåŠ¡å±‚)
- [ç¬¬å››å±‚ï¼šAPI å±‚](#ç¬¬å››å±‚api-å±‚)
- [ç¬¬äº”å±‚ï¼šæ•°æ®å±‚](#ç¬¬äº”å±‚æ•°æ®å±‚)
- [å±‚çº§é—´é€šä¿¡](#å±‚çº§é—´é€šä¿¡)
- [ç±»å‹ç³»ç»Ÿè®¾è®¡](#ç±»å‹ç³»ç»Ÿè®¾è®¡)
- [å®æˆ˜ç¤ºä¾‹](#å®æˆ˜ç¤ºä¾‹)

---

## æ¶æ„å…¨æ™¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç”¨æˆ·ç•Œé¢å±‚ (Layer 1)                 â”‚
â”‚  Pages, Layouts, App Router, ç”¨æˆ·äº¤äº’å…¥å£          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ ç»„ä»¶ç»„åˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç»„ä»¶å±‚ (Layer 2)                     â”‚
â”‚  React ç»„ä»¶, å¯å¤ç”¨ç»„ä»¶åº“, å±•ç¤ºå’Œå®¹å™¨ç»„ä»¶         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ è°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æœåŠ¡å±‚ (Layer 3)                     â”‚
â”‚  Server Actions, ä¸šåŠ¡é€»è¾‘, æ•°æ®è½¬æ¢               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                API å±‚ (Layer 4)                     â”‚
â”‚  Next.js API Routes, REST endpoints               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“ SQL
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                æ•°æ®å±‚ (Layer 5)                     â”‚
â”‚  PostgreSQL, Drizzle ORM, æ•°æ®åº“è¡¨å’Œè¿ç§»         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç¬¬ä¸€å±‚ï¼šç”¨æˆ·ç•Œé¢å±‚

### èŒè´£

- å±•ç¤ºç”¨æˆ·ç•Œé¢
- å¤„ç†ç”¨æˆ·äº¤äº’ (ç‚¹å‡»ã€è¾“å…¥ã€æ»šåŠ¨)
- è·¯ç”±å¯¼èˆª
- çŠ¶æ€ç®¡ç† (UI çŠ¶æ€ï¼Œå¦‚æ¨¡æ€æ¡†æ‰“å¼€/å…³é—­)
- å±€éƒ¨æ•°æ®ç¼“å­˜å’ŒåŒæ­¥

### æ ¸å¿ƒæ–‡ä»¶

```
src/app/
â”œâ”€â”€ [lang]/                           # å›½é™…åŒ–è·¯ç”±å‚æ•°
â”œâ”€â”€ auth/                             # è®¤è¯ç›¸å…³é¡µé¢
â”‚   â”œâ”€â”€ login/page.tsx                # ç™»å½•é¡µ
â”‚   â”œâ”€â”€ register/page.tsx             # æ³¨å†Œé¡µ
â”‚   â””â”€â”€ forgot-password/page.tsx      # å¿˜è®°å¯†ç é¡µ
â”œâ”€â”€ dashboard/                        # ç”¨æˆ·ä»ªè¡¨æ¿
â”‚   â”œâ”€â”€ layout.tsx                    # ä»ªè¡¨æ¿å¸ƒå±€
â”‚   â””â”€â”€ page.tsx                      # ä»ªè¡¨æ¿é¦–é¡µ
â”œâ”€â”€ blog/                             # åšå®¢ç›¸å…³
â”‚   â”œâ”€â”€ page.tsx                      # åšå®¢åˆ—è¡¨
â”‚   â””â”€â”€ [...slug]/page.tsx            # æ–‡ç« è¯¦æƒ…
â””â”€â”€ error.tsx                         # é”™è¯¯å¤„ç†

src/components/
â”œâ”€â”€ layouts/                          # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ navbar.tsx
â”‚   â””â”€â”€ sidebar.tsx
â””â”€â”€ pages/                            # é¡µé¢ç»„ä»¶
    â”œâ”€â”€ blog-list.tsx
    â”œâ”€â”€ dashboard-overview.tsx
    â””â”€â”€ ...
```

### å…³é”®æ¦‚å¿µ

#### App Router (Next.js 15)

```typescript
// src/app/[lang]/dashboard/page.tsx
import { DashboardContent } from '@/components/pages/dashboard'

// Server Component - åœ¨æœåŠ¡å™¨æ¸²æŸ“
export default async function DashboardPage() {
  // å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä½†éœ€è¦ Server Action
  return <DashboardContent />
}
```

#### è·¯ç”±å‚æ•°å’ŒæŸ¥è¯¢

```typescript
// åŠ¨æ€è·¯ç”±: /blog/my-first-post
// æ–‡ä»¶: src/app/blog/[slug]/page.tsx
interface BlogPageProps {
  params: Promise<{ slug: string }>
  searchParams: Promise<{ [key: string]: string | undefined }>
}

export default async function BlogPage({ params, searchParams }: BlogPageProps) {
  const { slug } = await params
  const { comments } = await searchParams
  // ...
}
```

#### å›½é™…åŒ–è·¯ç”±

```typescript
// æ‰€æœ‰è·¯ç”±éƒ½åŒ…è£¹åœ¨ [lang] ä¸­
// /en/dashboard â†’ è‹±æ–‡
// /zh/dashboard â†’ ä¸­æ–‡

export async function generateStaticParams() {
  return [
    { lang: 'en' },
    { lang: 'zh' },
  ]
}
```

### æ•°æ®æµå‘

```
ç”¨æˆ·äº¤äº’
    â†“
äº‹ä»¶å¤„ç†å™¨
    â†“
è°ƒç”¨ Server Action
    â†“
æ›´æ–° UI çŠ¶æ€
    â†“
é‡æ–°æ¸²æŸ“ç»„ä»¶
```

---

## ç¬¬äºŒå±‚ï¼šç»„ä»¶å±‚

### èŒè´£

- æä¾›å¯å¤ç”¨çš„ UI ç»„ä»¶
- å°è£…äº¤äº’é€»è¾‘
- åˆ†ç¦»å®¹å™¨ç»„ä»¶å’Œå±•ç¤ºç»„ä»¶
- æä¾› hooks å’Œ utils

### æ ¸å¿ƒç›®å½•ç»“æ„

```
src/components/
â”œâ”€â”€ ui/                               # Radix UI åŸºç¡€ç»„ä»¶
â”‚   â”œâ”€â”€ button.tsx
â”‚   â”œâ”€â”€ dialog.tsx
â”‚   â”œâ”€â”€ input.tsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ forms/                            # è¡¨å•ç»„ä»¶
â”‚   â”œâ”€â”€ login-form.tsx
â”‚   â”œâ”€â”€ signup-form.tsx
â”‚   â””â”€â”€ ...
â”œâ”€â”€ layouts/                          # å¸ƒå±€ç»„ä»¶
â”‚   â”œâ”€â”€ navbar.tsx
â”‚   â”œâ”€â”€ sidebar.tsx
â”‚   â””â”€â”€ footer.tsx
â”œâ”€â”€ cards/                            # å¡ç‰‡ç»„ä»¶
â”‚   â”œâ”€â”€ blog-card.tsx
â”‚   â”œâ”€â”€ pricing-card.tsx
â”‚   â””â”€â”€ ...
â””â”€â”€ pages/                            # é¡µé¢çº§å®¹å™¨ç»„ä»¶
    â”œâ”€â”€ dashboard-content.tsx
    â”œâ”€â”€ blog-list-view.tsx
    â””â”€â”€ ...
```

### ç»„ä»¶åˆ†ç±»

#### 1. å±•ç¤ºç»„ä»¶ (Presentational Components)

```typescript
// src/components/ui/button.tsx
interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary'
  size?: 'sm' | 'md' | 'lg'
  children: React.ReactNode
}

export function Button({ variant = 'primary', size = 'md', ...props }: ButtonProps) {
  return (
    <button
      className={cn(
        'px-4 py-2 rounded-md',
        variant === 'primary' && 'bg-blue-600 text-white',
        variant === 'secondary' && 'bg-gray-200 text-black'
      )}
      {...props}
    />
  )
}
```

**ç‰¹ç‚¹:**
- çº¯ UI è¡¨ç°
- æ— æ•°æ®è·å–
- æ—  Server Action è°ƒç”¨
- å®Œå…¨å¯æ§åˆ¶å’Œå¯æµ‹è¯•

#### 2. å®¹å™¨ç»„ä»¶ (Container Components)

```typescript
// src/components/pages/dashboard-content.tsx
'use client'

import { useEffect, useState } from 'react'
import { useQuery } from '@tanstack/react-query'
import { getDashboardData } from '@/actions/dashboard'

export function DashboardContent() {
  const { data, isLoading } = useQuery({
    queryKey: ['dashboard'],
    queryFn: () => getDashboardData(),
  })

  if (isLoading) return <LoadingSkeleton />

  return (
    <div>
      {/* ä½¿ç”¨æ•°æ®æ¸²æŸ“å±•ç¤ºç»„ä»¶ */}
      <DashboardHeader stats={data.stats} />
      <DashboardCharts data={data.chartData} />
    </div>
  )
}
```

**ç‰¹ç‚¹:**
- å¤„ç†ä¸šåŠ¡é€»è¾‘
- è·å–å’Œç®¡ç†æ•°æ®
- ç®¡ç† UI çŠ¶æ€
- ç»„åˆå±•ç¤ºç»„ä»¶

### è‡ªå®šä¹‰ Hooks

```typescript
// src/hooks/use-auth.ts
'use client'

import { useQuery } from '@tanstack/react-query'
import { getSession } from '@/actions/auth'

export function useAuth() {
  const { data: session, isLoading } = useQuery({
    queryKey: ['auth'],
    queryFn: getSession,
  })

  return { session, isLoading, isAuthenticated: !!session }
}

// ä½¿ç”¨
export function ProtectedComponent() {
  const { isAuthenticated } = useAuth()

  if (!isAuthenticated) return <LoginPrompt />
  return <SecureContent />
}
```

### çŠ¶æ€ç®¡ç† (Zustand)

```typescript
// src/stores/ui-store.ts
import { create } from 'zustand'

interface UIStore {
  sidebarOpen: boolean
  toggleSidebar: () => void
}

export const useUIStore = create<UIStore>((set) => ({
  sidebarOpen: true,
  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
}))

// ä½¿ç”¨
export function Sidebar() {
  const { sidebarOpen } = useUIStore()
  return <aside className={sidebarOpen ? 'block' : 'hidden'}>...</aside>
}
```

---

## ç¬¬ä¸‰å±‚ï¼šæœåŠ¡å±‚

### èŒè´£

- å®ç°ä¸šåŠ¡é€»è¾‘
- éªŒè¯æ•°æ®
- è°ƒç”¨æ•°æ®å±‚
- è¿”å›ç±»å‹å®‰å…¨çš„ç»“æœ
- é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### Server Actions

```typescript
// src/actions/dashboard.ts
'use server'

import { auth } from '@/lib/auth'
import { db } from '@/db'
import { user, payment } from '@/db/schema'
import { eq } from 'drizzle-orm'

// ç±»å‹å®šä¹‰
export type DashboardData = {
  stats: {
    totalUsers: number
    totalRevenue: number
    activeSubscriptions: number
  }
  chartData: Array<{ date: string; value: number }>
}

// æƒé™æ£€æŸ¥å®¢æˆ·ç«¯
import { createSafeActionClient } from 'next-safe-action'

const actionClient = createSafeActionClient()

const userActionClient = actionClient.use(async ({ next }) => {
  const session = await auth()
  if (!session) throw new Error('æœªæˆæƒ')

  return next({ ctx: { session } })
})

// Server Action å®ç°
export const getDashboardData = userActionClient.action(async ({ ctx }) => {
  const userId = ctx.session.user.id

  // è·å–ç”¨æˆ·ç»Ÿè®¡
  const userStats = await db.query.user.findFirst({
    where: eq(user.id, userId),
  })

  // è·å–æ”¯ä»˜ä¿¡æ¯
  const payments = await db.query.payment.findMany({
    where: eq(payment.userId, userId),
  })

  // è¿”å›ç±»å‹å®‰å…¨çš„æ•°æ®
  return {
    stats: {
      totalUsers: userStats?.totalCredits || 0,
      totalRevenue: payments.reduce((sum, p) => sum + p.amount, 0),
      activeSubscriptions: payments.filter((p) => p.status === 'active').length,
    },
    chartData: [], // ç”Ÿæˆå›¾è¡¨æ•°æ®
  } satisfies DashboardData
})
```

### Server Actions çš„ä¸‰å±‚æƒé™

```typescript
// 1. actionClient - å…¬å¼€æ“ä½œ (æ— éœ€è®¤è¯)
const publicAction = actionClient.schema(schema).action(async ({ parsedInput }) => {
  // ä¾‹: æäº¤è”ç³»è¡¨å•
  return { success: true }
})

// 2. userActionClient - ç”¨æˆ·æ“ä½œ (éœ€è¦ç™»å½•)
const userAction = userActionClient.schema(schema).action(async ({ parsedInput, ctx }) => {
  // ctx.session ä¿è¯å­˜åœ¨
  const userId = ctx.session.user.id
  // ä¾‹: æ›´æ–°ç”¨æˆ·èµ„æ–™
  return { success: true }
})

// 3. adminActionClient - ç®¡ç†å‘˜æ“ä½œ (éœ€è¦ç®¡ç†å‘˜æƒé™)
const adminAction = adminActionClient
  .schema(schema)
  .action(async ({ parsedInput, ctx }) => {
    // éªŒè¯ç®¡ç†å‘˜æƒé™
    if (ctx.session.user.role !== 'admin') throw new Error('ç¦æ­¢')
    // ä¾‹: åˆ é™¤ç”¨æˆ·
    return { success: true }
  })
```

### éªŒè¯å’Œé”™è¯¯å¤„ç†

```typescript
import { z } from 'zod'

const UpdateProfileSchema = z.object({
  name: z.string().min(2).max(100),
  email: z.string().email(),
  bio: z.string().max(500).optional(),
})

export const updateProfile = userActionClient
  .schema(UpdateProfileSchema)
  .action(async ({ parsedInput, ctx }) => {
    try {
      // parsedInput å·²é€šè¿‡ Zod éªŒè¯ï¼Œç±»å‹å®‰å…¨
      const { name, email, bio } = parsedInput
      const userId = ctx.session.user.id

      // æ£€æŸ¥é‚®ç®±å”¯ä¸€æ€§
      const existing = await db.query.user.findFirst({
        where: eq(user.email, email),
      })

      if (existing && existing.id !== userId) {
        return { error: 'é‚®ç®±å·²è¢«ä½¿ç”¨' }
      }

      // æ›´æ–°æ•°æ®åº“
      await db.update(user).set({ name, email, bio }).where(eq(user.id, userId))

      return { success: true, data: { name, email } }
    } catch (error) {
      console.error('æ›´æ–°èµ„æ–™å¤±è´¥:', error)
      return { error: 'æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•' }
    }
  })
```

---

## ç¬¬å››å±‚ï¼šAPI å±‚

### èŒè´£

- æä¾› HTTP ç«¯ç‚¹
- å¤„ç† webhook
- æ”¯æŒç¬¬ä¸‰æ–¹é›†æˆ
- å“åº”åºåˆ—åŒ–

### Next.js API Routes

```typescript
// src/app/api/webhooks/stripe/route.ts
import { stripe } from '@/lib/stripe'
import { handleStripeCheckoutCompleted } from '@/services/payment'

export async function POST(request: Request) {
  const body = await request.text()
  const signature = request.headers.get('stripe-signature')

  // éªŒè¯ Stripe ç­¾å
  const event = stripe.webhooks.constructEvent(
    body,
    signature!,
    process.env.STRIPE_WEBHOOK_SECRET!
  )

  switch (event.type) {
    case 'checkout.session.completed':
      await handleStripeCheckoutCompleted(event.data.object)
      break
    // å¤„ç†å…¶ä»–äº‹ä»¶
  }

  return Response.json({ received: true })
}
```

### REST API ç¤ºä¾‹

```typescript
// src/app/api/users/[id]/route.ts
import { db } from '@/db'
import { user } from '@/db/schema'
import { eq } from 'drizzle-orm'

export async function GET(request: Request, { params }: { params: { id: string } }) {
  const userData = await db.query.user.findFirst({
    where: eq(user.id, params.id),
  })

  if (!userData) {
    return Response.json({ error: 'ç”¨æˆ·ä¸å­˜åœ¨' }, { status: 404 })
  }

  return Response.json(userData)
}

export async function PUT(request: Request, { params }: { params: { id: string } }) {
  const data = await request.json()

  await db.update(user).set(data).where(eq(user.id, params.id))

  return Response.json({ success: true })
}
```

---

## ç¬¬äº”å±‚ï¼šæ•°æ®å±‚

### èŒè´£

- å®šä¹‰æ•°æ®æ¨¡å¼
- æ‰§è¡Œæ•°æ®åº“æ“ä½œ
- ç®¡ç†è¿ç§»
- ç´¢å¼•å’Œä¼˜åŒ–

### Drizzle Schema

```typescript
// src/db/schema.ts
import { pgTable, text, timestamp, integer, boolean } from 'drizzle-orm/pg-core'
import { sql } from 'drizzle-orm'

export const user = pgTable('user', {
  id: text('id').primaryKey().default(sql`uuid_generate_v4()`),
  email: text('email').notNull().unique(),
  name: text('name').notNull(),
  password: text('password'), // nullable for OAuth users
  tier: text('tier').default('free'), // 'free', 'pro', 'lifetime'
  totalCredits: integer('total_credits').default(0),
  emailVerified: boolean('email_verified').default(false),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
})

export const payment = pgTable('payment', {
  id: text('id').primaryKey().default(sql`uuid_generate_v4()`),
  userId: text('user_id')
    .notNull()
    .references(() => user.id, { onDelete: 'cascade' }),
  stripeId: text('stripe_id').unique(),
  amount: integer('amount').notNull(), // ç¾åˆ†
  status: text('status').default('pending'), // 'pending', 'completed', 'failed'
  tier: text('tier').notNull(), // 'pro', 'lifetime'
  createdAt: timestamp('created_at').defaultNow(),
})
```

### Drizzle Queries

```typescript
// æŸ¥è¯¢
const users = await db.query.user.findMany({
  limit: 10,
  where: eq(user.tier, 'pro'),
})

// å¸¦å…³è”
const userWithPayments = await db.query.user.findFirst({
  where: eq(user.id, userId),
  with: {
    payments: {
      limit: 10,
      orderBy: (payment) => desc(payment.createdAt),
    },
  },
})

// èšåˆ
const totalRevenue = await db
  .select({
    total: sql<number>`SUM(${payment.amount})`,
  })
  .from(payment)
  .where(eq(payment.status, 'completed'))

// æ›´æ–°
await db.update(user).set({ totalCredits: 100 }).where(eq(user.id, userId))

// åˆ é™¤
await db.delete(user).where(eq(user.id, userId))
```

---

## å±‚çº§é—´é€šä¿¡

### æ•°æ®ä»ä¸‹è€Œä¸ŠæµåŠ¨ (Query)

```
Component (ç¬¬2å±‚)
    â†“ è°ƒç”¨
Server Action (ç¬¬3å±‚)
    â†“ è°ƒç”¨
Drizzle Query (ç¬¬5å±‚)
    â†“ è¿”å› SQL ç»“æœ
Server Action
    â†“ è¿”å› TypeScript æ•°æ®
Component
    â†“ æ¸²æŸ“ UI
```

### å‘½ä»¤ä»ä¸Šè€Œä¸‹æµåŠ¨ (Mutation)

```
User Action (ç¬¬1å±‚)
    â†“
React Event Handler (ç¬¬2å±‚)
    â†“
Server Action Call (ç¬¬3å±‚)
    â†“ éªŒè¯
Drizzle Operation (ç¬¬5å±‚)
    â†“ æ•°æ®åº“æ›´æ–°
Server Action è¿”å› (ç¬¬3å±‚)
    â†“
UI é‡æ–°æ¸²æŸ“ (ç¬¬2å±‚)
```

---

## ç±»å‹ç³»ç»Ÿè®¾è®¡

### è´¯ç©¿æ‰€æœ‰å±‚çš„ç±»å‹

```typescript
// 1. æ•°æ®åº“ Schema ç±»å‹
type User = typeof user.$inferSelect
type NewUser = typeof user.$inferInsert

// 2. API å“åº”ç±»å‹
type UserResponse = {
  id: string
  email: string
  name: string
  tier: 'free' | 'pro' | 'lifetime'
}

// 3. Server Action å‚æ•°å’Œè¿”å›ç±»å‹
type UpdateProfileInput = z.infer<typeof UpdateProfileSchema>
type UpdateProfileResult = { success: true } | { error: string }

// 4. Component Props ç±»å‹
interface UserCardProps {
  user: UserResponse
  onUpdate?: (user: UserResponse) => void
}

// 5. Hook è¿”å›ç±»å‹
type UseUserReturn = {
  user: UserResponse | null
  isLoading: boolean
  error: Error | null
}
```

### ç±»å‹æµå‘

```
æ•°æ®åº“å®šä¹‰
    â†“ æ¨å¯¼ç±»å‹
TypeScript ç±»å‹
    â†“ ç”¨äº
Server Action
    â†“ æŒ‡å¯¼
API å“åº”
    â†“ ä¼ ç»™
React ç»„ä»¶
    â†“ æ˜¾ç¤º
UI
```

---

## å®æˆ˜ç¤ºä¾‹

### å®Œæ•´ç”¨æˆ·æµï¼šç”¨æˆ·æ³¨å†Œ

```typescript
// 1. UI å±‚ï¼šæ³¨å†Œè¡¨å•
// src/app/auth/register/page.tsx
import { RegisterForm } from '@/components/forms/register-form'

export default function RegisterPage() {
  return <RegisterForm />
}

// 2. ç»„ä»¶å±‚ï¼šè¡¨å•ç»„ä»¶
// src/components/forms/register-form.tsx
'use client'

import { useActionState } from 'react'
import { registerUser } from '@/actions/auth'

export function RegisterForm() {
  const [state, formAction] = useActionState(registerUser, null)

  return (
    <form action={formAction}>
      <input type="email" name="email" required />
      <input type="password" name="password" required />
      <button type="submit">æ³¨å†Œ</button>
      {state?.error && <p>{state.error}</p>}
    </form>
  )
}

// 3. æœåŠ¡å±‚ï¼šä¸šåŠ¡é€»è¾‘
// src/actions/auth.ts
import { z } from 'zod'
import { db } from '@/db'
import { user } from '@/db/schema'
import { createSafeActionClient } from 'next-safe-action'

const RegisterSchema = z.object({
  email: z.string().email(),
  password: z.string().min(8),
})

const actionClient = createSafeActionClient()

export const registerUser = actionClient.schema(RegisterSchema).action(
  async ({ parsedInput }) => {
    const { email, password } = parsedInput

    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    const existing = await db.query.user.findFirst({
      where: (users, { eq }) => eq(users.email, email),
    })

    if (existing) {
      return { error: 'é‚®ç®±å·²æ³¨å†Œ' }
    }

    // åˆ›å»ºç”¨æˆ·
    const hashedPassword = await hashPassword(password)
    const newUser = await db.insert(user).values({
      email,
      password: hashedPassword,
      name: email.split('@')[0],
    })

    // å‘é€éªŒè¯é‚®ä»¶
    await sendVerificationEmail(email)

    return { success: true, userId: newUser.insertId }
  }
)

// 4. æ•°æ®å±‚ï¼šæ•°æ®åº“å®šä¹‰
// src/db/schema.ts å·²å®šä¹‰ user è¡¨
```

---

## æ€»ç»“

äº”å±‚æ¶æ„çš„å¥½å¤„:

âœ… **å…³æ³¨ç‚¹åˆ†ç¦»** - æ¯å±‚åªåšä¸€ä»¶äº‹
âœ… **å¯ç»´æŠ¤æ€§** - æ”¹åŠ¨å±€é™åœ¨ç‰¹å®šå±‚
âœ… **å¯æµ‹è¯•æ€§** - æ¯å±‚å¯ç‹¬ç«‹æµ‹è¯•
âœ… **å¯å¤ç”¨æ€§** - ç»„ä»¶å’Œé€»è¾‘å¯å¤ç”¨
âœ… **ç±»å‹å®‰å…¨** - ç±»å‹è´¯ç©¿æ•´ä¸ªæµç¨‹
âœ… **æ˜“äºæ‰©å±•** - æ–°åŠŸèƒ½å¯æŒ‰å±‚æ·»åŠ 

---

**ç›¸å…³é˜…è¯»:**
- [è®¾è®¡æ€æƒ³å’Œæ¨¡å¼](./è®¾è®¡æ€æƒ³å’Œæ¨¡å¼.md)
- [æ¦‚å¿µæ¾„æ¸…](./æ¦‚å¿µæ¾„æ¸….md)
- [æ•´ä½“äº”å±‚æ¶æ„å›¾è¡¨](../diagrams/architecture/1-æ•´ä½“äº”å±‚æ¶æ„.md)

**æœ€åæ›´æ–°:** 2025-11-18
