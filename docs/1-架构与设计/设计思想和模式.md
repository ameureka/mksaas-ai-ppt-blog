# è®¾è®¡æ€æƒ³å’Œæ¨¡å¼

mk-saas-blog çš„æ ¸å¿ƒè®¾è®¡åŸåˆ™ã€æ¶æ„æ¨¡å¼å’Œæœ€ä½³å®è·µã€‚

---

## ğŸ“‹ ç›®å½•

- [æ ¸å¿ƒè®¾è®¡åŸåˆ™](#æ ¸å¿ƒè®¾è®¡åŸåˆ™)
- [å‰åç«¯åˆ†ç¦»](#å‰åç«¯åˆ†ç¦»)
- [Server Actions ä¸‰å±‚æƒé™æ¨¡å‹](#server-actions-ä¸‰å±‚æƒé™æ¨¡å‹)
- [å®ç°æ¨¡å¼](#å®ç°æ¨¡å¼)
- [çŠ¶æ€ç®¡ç†ç­–ç•¥](#çŠ¶æ€ç®¡ç†ç­–ç•¥)
- [é”™è¯¯å¤„ç†è®¾è®¡](#é”™è¯¯å¤„ç†è®¾è®¡)
- [ç±»å‹å®‰å…¨ç­–ç•¥](#ç±»å‹å®‰å…¨ç­–ç•¥)
- [æ€§èƒ½ä¼˜åŒ–æ€æƒ³](#æ€§èƒ½ä¼˜åŒ–æ€æƒ³)

---

## æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. åˆ†å±‚åŸåˆ™ (Layering)

**ç†å¿µ:** å°†ç³»ç»Ÿåˆ†ä¸ºä¸åŒçš„å±‚ï¼Œæ¯å±‚æœ‰æ¸…æ™°çš„èŒè´£ã€‚

```
UI å±‚         â†’ å±•ç¤ºå’Œäº¤äº’
Component å±‚  â†’ å¯å¤ç”¨é€»è¾‘
Service å±‚    â†’ ä¸šåŠ¡å¤„ç†
API å±‚        â†’ HTTP æ¥å£
Data å±‚       â†’ æ•°æ®æŒä¹…åŒ–
```

**å¥½å¤„:**
- å…³æ³¨ç‚¹åˆ†ç¦» (Separation of Concerns)
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- ä»£ç å¤ç”¨
- æ˜“äºæ‰©å±•

### 2. ç±»å‹å®‰å…¨åŸåˆ™ (Type Safety)

**ç†å¿µ:** åœ¨ç¼–è¯‘æ—¶è€Œéè¿è¡Œæ—¶æ•è·é”™è¯¯ã€‚

```typescript
// âŒ ä¸å®‰å…¨
const user = await db.query('SELECT * FROM users WHERE id = ?', [id])
// user çš„ç±»å‹æ˜¯ anyï¼Œç¼–è¯‘æ—¶æ— æ³•æ£€æŸ¥

// âœ… å®‰å…¨
const user = await db.query.user.findFirst({
  where: eq(user.id, id),
})
// user çš„ç±»å‹è¢«æ­£ç¡®æ¨å¯¼ä¸º User | undefined
```

### 3. æœ€å°æƒé™åŸåˆ™ (Principle of Least Privilege)

**ç†å¿µ:** ä»£ç å’Œç”¨æˆ·åªè·å¾—å®Œæˆä»»åŠ¡æ‰€éœ€çš„æœ€å°æƒé™ã€‚

```typescript
// Server Action æƒé™åˆ†å±‚
- publicAction: æ— éœ€è®¤è¯
- userAction: éœ€è¦ç™»å½•
- adminAction: éœ€è¦ç®¡ç†å‘˜æƒé™
```

### 4. é˜²å¾¡æ€§ç¼–ç¨‹ (Defensive Programming)

**ç†å¿µ:** å‡è®¾æ‰€æœ‰è¾“å…¥éƒ½ä¸å¯ä¿¡ã€‚

```typescript
// éªŒè¯ â†’ æ£€æŸ¥ â†’ æˆæƒ â†’ æ‰§è¡Œ
export const updateProfile = userActionClient
  .schema(UpdateProfileSchema)  // 1. éªŒè¯ Input
  .action(async ({ parsedInput, ctx }) => {
    const { name } = parsedInput
    const userId = ctx.session.user.id

    // 2. æ£€æŸ¥èµ„æºæ‰€æœ‰æƒ
    const profile = await db.query.user.findFirst({
      where: eq(user.id, userId),
    })
    if (!profile) throw new Error('ç”¨æˆ·ä¸å­˜åœ¨')

    // 3. æˆæƒ
    if (profile.id !== userId) throw new Error('æ— æƒé™')

    // 4. æ‰§è¡Œ
    await db.update(user).set({ name }).where(eq(user.id, userId))

    return { success: true }
  })
```

### 5. DRY åŸåˆ™ (Don't Repeat Yourself)

**ç†å¿µ:** ä¸€å¤„å®šä¹‰ï¼Œå¤šå¤„ä½¿ç”¨ã€‚

```typescript
// å®šä¹‰ä¸€æ¬¡
const UpdateProfileSchema = z.object({
  name: z.string().min(2).max(100),
  email: z.string().email(),
})

// åœ¨ Server Action ä¸­ä½¿ç”¨
export const updateProfile = userActionClient
  .schema(UpdateProfileSchema)
  .action(async ({ parsedInput }) => {
    // parsedInput å·²é€šè¿‡éªŒè¯
  })

// åœ¨ç±»å‹ç³»ç»Ÿä¸­ä½¿ç”¨
type UpdateProfileInput = z.infer<typeof UpdateProfileSchema>

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export function UpdateProfileForm() {
  const [data, setData] = useState<UpdateProfileInput>({})
}
```

---

## å‰åç«¯åˆ†ç¦»

### Server Components vs Client Components

**æ ¸å¿ƒæ€æƒ³:** åŒºåˆ†ä»€ä¹ˆåº”è¯¥åœ¨æœåŠ¡å™¨ï¼Œä»€ä¹ˆåº”è¯¥åœ¨æµè§ˆå™¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Next.js App Router                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  Server Components (é»˜è®¤)                       â”‚
â”‚  â”œâ”€ ç›´æ¥è®¿é—®æ•°æ®åº“                              â”‚
â”‚  â”œâ”€ å®‰å…¨å­˜å‚¨å¯†é’¥                                â”‚
â”‚  â”œâ”€ å‡å°‘ JavaScript å‘é€                        â”‚
â”‚  â””â”€ ä¾‹: é¡µé¢ã€å¸ƒå±€ã€æ•°æ®è·å–                    â”‚
â”‚                                                 â”‚
â”‚  Client Components ('use client')              â”‚
â”‚  â”œâ”€ ä½¿ç”¨ React hooks                           â”‚
â”‚  â”œâ”€ äº¤äº’å’ŒçŠ¶æ€ç®¡ç†                              â”‚
â”‚  â”œâ”€ è®¿é—®æµè§ˆå™¨ API                              â”‚
â”‚  â””â”€ ä¾‹: è¡¨å•ã€æŒ‰é’®ã€æ¨¡æ€æ¡†                      â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å†³ç­–çŸ©é˜µ:**

| éœ€æ±‚ | Server | Client |
|------|--------|--------|
| è®¿é—®æ•°æ®åº“ | âœ… | âŒ |
| ä½¿ç”¨ useState | âŒ | âœ… |
| å¤„ç†å¯†é’¥ | âœ… | âŒ |
| äº¤äº’ | âŒ | âœ… |
| å‡å°‘ JS | âœ… | âŒ |

### æ•°æ®æµè®¾è®¡

```
Server Component
  â†“ (æ— æ³•ç›´æ¥è°ƒç”¨)
Client Component (éœ€è¦ props ä¼ é€’)
  â†“ (ç”¨æˆ·äº¤äº’)
Server Action (é€šè¿‡ RPC è°ƒç”¨)
  â†“ (è¿”å›ç»“æœ)
Client çŠ¶æ€æ›´æ–°
  â†“
é‡æ–°æ¸²æŸ“
```

---

## Server Actions ä¸‰å±‚æƒé™æ¨¡å‹

### è®¾è®¡æ€æƒ³

Server Actions æŒ‰ç…§æƒé™çº§åˆ«åˆ†ä¸ºä¸‰å±‚ï¼Œç¡®ä¿æ¯ä¸ªæ“ä½œéƒ½ç»è¿‡é€‚å½“çš„æˆæƒæ£€æŸ¥ã€‚

```typescript
// åŸºç¡€å®¢æˆ·ç«¯
const actionClient = createSafeActionClient()

// ç¬¬ 1 å±‚ï¼šå…¬å¼€æ“ä½œï¼ˆæ— è®¤è¯ï¼‰
const publicAction = actionClient
  .schema(schema)
  .action(async ({ parsedInput }) => {
    // æ— éœ€è®¤è¯
    // ä¾‹: æäº¤è”ç³»è¡¨å•ã€è®¢é˜…é‚®ä»¶
  })

// ç¬¬ 2 å±‚ï¼šç”¨æˆ·æ“ä½œï¼ˆéœ€è¦ç™»å½•ï¼‰
const userActionClient = actionClient.use(async ({ next }) => {
  const session = await auth()
  if (!session?.user) throw new Error('æœªæˆæƒ')
  return next({ ctx: { session } })
})

const userAction = userActionClient
  .schema(schema)
  .action(async ({ parsedInput, ctx }) => {
    const userId = ctx.session.user.id
    // æœ‰æ•ˆçš„ç”¨æˆ· IDï¼Œå¯å®‰å…¨æ“ä½œ
    // ä¾‹: æ›´æ–°ä¸ªäººèµ„æ–™ã€ä¸Šä¼ æ–‡ä»¶
  })

// ç¬¬ 3 å±‚ï¼šç®¡ç†å‘˜æ“ä½œï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
const adminActionClient = userActionClient.use(async ({ next, ctx }) => {
  if (ctx.session.user.role !== 'admin') {
    throw new Error('éœ€è¦ç®¡ç†å‘˜æƒé™')
  }
  return next()
})

const adminAction = adminActionClient
  .schema(schema)
  .action(async ({ parsedInput, ctx }) => {
    // ç®¡ç†å‘˜æƒé™å·²éªŒè¯
    // ä¾‹: åˆ é™¤ç”¨æˆ·ã€å¯¼å‡ºæ•°æ®
  })
```

### æƒé™æ£€æŸ¥æµç¨‹

```
è¯·æ±‚åˆ°è¾¾
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. éªŒè¯ Input       â”‚
â”‚    (Schema æ£€æŸ¥)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. éªŒè¯è®¤è¯         â”‚
â”‚    (æœ‰æ•ˆ Session?)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. éªŒè¯æˆæƒ         â”‚
â”‚    (ç”¨æˆ·æƒé™?)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“ é€šè¿‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ‰§è¡Œæ“ä½œ         â”‚
â”‚    (ä¸šåŠ¡é€»è¾‘)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
è¿”å›ç»“æœ
```

---

## å®ç°æ¨¡å¼

### 1. å®¹å™¨ç»„ä»¶æ¨¡å¼

**ç†å¿µ:** åˆ†ç¦»æ•°æ®è·å–/é€»è¾‘ï¼ˆå®¹å™¨ï¼‰å’Œå±•ç¤ºï¼ˆå±•ç¤ºç»„ä»¶ï¼‰ã€‚

```typescript
// å±•ç¤ºç»„ä»¶ï¼šçº¯ UIï¼Œæ— å‰¯ä½œç”¨
interface UserCardProps {
  user: User
  onUpdate?: (user: User) => void
}

export function UserCard({ user, onUpdate }: UserCardProps) {
  return (
    <div className="card">
      <h2>{user.name}</h2>
      <p>{user.email}</p>
      <button onClick={() => onUpdate?.(user)}>ç¼–è¾‘</button>
    </div>
  )
}

// å®¹å™¨ç»„ä»¶ï¼šæ•°æ®è·å–å’Œé€»è¾‘
'use client'

export function UserCardContainer({ userId }: { userId: string }) {
  const { data: user } = useQuery({
    queryKey: ['user', userId],
    queryFn: () => getUser(userId),
  })

  const handleUpdate = async (updatedUser: User) => {
    await updateUser(updatedUser)
    queryClient.invalidateQueries({ queryKey: ['user', userId] })
  }

  if (!user) return <Skeleton />

  return <UserCard user={user} onUpdate={handleUpdate} />
}
```

**ä¼˜ç‚¹:**
- å±•ç¤ºç»„ä»¶é«˜åº¦å¯å¤ç”¨
- é€»è¾‘å®¹æ˜“æµ‹è¯•
- UI å’Œæ•°æ®åˆ†ç¦»

### 2. Hook æ¨¡å¼

**ç†å¿µ:** å°†å¯å¤ç”¨çš„é€»è¾‘æå–åˆ° Hookã€‚

```typescript
// è‡ªå®šä¹‰ Hook
'use client'

export function useUser(userId: string) {
  const { data: user, isLoading, error } = useQuery({
    queryKey: ['user', userId],
    queryFn: async () => {
      return await getUser(userId)
    },
  })

  const updateUser = async (data: UpdateUserInput) => {
    return await updateUserAction(data)
  }

  return { user, isLoading, error, updateUser }
}

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export function UserProfile({ userId }: { userId: string }) {
  const { user, isLoading, updateUser } = useUser(userId)

  if (isLoading) return <Skeleton />

  return (
    <form onSubmit={async (e) => {
      e.preventDefault()
      await updateUser(formData)
    }}>
      {/* è¡¨å•å†…å®¹ */}
    </form>
  )
}
```

**ä½•æ—¶ä½¿ç”¨:**
- å¤šä¸ªç»„ä»¶éœ€è¦ç›¸åŒé€»è¾‘
- å¤æ‚çš„çŠ¶æ€ç®¡ç†
- æ•°æ®è·å–å’Œç¼“å­˜

### 3. è¡¨å•æ¨¡å¼

**ç†å¿µ:** ç»Ÿä¸€çš„è¡¨å•å¤„ç†æ–¹æ³•ï¼Œç»“åˆéªŒè¯ã€‚

```typescript
'use client'

import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { z } from 'zod'

// 1. å®šä¹‰ Schema
const LoginSchema = z.object({
  email: z.string().email('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  password: z.string().min(8, 'å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦'),
})

type LoginInput = z.infer<typeof LoginSchema>

// 2. å®šä¹‰ Server Action
export const login = actionClient
  .schema(LoginSchema)
  .action(async ({ parsedInput }) => {
    // å¤„ç†ç™»å½•
  })

// 3. åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export function LoginForm() {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
  } = useForm<LoginInput>({
    resolver: zodResolver(LoginSchema),
  })

  const onSubmit = async (data: LoginInput) => {
    await login(data)
  }

  return (
    <form onSubmit={handleSubmit(onSubmit)}>
      <input {...register('email')} />
      {errors.email && <span>{errors.email.message}</span>}

      <input {...register('password')} type="password" />
      {errors.password && <span>{errors.password.message}</span>}

      <button type="submit" disabled={isSubmitting}>
        ç™»å½•
      </button>
    </form>
  )
}
```

---

## çŠ¶æ€ç®¡ç†ç­–ç•¥

### Server State vs UI State

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åˆ†ç±»                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                    â”‚
â”‚  Server State                      â”‚
â”‚  â”œâ”€ ç”¨æˆ·æ•°æ®                        â”‚
â”‚  â”œâ”€ æ•°æ®åº“æ•°æ®                      â”‚
â”‚  â”œâ”€ API å“åº”                       â”‚
â”‚  â””â”€ æ¥æº: æ•°æ®åº“                    â”‚
â”‚  â””â”€ ç®¡ç†å·¥å…·: React Query           â”‚
â”‚                                    â”‚
â”‚  UI State                          â”‚
â”‚  â”œâ”€ æ¨¡æ€æ¡†æ‰“å¼€/å…³é—­                 â”‚
â”‚  â”œâ”€ è¾“å…¥æ¡†ç„¦ç‚¹                      â”‚
â”‚  â”œâ”€ èœå•å±•å¼€/æ”¶èµ·                   â”‚
â”‚  â”œâ”€ æ·±è‰²/æµ…è‰²ä¸»é¢˜                   â”‚
â”‚  â””â”€ æ¥æº: ç”¨æˆ·äº¤äº’                  â”‚
â”‚  â””â”€ ç®¡ç†å·¥å…·: useState / Zustand    â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### React Query (Server State)

```typescript
'use client'

import { useQuery, useMutation } from '@tanstack/react-query'

// æŸ¥è¯¢ï¼ˆè·å–æ•°æ®ï¼‰
const { data: users, isLoading } = useQuery({
  queryKey: ['users'],
  queryFn: () => getUsers(),
  staleTime: 1000 * 60 * 5, // 5 åˆ†é’Ÿåæ ‡è®°ä¸ºè¿‡æœŸ
})

// å˜æ›´ï¼ˆä¿®æ”¹æ•°æ®ï¼‰
const { mutate: deleteUser } = useMutation({
  mutationFn: (userId: string) => deleteUserAction(userId),
  onSuccess: () => {
    // é‡æ–°è·å–åˆ—è¡¨
    queryClient.invalidateQueries({ queryKey: ['users'] })
  },
})

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
return (
  <button onClick={() => deleteUser(userId)}>
    åˆ é™¤
  </button>
)
```

### Zustand (UI State)

```typescript
import { create } from 'zustand'

// å®šä¹‰ Store
interface UIStore {
  sidebarOpen: boolean
  theme: 'light' | 'dark'
  notifications: Notification[]

  toggleSidebar: () => void
  setTheme: (theme: 'light' | 'dark') => void
  addNotification: (notification: Notification) => void
}

export const useUIStore = create<UIStore>((set) => ({
  sidebarOpen: true,
  theme: 'light',
  notifications: [],

  toggleSidebar: () =>
    set((state) => ({ sidebarOpen: !state.sidebarOpen })),

  setTheme: (theme) => set({ theme }),

  addNotification: (notification) =>
    set((state) => ({
      notifications: [...state.notifications, notification],
    })),
}))

// åœ¨ç»„ä»¶ä¸­ä½¿ç”¨
export function Sidebar() {
  const { sidebarOpen, toggleSidebar } = useUIStore()

  return (
    <aside className={sidebarOpen ? 'block' : 'hidden'}>
      <button onClick={toggleSidebar}>æ”¶èµ·</button>
    </aside>
  )
}
```

---

## é”™è¯¯å¤„ç†è®¾è®¡

### ä¸‰å±‚é”™è¯¯å¤„ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è¾“å…¥éªŒè¯        â”‚
â”‚    (Zod Schema)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ å¤±è´¥
    è¿”å› { error }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ä¸šåŠ¡é€»è¾‘        â”‚
â”‚    (ä¸šåŠ¡è§„åˆ™)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ å¤±è´¥
    è¿”å› { error }

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ç³»ç»Ÿé”™è¯¯        â”‚
â”‚    (try-catch)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ å¤±è´¥
    è¿”å›é”™è¯¯æ¶ˆæ¯
```

### å®ç°ç¤ºä¾‹

```typescript
export const updateProfile = userActionClient
  .schema(UpdateProfileSchema)  // ç¬¬1å±‚ï¼šè¾“å…¥éªŒè¯
  .action(async ({ parsedInput, ctx }) => {
    try {
      const { name, email } = parsedInput

      // ç¬¬2å±‚ï¼šä¸šåŠ¡é€»è¾‘éªŒè¯
      const existingEmail = await db.query.user.findFirst({
        where: eq(user.email, email),
      })

      if (existingEmail && existingEmail.id !== ctx.session.user.id) {
        return { error: 'é‚®ç®±å·²è¢«ä½¿ç”¨' }
      }

      // æ‰§è¡Œæ›´æ–°
      await db
        .update(user)
        .set({ name, email })
        .where(eq(user.id, ctx.session.user.id))

      return { success: true }
    } catch (error) {
      // ç¬¬3å±‚ï¼šç³»ç»Ÿé”™è¯¯
      console.error('æ›´æ–°å¤±è´¥:', error)
      return { error: 'æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' }
    }
  })
```

### é”™è¯¯å±•ç¤º

```typescript
'use client'

import { useActionState } from 'react'

export function UpdateProfileForm() {
  const [state, formAction] = useActionState(updateProfile, null)

  return (
    <form action={formAction}>
      <input type="text" name="name" />

      {/* é”™è¯¯å±•ç¤º */}
      {state?.error && (
        <div className="error-message">{state.error}</div>
      )}

      {/* æˆåŠŸæç¤º */}
      {state?.success && (
        <div className="success-message">æ›´æ–°æˆåŠŸï¼</div>
      )}

      <button type="submit">ä¿å­˜</button>
    </form>
  )
}
```

---

## ç±»å‹å®‰å…¨ç­–ç•¥

### End-to-End ç±»å‹æ£€æŸ¥

```
æ•°æ®åº“è¡¨
    â†“
Drizzle Schema ç±»å‹æ¨å¯¼
    â†“
Server Action å‚æ•°/è¿”å›ç±»å‹
    â†“
API å“åº”ç±»å‹
    â†“
React ç»„ä»¶ Props ç±»å‹
    â†“
UI å®Œå…¨ç±»å‹å®‰å…¨
```

### å®ç°æ–¹å¼

```typescript
// 1. Database Schema
const user = pgTable('user', {
  id: text('id').primaryKey(),
  name: text('name').notNull(),
  email: text('email').notNull().unique(),
})

// 2. æ¨å¯¼ç±»å‹
type User = typeof user.$inferSelect
type NewUser = typeof user.$inferInsert

// 3. Server Action ç±»å‹
const UpdateUserSchema = z.object({
  name: z.string(),
  email: z.string().email(),
})

type UpdateUserInput = z.infer<typeof UpdateUserSchema>
type UpdateUserResult = { success: true } | { error: string }

export const updateUser = userActionClient
  .schema(UpdateUserSchema)
  .action(async ({ parsedInput }): Promise<UpdateUserResult> => {
    // å®Œå…¨ç±»å‹å®‰å…¨
  })

// 4. React Component Props
interface UserFormProps {
  user: User
  onUpdate: (data: UpdateUserInput) => Promise<UpdateUserResult>
}

export function UserForm({ user, onUpdate }: UserFormProps) {
  // TypeScript ä¼šæ£€æŸ¥æ‰€æœ‰ç±»å‹
}

// 5. Hook è¿”å›ç±»å‹
function useUser(id: string): {
  user: User | null
  updateUser: (data: UpdateUserInput) => Promise<UpdateUserResult>
} {
  // å®Œæ•´çš„ç±»å‹ä¿¡æ¯
}
```

---

## æ€§èƒ½ä¼˜åŒ–æ€æƒ³

### æ ¸å¿ƒåŸåˆ™

1. **å‡å°‘ JavaScript** - ä½¿ç”¨ Server Components
2. **ä»£ç åˆ†å‰²** - åŠ¨æ€å¯¼å…¥é‡é‡çº§ç»„ä»¶
3. **ç¼“å­˜ç­–ç•¥** - ISR å’Œ React Query
4. **å›¾ç‰‡ä¼˜åŒ–** - Next.js Image ç»„ä»¶
5. **ç›‘æ§æŒ‡æ ‡** - Core Web Vitals

### å®ç°ç¤ºä¾‹

```typescript
// 1. Server Componentsï¼ˆé»˜è®¤ï¼‰
// âœ… æ²¡æœ‰ JavaScript å‘é€åˆ°æµè§ˆå™¨

// 2. åŠ¨æ€å¯¼å…¥
'use client'

const HeavyComponent = dynamic(() => import('./heavy'), {
  loading: () => <Skeleton />,
  ssr: false, // ä»…åœ¨å®¢æˆ·ç«¯åŠ è½½
})

// 3. ISRï¼ˆå¢é‡é™æ€å†ç”Ÿæˆï¼‰
export const revalidate = 3600 // 1 å°æ—¶åé‡æ–°ç”Ÿæˆ

export default async function Blog() {
  const posts = await db.query.post.findMany()
  return <PostList posts={posts} />
}

// 4. å›¾ç‰‡ä¼˜åŒ–
import Image from 'next/image'

<Image
  src="/blog/cover.jpg"
  alt="æ–‡ç« å°é¢"
  width={1200}
  height={630}
  priority // ä¼˜å…ˆåŠ è½½
/>

// 5. React Query ç¼“å­˜
const { data } = useQuery({
  queryKey: ['posts'],
  queryFn: () => getPosts(),
  staleTime: 1000 * 60 * 10, // 10 åˆ†é’Ÿç¼“å­˜
})
```

---

## æ€»ç»“

mk-saas-blog çš„è®¾è®¡éµå¾ªä»¥ä¸‹æ ¸å¿ƒæ€æƒ³:

âœ… **æ¸…æ™°åˆ†å±‚** - æ¯å±‚èŒè´£æ˜ç¡®
âœ… **ç±»å‹å®‰å…¨** - ç¼–è¯‘æ—¶é”™è¯¯æ£€æŸ¥
âœ… **æƒé™ä¸¥æ ¼** - æœ€å°æƒé™åŸåˆ™
âœ… **é˜²å¾¡æ€§** - ä¸ä¿¡ä»»è¾“å…¥
âœ… **é«˜æ€§èƒ½** - å‡å°‘ JavaScript
âœ… **æ˜“ç»´æŠ¤** - DRY å’Œæ¨¡å¼åŒ–

é€šè¿‡è¿™äº›è®¾è®¡ï¼Œé¡¹ç›®æ—¢ä¿è¯äº†å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œåˆæä¾›äº†è‰¯å¥½çš„å¼€å‘ä½“éªŒã€‚

---

**ç›¸å…³æ–‡æ¡£:**
- [äº”å±‚æ¶æ„è¯¦è§£](./äº”å±‚æ¶æ„è¯¦è§£.md)
- [æ¦‚å¿µæ¾„æ¸…](./æ¦‚å¿µæ¾„æ¸….md)

**æœ€åæ›´æ–°:** 2025-11-18
