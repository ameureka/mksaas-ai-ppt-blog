# QA-14.0 LLM APIä½¿ç”¨å’Œé™æµ

## ğŸ“‹ é—®é¢˜
é’ˆå¯¹å¤§æ¨¡å‹ï¼Œé¡¹ç›®LLM APIæ˜¯å¦‚ä½•ä½¿ç”¨ï¼Œæ˜¯å¦æœ‰LLM APIé™æµï¼Ÿ

## âœ… å›ç­”

é¡¹ç›®é›†æˆäº† **å¤šä¸ªå¤§æ¨¡å‹æä¾›å•†**ï¼Œä½¿ç”¨ **Vercel AI SDK** ç»Ÿä¸€ç®¡ç†ï¼Œå®æ–½äº†**è¶…æ—¶æ§åˆ¶**ä½†**æœªå®æ–½é€Ÿç‡é™åˆ¶**ï¼ˆå»ºè®®æ·»åŠ ï¼‰ã€‚

### ğŸ¤– æ”¯æŒçš„ LLM æä¾›å•†

#### ä¾èµ–æ¸…å•

**æ–‡ä»¶**: `package.json`

```json
{
  "ai": "^5.0.0",                                      // Vercel AI SDK æ ¸å¿ƒ
  "@ai-sdk/openai": "^2.0.0",                         // OpenAI
  "@ai-sdk/google": "^2.0.0",                         // Google Gemini
  "@ai-sdk/replicate": "^1.0.0",                      // Replicate
  "@ai-sdk/fireworks": "^1.0.0",                      // Fireworks AI
  "@ai-sdk/fal": "^1.0.0",                            // FAL
  "@ai-sdk/deepseek": "^1.0.0",                       // DeepSeek
  "@ai-sdk/react": "^2.0.22",                         // React Hooks
  "@openrouter/ai-sdk-provider": "^1.0.0-beta.6"      // OpenRouter (100+ æ¨¡å‹)
}
```

**æ¥æº**: `package.json:29-35,48,91`

#### ç¯å¢ƒå˜é‡é…ç½®

**æ–‡ä»¶**: `env.example`

```bash
# AI æ¨¡å‹ API å¯†é’¥
AI_GATEWAY_API_KEY=""                # AI Gateway (å¯é€‰)
FAL_API_KEY=""                       # FAL
FIREWORKS_API_KEY=""                 # Fireworks AI
OPENAI_API_KEY=""                    # OpenAI
REPLICATE_API_TOKEN=""               # Replicate
GOOGLE_GENERATIVE_AI_API_KEY=""      # Google Gemini
DEEPSEEK_API_KEY=""                  # DeepSeek
OPENROUTER_API_KEY=""                # OpenRouter

# ç½‘é¡µå†…å®¹åˆ†æ
FIRECRAWL_API_KEY=""                 # Firecrawl
```

**æ¥æº**: `env.example`

### ğŸ’¬ LLM API ä½¿ç”¨æ–¹å¼

#### 1. AI èŠå¤© API

**æ–‡ä»¶**: `src/app/api/chat/route.ts`

```typescript
import { openai } from '@ai-sdk/openai';
import { google } from '@ai-sdk/google';
import { deepseek } from '@ai-sdk/deepseek';
import { streamText } from 'ai';

// è¶…æ—¶é…ç½®
export const maxDuration = 30;  // 30 ç§’è¶…æ—¶

export async function POST(req: Request) {
  const { messages, model, webSearch } = await req.json();

  // 1. é€‰æ‹©æ¨¡å‹
  let selectedModel;
  if (model.startsWith('gpt-')) {
    selectedModel = openai(model);
  } else if (model.startsWith('gemini-')) {
    selectedModel = google(model);
  } else if (model.startsWith('deepseek-')) {
    selectedModel = deepseek(model);
  }

  // 2. å¯é€‰ Web Searchï¼ˆPerplexity Sonarï¼‰
  if (webSearch) {
    const perplexity = openrouter('perplexity/sonar-pro');
    selectedModel = perplexity;
  }

  // 3. æµå¼å“åº”
  const result = streamText({
    model: selectedModel,
    messages,
    temperature: 0.7,
    maxTokens: 4096,
    onFinish: async ({ usage, text }) => {
      // è®°å½•ä½¿ç”¨æƒ…å†µ
      console.log(`Tokens used: ${usage.totalTokens}`);
    }
  });

  // 4. è¿”å›æµ
  return result.toDataStreamResponse({
    sendSources: webSearch,      // å‘é€æ¥æºä¿¡æ¯
    sendReasoning: true          // å‘é€æ¨ç†è¿‡ç¨‹
  });
}
```

**æ¥æº**: `src/app/api/chat/route.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

**å…³é”®ç‰¹æ€§**:
- âœ… æµå¼å“åº”ï¼ˆServer-Sent Eventsï¼‰
- âœ… å¤šæ¨¡å‹æ”¯æŒ
- âœ… Web Search é›†æˆï¼ˆPerplexity Sonarï¼‰
- âœ… Token ä½¿ç”¨è¿½è¸ª
- âœ… 30 ç§’è¶…æ—¶

#### 2. AI å›¾ç‰‡ç”Ÿæˆ API

**æ–‡ä»¶**: `src/app/api/generate-images/route.ts`

```typescript
import { openai } from '@ai-sdk/openai';
import { fireworks } from '@ai-sdk/fireworks';
import { replicate } from '@ai-sdk/replicate';
import { fal } from '@ai-sdk/fal';
import { generateImage } from 'ai';

const TIMEOUT = 55000;  // 55 ç§’è¶…æ—¶

export async function POST(req: Request) {
  const { prompt, provider, modelId, options } = await req.json();

  const requestId = nanoid();
  console.log(`[${requestId}] Starting image generation`);

  try {
    // 1. é€‰æ‹©æä¾›å•†å’Œæ¨¡å‹
    let model;
    switch (provider) {
      case 'openai':
        model = openai.image(modelId);  // dall-e-3
        break;
      case 'fireworks':
        model = fireworks.image(modelId);
        break;
      case 'replicate':
        model = replicate.image(modelId);  // flux-schnell
        break;
      case 'fal':
        model = fal.image(modelId);  // flux/dev
        break;
    }

    // 2. è¶…æ—¶æ§åˆ¶
    const imagePromise = generateImage({
      model,
      prompt,
      size: options.size,
      aspectRatio: options.aspectRatio,
      n: options.numImages || 1
    });

    const timeoutPromise = new Promise((_, reject) => {
      setTimeout(() => reject(new Error('Timeout')), TIMEOUT);
    });

    // 3. ç«é€Ÿæ‰§è¡Œ
    const result = await Promise.race([imagePromise, timeoutPromise]);

    console.log(`[${requestId}] Completed successfully`);

    return Response.json({
      images: result.images,
      timestamp: Date.now(),
      requestId
    });

  } catch (error) {
    console.error(`[${requestId}] Failed`, error);

    return Response.json(
      { error: 'Image generation failed' },
      { status: 500 }
    );
  }
}
```

**æ¥æº**: `src/app/api/generate-images/route.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

**å…³é”®ç‰¹æ€§**:
- âœ… å¤šæä¾›å•†æ”¯æŒï¼ˆOpenAI, Fireworks, Replicate, FALï¼‰
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ55 ç§’ï¼‰
- âœ… è¯·æ±‚ ID è¿½è¸ª
- âœ… é”™è¯¯å¤„ç†

#### 3. ç½‘é¡µå†…å®¹åˆ†æ API

**æ–‡ä»¶**: `src/app/api/analyze-content/route.ts`

```typescript
import FirecrawlApp from '@mendable/firecrawl-js';

export async function POST(req: Request) {
  const { url } = await req.json();

  // 1. ä½¿ç”¨ Firecrawl æŠ“å–ç½‘é¡µ
  const firecrawl = new FirecrawlApp({
    apiKey: process.env.FIRECRAWL_API_KEY!
  });

  const scrapeResult = await firecrawl.scrapeUrl(url, {
    formats: ['markdown', 'html']
  });

  // 2. ä½¿ç”¨ LLM åˆ†æå†…å®¹ï¼ˆå¯é€‰ï¼‰
  // const analysis = await streamText({
  //   model: openai('gpt-4-turbo'),
  //   prompt: `Analyze this content: ${scrapeResult.markdown}`
  // });

  return Response.json({
    content: scrapeResult.markdown,
    metadata: scrapeResult.metadata
  });
}
```

**æ¥æº**: `src/app/api/analyze-content/route.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

### â±ï¸ è¶…æ—¶å’Œé™åˆ¶

#### 1. API è¶…æ—¶é…ç½®

**èŠå¤© API**:
```typescript
export const maxDuration = 30;  // 30 ç§’
```

**å›¾ç‰‡ç”Ÿæˆ API**:
```typescript
const TIMEOUT = 55000;  // 55 ç§’
```

**æ‰€æœ‰ APIï¼ˆVercel å…¨å±€ï¼‰**:
```json
{
  "functions": {
    "src/app/api/**/*": {
      "maxDuration": 300  // 5 åˆ†é’Ÿï¼ˆVercel Proï¼‰
    }
  }
}
```

**æ¥æº**: `src/app/api/chat/route.ts`, `src/app/api/generate-images/route.ts`, `vercel.json`

#### 2. Token é™åˆ¶

**èŠå¤© API**:
```typescript
streamText({
  maxTokens: 4096,  // æœ€å¤§è¾“å‡º token
  temperature: 0.7
})
```

**æˆæœ¬è€ƒè™‘**:
- GPT-4 Turbo: $10/1M input tokens, $30/1M output tokens
- GPT-3.5 Turbo: $0.5/1M input tokens, $1.5/1M output tokens
- Gemini Pro: å…è´¹ï¼ˆé…é¢å†…ï¼‰

### ğŸš« é™æµæœºåˆ¶ï¼ˆå½“å‰çŠ¶æ€ï¼‰

#### å½“å‰å®æ–½

**å·²å®æ–½**:
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ30-55 ç§’ï¼‰
- âœ… è¯·æ±‚ ID è¿½è¸ª
- âœ… é”™è¯¯æ—¥å¿—è®°å½•

**æœªå®æ–½**:
- âŒ API é€Ÿç‡é™åˆ¶
- âŒ ç”¨æˆ·é…é¢ç®¡ç†
- âŒ è¯·æ±‚é˜Ÿåˆ—
- âŒ é‡è¯•æœºåˆ¶

#### å»ºè®®å®æ–½

**1. åŸºäº IP çš„é€Ÿç‡é™åˆ¶**:

```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(
    10,      // 10 æ¬¡è¯·æ±‚
    '1 m'    // æ¯ 1 åˆ†é’Ÿ
  )
});

export async function POST(req: Request) {
  const ip = req.headers.get('x-forwarded-for') || 'unknown';
  const { success, limit, remaining } = await ratelimit.limit(ip);

  if (!success) {
    return Response.json(
      {
        error: 'Too many requests',
        limit,
        remaining,
        resetAt: new Date(Date.now() + 60000).toISOString()
      },
      { status: 429 }
    );
  }

  // å¤„ç†è¯·æ±‚
}
```

**æˆæœ¬**: Upstash Redis å…è´¹å±‚ 10k å‘½ä»¤/å¤©

**2. åŸºäºç”¨æˆ·çš„é…é¢ç®¡ç†**:

```typescript
import { getUserCredits, consumeCredits } from '@/credits/credits';

export async function POST(req: Request) {
  const session = await getSession();
  if (!session?.user) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // 1. æ£€æŸ¥ç§¯åˆ†
  const credits = await getUserCredits(session.user.id);
  if (credits.currentCredits < 1) {
    return Response.json(
      { error: 'Insufficient credits' },
      { status: 402 }
    );
  }

  // 2. è°ƒç”¨ AI API
  const result = await streamText(...);

  // 3. æ¶ˆè´¹ç§¯åˆ†
  await consumeCredits({
    userId: session.user.id,
    amount: 1,
    description: 'AI chat message'
  });

  return result.toDataStreamResponse();
}
```

**ä¼˜åŠ¿**:
- ç²¾ç¡®æ§åˆ¶æˆæœ¬
- å…¬å¹³åˆ†é…èµ„æº
- é¼“åŠ±ä»˜è´¹

**3. è¯·æ±‚é˜Ÿåˆ—ï¼ˆé«˜æµé‡åœºæ™¯ï¼‰**:

```typescript
import { Queue } from 'bullmq';
import { Redis } from 'ioredis';

const imageQueue = new Queue('image-generation', {
  connection: new Redis(process.env.REDIS_URL!)
});

export async function POST(req: Request) {
  const { prompt, provider, modelId } = await req.json();

  // æ·»åŠ åˆ°é˜Ÿåˆ—
  const job = await imageQueue.add('generate', {
    prompt,
    provider,
    modelId
  });

  return Response.json({
    jobId: job.id,
    status: 'queued'
  });
}

// æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
export async function GET(req: Request) {
  const jobId = req.url.searchParams.get('jobId');
  const job = await imageQueue.getJob(jobId);

  return Response.json({
    status: await job.getState(),
    result: job.returnvalue
  });
}
```

**æˆæœ¬**: Upstash Redis $10-50/æœˆ

### ğŸ“Š LLM æˆæœ¬ä¼˜åŒ–

#### 1. æ¨¡å‹é€‰æ‹©ç­–ç•¥

```typescript
// æ™ºèƒ½è·¯ç”±ï¼šæ ¹æ®å¤æ‚åº¦é€‰æ‹©æ¨¡å‹
function selectModel(complexity: 'simple' | 'complex') {
  if (complexity === 'simple') {
    return openai('gpt-3.5-turbo');  // ä¾¿å®œ
  } else {
    return openai('gpt-4-turbo');    // å¼ºå¤§
  }
}
```

#### 2. ç¼“å­˜å“åº”

```typescript
import { Redis } from '@upstash/redis';

const redis = Redis.fromEnv();

export async function POST(req: Request) {
  const { prompt } = await req.json();

  // 1. æ£€æŸ¥ç¼“å­˜
  const cacheKey = `ai:${hashPrompt(prompt)}`;
  const cached = await redis.get(cacheKey);

  if (cached) {
    console.log('Cache hit');
    return Response.json(cached);
  }

  // 2. è°ƒç”¨ AI API
  const result = await streamText(...);

  // 3. ç¼“å­˜ç»“æœï¼ˆ1 å°æ—¶ï¼‰
  await redis.set(cacheKey, result, { ex: 3600 });

  return Response.json(result);
}
```

#### 3. Token ä½¿ç”¨è¿½è¸ª

```typescript
onFinish: async ({ usage, text }) => {
  // è®°å½•åˆ°æ•°æ®åº“
  await db.insert(aiUsageTable).values({
    userId: session.user.id,
    model: 'gpt-4-turbo',
    inputTokens: usage.promptTokens,
    outputTokens: usage.completionTokens,
    totalTokens: usage.totalTokens,
    cost: calculateCost(usage),
    createdAt: new Date()
  });
}
```

### ğŸ” ç›‘æ§å’Œè¿½è¸ª

#### 1. è¯·æ±‚ ID è¿½è¸ª

```typescript
const requestId = nanoid();
console.log(`[${requestId}] Starting request`);

// ... å¤„ç†è¯·æ±‚

console.log(`[${requestId}] Completed`);
```

**æ¥æº**: `src/app/api/generate-images/route.ts`

#### 2. é”™è¯¯å¤„ç†

```typescript
try {
  const result = await generateImage(...);
} catch (error) {
  console.error(`[${requestId}] Failed`, error);

  // å‘é€å‘Šè­¦
  await sendDiscordNotification({
    title: 'AI API Error',
    description: error.message
  });

  return Response.json(
    { error: 'Generation failed' },
    { status: 500 }
  );
}
```

#### 3. ä½¿ç”¨ç»Ÿè®¡

**æ¨èæ·»åŠ **:
- æ¯æ—¥è¯·æ±‚æ•°
- å¹³å‡å“åº”æ—¶é—´
- é”™è¯¯ç‡
- Token ä½¿ç”¨é‡
- æˆæœ¬è¿½è¸ª

### ğŸ¯ LLM æœ€ä½³å®è·µ

#### å·²å®æ–½

1. âœ… **å¤šæä¾›å•†** - é¿å…å•ç‚¹ä¾èµ–
2. âœ… **æµå¼å“åº”** - æ”¹å–„ç”¨æˆ·ä½“éªŒ
3. âœ… **è¶…æ—¶æ§åˆ¶** - é¿å…é•¿æ—¶é—´ç­‰å¾…
4. âœ… **é”™è¯¯å¤„ç†** - ä¼˜é›…é™çº§
5. âœ… **è¯·æ±‚è¿½è¸ª** - ä¾¿äºè°ƒè¯•

#### å»ºè®®å®æ–½

1. ğŸ”„ **é€Ÿç‡é™åˆ¶** - IP æˆ–ç”¨æˆ·çº§åˆ«
2. ğŸ”„ **ç§¯åˆ†ç³»ç»Ÿ** - æˆæœ¬æ§åˆ¶
3. ğŸ”„ **å“åº”ç¼“å­˜** - é™ä½æˆæœ¬
4. ğŸ”„ **ä½¿ç”¨è¿½è¸ª** - ç»Ÿè®¡å’Œåˆ†æ
5. ğŸ”„ **è¯·æ±‚é˜Ÿåˆ—** - é«˜æµé‡åœºæ™¯
6. ğŸ”„ **é‡è¯•æœºåˆ¶** - æé«˜å¯é æ€§

### ğŸ“Š LLM ä½¿ç”¨åœºæ™¯æ€»ç»“

| åŠŸèƒ½ | æä¾›å•† | æ¨¡å‹ | æˆæœ¬ä¼°ç®— | é™æµ |
|------|--------|------|---------|------|
| AI èŠå¤© | OpenAI/Google/DeepSeek | GPT-4/Gemini | $0.03/1k tokens | âŒ æœªå®æ–½ |
| å›¾ç‰‡ç”Ÿæˆ | OpenAI/Replicate/FAL | DALL-E 3/Flux | $0.04-0.12/å¼  | âŒ æœªå®æ–½ |
| ç½‘é¡µåˆ†æ | Firecrawl + LLM | GPT-4 | $0.01/é¡µ | âŒ æœªå®æ–½ |

**æˆæœ¬ä¼˜åŒ–å»ºè®®**:
- å®æ–½ç§¯åˆ†ç³»ç»Ÿï¼ˆå·²æœ‰ä»£ç ï¼‰
- æ·»åŠ é€Ÿç‡é™åˆ¶ï¼ˆå»ºè®®ä½¿ç”¨ Upstashï¼‰
- ç¼“å­˜å¸¸è§è¯·æ±‚ï¼ˆå»ºè®®ä½¿ç”¨ Redisï¼‰

## ğŸ“ ä¿¡æ¯æ¥æº
- `package.json` - AI SDK ä¾èµ–
- `env.example` - API å¯†é’¥é…ç½®
- `src/app/api/chat/route.ts` - èŠå¤© API å®ç°
- `src/app/api/generate-images/route.ts` - å›¾ç‰‡ç”Ÿæˆ API å®ç°
- `src/app/api/analyze-content/route.ts` - å†…å®¹åˆ†æ API å®ç°
- `vercel.json` - è¶…æ—¶é…ç½®
- Vercel AI SDK å®˜æ–¹æ–‡æ¡£ - ä½¿ç”¨æŒ‡å—
- OpenAI / Google / Replicate å®˜æ–¹æ–‡æ¡£ - å®šä»·
