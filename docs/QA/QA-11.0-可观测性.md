# QA-11.0 可观测性

## 📋 问题
项目可观测性是什么？

## ✅ 回答

项目集成了多种**分析和监控工具**，提供全面的可观测性支持，但默认为可选配置。

### 📊 支持的分析提供商

项目支持 **9+ 种分析工具**，采用模块化配置，可根据需求选择启用。

#### 1. PostHog（用户行为分析）

**功能**:
- ✅ 事件追踪
- ✅ Session Replay（会话回放）
- ✅ Feature Flags（功能开关）
- ✅ A/B 测试
- ✅ 用户漏斗分析

**配置**: `package.json`

```json
{
  "posthog-js": "^1.261.7"
}
```

**环境变量**: `env.example`

```bash
NEXT_PUBLIC_POSTHOG_KEY=""
NEXT_PUBLIC_POSTHOG_HOST=""
```

**来源**: `package.json`, `env.example`

**免费层**: 100 万事件/月

#### 2. Vercel Analytics（性能分析）

**功能**:
- ✅ Web Vitals 监控（FCP, LCP, CLS, FID, TTFB）
- ✅ Real User Monitoring (RUM)
- ✅ 边缘函数执行时间
- ✅ 地理位置分布

**配置**: `src/config/website.tsx`

```typescript
analytics: {
  enableVercelAnalytics: false,  // 默认禁用
  enableSpeedInsights: false     // 默认禁用
}
```

**依赖**: `package.json`

```json
{
  "@vercel/analytics": "^1.5.0",
  "@vercel/speed-insights": "^1.2.0"
}
```

**来源**: `src/config/website.tsx`, `package.json`

**免费层**: 2500 个数据点/月（Hobby 计划）

#### 3. Google Analytics

**功能**:
- ✅ 流量分析
- ✅ 用户路径
- ✅ 转化追踪
- ✅ 电商追踪

**环境变量**:

```bash
NEXT_PUBLIC_GOOGLE_ANALYTICS_ID=""
```

**来源**: `env.example`

#### 4. Umami Analytics（隐私友好）

**功能**:
- ✅ 自托管选项
- ✅ GDPR 合规
- ✅ 无 Cookie
- ✅ 实时数据

**环境变量**:

```bash
NEXT_PUBLIC_UMAMI_WEBSITE_ID=""
NEXT_PUBLIC_UMAMI_SCRIPT="https://cloud.umami.is/script.js"
```

**来源**: `env.example`

#### 5. OpenPanel Analytics（开源）

**功能**:
- ✅ 开源
- ✅ 隐私优先
- ✅ 实时仪表板

**环境变量**:

```bash
NEXT_PUBLIC_OPENPANEL_CLIENT_ID=""
```

**来源**: `env.example`

**依赖**: `package.json`

```json
{
  "@openpanel/nextjs": "^1.0.7"
}
```

**来源**: `package.json`

#### 6. Plausible Analytics（简单分析）

**功能**:
- ✅ 轻量级（< 1KB）
- ✅ 隐私友好
- ✅ 简单易用

**环境变量**:

```bash
NEXT_PUBLIC_PLAUSIBLE_DOMAIN=""
NEXT_PUBLIC_PLAUSIBLE_SCRIPT="https://plausible.io/js/script.js"
```

**来源**: `env.example`

#### 7. Ahrefs Analytics（SEO）

**功能**:
- ✅ SEO 分析
- ✅ 关键词追踪
- ✅ 流量来源

**环境变量**:

```bash
NEXT_PUBLIC_AHREFS_WEBSITE_ID=""
```

**来源**: `env.example`

#### 8. Seline Analytics

**环境变量**:

```bash
NEXT_PUBLIC_SELINE_TOKEN=""
```

**来源**: `env.example`

#### 9. DataFast Analytics（收入追踪）

**功能**:
- ✅ 收入归因
- ✅ 用户价值分析

**环境变量**:

```bash
NEXT_PUBLIC_DATAFAST_WEBSITE_ID=""
NEXT_PUBLIC_DATAFAST_DOMAIN=""
```

**配置**: `src/config/website.tsx`

```typescript
features: {
  enableDatafastRevenueTrack: false  // 默认禁用
}
```

**来源**: `env.example`, `src/config/website.tsx`

#### 10. Microsoft Clarity（热力图）

**功能**:
- ✅ Session Replay
- ✅ 热力图
- ✅ 滚动分析
- ✅ 点击追踪

**环境变量**:

```bash
NEXT_PUBLIC_CLARITY_PROJECT_ID=""
```

**来源**: `env.example`

### 🔔 通知和告警

#### 1. Discord Webhook

**功能**:
- ✅ 支付通知
- ✅ 新用户注册
- ✅ 错误告警

**实现**: `src/notification/discord.ts`

```typescript
export async function sendDiscordNotification(
  sessionId: string,
  customerId: string,
  userName: string,
  amount: number
) {
  const webhookUrl = process.env.DISCORD_WEBHOOK_URL;
  if (!webhookUrl) return;

  const message = {
    embeds: [{
      title: '💰 New Payment Received',
      description: `User **${userName}** paid **$${amount}**`,
      color: 0x00ff00,
      fields: [
        { name: 'Customer ID', value: customerId, inline: true },
        { name: 'Session ID', value: sessionId, inline: true }
      ],
      timestamp: new Date().toISOString()
    }]
  };

  await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(message)
  });
}
```

**环境变量**:

```bash
DISCORD_WEBHOOK_URL=""
```

**来源**: `src/notification/discord.ts`, `env.example`

#### 2. 飞书 Webhook（Feishu）

**功能**:
- ✅ 支付通知
- ✅ 系统告警

**实现**: `src/notification/feishu.ts`

```typescript
export async function sendFeishuNotification(
  sessionId: string,
  customerId: string,
  userName: string,
  amount: number
) {
  const webhookUrl = process.env.FEISHU_WEBHOOK_URL;
  if (!webhookUrl) return;

  const message = {
    msg_type: 'text',
    content: {
      text: `💰 收到新支付\n用户: ${userName}\n金额: $${amount}\n客户ID: ${customerId}\n会话ID: ${sessionId}`
    }
  };

  await fetch(webhookUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(message)
  });
}
```

**环境变量**:

```bash
FEISHU_WEBHOOK_URL=""
```

**来源**: `src/notification/feishu.ts`, `env.example`

**调用场景**: `src/payment/provider/stripe.ts`

```typescript
// 支付成功后发送通知
await sendNotification(
  checkoutSession.id,
  checkoutSession.customer as string,
  checkoutSession.customer_details?.name || 'Unknown',
  checkoutSession.amount_total! / 100
);
```

**来源**: 基于项目逻辑推测

### 📝 日志记录

#### 1. 控制台日志

**策略**: 结构化日志

```typescript
// 成功日志
console.log('[Payment] Invoice paid:', invoiceId);

// 错误日志
console.error('[Payment] Failed to process:', error);

// 调试日志（开发环境）
if (process.env.NODE_ENV === 'development') {
  console.debug('[Debug] Session data:', session);
}
```

**来源**: 项目代码模式

#### 2. Vercel 日志

**访问**: Vercel Dashboard → Project → Logs

**功能**:
- ✅ 实时日志流
- ✅ 按时间筛选
- ✅ 按严重程度筛选
- ✅ 搜索功能

**保留时间**:
- Hobby: 1 小时
- Pro: 7 天

#### 3. 错误追踪（未实施，建议）

**推荐工具**:
- **Sentry** - 完整的错误监控
- **Rollbar** - 实时错误追踪
- **Bugsnag** - 错误分析

**实施示例** (Sentry):

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
  environment: process.env.NODE_ENV
});
```

### 🔍 监控指标

#### 应用性能指标

**Web Vitals** (Vercel Analytics):
- **FCP** (First Contentful Paint) - 首次内容绘制
- **LCP** (Largest Contentful Paint) - 最大内容绘制
- **CLS** (Cumulative Layout Shift) - 累积布局偏移
- **FID** (First Input Delay) - 首次输入延迟
- **TTFB** (Time to First Byte) - 首字节时间

**来源**: Vercel Analytics 文档

#### 用户行为指标

**PostHog 事件**:
- 页面浏览
- 用户注册
- 支付完成
- AI 功能使用
- 订阅变更

**自定义事件示例**:

```typescript
import { usePostHog } from 'posthog-js/react';

const posthog = usePostHog();

// 追踪支付
posthog?.capture('payment_completed', {
  plan: 'pro',
  amount: 9.90,
  currency: 'USD'
});

// 追踪 AI 使用
posthog?.capture('ai_image_generated', {
  provider: 'openai',
  model: 'dall-e-3'
});
```

#### 业务指标

**关键指标**:
- 日活跃用户 (DAU)
- 月活跃用户 (MAU)
- 付费转化率
- 用户留存率
- 平均收入 (ARPU)
- 客户终身价值 (LTV)
- 流失率

**数据来源**: PostHog / Google Analytics

### 🎯 可观测性策略

#### 三大支柱

1. **日志 (Logging)**
   - ✅ Vercel 日志
   - ✅ 结构化日志
   - 🔄 考虑添加 Sentry

2. **指标 (Metrics)**
   - ✅ Vercel Analytics（性能）
   - ✅ PostHog（用户行为）
   - ✅ 多分析提供商

3. **追踪 (Tracing)**
   - ✅ 请求 ID 追踪（AI API）
   - 🔄 考虑添加 OpenTelemetry

#### 监控仪表板

**推荐设置**:
- **PostHog**: 用户行为和产品分析
- **Vercel**: 性能和错误监控
- **Discord/飞书**: 实时告警
- **Google Analytics**: 流量分析

### 💡 可观测性最佳实践

1. **分层监控**
   - 基础层: Vercel 日志 + Discord 通知
   - 进阶层: PostHog + Google Analytics
   - 专业层: 添加 Sentry + OpenTelemetry

2. **告警策略**
   - 💰 支付成功: Discord/飞书通知
   - ⚠️ 支付失败: Discord/飞书通知 + 错误日志
   - 🔴 系统错误: Sentry 告警
   - 📊 异常流量: PostHog 告警

3. **数据隐私**
   - 使用隐私友好的分析工具（Umami, Plausible）
   - PostHog 自托管选项
   - GDPR 合规考虑

4. **成本优化**
   - 免费层优先（PostHog, Vercel, Google Analytics）
   - 按需启用（默认禁用大部分分析）
   - 采样策略（追踪 10% 的请求）

### 📊 可观测性对比

| 工具 | 类型 | 免费层 | 推荐场景 |
|------|------|--------|---------|
| PostHog | 用户行为 | 100 万事件/月 | 产品分析 |
| Vercel Analytics | 性能 | 2500 数据点/月 | 性能监控 |
| Google Analytics | 流量 | 无限制 | 流量分析 |
| Umami | 隐私友好 | 自托管免费 | GDPR 合规 |
| Clarity | 会话回放 | 无限制 | UX 优化 |
| Discord | 通知 | 无限制 | 实时告警 |

## 📍 信息来源
- `package.json` - 分析工具依赖
- `env.example` - 分析工具配置
- `src/config/website.tsx` - 功能开关
- `src/notification/` - 通知实现
- Vercel / PostHog 官方文档 - 功能和定价
