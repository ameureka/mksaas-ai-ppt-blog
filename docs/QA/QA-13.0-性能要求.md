# QA-13.0 é¡¹ç›®æ€§èƒ½è¦æ±‚

## ğŸ“‹ é—®é¢˜
é¡¹ç›®æ€§èƒ½è¦æ±‚å¦‚ä½•ï¼Ÿ

## âœ… å›ç­”

é¡¹ç›®é€šè¿‡é…ç½®ã€æ¶æ„è®¾è®¡å’Œæœ€ä½³å®è·µå®ç°äº†é«˜æ€§èƒ½è¦æ±‚ï¼Œä½†æ²¡æœ‰æ˜ç¡®çš„ç¡¬æ€§æŒ‡æ ‡æ–‡æ¡£ã€‚ä»¥ä¸‹æ˜¯åŸºäºä»£ç åˆ†æå¾—å‡ºçš„æ€§èƒ½è¦æ±‚å’Œä¼˜åŒ–æªæ–½ã€‚

### âš¡ æ¨æµ‹çš„æ€§èƒ½ç›®æ ‡

åŸºäº Next.js 15 å’Œç°ä»£æ¶æ„ï¼Œæ¨æµ‹çš„æ€§èƒ½ç›®æ ‡ï¼š

| æ€§èƒ½æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®ç°æ–¹å¼ |
|---------|--------|---------|
| é¡µé¢åŠ è½½æ—¶é—´ï¼ˆFCPï¼‰ | < 1.5 ç§’ | Next.js SSR + è¾¹ç¼˜æ¸²æŸ“ |
| äº¤äº’å“åº”æ—¶é—´ï¼ˆTTIï¼‰ | < 2.5 ç§’ | React 18 Streaming |
| API å“åº”æ—¶é—´ | < 500ms | Server Actions + æ•°æ®åº“ç´¢å¼• |
| AI èŠå¤©å“åº” | < 3 ç§’ï¼ˆé¦–å­—ï¼‰ | æµå¼å“åº” |
| AI å›¾ç‰‡ç”Ÿæˆ | < 30 ç§’ | å¤šæä¾›å•† + è¶…æ—¶æ§åˆ¶ |
| æœç´¢å“åº”æ—¶é—´ | < 200ms | Fumadocs å…¨æ–‡ç´¢å¼• |
| å¹¶å‘ç”¨æˆ·æ•° | > 1000 | Vercel è¾¹ç¼˜ç½‘ç»œè‡ªåŠ¨æ‰©å±• |

### ğŸš€ æ€§èƒ½ä¼˜åŒ–æªæ–½

#### 1. æœåŠ¡ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰å’Œé™æ€ç”Ÿæˆ

**Next.js 15 App Router æ¶æ„**:

```typescript
// é™æ€é¡µé¢ï¼ˆæ„å»ºæ—¶ç”Ÿæˆï¼‰
// src/app/[locale]/(marketing)/(home)/page.tsx
export default async function HomePage() {
  // é™æ€ç”Ÿæˆï¼Œæå¿«åŠ è½½
  return <HomePage />;
}

// åŠ¨æ€é¡µé¢ï¼ˆæœåŠ¡ç«¯æ¸²æŸ“ï¼‰
// src/app/[locale]/(protected)/dashboard/page.tsx
export default async function DashboardPage() {
  const session = await getSession();
  // SSRï¼Œæ•°æ®å®æ—¶ä½†æ¸²æŸ“å¿«
  return <Dashboard user={session.user} />;
}

// å®¢æˆ·ç«¯ç»„ä»¶ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
'use client';
export default function InteractiveChart() {
  // å®¢æˆ·ç«¯æ¸²æŸ“ï¼Œå‡å°‘æœåŠ¡å™¨è´Ÿè½½
}
```

**æ¥æº**: Next.js 15 App Router æ¶æ„

#### 2. è¾¹ç¼˜è®¡ç®—éƒ¨ç½²

**Vercel Edge Network**:
- 300+ è¾¹ç¼˜èŠ‚ç‚¹
- è‡ªåŠ¨é€‰æ‹©æœ€è¿‘èŠ‚ç‚¹
- å†·å¯åŠ¨æ—¶é—´ < 100ms

**Cloudflare Workersï¼ˆå¯é€‰ï¼‰**:
- 330+ è¾¹ç¼˜ä½ç½®
- é›¶å†·å¯åŠ¨
- P99 å»¶è¿Ÿ < 50ms

**æ¥æº**: `QA-6.0-éƒ¨ç½²ç­–ç•¥.md`

#### 3. æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥**: `src/db/schema.ts`

```typescript
// ç”¨æˆ·è¡¨ - 3 ä¸ªç´¢å¼•
user: {
  userIdIdx: index('user_id_idx').on(table.id),
  userCustomerIdIdx: index('user_customer_id_idx').on(table.customerId),
  userRoleIdx: index('user_role_idx').on(table.role)
}

// æ”¯ä»˜è¡¨ - 8 ä¸ªç´¢å¼•ï¼ˆæŸ¥è¯¢é¢‘ç¹ï¼‰
payment: {
  paymentUserIdIdx: index('payment_user_id_idx').on(table.userId),
  paymentCustomerIdIdx: index('payment_customer_id_idx').on(table.customerId),
  paymentSubscriptionIdIdx: index('payment_subscription_id_idx').on(table.subscriptionId),
  paymentInvoiceIdIdx: index('payment_invoice_id_idx').on(table.invoiceId),
  paymentStatusIdx: index('payment_status_idx').on(table.status),
  paymentTypeIdx: index('payment_type_idx').on(table.type),
  paymentSceneIdx: index('payment_scene_idx').on(table.scene),
  paymentPaidIdx: index('payment_paid_idx').on(table.paid)
}
```

**æŸ¥è¯¢ä¼˜åŒ–**: Drizzle ORM ç±»å‹å®‰å…¨æŸ¥è¯¢

```typescript
// é«˜æ•ˆæŸ¥è¯¢ç¤ºä¾‹
const payments = await db
  .select()
  .from(payment)
  .where(
    and(
      eq(payment.userId, userId),
      eq(payment.status, 'active')
    )
  )
  .limit(10);
```

**æ¥æº**: `src/db/schema.ts`

#### 4. ç¼“å­˜ç­–ç•¥

**React Cacheï¼ˆæœåŠ¡ç«¯ï¼‰**:

```typescript
import { cache } from 'react';
import { auth } from '@/lib/auth';

export const getSession = cache(async () => {
  return await auth.api.getSession({
    headers: await headers()
  });
});
```

**ç”¨é€”**: é¿å…åŒä¸€è¯·æ±‚å¤šæ¬¡è°ƒç”¨ `getSession()`

**æ¥æº**: `src/lib/server.ts`

**Better Auth Cookie Cache**:

```typescript
session: {
  cookieCache: {
    enabled: true,
    maxAge: 60 * 60  // 1 å°æ—¶ç¼“å­˜
  }
}
```

**æ¥æº**: `src/lib/auth.ts`

**TanStack Queryï¼ˆå®¢æˆ·ç«¯ï¼‰**:

```typescript
import { QueryClient } from '@tanstack/react-query';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 60 * 1000,      // 1 åˆ†é’Ÿå†…æ•°æ®è§†ä¸ºæ–°é²œ
      cacheTime: 5 * 60 * 1000   // ç¼“å­˜ 5 åˆ†é’Ÿ
    }
  }
});
```

**æ¥æº**: Next.js å®¢æˆ·ç«¯ç¼“å­˜æœ€ä½³å®è·µ

**CDN ç¼“å­˜**: é™æ€èµ„æºè‡ªåŠ¨ç¼“å­˜åˆ° Vercel Edge Network

#### 5. ä»£ç åˆ†å‰²å’Œæ‡’åŠ è½½

**åŠ¨æ€å¯¼å…¥**:

```typescript
import dynamic from 'next/dynamic';

// æ‡’åŠ è½½å¤§å‹ç»„ä»¶
const HeavyChart = dynamic(() => import('@/components/heavy-chart'), {
  loading: () => <Spinner />,
  ssr: false  // ä»…å®¢æˆ·ç«¯æ¸²æŸ“
});
```

**è·¯ç”±åˆ†ç»„**: ä½¿ç”¨ `(marketing)`, `(protected)` ç­‰åˆ†ç»„ï¼Œè‡ªåŠ¨ä»£ç åˆ†å‰²

**æ¥æº**: Next.js 15 æœ€ä½³å®è·µ

#### 6. å›¾ç‰‡ä¼˜åŒ–

**é…ç½®**: `next.config.ts`

```typescript
{
  images: {
    unoptimized: true,  // ç¦ç”¨ Next.js å›¾ç‰‡ä¼˜åŒ–ï¼ˆé¿å… Vercel é™åˆ¶ï¼‰
    remotePatterns: [   // å…è®¸çš„è¿œç¨‹å›¾ç‰‡åŸŸå
      { hostname: 'cdn.mksaas.me' },
      { hostname: 'avatars.githubusercontent.com' },
      { hostname: 'lh3.googleusercontent.com' },
      // ... æ›´å¤š
    ]
  }
}
```

**ä½¿ç”¨ Cloudinary/ImageKit**: å¤–éƒ¨å›¾ç‰‡ CDN ä¼˜åŒ–

**æ¥æº**: `next.config.ts`

#### 7. API æ€§èƒ½é™åˆ¶

**è¶…æ—¶é…ç½®**:

```typescript
// èŠå¤© API
export const maxDuration = 30;  // 30 ç§’

// å›¾ç‰‡ç”Ÿæˆ API
const timeout = 55;  // 55 ç§’

// æ‰€æœ‰ APIï¼ˆVercel é…ç½®ï¼‰
{
  "functions": {
    "src/app/api/**/*": {
      "maxDuration": 300  // 5 åˆ†é’Ÿï¼ˆPro è®¡åˆ’ï¼‰
    }
  }
}
```

**æ¥æº**: `src/app/api/chat/route.ts`, `src/app/api/generate-images/route.ts`, `vercel.json`

**è½®è¯¢ä¼˜åŒ–**:

```typescript
const PAYMENT_POLL_INTERVAL = 2000;      // 2 ç§’è½®è¯¢é—´éš”
const PAYMENT_MAX_POLL_TIME = 60000;     // æœ€å¤§ 60 ç§’
const PAYMENT_RECORD_RETRY_ATTEMPTS = 30; // æœ€å¤š 30 æ¬¡é‡è¯•
```

**æ¥æº**: `src/lib/constants.ts`

#### 8. æ•°æ®åº“è¿æ¥æ± 

**PostgreSQL è¿æ¥æ± **:

```typescript
import postgres from 'postgres';

const client = postgres(process.env.DATABASE_URL!, {
  max: 10,                // æœ€å¤§è¿æ¥æ•°
  idle_timeout: 20,       // ç©ºé—²è¶…æ—¶ï¼ˆç§’ï¼‰
  connect_timeout: 10     // è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
});
```

**æ¨è**: ä½¿ç”¨ Supabase Pooler æˆ– Neon Serverless Driver

**æ¥æº**: postgres.js æ–‡æ¡£

#### 9. æœç´¢æ€§èƒ½

**Fumadocs æœç´¢**: `src/app/api/search/route.ts`

```typescript
import { createSearchAPI } from 'fumadocs-core/server';

// ä¸­æ–‡åˆ†è¯å™¨
import { createFromSource } from 'fumadocs-core/search/orama';
import { createTokenizer } from '@orama/tokenizers/mandarin';

const mandarinTokenizer = await createTokenizer();

export const { GET } = createSearchAPI('advanced', {
  indexes: [
    createFromSource(source, (page) => ({
      title: page.data.title,
      content: page.data.content,
      description: page.data.description
    }))
  ],
  language: locale === 'zh' ? {
    tokenizer: mandarinTokenizer
  } : undefined,
  limit: 20  // é™åˆ¶è¿”å› 20 ä¸ªç»“æœ
});
```

**æ€§èƒ½**: å†…å­˜ç´¢å¼•ï¼ŒæŸ¥è¯¢ < 100ms

**æ¥æº**: `src/app/api/search/route.ts`

### ğŸ“Š æ€§èƒ½ç›‘æ§

#### 1. Vercel Analyticsï¼ˆå¯é€‰ï¼‰

```typescript
// src/config/website.tsx
analytics: {
  enableVercelAnalytics: false,
  enableSpeedInsights: false
}
```

**æŒ‡æ ‡**:
- Web Vitals (FCP, LCP, CLS, FID, TTFB)
- Real User Monitoring (RUM)
- Edge å‡½æ•°æ‰§è¡Œæ—¶é—´

**æ¥æº**: `src/config/website.tsx`

#### 2. PostHog Analytics

```typescript
NEXT_PUBLIC_POSTHOG_KEY="..."
NEXT_PUBLIC_POSTHOG_HOST="..."
```

**ç›‘æ§**:
- é¡µé¢åŠ è½½æ—¶é—´
- ç”¨æˆ·æ“ä½œå»¶è¿Ÿ
- Session Replay

**æ¥æº**: `env.example`

#### 3. è‡ªå®šä¹‰æ€§èƒ½è¿½è¸ª

**AI è¯·æ±‚è¿½è¸ª**:

```typescript
const requestId = nanoid();
console.log(`[${requestId}] Image generation started`);

const startTime = Date.now();
const images = await generateImages(...);
const duration = Date.now() - startTime;

console.log(`[${requestId}] Completed in ${duration}ms`);
```

**æ¥æº**: `src/app/api/generate-images/route.ts`

### ğŸ¯ æ€§èƒ½ç“¶é¢ˆå’Œè§£å†³æ–¹æ¡ˆ

#### ç“¶é¢ˆ 1: æ•°æ®åº“æŸ¥è¯¢æ…¢

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æ·»åŠ ç´¢å¼•ï¼ˆå·²å®ç° 20+ ä¸ªç´¢å¼•ï¼‰
- âœ… ä½¿ç”¨ Drizzle ORM æŸ¥è¯¢ä¼˜åŒ–
- âœ… è¿æ¥æ± ï¼ˆpostgres.jsï¼‰
- ğŸ”„ è€ƒè™‘ Redis ç¼“å­˜çƒ­æ•°æ®

#### ç“¶é¢ˆ 2: AI è¯·æ±‚æ…¢

**è§£å†³æ–¹æ¡ˆ**:
- âœ… æµå¼å“åº”ï¼ˆèŠå¤©ï¼‰
- âœ… å¤šæä¾›å•†è´Ÿè½½å‡è¡¡
- âœ… è¶…æ—¶æ§åˆ¶ï¼ˆ55 ç§’ï¼‰
- âœ… è¯·æ±‚ ID è¿½è¸ª

**æ¥æº**: `src/app/api/chat/route.ts`, `src/app/api/generate-images/route.ts`

#### ç“¶é¢ˆ 3: æ–‡ä»¶ä¸Šä¼ æ…¢

**è§£å†³æ–¹æ¡ˆ**:
- âœ… é™åˆ¶æ–‡ä»¶å¤§å°ï¼ˆ4MBï¼‰
- âœ… ä½¿ç”¨ Cloudflare R2ï¼ˆå…¨çƒ CDNï¼‰
- âœ… å®¢æˆ·ç«¯å‹ç¼©ï¼ˆå¯é€‰ï¼‰

**æ¥æº**: `src/app/api/storage/upload/route.ts`

#### ç“¶é¢ˆ 4: é¦–æ¬¡åŠ è½½æ…¢

**è§£å†³æ–¹æ¡ˆ**:
- âœ… ä»£ç åˆ†å‰²ï¼ˆNext.js è‡ªåŠ¨ï¼‰
- âœ… æ‡’åŠ è½½ç»„ä»¶
- âœ… è¾¹ç¼˜æ¸²æŸ“ï¼ˆVercel/Cloudflareï¼‰
- âœ… é™æ€ç”Ÿæˆï¼ˆè¥é”€é¡µé¢ï¼‰

### ğŸ”¬ æ€§èƒ½æµ‹è¯•å»ºè®®

#### Lighthouse æµ‹è¯•

**ç›®æ ‡åˆ†æ•°**:
- Performance: > 90
- Accessibility: > 95
- Best Practices: > 95
- SEO: > 95

#### è´Ÿè½½æµ‹è¯•

**å·¥å…·**: k6, Artillery, Apache JMeter

**åœºæ™¯**:
```javascript
// k6 æµ‹è¯•è„šæœ¬ç¤ºä¾‹
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '2m', target: 100 },   // çˆ¬å‡åˆ° 100 ç”¨æˆ·
    { duration: '5m', target: 100 },   // ä¿æŒ 100 ç”¨æˆ·
    { duration: '2m', target: 500 },   // çˆ¬å‡åˆ° 500 ç”¨æˆ·
    { duration: '5m', target: 500 },   // ä¿æŒ 500 ç”¨æˆ·
    { duration: '2m', target: 0 }      // ä¸‹é™åˆ° 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500']   // 95% è¯·æ±‚ < 500ms
  }
};

export default function() {
  http.get('https://yourdomain.com');
}
```

### ğŸ“ˆ æ‰©å±•æ€§è€ƒè™‘

#### å½“å‰æ¶æ„æ”¯æŒ

- **ç”¨æˆ·æ•°**: 1k - 10kï¼ˆVercel Proï¼‰
- **å¹¶å‘**: 100 - 1000
- **æ•°æ®åº“**: 10GB - 100GB

#### æ‰©å±•æ–¹æ¡ˆ

**10k - 100k ç”¨æˆ·**:
- æ•°æ®åº“: ä¸“ç”¨ PostgreSQL + è¯»å‰¯æœ¬
- ç¼“å­˜: Redis (Upstash)
- CDN: Cloudflare
- è®¡ç®—: Cloudflare Workers æˆ–å¤šåŒºåŸŸéƒ¨ç½²

**100k+ ç”¨æˆ·**:
- æ•°æ®åº“: åˆ†ç‰‡ + ä¸»ä»å¤åˆ¶
- ç¼“å­˜: å¤šå±‚ç¼“å­˜ï¼ˆEdge + Redisï¼‰
- è´Ÿè½½å‡è¡¡: å¤šåŒºåŸŸ + å…¨çƒè´Ÿè½½å‡è¡¡
- é˜Ÿåˆ—: BullMQ + Upstash Redis

### ğŸ’° æ€§èƒ½ vs æˆæœ¬å¹³è¡¡

| ç”¨æˆ·è§„æ¨¡ | éƒ¨ç½²æ–¹æ¡ˆ | æ€§èƒ½ | æˆæœ¬/æœˆ |
|---------|---------|------|--------|
| < 1k | Vercel Hobby | ä¸­ | $0 |
| 1k - 10k | Vercel Pro | é«˜ | $20-50 |
| 10k - 50k | Cloudflare Workers | æé«˜ | $50-200 |
| 50k+ | æ··åˆéƒ¨ç½² | æé«˜ | $200-1000 |

### ğŸ¯ æ€§èƒ½æœ€ä½³å®è·µï¼ˆå·²å®æ–½ï¼‰

1. âœ… **æœåŠ¡ç«¯æ¸²æŸ“** - Next.js SSR
2. âœ… **è¾¹ç¼˜éƒ¨ç½²** - Vercel/Cloudflare
3. âœ… **æ•°æ®åº“ç´¢å¼•** - 20+ ç´¢å¼•
4. âœ… **ç¼“å­˜ç­–ç•¥** - React Cache + Cookie Cache + TanStack Query
5. âœ… **ä»£ç åˆ†å‰²** - Next.js è‡ªåŠ¨åˆ†å‰²
6. âœ… **æµå¼å“åº”** - AI èŠå¤©æµå¼
7. âœ… **è¶…æ—¶æ§åˆ¶** - API è¶…æ—¶é™åˆ¶
8. âœ… **æ€§èƒ½ç›‘æ§** - PostHog + Vercel Analyticsï¼ˆå¯é€‰ï¼‰
9. âœ… **æ‡’åŠ è½½** - åŠ¨æ€å¯¼å…¥å¤§å‹ç»„ä»¶
10. âœ… **CDN åŠ é€Ÿ** - é™æ€èµ„æºå…¨çƒåˆ†å‘

## ğŸ“ ä¿¡æ¯æ¥æº
- `next.config.ts` - å›¾ç‰‡ä¼˜åŒ–é…ç½®
- `vercel.json` - API è¶…æ—¶é…ç½®
- `src/db/schema.ts` - æ•°æ®åº“ç´¢å¼•
- `src/lib/server.ts` - React Cache ä½¿ç”¨
- `src/lib/auth.ts` - ä¼šè¯ç¼“å­˜é…ç½®
- `src/lib/constants.ts` - è½®è¯¢å’Œè¶…æ—¶å¸¸é‡
- `src/app/api/` - API è¶…æ—¶é…ç½®
- `src/config/website.tsx` - Analytics é…ç½®
- Next.js 15 å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æœ€ä½³å®è·µ
- Vercel / Cloudflare å®˜æ–¹æ–‡æ¡£ - æ€§èƒ½æŒ‡æ ‡
