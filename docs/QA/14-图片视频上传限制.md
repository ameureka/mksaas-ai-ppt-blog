# 问题14: 博客对于图片的上传有没有限制，对于视频的上传有没有限制，尤其是 YouTube 的视频链接？

## 图片上传和管理

### 1. 当前图片系统

**已集成**: AWS S3 图片上传

**文件位置**: `src/storage/`

**配置** (`src/config/website.tsx`):
```typescript
storage: {
  enable: true,
  provider: 's3',
}
```

---

### 2. 图片上传限制

#### 2.1 技术限制

**API 端点**: `POST /api/storage/upload`

**默认限制**:
```typescript
// Next.js 默认限制
{
  maxFileSize: 4.5 MB,  // Vercel: 4.5 MB
  maxFileSize: 50 MB,   // 自托管: 可配置
}
```

**修改限制** (`next.config.ts`):
```typescript
export default {
  api: {
    bodyParser: {
      sizeLimit: '10mb',  // 增加到 10 MB
    },
  },
};
```

**Vercel 部署限制**:
- ✅ 单个文件: 4.5 MB（Serverless Function 限制）
- ⚠️ Hobby 层: 总请求体 4.5 MB
- ✅ Pro 层: 可增加到 25 MB

#### 2.2 S3 存储限制

**AWS S3 限制**:
- ✅ 单个对象: 最大 5 TB
- ✅ 存储空间: 无限制
- ✅ 带宽: 按需付费

**免费层**（前 12 个月）:
- 5 GB 存储
- 20,000 GET 请求
- 2,000 PUT 请求

**估算成本**（超出免费层后）:
```
存储成本: $0.023/GB/月
GET 请求: $0.0004/1000 请求
PUT 请求: $0.005/1000 请求
数据传输: $0.09/GB（前 10 TB）

示例（1000 张图片）:
- 图片总大小: 500 MB
- 月访问: 10,000 次
- 成本: ~$0.50/月
```

---

### 3. 图片上传实现

#### 3.1 Server Action

```typescript
// src/actions/upload-image.ts
'use server';

import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { nanoid } from 'nanoid';

export async function uploadImageAction(formData: FormData) {
  const file = formData.get('file') as File;

  // 验证文件类型
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowedTypes.includes(file.type)) {
    return { error: '不支持的文件类型' };
  }

  // 验证文件大小（10 MB）
  const maxSize = 10 * 1024 * 1024;
  if (file.size > maxSize) {
    return { error: '文件大小超过 10 MB 限制' };
  }

  // 生成唯一文件名
  const extension = file.name.split('.').pop();
  const filename = `${nanoid()}.${extension}`;

  // 上传到 S3
  const s3Client = new S3Client({
    region: process.env.AWS_REGION,
    credentials: {
      accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
      secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
    },
  });

  const buffer = Buffer.from(await file.arrayBuffer());

  await s3Client.send(
    new PutObjectCommand({
      Bucket: process.env.AWS_BUCKET_NAME,
      Key: `blog-images/${filename}`,
      Body: buffer,
      ContentType: file.type,
      CacheControl: 'public, max-age=31536000', // 1 年
    })
  );

  // 返回 CDN URL
  const url = `https://cdn.mksaas.me/blog-images/${filename}`;
  return { url };
}
```

#### 3.2 上传组件

```typescript
// src/components/upload/image-uploader.tsx
'use client';

import { useState } from 'react';
import { uploadImageAction } from '@/actions/upload-image';

export function ImageUploader() {
  const [uploading, setUploading] = useState(false);
  const [imageUrl, setImageUrl] = useState<string>();

  const handleUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setUploading(true);

    const formData = new FormData();
    formData.append('file', file);

    const result = await uploadImageAction(formData);

    if (result.url) {
      setImageUrl(result.url);
    } else {
      alert(result.error);
    }

    setUploading(false);
  };

  return (
    <div>
      <input
        type="file"
        accept="image/*"
        onChange={handleUpload}
        disabled={uploading}
      />
      {uploading && <p>上传中...</p>}
      {imageUrl && (
        <div>
          <img src={imageUrl} alt="上传的图片" className="max-w-md" />
          <input
            type="text"
            value={imageUrl}
            readOnly
            onClick={(e) => e.currentTarget.select()}
          />
        </div>
      )}
    </div>
  );
}
```

#### 3.3 在 MDX 中使用

**方式1: 直接引用 S3 URL**

```markdown
![图片描述](https://cdn.mksaas.me/blog-images/abc123.jpg)
```

**方式2: Next.js Image 组件**

```mdx
import Image from 'next/image';

<Image
  src="https://cdn.mksaas.me/blog-images/abc123.jpg"
  alt="图片描述"
  width={800}
  height={600}
/>
```

---

### 4. 图片优化建议

#### 4.1 图片压缩

**上传前压缩**:

```typescript
// 使用 sharp 库压缩图片
import sharp from 'sharp';

async function compressImage(buffer: Buffer) {
  return await sharp(buffer)
    .resize(1920, 1080, { fit: 'inside', withoutEnlargement: true })
    .webp({ quality: 80 })
    .toBuffer();
}
```

#### 4.2 图片格式

**推荐格式**:
- ✅ WebP（最优，80% 压缩率）
- ✅ AVIF（更优，但兼容性差）
- ⚠️ JPEG（通用）
- ❌ PNG（仅适合透明图）

**自动转换**:

```typescript
export async function uploadImageAction(formData: FormData) {
  const file = formData.get('file') as File;
  const buffer = Buffer.from(await file.arrayBuffer());

  // 转换为 WebP
  const webpBuffer = await sharp(buffer)
    .webp({ quality: 80 })
    .toBuffer();

  // 上传 WebP 版本
  await s3Client.send(
    new PutObjectCommand({
      Bucket: process.env.AWS_BUCKET_NAME,
      Key: `blog-images/${filename}.webp`,
      Body: webpBuffer,
      ContentType: 'image/webp',
    })
  );
}
```

#### 4.3 响应式图片

**生成多个尺寸**:

```typescript
// 生成缩略图、中图、大图
const sizes = [
  { width: 400, suffix: 'thumb' },
  { width: 800, suffix: 'medium' },
  { width: 1920, suffix: 'large' },
];

for (const size of sizes) {
  const resizedBuffer = await sharp(buffer)
    .resize(size.width)
    .webp({ quality: 80 })
    .toBuffer();

  await s3Client.send(
    new PutObjectCommand({
      Bucket: process.env.AWS_BUCKET_NAME,
      Key: `blog-images/${filename}-${size.suffix}.webp`,
      Body: resizedBuffer,
      ContentType: 'image/webp',
    })
  );
}
```

**在 MDX 中使用**:

```mdx
<picture>
  <source
    media="(max-width: 640px)"
    srcset="https://cdn.mksaas.me/blog-images/abc-thumb.webp"
  />
  <source
    media="(max-width: 1024px)"
    srcset="https://cdn.mksaas.me/blog-images/abc-medium.webp"
  />
  <img
    src="https://cdn.mksaas.me/blog-images/abc-large.webp"
    alt="响应式图片"
  />
</picture>
```

---

## 视频处理

### 1. 视频上传（不推荐）

**为什么不推荐直接上传视频？**

❌ **问题**:
- 文件体积巨大（几百 MB 到几 GB）
- 需要转码处理
- 带宽成本高
- 播放体验差（需要流媒体）
- Serverless Function 超时（10-60秒）

**如果必须上传视频**:

```typescript
// ⚠️ 仅适合小视频（<50MB）
export async function uploadVideoAction(formData: FormData) {
  const file = formData.get('file') as File;

  // 限制视频大小
  const maxSize = 50 * 1024 * 1024; // 50 MB
  if (file.size > maxSize) {
    return { error: '视频大小超过 50 MB' };
  }

  // 上传到 S3
  // ... 类似图片上传
}
```

---

### 2. YouTube 视频嵌入（推荐）

**优势**:
- ✅ 无需上传
- ✅ 无带宽成本
- ✅ 专业视频播放器
- ✅ YouTube CDN 分发
- ✅ 自动生成字幕

#### 2.1 YouTube 嵌入限制

**YouTube 没有限制**:
- ✅ 无需 API Key（公开视频）
- ✅ 无请求配额限制
- ✅ 免费使用

#### 2.2 YouTube 嵌入组件

```typescript
// src/components/mdx/youtube-embed.tsx
export function YouTubeEmbed({ id, title }: { id: string; title?: string }) {
  return (
    <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
      <iframe
        className="absolute top-0 left-0 w-full h-full"
        src={`https://www.youtube-nocookie.com/embed/${id}`}
        title={title || 'YouTube video'}
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowFullScreen
      />
    </div>
  );
}
```

**在 MDX 中使用**:

```mdx
# 文章标题

文字内容...

<YouTubeEmbed id="dQw4w9WgXcQ" title="视频标题" />

更多内容...
```

#### 2.3 自动解析 YouTube 链接

**Remark 插件**:

```typescript
// src/lib/remark-youtube.ts
import { visit } from 'unist-util-visit';

export function remarkYouTube() {
  return (tree: any) => {
    visit(tree, 'link', (node) => {
      const url = node.url;
      const youtubeRegex = /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
      const match = url.match(youtubeRegex);

      if (match) {
        const videoId = match[1];

        // 替换为 YouTube 组件
        node.type = 'mdxJsxFlowElement';
        node.name = 'YouTubeEmbed';
        node.attributes = [
          { type: 'mdxJsxAttribute', name: 'id', value: videoId },
        ];
        delete node.url;
        delete node.children;
      }
    });
  };
}
```

**配置**:

```typescript
// next.config.ts 或 fumadocs 配置
import { remarkYouTube } from './src/lib/remark-youtube';

export default {
  mdx: {
    remarkPlugins: [remarkYouTube],
  },
};
```

**使用**（自动转换）:

```markdown
点击观看视频：https://www.youtube.com/watch?v=dQw4w9WgXcQ

<!-- 自动转换为 YouTube 嵌入播放器 -->
```

#### 2.4 优化 YouTube 加载

**延迟加载**:

```typescript
// src/components/mdx/youtube-embed.tsx
'use client';

import { useState } from 'react';

export function YouTubeEmbed({ id, title }: { id: string; title?: string }) {
  const [loaded, setLoaded] = useState(false);

  if (!loaded) {
    // 显示预览图
    return (
      <div
        className="relative w-full cursor-pointer"
        style={{ paddingBottom: '56.25%' }}
        onClick={() => setLoaded(true)}
      >
        <img
          className="absolute top-0 left-0 w-full h-full object-cover"
          src={`https://img.youtube.com/vi/${id}/maxresdefault.jpg`}
          alt={title}
        />
        <div className="absolute inset-0 flex items-center justify-center">
          <button className="bg-red-600 text-white px-6 py-3 rounded-lg">
            ▶ 播放视频
          </button>
        </div>
      </div>
    );
  }

  // 加载真实 iframe
  return (
    <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
      <iframe
        className="absolute top-0 left-0 w-full h-full"
        src={`https://www.youtube-nocookie.com/embed/${id}?autoplay=1`}
        title={title || 'YouTube video'}
        allow="autoplay; encrypted-media"
        allowFullScreen
      />
    </div>
  );
}
```

**优势**:
- ✅ 节省带宽（不自动加载 iframe）
- ✅ 提升页面加载速度
- ✅ 更好的用户体验

---

### 3. 其他视频平台

#### 3.1 Vimeo

```typescript
export function VimeoEmbed({ id, title }: { id: string; title?: string }) {
  return (
    <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
      <iframe
        className="absolute top-0 left-0 w-full h-full"
        src={`https://player.vimeo.com/video/${id}`}
        title={title}
        allow="autoplay; fullscreen; picture-in-picture"
        allowFullScreen
      />
    </div>
  );
}
```

#### 3.2 Bilibili

```typescript
export function BilibiliEmbed({ bvid, title }: { bvid: string; title?: string }) {
  return (
    <div className="relative w-full" style={{ paddingBottom: '56.25%' }}>
      <iframe
        className="absolute top-0 left-0 w-full h-full"
        src={`https://player.bilibili.com/player.html?bvid=${bvid}`}
        title={title}
        allowFullScreen
      />
    </div>
  );
}
```

---

## 推荐方案总结

### 图片

**✅ 推荐**:
1. **小图片**（<1MB）: 直接上传到 S3
2. **大图片**（>1MB）: 压缩后上传
3. **频繁访问**: 使用 CDN（CloudFront、Cloudflare）

**配额和成本**:
```
S3 免费层: 5 GB 存储 + 20,000 GET 请求/月
预计成本（1000张图片）: $0.50-2.00/月
```

**限制**:
```
单个文件: 建议 <10 MB
总存储: 无限制（按用量付费）
上传速度: 取决于网络和服务器
```

---

### 视频

**✅ 强烈推荐**:
1. **YouTube 嵌入**（免费，无限制）
2. **Vimeo**（更专业）
3. **Bilibili**（中国用户）

**❌ 不推荐**:
- 直接上传视频文件
- 自建视频服务器

**如果必须上传视频**:
```
推荐方案:
1. 使用 Cloudflare Stream（$1/1000分钟）
2. 使用 Mux（$0.005/分钟存储）
3. 使用 AWS MediaConvert + CloudFront
```

---

## 实施建议

### 第1步: 图片系统

1. ✅ 已集成 S3 上传
2. 添加图片压缩
3. 配置 CDN
4. 实现响应式图片

### 第2步: 视频嵌入

1. 创建 YouTube 嵌入组件
2. 添加延迟加载
3. 支持多个视频平台
4. 添加 Remark 插件自动转换

### 第3步: 优化

1. 监控 S3 成本
2. 定期清理未使用的图片
3. 实现图片懒加载
4. 添加图片 CDN

---

## 总结

**图片上传**:
- ✅ **有限制**（建议 <10 MB）
- ✅ 使用 S3 存储（成本低）
- ✅ 免费层足够（5 GB）

**视频上传**:
- ❌ **不推荐**（成本高，体验差）
- ✅ 使用 YouTube 嵌入（免费，无限制）
- ✅ 支持所有主流视频平台

**YouTube 视频**:
- ✅ **无限制**
- ✅ 完全免费
- ✅ 专业播放器
- ✅ 推荐使用

**关键要点**:
1. 图片压缩后上传到 S3
2. 视频使用 YouTube 等平台嵌入
3. 使用 CDN 加速图片访问
4. 实现延迟加载优化性能

这是**最经济、最高效的媒体管理方案**！
