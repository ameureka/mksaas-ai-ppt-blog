# QA-19.0 核心功能用户故事

## 📋 问题
综上分析项目核心功能以用户故事模式描述？

## ✅ 回答

基于项目完整分析，以用户故事（User Story）模式描述所有核心功能。

### 👤 角色定义

- **访客（Visitor）** - 未注册用户
- **免费用户（Free User）** - 已注册，使用免费计划
- **付费用户（Pro User）** - 订阅 Pro 计划或购买终身计划
- **管理员（Admin）** - 系统管理员

---

## 🔐 用户认证与管理

### US-1: 用户注册（邮箱/密码）

**作为** 访客
**我想要** 使用邮箱和密码注册账户
**以便** 开始使用平台服务

**验收标准**:
- ✅ 输入邮箱、密码（至少 8 字符）
- ✅ 收到邮箱验证邮件
- ✅ 点击验证链接后激活账户
- ✅ 自动订阅时事通讯
- ✅ 获得 50 个免费积分（30 天过期）
- ✅ 跳转到 /settings/profile

**技术实现**: `src/lib/auth.ts`, Better Auth emailAndPassword

---

### US-2: 社交登录（GitHub/Google）

**作为** 访客
**我想要** 使用 GitHub 或 Google 账户登录
**以便** 快速注册，无需输入密码

**验收标准**:
- ✅ 点击"使用 GitHub 登录"
- ✅ 跳转到 GitHub 授权页面
- ✅ 授权后自动创建账户
- ✅ 获得 50 个免费积分
- ✅ 自动登录

**技术实现**: `src/lib/auth.ts`, Better Auth OAuth

---

### US-3: 邮箱验证

**作为** 注册用户
**我想要** 验证我的邮箱地址
**以便** 确认账户所有权并启用所有功能

**验收标准**:
- ✅ 收到验证邮件（英文或中文）
- ✅ 点击邮件中的验证链接
- ✅ 显示"邮箱验证成功"消息
- ✅ user.emailVerified 设置为 true

**技术实现**: `src/lib/auth.ts`, `src/mail/templates/`

---

### US-4: 密码重置

**作为** 免费用户
**我想要** 重置我的密码
**以便** 在忘记密码时恢复账户访问

**验收标准**:
- ✅ 点击"忘记密码"
- ✅ 输入注册邮箱
- ✅ 收到密码重置邮件
- ✅ 点击链接，设置新密码
- ✅ 使用新密码登录成功

**技术实现**: `src/lib/auth.ts`, Better Auth sendResetPassword

---

### US-5: 账户链接

**作为** 免费用户（已有邮箱账户）
**我想要** 连接我的 GitHub 账户
**以便** 可以使用多种方式登录同一账户

**验收标准**:
- ✅ 登录后访问 /settings/security
- ✅ 点击"连接 GitHub"
- ✅ GitHub 授权
- ✅ 账户成功连接
- ✅ 可以使用邮箱或 GitHub 登录

**技术实现**: `src/lib/auth.ts`, Better Auth accountLinking

---

## 💳 支付与订阅

### US-6: 订阅 Pro 计划（月付）

**作为** 免费用户
**我想要** 订阅 Pro 月付计划（$9.90/月）
**以便** 每月获得 1000 积分并使用高级功能

**验收标准**:
- ✅ 访问 /pricing
- ✅ 点击 Pro 计划的"订阅"按钮
- ✅ 跳转到 Stripe Checkout
- ✅ 输入信用卡信息并完成支付
- ✅ 支付成功后返回应用
- ✅ 立即获得 1000 积分（30 天过期）
- ✅ 每月自动扣款并发放积分

**技术实现**: `src/actions/create-checkout-session.ts`, `src/payment/provider/stripe.ts`

---

### US-7: 订阅 Pro 计划（年付）

**作为** 免费用户
**我想要** 订阅 Pro 年付计划（$99/年）
**以便** 节省 17% 的费用

**验收标准**:
- ✅ 选择年付选项（$99/年 vs $118.80/年）
- ✅ 完成支付
- ✅ 每月获得 1000 积分
- ✅ 每年自动续费

**技术实现**: `src/config/website.tsx`

---

### US-8: 购买终身计划

**作为** 免费用户
**我想要** 一次性购买终身计划（$199）
**以便** 永久访问 Pro 功能

**验收标准**:
- ✅ 选择终身计划
- ✅ 一次性支付 $199
- ✅ 每月获得 1000 积分（终身）
- ✅ 无需再付费

**技术实现**: `src/config/website.tsx`

---

### US-9: 购买积分包

**作为** 免费用户
**我想要** 购买 100 积分包（$9.90）
**以便** 在不订阅的情况下使用 AI 功能

**验收标准**:
- ✅ 访问 /pricing
- ✅ 选择积分包（100/200/500/1000）
- ✅ 完成支付
- ✅ 积分立即到账
- ✅ 积分 30 天过期

**技术实现**: `src/actions/create-credit-checkout-session.ts`, `src/config/website.tsx`

---

### US-10: 管理订阅

**作为** 付费用户
**我想要** 管理我的订阅
**以便** 查看详情、更新支付方式或取消订阅

**验收标准**:
- ✅ 访问 /settings/billing
- ✅ 点击"管理订阅"
- ✅ 跳转到 Stripe 客户门户
- ✅ 可以查看订阅详情
- ✅ 可以更新支付方式
- ✅ 可以取消订阅
- ✅ 取消后继续使用到期末

**技术实现**: `src/actions/create-customer-portal-session.ts`

---

## 🪙 积分系统

### US-11: 查看积分余额

**作为** 免费用户
**我想要** 查看我的当前积分余额
**以便** 了解还能使用多少次 AI 功能

**验收标准**:
- ✅ 访问 /dashboard 或 /settings/credits
- ✅ 看到当前积分数（如 50）
- ✅ 看到积分过期时间
- ✅ 看到积分历史记录

**技术实现**: `src/actions/get-credit-balance.ts`

---

### US-12: 积分自动过期

**作为** 系统
**我想要** 每天自动处理过期的积分
**以便** 保持积分系统的正确性

**验收标准**:
- ✅ Cron Job 每天 00:00 UTC 执行
- ✅ 查找所有过期的 creditTransaction
- ✅ 扣除对应的积分
- ✅ 标记交易已处理
- ✅ 记录处理日志

**技术实现**: `src/credits/distribute.ts`, `src/app/api/distribute-credits/route.ts`

---

## 🤖 AI 功能

### US-13: AI 聊天

**作为** 免费用户
**我想要** 与 AI 聊天
**以便** 获得问题解答或灵感

**验收标准**:
- ✅ 访问 /ai/chat
- ✅ 输入消息
- ✅ 消费 1 积分
- ✅ 收到 AI 流式响应
- ✅ 可以查看历史对话
- ✅ 可以切换模型（GPT-4, Gemini, DeepSeek）
- ✅ 可选启用 Web Search

**技术实现**: `src/app/api/chat/route.ts`

---

### US-14: AI 图片生成

**作为** 付费用户
**我想要** 生成 AI 图片
**以便** 创作视觉内容

**验收标准**:
- ✅ 访问 /ai/image
- ✅ 输入提示词（如"a cat in space"）
- ✅ 选择提供商（OpenAI/Fireworks/Replicate/FAL）
- ✅ 选择模型（DALL-E 3/Flux 等）
- ✅ 消费 5 积分
- ✅ 55 秒内生成图片
- ✅ 可以下载图片
- ✅ 可以生成多张图片

**技术实现**: `src/app/api/generate-images/route.ts`

---

### US-15: 网页内容分析

**作为** 付费用户
**我想要** 分析网页内容
**以便** 快速理解网页主要信息

**验收标准**:
- ✅ 访问 /ai/text
- ✅ 输入网页 URL
- ✅ 消费 2 积分
- ✅ 使用 Firecrawl 抓取网页
- ✅ 使用 AI 分析内容
- ✅ 显示结构化结果

**技术实现**: `src/app/api/analyze-content/route.ts`

---

## 📧 邮件与通讯

### US-16: 订阅时事通讯

**作为** 访客
**我想要** 订阅时事通讯
**以便** 接收产品更新和优惠信息

**验收标准**:
- ✅ 在首页输入邮箱
- ✅ 点击"订阅"
- ✅ 收到确认邮件
- ✅ 邮箱添加到 Resend Audience
- ✅ 可以随时取消订阅

**技术实现**: `src/actions/subscribe-newsletter.ts`

---

### US-17: 自动订阅

**作为** 新用户
**我想要** 注册时自动订阅时事通讯
**以便** 不错过重要更新

**验收标准**:
- ✅ 注册账户
- ✅ 自动订阅时事通讯（newsletter.autoSubscribeAfterSignUp: true）
- ✅ 无需额外操作

**技术实现**: `src/lib/auth.ts`, `src/config/website.tsx`

---

## 📝 内容浏览

### US-18: 浏览博客

**作为** 访客
**我想要** 浏览博客文章
**以便** 学习和获取灵感

**验收标准**:
- ✅ 访问 /blog
- ✅ 看到博客列表（每页 12 篇）
- ✅ 可以按分类筛选
- ✅ 可以翻页
- ✅ 点击文章进入详情页
- ✅ 看到相关文章推荐（3 篇）

**技术实现**: `src/app/[locale]/(marketing)/blog/`, `src/config/website.tsx`

---

### US-19: 搜索文档

**作为** 免费用户
**我想要** 搜索文档
**以便** 快速找到我需要的信息

**验收标准**:
- ✅ 访问 /docs
- ✅ 在搜索框输入关键词
- ✅ 看到实时搜索结果（< 200ms）
- ✅ 支持中文分词
- ✅ 显示匹配的标题和内容
- ✅ 点击结果跳转到对应页面

**技术实现**: `src/app/api/search/route.ts`

---

## 👨‍💼 管理功能

### US-20: 查看用户列表（管理员）

**作为** 管理员
**我想要** 查看所有用户
**以便** 管理用户账户

**验收标准**:
- ✅ 访问 /admin/users
- ✅ 看到用户列表（表格形式）
- ✅ 可以搜索用户（邮箱、姓名）
- ✅ 可以按状态筛选（活跃、封禁）
- ✅ 可以查看用户详情

**技术实现**: `src/actions/get-users.ts`, `src/app/[locale]/(protected)/admin/users/page.tsx`

---

### US-21: 封禁用户（管理员）

**作为** 管理员
**我想要** 封禁违规用户
**以便** 维护平台秩序

**验收标准**:
- ✅ 在用户列表选择用户
- ✅ 点击"封禁"按钮
- ✅ 输入封禁原因
- ✅ 设置封禁过期时间（可选）
- ✅ 确认封禁
- ✅ 用户被强制登出
- ✅ 用户无法再登录

**技术实现**: `src/lib/auth.ts`, Better Auth admin plugin

---

## 🌐 国际化

### US-22: 切换语言

**作为** 访客
**我想要** 切换网站语言
**以便** 使用我熟悉的语言浏览

**验收标准**:
- ✅ 点击语言切换器
- ✅ 选择"中文"
- ✅ 所有 UI 文本切换为中文
- ✅ URL 变为 /zh/...
- ✅ 邮件也使用中文发送

**技术实现**: `src/i18n/`, `messages/zh.json`

---

## 🎨 主题定制

### US-23: 切换深色/浅色模式

**作为** 免费用户
**我想要** 切换深色或浅色模式
**以便** 适应不同环境的使用

**验收标准**:
- ✅ 点击主题切换器
- ✅ 选择"深色模式"或"浅色模式"
- ✅ 全站主题立即切换
- ✅ 偏好保存到 Cookie
- ✅ 下次访问保持选择

**技术实现**: `src/config/website.tsx`, next-themes

---

### US-24: 切换主题颜色

**作为** 免费用户
**我想要** 切换主题颜色（蓝色/绿色/琥珀色）
**以便** 个性化外观

**验收标准**:
- ✅ 访问 /settings/appearance
- ✅ 选择主题颜色
- ✅ 主色调立即切换
- ✅ 偏好保存

**技术实现**: `src/config/website.tsx`

---

## 📊 总结

### 功能统计

| 类别 | 用户故事数 | 状态 |
|------|-----------|------|
| 认证与管理 | 6 | ✅ 已实现 |
| 支付与订阅 | 5 | ✅ 已实现 |
| 积分系统 | 2 | ✅ 已实现 |
| AI 功能 | 3 | ✅ 已实现 |
| 邮件与通讯 | 2 | ✅ 已实现 |
| 内容浏览 | 2 | ✅ 已实现 |
| 管理功能 | 2 | ✅ 已实现 |
| 国际化 | 1 | ✅ 已实现 |
| 主题定制 | 2 | ✅ 已实现 |
| **总计** | **25** | **100% 已实现** |

### 用户旅程

**典型免费用户旅程**:
```
注册 → 获得 50 积分 → 使用 AI 聊天 → 积分用完 →
订阅 Pro 计划 → 每月获得 1000 积分 → 持续使用 →
管理订阅（更新支付方式/取消）
```

**典型付费用户旅程**:
```
购买终身计划 → 每月获得 1000 积分 → 使用所有 AI 功能 →
积分不够 → 购买额外积分包 → 持续使用
```

**典型管理员旅程**:
```
登录 → 查看用户列表 → 封禁违规用户 → 查看系统统计 →
接收支付通知（Discord/飞书）
```

## 📍 信息来源
综合所有 QA 文档分析得出
