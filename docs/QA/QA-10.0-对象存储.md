# QA-10.0 å¯¹è±¡å­˜å‚¨

## ğŸ“‹ é—®é¢˜
é¡¹ç›®å¯¹è±¡å­˜å‚¨æ˜¯ä»€ä¹ˆï¼Ÿ

## âœ… å›ç­”

é¡¹ç›®é›†æˆäº† **S3 å…¼å®¹å¯¹è±¡å­˜å‚¨**ï¼Œæ”¯æŒå¤šç§å­˜å‚¨æä¾›å•†ï¼Œä¸»è¦æ¨èä½¿ç”¨ **Cloudflare R2**ã€‚

### â˜ï¸ å­˜å‚¨æ¶æ„

#### æä¾›å•†æ¨¡å¼è®¾è®¡

**æ–‡ä»¶**: `src/storage/index.ts`

```typescript
// å­˜å‚¨æä¾›å•†æ¥å£
export interface StorageProvider {
  upload(key: string, file: Buffer, contentType: string): Promise<string>;
  delete(key: string): Promise<void>;
}

// æä¾›å•†å·¥å‚
class StorageProviderFactory {
  private static instance: StorageProvider;

  static getProvider(): StorageProvider {
    if (!this.instance) {
      const providerType = websiteConfig.storage.provider;

      switch (providerType) {
        case 's3':
          this.instance = new S3Provider();
          break;
        default:
          throw new Error(`Unsupported storage provider: ${providerType}`);
      }
    }
    return this.instance;
  }
}

export const storageProvider = StorageProviderFactory.getProvider();
```

**æ¥æº**: `src/storage/index.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

### ğŸ“¦ S3 æä¾›å•†å®ç°

#### æ ¸å¿ƒåº“

```json
{
  "s3mini": "0.2.0"  // Cloudflare Workers å…¼å®¹çš„ S3 å®¢æˆ·ç«¯
}
```

**é€‰æ‹©ç†ç”±**:
- è½»é‡çº§ï¼ˆé€‚åˆè¾¹ç¼˜è®¡ç®—ï¼‰
- Cloudflare Workers å…¼å®¹
- æ”¯æŒæ ‡å‡† S3 API

**æ¥æº**: `package.json`

#### å®ç°ä»£ç 

**æ–‡ä»¶**: `src/storage/provider/s3.ts`

```typescript
import { S3Client } from 's3mini';

export class S3Provider implements StorageProvider {
  private client: S3Client;

  constructor() {
    // ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
    const config = {
      region: process.env.STORAGE_REGION!,        // é€šå¸¸æ˜¯ 'auto'
      endpoint: process.env.STORAGE_ENDPOINT!,    // R2 endpoint
      credentials: {
        accessKeyId: process.env.STORAGE_ACCESS_KEY_ID!,
        secretAccessKey: process.env.STORAGE_SECRET_ACCESS_KEY!
      }
    };

    this.client = new S3Client(config);
  }

  async upload(
    key: string,
    file: Buffer,
    contentType: string
  ): Promise<string> {
    const bucketName = process.env.STORAGE_BUCKET_NAME!;

    try {
      await this.client.putObject({
        Bucket: bucketName,
        Key: key,
        Body: file,
        ContentType: contentType
      });

      // è¿”å›å…¬å¼€ URL
      const publicUrl = process.env.STORAGE_PUBLIC_URL!;
      return `${publicUrl}/${key}`;
    } catch (error) {
      console.error('S3 upload failed:', error);
      throw new Error('Failed to upload file to S3');
    }
  }

  async delete(key: string): Promise<void> {
    const bucketName = process.env.STORAGE_BUCKET_NAME!;

    try {
      await this.client.deleteObject({
        Bucket: bucketName,
        Key: key
      });
    } catch (error) {
      console.error('S3 delete failed:', error);
      throw new Error('Failed to delete file from S3');
    }
  }
}
```

**æ¥æº**: `src/storage/provider/s3.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

### ğŸ”§ é…ç½®

#### ç¯å¢ƒå˜é‡

**æ–‡ä»¶**: `env.example`

```bash
# å­˜å‚¨é…ç½®ï¼ˆCloudflare R2 æˆ– S3 å…¼å®¹æœåŠ¡ï¼‰
STORAGE_REGION="auto"                      # Cloudflare R2 ä½¿ç”¨ 'auto'
STORAGE_BUCKET_NAME=""                     # Bucket åç§°
STORAGE_ACCESS_KEY_ID=""                   # è®¿é—®å¯†é’¥ ID
STORAGE_SECRET_ACCESS_KEY=""               # è®¿é—®å¯†é’¥
STORAGE_ENDPOINT=""                        # R2 endpoint URL
STORAGE_PUBLIC_URL=""                      # å…¬å¼€è®¿é—® URL
```

**æ¥æº**: `env.example`

#### åº”ç”¨é…ç½®

**æ–‡ä»¶**: `src/config/website.tsx`

```typescript
export const websiteConfig = {
  storage: {
    enable: true,           // å¯ç”¨å­˜å‚¨
    provider: 's3'          // ä½¿ç”¨ S3 å…¼å®¹æä¾›å•†
  }
}
```

**æ¥æº**: `src/config/website.tsx`

### ğŸ“¤ æ–‡ä»¶ä¸Šä¼  API

#### API è·¯ç”±

**æ–‡ä»¶**: `src/app/api/storage/upload/route.ts`

```typescript
import { storageProvider } from '@/storage';

export async function POST(req: Request) {
  try {
    // 1. è§£æ FormData
    const formData = await req.formData();
    const file = formData.get('file') as File;

    if (!file) {
      return Response.json(
        { error: 'No file provided' },
        { status: 400 }
      );
    }

    // 2. éªŒè¯æ–‡ä»¶å¤§å°
    const MAX_FILE_SIZE = 4 * 1024 * 1024;  // 4MB
    if (file.size > MAX_FILE_SIZE) {
      return Response.json(
        { error: 'File too large. Max size: 4MB' },
        { status: 400 }
      );
    }

    // 3. éªŒè¯æ–‡ä»¶ç±»å‹
    const ALLOWED_TYPES = [
      'image/jpeg',
      'image/png',
      'image/webp'
    ];

    if (!ALLOWED_TYPES.includes(file.type)) {
      return Response.json(
        { error: 'Invalid file type' },
        { status: 400 }
      );
    }

    // 4. ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
    const timestamp = Date.now();
    const randomString = Math.random().toString(36).substring(2, 15);
    const extension = file.name.split('.').pop();
    const key = `uploads/${timestamp}-${randomString}.${extension}`;

    // 5. è½¬æ¢ä¸º Buffer
    const arrayBuffer = await file.arrayBuffer();
    const buffer = Buffer.from(arrayBuffer);

    // 6. ä¸Šä¼ åˆ°å­˜å‚¨
    const url = await storageProvider.upload(
      key,
      buffer,
      file.type
    );

    // 7. è¿”å›ç»“æœ
    return Response.json({
      url,
      key,
      size: file.size,
      type: file.type
    });

  } catch (error) {
    console.error('Upload error:', error);
    return Response.json(
      { error: 'Failed to upload file' },
      { status: 500 }
    );
  }
}
```

**æ¥æº**: `src/app/api/storage/upload/route.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

### ğŸŒ æ”¯æŒçš„å­˜å‚¨æä¾›å•†

#### 1. Cloudflare R2ï¼ˆæ¨èï¼‰

**ä¼˜åŠ¿**:
- âœ… **é›¶æµé‡è´¹ç”¨** - ä¸æ”¶å–å‡ºç«™æµé‡è´¹
- âœ… **å…è´¹å±‚æ…·æ…¨** - 10GB å­˜å‚¨ + 100 ä¸‡æ¬¡æ“ä½œ/æœˆ
- âœ… **å…¨çƒ CDN** - Cloudflare ç½‘ç»œåŠ é€Ÿ
- âœ… **S3 å…¼å®¹** - æ— ç¼è¿ç§»
- âœ… **Workers é›†æˆ** - å¯éƒ¨ç½²åˆ°è¾¹ç¼˜

**å®šä»·**:
- å­˜å‚¨ï¼š$0.015/GB/æœˆ
- Class A æ“ä½œï¼ˆå†™ï¼‰ï¼š$4.50/ç™¾ä¸‡æ¬¡
- Class B æ“ä½œï¼ˆè¯»ï¼‰ï¼š$0.36/ç™¾ä¸‡æ¬¡
- **å‡ºç«™æµé‡ï¼š$0**ï¼ˆæ ¸å¿ƒä¼˜åŠ¿ï¼‰

**é…ç½®ç¤ºä¾‹**:
```bash
STORAGE_REGION="auto"
STORAGE_BUCKET_NAME="my-app-files"
STORAGE_ACCESS_KEY_ID="<R2_ACCESS_KEY_ID>"
STORAGE_SECRET_ACCESS_KEY="<R2_SECRET_ACCESS_KEY>"
STORAGE_ENDPOINT="https://<ACCOUNT_ID>.r2.cloudflarestorage.com"
STORAGE_PUBLIC_URL="https://files.yourdomain.com"
```

**æ¥æº**: Cloudflare R2 å®˜æ–¹æ–‡æ¡£

#### 2. AWS S3

**ä¼˜åŠ¿**:
- âœ… è¡Œä¸šæ ‡å‡†
- âœ… åŠŸèƒ½ä¸°å¯Œï¼ˆç‰ˆæœ¬æ§åˆ¶ã€ç”Ÿå‘½å‘¨æœŸç­‰ï¼‰
- âœ… å…¨çƒå¯ç”¨

**åŠ£åŠ¿**:
- âŒ å‡ºç«™æµé‡è´¹ç”¨ï¼ˆ$0.09/GBï¼‰
- âŒ ä»·æ ¼ç›¸å¯¹è¾ƒé«˜

**é…ç½®ç¤ºä¾‹**:
```bash
STORAGE_REGION="us-east-1"
STORAGE_BUCKET_NAME="my-app-bucket"
STORAGE_ACCESS_KEY_ID="<AWS_ACCESS_KEY_ID>"
STORAGE_SECRET_ACCESS_KEY="<AWS_SECRET_ACCESS_KEY>"
STORAGE_ENDPOINT="https://s3.us-east-1.amazonaws.com"
STORAGE_PUBLIC_URL="https://my-app-bucket.s3.amazonaws.com"
```

#### 3. å…¶ä»– S3 å…¼å®¹æœåŠ¡

**æ”¯æŒ**:
- MinIOï¼ˆè‡ªæ‰˜ç®¡ï¼‰
- DigitalOcean Spaces
- Backblaze B2
- Wasabi
- Linode Object Storage

**æ¥æº**: s3mini åº“å…¼å®¹æ€§

### ğŸ“ å­˜å‚¨é…ç½®æ–‡ä»¶

**æ–‡ä»¶**: `src/storage/config/storage-config.ts`

```typescript
export interface StorageConfig {
  region: string;
  bucketName: string;
  accessKeyId: string;
  secretAccessKey: string;
  endpoint: string;
  publicUrl: string;
}

export function getStorageConfig(): StorageConfig {
  return {
    region: process.env.STORAGE_REGION!,
    bucketName: process.env.STORAGE_BUCKET_NAME!,
    accessKeyId: process.env.STORAGE_ACCESS_KEY_ID!,
    secretAccessKey: process.env.STORAGE_SECRET_ACCESS_KEY!,
    endpoint: process.env.STORAGE_ENDPOINT!,
    publicUrl: process.env.STORAGE_PUBLIC_URL!
  };
}
```

**æ¥æº**: `src/storage/config/storage-config.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

### âš™ï¸ ä½¿ç”¨é™åˆ¶

#### æ–‡ä»¶å¤§å°é™åˆ¶

```typescript
const MAX_FILE_SIZE = 4 * 1024 * 1024;  // 4MB
```

**åŸå› **: Vercel å‡½æ•°è¯·æ±‚ä½“é™åˆ¶

**æ¥æº**: `src/lib/constants.ts`, `src/app/api/storage/upload/route.ts`

#### æ–‡ä»¶ç±»å‹é™åˆ¶

```typescript
const ALLOWED_TYPES = [
  'image/jpeg',
  'image/png',
  'image/webp'
];
```

**ç”¨é€”**: ç›®å‰ä»…æ”¯æŒå›¾ç‰‡ä¸Šä¼ 

**æ¥æº**: `src/app/api/storage/upload/route.ts`

### ğŸ¯ å­˜å‚¨ä½¿ç”¨åœºæ™¯

#### 1. ç”¨æˆ·å¤´åƒä¸Šä¼ 

**æµç¨‹**:
```
ç”¨æˆ·é€‰æ‹©å›¾ç‰‡ â†’ POST /api/storage/upload â†’ è¿”å› URL â†’ æ›´æ–° user.image
```

**é…ç½®**: `src/config/website.tsx`
```typescript
features: {
  enableUpdateAvatar: true  // å¯ç”¨å¤´åƒæ›´æ–°
}
```

**æ¥æº**: `src/config/website.tsx`

#### 2. AI ç”Ÿæˆå›¾ç‰‡å­˜å‚¨

**å¯é€‰åœºæ™¯**: å°† AI ç”Ÿæˆçš„å›¾ç‰‡å­˜å‚¨åˆ° R2ï¼Œè€Œä¸æ˜¯ä¾èµ–ä¸´æ—¶ URL

#### 3. åšå®¢å›¾ç‰‡

**å¯é€‰åœºæ™¯**: MDX åšå®¢æ–‡ç« çš„å›¾ç‰‡èµ„æº

### ğŸ”„ å­˜å‚¨æ“ä½œ

#### ä¸Šä¼ æ–‡ä»¶

```typescript
import { storageProvider } from '@/storage';

const url = await storageProvider.upload(
  'uploads/my-file.jpg',  // key
  fileBuffer,             // Buffer
  'image/jpeg'            // contentType
);
```

#### åˆ é™¤æ–‡ä»¶

```typescript
import { storageProvider } from '@/storage';

await storageProvider.delete('uploads/my-file.jpg');
```

**æ¥æº**: `src/storage/index.ts`

### ğŸ’° æˆæœ¬ä¼°ç®—ï¼ˆCloudflare R2ï¼‰

**å‡è®¾åœºæ™¯**: 1000 æ´»è·ƒç”¨æˆ·

| æ“ä½œ | æ•°é‡/æœˆ | è´¹ç”¨ |
|------|---------|------|
| å­˜å‚¨ | 10GB | $0.15 |
| ä¸Šä¼ ï¼ˆClass Aï¼‰| 10,000 æ¬¡ | $0.05 |
| ä¸‹è½½ï¼ˆClass Bï¼‰| 100,000 æ¬¡ | $0.04 |
| å‡ºç«™æµé‡ | 100GB | **$0** |
| **æ€»è®¡** | - | **$0.24/æœˆ** |

**å¯¹æ¯” AWS S3**:
- å‡ºç«™æµé‡ 100GB: **$9.00**
- æ€»è®¡çº¦: **$9.24/æœˆ**

**æˆæœ¬ä¼˜åŠ¿**: R2 æ¯” S3 ä¾¿å®œ 97%ï¼ˆä¸»è¦çœåœ¨æµé‡è´¹ï¼‰

**æ¥æº**: Cloudflare R2 å’Œ AWS S3 å®˜æ–¹å®šä»·

### ğŸš€ æ‰©å±•æ€§

#### æ·»åŠ æ–°æä¾›å•†

1. åœ¨ `src/storage/provider/` åˆ›å»ºæ–°æä¾›å•†ç±»
2. å®ç° `StorageProvider` æ¥å£
3. åœ¨ `StorageProviderFactory` æ·»åŠ åˆ†æ”¯
4. æ›´æ–°é…ç½®å’Œç¯å¢ƒå˜é‡

**ç¤ºä¾‹**: æ·»åŠ  UploadThing æä¾›å•†
```typescript
// src/storage/provider/uploadthing.ts
export class UploadThingProvider implements StorageProvider {
  async upload(key: string, file: Buffer, contentType: string) {
    // å®ç° UploadThing ä¸Šä¼ é€»è¾‘
  }

  async delete(key: string) {
    // å®ç° UploadThing åˆ é™¤é€»è¾‘
  }
}
```

### ğŸ” å®‰å…¨æ€§

1. **è®¿é—®æ§åˆ¶**:
   - Bucket é»˜è®¤ç§æœ‰
   - é€šè¿‡ç­¾å URL æˆ–å…¬å¼€ URL è®¿é—®

2. **ç¯å¢ƒå˜é‡**:
   - å¯†é’¥å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡
   - ä¸æäº¤åˆ°ä»£ç åº“

3. **æ–‡ä»¶éªŒè¯**:
   - ç±»å‹æ£€æŸ¥
   - å¤§å°é™åˆ¶
   - æ–‡ä»¶åæ¸…ç†

4. **CORS é…ç½®**:
   - ä»…å…è®¸ç‰¹å®šæ¥æºä¸Šä¼ 

**æ¥æº**: æœ€ä½³å®è·µ

## ğŸ“ ä¿¡æ¯æ¥æº
- `src/storage/` - å­˜å‚¨å®ç°
- `src/app/api/storage/upload/route.ts` - ä¸Šä¼  API
- `src/config/website.tsx` - å­˜å‚¨é…ç½®
- `env.example` - ç¯å¢ƒå˜é‡
- `package.json` - s3mini ä¾èµ–
- Cloudflare R2 å®˜æ–¹æ–‡æ¡£ - å®šä»·å’ŒåŠŸèƒ½
