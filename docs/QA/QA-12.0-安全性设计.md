# QA-12.0 å®‰å…¨æ€§è®¾è®¡

## ğŸ“‹ é—®é¢˜
é¡¹ç›®çš„å®‰å…¨æ€§è®¾è®¡æ€ä¹ˆæ ·ï¼Œå®‰å…¨è¦æ±‚ï¼Ÿ

## âœ… å›ç­”

é¡¹ç›®å®æ–½äº†**å¤šå±‚å®‰å…¨ç­–ç•¥**ï¼Œæ¶µç›–è®¤è¯ã€æˆæƒã€æ•°æ®éªŒè¯ã€API å®‰å…¨ç­‰æ–¹é¢ã€‚

### ğŸ” è®¤è¯å®‰å…¨

#### 1. Better Auth å®‰å…¨ç‰¹æ€§

**å¯†ç å®‰å…¨**:

```typescript
// src/lib/auth.ts
emailAndPassword: {
  enabled: true,
  requireEmailVerification: true,  // å¼ºåˆ¶é‚®ç®±éªŒè¯
  sendResetPassword: async ({ user, url }) => {
    // å‘é€å¯†ç é‡ç½®é‚®ä»¶
  }
}
```

**å¯†ç è¦æ±‚**:
- æœ€å°é•¿åº¦: 8 å­—ç¬¦ï¼ˆBetter Auth é»˜è®¤ï¼‰
- å¯†ç å“ˆå¸Œ: bcrypt
- å­˜å‚¨ä½ç½®: `account.password`

**æ¥æº**: `src/lib/auth.ts`

#### 2. ä¼šè¯ç®¡ç†

```typescript
session: {
  expiresIn: 60 * 60 * 24 * 7,      // 7 å¤©è¿‡æœŸ
  updateAge: 60 * 60 * 24,          // 24 å°æ—¶æ›´æ–°ä¸€æ¬¡
  freshAge: 0,                      // ç¦ç”¨æ–°é²œåº¦æ£€æŸ¥
  cookieCache: {
    enabled: true,
    maxAge: 60 * 60                 // 1 å°æ—¶ç¼“å­˜
  }
}
```

**å®‰å…¨æªæ–½**:
- âœ… HttpOnly Cookie
- âœ… Secure Cookie (HTTPS)
- âœ… SameSite=Lax
- âœ… å®šæœŸæ›´æ–° token
- âœ… IP åœ°å€è®°å½•
- âœ… User Agent è®°å½•

**æ¥æº**: `src/lib/auth.ts`, `src/db/schema.ts`

#### 3. OAuth å®‰å…¨

```typescript
account: {
  accountLinking: {
    enabled: true,
    trustedProviders: ['google', 'github']  // ä»…ä¿¡ä»»çš„æä¾›å•†
  }
}
```

**OAuth ä»¤ç‰Œç®¡ç†**:
- è®¿é—®ä»¤ç‰Œï¼ˆaccessTokenï¼‰å­˜å‚¨
- åˆ·æ–°ä»¤ç‰Œï¼ˆrefreshTokenï¼‰å­˜å‚¨
- ä»¤ç‰Œè¿‡æœŸæ—¶é—´è¿½è¸ª
- è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°

**æ¥æº**: `src/lib/auth.ts`, `src/db/schema.ts`

#### 4. é‚®ç®±éªŒè¯

```typescript
verification: {
  identifier: string,  // é‚®ç®±
  value: string,       // éªŒè¯ç /ä»¤ç‰Œ
  expiresAt: Date      // è¿‡æœŸæ—¶é—´
}
```

**å®‰å…¨ç‰¹æ€§**:
- âœ… éªŒè¯ç æœ‰æ—¶æ•ˆæ€§
- âœ… ä¸€æ¬¡æ€§ä½¿ç”¨
- âœ… å®‰å…¨éšæœºç”Ÿæˆ

**æ¥æº**: `src/db/schema.ts`

### ğŸ›¡ï¸ æˆæƒå’Œæƒé™

#### 1. ä¸‰å±‚æƒé™ç³»ç»Ÿ

**æ–‡ä»¶**: `src/lib/safe-action.ts`

```typescript
// 1. å…¬å¼€ Action
export const actionClient = createSafeActionClient();

// 2. ç”¨æˆ· Actionï¼ˆéœ€è¦ç™»å½•ï¼‰
export const userActionClient = actionClient.use(async ({ next }) => {
  const session = await getSession();
  if (!session?.user) {
    throw new Error('Unauthorized', { code: 'UNAUTHORIZED' });
  }
  return next({ ctx: { userId: session.user.id, user: session.user } });
});

// 3. ç®¡ç†å‘˜ Actionï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
export const adminActionClient = userActionClient.use(async ({ next, ctx }) => {
  const isDemoWebsite = process.env.NEXT_PUBLIC_DEMO_WEBSITE === 'true';
  if (ctx.user.role !== 'admin' && !isDemoWebsite) {
    throw new Error('Unauthorized', { code: 'UNAUTHORIZED' });
  }
  return next({ ctx });
});
```

**æ¥æº**: `src/lib/safe-action.ts`

#### 2. ç”¨æˆ·è§’è‰²

```typescript
user: {
  role: 'admin' | 'user' | null
}
```

**æƒé™æ§åˆ¶**:
- **admin**: ç”¨æˆ·ç®¡ç†ã€å°ç¦ã€æŸ¥çœ‹æ‰€æœ‰æ•°æ®
- **user**: æ ‡å‡†ç”¨æˆ·æƒé™
- **null**: é»˜è®¤ç”¨æˆ·

**æ¥æº**: `src/db/schema.ts`

#### 3. ç”¨æˆ·å°ç¦

```typescript
user: {
  banned: boolean,
  banReason: string,
  banExpires: Date
}
```

**å°ç¦ç®¡ç†**:
- âœ… æ°¸ä¹…å°ç¦
- âœ… ä¸´æ—¶å°ç¦ï¼ˆbanExpiresï¼‰
- âœ… å°ç¦åŸå› è®°å½•
- âœ… ç®¡ç†å‘˜æ“ä½œæ—¥å¿—

**æ¥æº**: `src/db/schema.ts`

**Better Auth å°ç¦æ’ä»¶**:

```typescript
admin({
  defaultBanExpiresIn: undefined,  // é»˜è®¤æ°¸ä¹…å°ç¦
  bannedUserMessage: 'You have been banned from this application. Please contact support.'
})
```

**æ¥æº**: `src/lib/auth.ts`

### ğŸ”’ æ•°æ®éªŒè¯

#### 1. Zod Schema éªŒè¯

**æ‰€æœ‰ Server Actions éƒ½ä½¿ç”¨ Zod éªŒè¯**:

```typescript
// src/actions/consume-credits.ts
const schema = z.object({
  userId: z.string(),
  amount: z.number().positive(),
  description: z.string().optional()
});

export const consumeCreditsAction = userActionClient
  .schema(schema)
  .action(async ({ parsedInput }) => {
    // å·²éªŒè¯çš„è¾“å…¥
  });
```

**æ¥æº**: `src/actions/consume-credits.ts`

**éªŒè¯ç±»å‹**:
- âœ… ç±»å‹éªŒè¯ï¼ˆstring, number, booleanï¼‰
- âœ… æ ¼å¼éªŒè¯ï¼ˆemail, uuidï¼‰
- âœ… èŒƒå›´éªŒè¯ï¼ˆmin, max, positiveï¼‰
- âœ… è‡ªå®šä¹‰éªŒè¯

#### 2. æ–‡ä»¶ä¸Šä¼ éªŒè¯

**æ–‡ä»¶**: `src/app/api/storage/upload/route.ts`

```typescript
// 1. æ–‡ä»¶å¤§å°éªŒè¯
const MAX_FILE_SIZE = 4 * 1024 * 1024;  // 4MB
if (file.size > MAX_FILE_SIZE) {
  return Response.json({ error: 'File too large' }, { status: 400 });
}

// 2. æ–‡ä»¶ç±»å‹éªŒè¯
const ALLOWED_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
if (!ALLOWED_TYPES.includes(file.type)) {
  return Response.json({ error: 'Invalid file type' }, { status: 400 });
}

// 3. æ–‡ä»¶åæ¸…ç†ï¼ˆé˜²æ­¢è·¯å¾„ç©¿è¶Šï¼‰
const extension = file.name.split('.').pop();
const key = `uploads/${timestamp}-${randomString}.${extension}`;
```

**æ¥æº**: `src/app/api/storage/upload/route.ts`

#### 3. SQL æ³¨å…¥é˜²æŠ¤

**Drizzle ORM å‚æ•°åŒ–æŸ¥è¯¢**:

```typescript
// å®‰å…¨ï¼šå‚æ•°åŒ–æŸ¥è¯¢
await db
  .select()
  .from(user)
  .where(eq(user.email, userEmail));

// å±é™©ï¼šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆé¡¹ç›®ä¸­æœªä½¿ç”¨ï¼‰
// await db.execute(`SELECT * FROM user WHERE email = '${userEmail}'`);
```

**æ¥æº**: Drizzle ORM è‡ªåŠ¨é˜²æŠ¤

### ğŸŒ API å®‰å…¨

#### 1. Webhook ç­¾åéªŒè¯

**Stripe Webhook**:

```typescript
// src/app/api/webhooks/stripe/route.ts
import Stripe from 'stripe';

const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);

export async function POST(request: Request) {
  const body = await request.text();
  const signature = request.headers.get('stripe-signature')!;

  try {
    // éªŒè¯ç­¾å
    const event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
    // ç­¾åæœ‰æ•ˆï¼Œå¤„ç†äº‹ä»¶
  } catch (err) {
    // ç­¾åæ— æ•ˆï¼Œæ‹’ç»è¯·æ±‚
    return Response.json({ error: 'Invalid signature' }, { status: 400 });
  }
}
```

**æ¥æº**: `src/app/api/webhooks/stripe/route.ts`

#### 2. Cron Job æˆæƒ

**Basic Auth éªŒè¯**:

```typescript
// src/app/api/distribute-credits/route.ts
export async function GET(request: Request) {
  const auth = request.headers.get('authorization');

  const [username, password] = Buffer.from(
    auth?.split(' ')[1] || '',
    'base64'
  ).toString().split(':');

  if (
    username !== process.env.CRON_JOBS_USERNAME ||
    password !== process.env.CRON_JOBS_PASSWORD
  ) {
    return Response.json({ error: 'Unauthorized' }, { status: 401 });
  }

  // æˆæƒé€šè¿‡ï¼Œæ‰§è¡Œä»»åŠ¡
}
```

**æ¥æº**: `src/app/api/distribute-credits/route.ts`, `env.example`

#### 3. Captcha éªŒè¯ï¼ˆå¯é€‰ï¼‰

**Cloudflare Turnstile**:

```typescript
// src/actions/validate-captcha.ts
export const validateCaptchaAction = actionClient
  .schema(z.object({
    token: z.string()
  }))
  .action(async ({ parsedInput: { token } }) => {
    const response = await fetch(
      'https://challenges.cloudflare.com/turnstile/v0/siteverify',
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          secret: process.env.TURNSTILE_SECRET_KEY,
          response: token
        })
      }
    );

    const data = await response.json();
    return { success: data.success };
  });
```

**é…ç½®**: `src/config/website.tsx`

```typescript
features: {
  enableTurnstileCaptcha: false  // é»˜è®¤ç¦ç”¨
}
```

**æ¥æº**: `src/actions/validate-captcha.ts`, `src/config/website.tsx`, `env.example`

**ä¾èµ–**: `package.json`

```json
{
  "@marsidev/react-turnstile": "^1.1.0"
}
```

**æ¥æº**: `package.json`

#### 4. API é€Ÿç‡é™åˆ¶ï¼ˆæœªå®æ–½ï¼Œå»ºè®®ï¼‰

**æ¨èå®ç°**:

```typescript
import { Ratelimit } from '@upstash/ratelimit';
import { Redis } from '@upstash/redis';

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '10 s'),  // 10 è¯·æ±‚/10 ç§’
});

export async function POST(request: Request) {
  const ip = request.headers.get('x-forwarded-for') || 'unknown';
  const { success } = await ratelimit.limit(ip);

  if (!success) {
    return Response.json({ error: 'Too many requests' }, { status: 429 });
  }

  // å¤„ç†è¯·æ±‚
}
```

**æˆæœ¬**: Upstash Redis å…è´¹å±‚ 10k å‘½ä»¤/å¤©

### ğŸ”‘ å¯†é’¥ç®¡ç†

#### 1. ç¯å¢ƒå˜é‡

**æ‰€æœ‰æ•æ„Ÿä¿¡æ¯å­˜å‚¨åœ¨ç¯å¢ƒå˜é‡**:

```bash
# è®¤è¯å¯†é’¥
BETTER_AUTH_SECRET="<32 å­—ç¬¦éšæœºå­—ç¬¦ä¸²>"

# OAuth å¯†é’¥
GITHUB_CLIENT_SECRET=""
GOOGLE_CLIENT_SECRET=""

# æ”¯ä»˜å¯†é’¥
STRIPE_SECRET_KEY=""
STRIPE_WEBHOOK_SECRET=""

# API å¯†é’¥
RESEND_API_KEY=""
OPENAI_API_KEY=""
```

**æ¥æº**: `env.example`

#### 2. å¯†é’¥å®‰å…¨

**æœ€ä½³å®è·µ**:
- âœ… ä¸æäº¤åˆ°ä»£ç åº“ï¼ˆ`.gitignore` åŒ…å« `.env*`ï¼‰
- âœ… ä½¿ç”¨å¹³å°ç¯å¢ƒå˜é‡ç®¡ç†ï¼ˆVercel/Cloudflareï¼‰
- âœ… å®šæœŸè½®æ¢å¯†é’¥
- âœ… æœ€å°æƒé™åŸåˆ™

#### 3. å®¢æˆ·ç«¯ vs æœåŠ¡ç«¯å¯†é’¥

**å®¢æˆ·ç«¯å®‰å…¨å¯†é’¥** (NEXT_PUBLIC_):
```bash
NEXT_PUBLIC_BASE_URL=""           # å…¬å¼€
NEXT_PUBLIC_POSTHOG_KEY=""        # å…¬å¼€
NEXT_PUBLIC_STRIPE_PRICE_*=""     # å…¬å¼€ï¼ˆPrice IDï¼‰
```

**æœåŠ¡ç«¯å¯†é’¥** (æ— å‰ç¼€):
```bash
STRIPE_SECRET_KEY=""              # ç§å¯†
BETTER_AUTH_SECRET=""             # ç§å¯†
DATABASE_URL=""                   # ç§å¯†
```

**æ¥æº**: Next.js ç¯å¢ƒå˜é‡è§„èŒƒ

### ğŸ›¡ï¸ æ•°æ®å®‰å…¨

#### 1. æ•°æ®åº“å®‰å…¨

**è¿æ¥å®‰å…¨**:
- âœ… SSL/TLS è¿æ¥ï¼ˆPostgreSQLï¼‰
- âœ… è¿æ¥æ± é™åˆ¶
- âœ… æœ€å°æƒé™æ•°æ®åº“ç”¨æˆ·

**æ•°æ®å®Œæ•´æ€§**:
- âœ… å¤–é”®çº¦æŸ
- âœ… å”¯ä¸€çº¦æŸ
- âœ… éç©ºçº¦æŸ
- âœ… äº‹åŠ¡æ”¯æŒ

**æ¥æº**: `src/db/schema.ts`

#### 2. æ•æ„Ÿæ•°æ®å¤„ç†

**å¯†ç **:
- âœ… bcrypt å“ˆå¸Œ
- âœ… ä»ä¸æ˜æ–‡å­˜å‚¨
- âœ… ä»ä¸åœ¨æ—¥å¿—ä¸­è®°å½•

**æ”¯ä»˜ä¿¡æ¯**:
- âœ… ä¸å­˜å‚¨ä¿¡ç”¨å¡ä¿¡æ¯ï¼ˆStripe æ‰˜ç®¡ï¼‰
- âœ… ä»…å­˜å‚¨ Stripe å®¢æˆ· ID å’Œè®¢é˜… ID

**ä¸ªäººä¿¡æ¯**:
- âœ… é‚®ç®±éªŒè¯
- âœ… GDPR åˆè§„è€ƒè™‘

**æ¥æº**: é¡¹ç›®è®¾è®¡

#### 3. æ•°æ®è®¿é—®æ§åˆ¶

```typescript
// ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
export const getCreditBalanceAction = userActionClient
  .schema(z.object({ userId: z.string() }))
  .action(async ({ parsedInput: { userId }, ctx }) => {
    // ctx.userId æ¥è‡ªä¼šè¯
    if (userId !== ctx.userId) {
      throw new Error('Unauthorized');
    }

    // æŸ¥è¯¢æ•°æ®
  });
```

**æ¥æº**: Server Actions è®¾è®¡æ¨¡å¼

### ğŸŒ ç½‘ç»œå®‰å…¨

#### 1. HTTPS

**å¼ºåˆ¶ HTTPS**:
- âœ… Vercel è‡ªåŠ¨æä¾›
- âœ… Cloudflare è‡ªåŠ¨æä¾›
- âœ… è‡ªåŠ¨é‡å®šå‘ HTTP â†’ HTTPS

#### 2. CORS

**Better Auth è‡ªåŠ¨å¤„ç†è®¤è¯ CORS**:

```typescript
// è‡ªå®šä¹‰ CORSï¼ˆå¦‚éœ€ï¼‰
export async function OPTIONS(request: Request) {
  return new Response(null, {
    headers: {
      'Access-Control-Allow-Origin': process.env.NEXT_PUBLIC_BASE_URL!,
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization'
    }
  });
}
```

#### 3. CSPï¼ˆå†…å®¹å®‰å…¨ç­–ç•¥ï¼‰

**æ¨èé…ç½®** (next.config.ts):

```typescript
async headers() {
  return [
    {
      source: '/(.*)',
      headers: [
        {
          key: 'Content-Security-Policy',
          value: "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline';"
        }
      ]
    }
  ];
}
```

**å½“å‰çŠ¶æ€**: æœªå®æ–½ï¼ˆå»ºè®®æ·»åŠ ï¼‰

### ğŸš¨ å®‰å…¨ç›‘æ§

#### 1. é”™è¯¯æ—¥å¿—

```typescript
// è®°å½•å®‰å…¨ç›¸å…³é”™è¯¯
console.error('[Security] Unauthorized access attempt:', {
  userId: session?.user.id,
  ip: request.headers.get('x-forwarded-for'),
  timestamp: new Date()
});
```

#### 2. é€šçŸ¥å‘Šè­¦

**Discord/é£ä¹¦é€šçŸ¥**:
- æ”¯ä»˜å¼‚å¸¸
- ç™»å½•å¤±è´¥ï¼ˆå¯æ·»åŠ ï¼‰
- API å¼‚å¸¸

**æ¥æº**: `src/notification/`

#### 3. å®¡è®¡æ—¥å¿—ï¼ˆå»ºè®®ï¼‰

**æ¨èå®ç°**:
- ç”¨æˆ·ç™»å½•/ç™»å‡º
- æƒé™å˜æ›´
- å°ç¦æ“ä½œ
- æ”¯ä»˜äº‹ä»¶

### ğŸ¯ å®‰å…¨è¦æ±‚æ€»ç»“

| å®‰å…¨å±‚é¢ | è¦æ±‚ | å®æ–½çŠ¶æ€ |
|---------|------|---------|
| è®¤è¯ | é‚®ç®±éªŒè¯ + å¯†ç å“ˆå¸Œ | âœ… å·²å®æ–½ |
| æˆæƒ | ä¸‰å±‚æƒé™ï¼ˆpublic/user/adminï¼‰ | âœ… å·²å®æ–½ |
| æ•°æ®éªŒè¯ | Zod schema éªŒè¯ | âœ… å·²å®æ–½ |
| SQL æ³¨å…¥ | å‚æ•°åŒ–æŸ¥è¯¢ | âœ… å·²å®æ–½ |
| Webhook å®‰å…¨ | ç­¾åéªŒè¯ | âœ… å·²å®æ–½ |
| Captcha | Cloudflare Turnstile | ğŸ”„ å¯é€‰ |
| é€Ÿç‡é™åˆ¶ | API é™æµ | âŒ æœªå®æ–½ |
| HTTPS | å¼ºåˆ¶ HTTPS | âœ… å·²å®æ–½ |
| CORS | è·¨åŸŸæ§åˆ¶ | âœ… å·²å®æ–½ |
| CSP | å†…å®¹å®‰å…¨ç­–ç•¥ | âŒ å»ºè®®æ·»åŠ  |
| å®¡è®¡æ—¥å¿— | æ“ä½œå®¡è®¡ | âŒ å»ºè®®æ·»åŠ  |

### ğŸ” å®‰å…¨æœ€ä½³å®è·µ

1. âœ… **æœ€å°æƒé™åŸåˆ™** - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
2. âœ… **æ·±åº¦é˜²å¾¡** - å¤šå±‚å®‰å…¨æªæ–½
3. âœ… **å®‰å…¨é»˜è®¤** - é»˜è®¤ç¦ç”¨ä¸å®‰å…¨åŠŸèƒ½
4. âœ… **å¯†é’¥ç®¡ç†** - ç¯å¢ƒå˜é‡ + å¹³å°ç®¡ç†
5. âœ… **è¾“å…¥éªŒè¯** - Zod schema éªŒè¯
6. âœ… **è¾“å‡ºç¼–ç ** - React è‡ªåŠ¨è½¬ä¹‰
7. âœ… **HTTPS å¼ºåˆ¶** - æ‰€æœ‰é€šä¿¡åŠ å¯†
8. âœ… **ä¼šè¯ç®¡ç†** - å®šæœŸæ›´æ–° + HttpOnly Cookie

## ğŸ“ ä¿¡æ¯æ¥æº
- `src/lib/auth.ts` - è®¤è¯é…ç½®
- `src/lib/safe-action.ts` - æˆæƒç³»ç»Ÿ
- `src/db/schema.ts` - æ•°æ®æ¨¡å‹å®‰å…¨
- `src/app/api/webhooks/stripe/route.ts` - Webhook å®‰å…¨
- `src/app/api/storage/upload/route.ts` - æ–‡ä»¶ä¸Šä¼ éªŒè¯
- `env.example` - å¯†é’¥é…ç½®
- Better Auth å®˜æ–¹æ–‡æ¡£ - å®‰å…¨ç‰¹æ€§
- Stripe å®˜æ–¹æ–‡æ¡£ - Webhook å®‰å…¨
