# QA-15.0 æ”¯ä»˜ç³»ç»Ÿè®¾è®¡

## ğŸ“‹ é—®é¢˜
é¡¹ç›®çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘æ”¯ä»˜å¦‚ä½•è®¾è®¡ï¼Ÿ

## âœ… å›ç­”

é¡¹ç›®ä½¿ç”¨ **Stripe** å®ç°äº†å®Œæ•´çš„æ”¯ä»˜ç³»ç»Ÿï¼Œé‡‡ç”¨**æä¾›å•†æ¨¡å¼**è®¾è®¡ï¼Œæ”¯æŒ**è®¢é˜…**ã€**ä¸€æ¬¡æ€§æ”¯ä»˜**å’Œ**ç§¯åˆ†è´­ä¹°**ä¸‰ç§åœºæ™¯ã€‚

### ğŸ—ï¸ æ”¯ä»˜æ¶æ„è®¾è®¡

#### æä¾›å•†æ¨¡å¼

**æ–‡ä»¶**: `src/payment/index.ts`

```typescript
// æ”¯ä»˜æä¾›å•†æ¥å£
export interface PaymentProvider {
  createCheckout(params: CreateCheckoutParams): Promise<CheckoutResult>;
  createCreditCheckout(params: CreditCheckoutParams): Promise<CheckoutResult>;
  createCustomerPortal(params: CustomerPortalParams): Promise<PortalResult>;
  handleWebhookEvent(payload: any, signature?: string): Promise<void>;
}

// æä¾›å•†å·¥å‚
class PaymentProviderFactory {
  private static instance: PaymentProvider;

  static getProvider(): PaymentProvider {
    if (!this.instance) {
      const providerType = websiteConfig.payment.provider;

      switch (providerType) {
        case 'stripe':
          this.instance = new StripeProvider();
          break;
        default:
          throw new Error(`Unsupported payment provider: ${providerType}`);
      }
    }
    return this.instance;
  }
}

export const paymentProvider = PaymentProviderFactory.getProvider();
```

**æ¥æº**: `src/payment/index.ts` (åŸºäº Explore ä»£ç†æŠ¥å‘Š)

**ä¼˜åŠ¿**:
- âœ… å¯æ‰©å±• - è½»æ¾æ·»åŠ æ–°æä¾›å•†ï¼ˆPayPal, Lemon Squeezy ç­‰ï¼‰
- âœ… è§£è€¦ - ä¸šåŠ¡é€»è¾‘ä¸æ”¯ä»˜å®ç°åˆ†ç¦»
- âœ… ç»Ÿä¸€æ¥å£ - ä¸€è‡´çš„è°ƒç”¨æ–¹å¼

#### æ”¯ä»˜ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `src/payment/types.ts`

```typescript
// æ”¯ä»˜ç±»å‹
export enum PaymentTypes {
  SUBSCRIPTION = 'subscription',  // è®¢é˜…ä»˜è´¹
  ONE_TIME = 'one_time'           // ä¸€æ¬¡æ€§ä»˜è´¹
}

// è®¡åˆ’å‘¨æœŸ
export enum PlanIntervals {
  MONTH = 'month',
  YEAR = 'year'
}

// æ”¯ä»˜åœºæ™¯
export enum PaymentScenes {
  LIFETIME = 'lifetime',          // ç»ˆèº«è®¡åˆ’
  CREDIT = 'credit',              // ç§¯åˆ†è´­ä¹°
  SUBSCRIPTION = 'subscription'   // è®¢é˜…è®¡åˆ’
}
```

**æ¥æº**: `src/payment/types.ts`

### ğŸ’³ Stripe æä¾›å•†å®ç°

#### æ ¸å¿ƒåŠŸèƒ½

**æ–‡ä»¶**: `src/payment/provider/stripe.ts`

**1. åˆ›å»ºç»“è´¦ä¼šè¯ï¼ˆè®¢é˜…/è®¡åˆ’ï¼‰**:

```typescript
async createCheckout(params: CreateCheckoutParams): Promise<CheckoutResult> {
  const {
    userId,
    userName,
    userEmail,
    planId,
    priceId,
    successUrl,
    cancelUrl,
    trialPeriodDays,
    allowPromotionCodes
  } = params;

  // 1. æŸ¥æ‰¾æˆ–åˆ›å»º Stripe å®¢æˆ·
  const customer = await this.createOrGetCustomer(userId, userEmail, userName);

  // 2. è·å–ä»·æ ¼ä¿¡æ¯
  const price = await stripe.prices.retrieve(priceId);
  const isSubscription = price.type === 'recurring';

  // 3. åˆ›å»ºç»“è´¦ä¼šè¯
  const session = await stripe.checkout.sessions.create({
    customer: customer.id,
    mode: isSubscription ? 'subscription' : 'payment',
    line_items: [
      {
        price: priceId,
        quantity: 1
      }
    ],
    success_url: successUrl,
    cancel_url: cancelUrl,
    allow_promotion_codes: allowPromotionCodes,
    subscription_data: isSubscription
      ? {
          trial_period_days: trialPeriodDays,
          metadata: {
            userId,
            userName,
            planId,
            scene: 'subscription'
          }
        }
      : undefined,
    metadata: {
      userId,
      userName,
      planId,
      scene: isSubscription ? 'subscription' : 'lifetime'
    }
  });

  return {
    url: session.url!,
    sessionId: session.id
  };
}
```

**æ¥æº**: `src/payment/provider/stripe.ts` (åŸºäºä»£ç é€»è¾‘)

**2. åˆ›å»ºç§¯åˆ†åŒ…ç»“è´¦**:

```typescript
async createCreditCheckout(params: CreditCheckoutParams): Promise<CheckoutResult> {
  const { userId, userEmail, userName, packageId, priceId, successUrl, cancelUrl } = params;

  const customer = await this.createOrGetCustomer(userId, userEmail, userName);

  const session = await stripe.checkout.sessions.create({
    customer: customer.id,
    mode: 'payment',
    line_items: [
      {
        price: priceId,
        quantity: 1
      }
    ],
    success_url: successUrl,
    cancel_url: cancelUrl,
    metadata: {
      userId,
      userName,
      packageId,
      scene: 'credit'
    }
  });

  return {
    url: session.url!,
    sessionId: session.id
  };
}
```

**æ¥æº**: `src/actions/create-credit-checkout-session.ts`

**3. åˆ›å»ºå®¢æˆ·é—¨æˆ·**:

```typescript
async createCustomerPortal(params: CustomerPortalParams): Promise<PortalResult> {
  const { customerId, returnUrl } = params;

  const session = await stripe.billingPortal.sessions.create({
    customer: customerId,
    return_url: returnUrl
  });

  return {
    url: session.url
  };
}
```

**åŠŸèƒ½**:
- æŸ¥çœ‹è®¢é˜…
- æ›´æ–°æ”¯ä»˜æ–¹å¼
- å–æ¶ˆè®¢é˜…
- æŸ¥çœ‹å‘ç¥¨å†å²

**æ¥æº**: `src/actions/create-customer-portal-session.ts`

**4. Webhook äº‹ä»¶å¤„ç†**:

```typescript
async handleWebhookEvent(event: Stripe.Event): Promise<void> {
  switch (event.type) {
    case 'checkout.session.completed':
      await this.handleCheckoutCompleted(event.data.object);
      break;

    case 'customer.subscription.updated':
      await this.handleSubscriptionUpdated(event.data.object);
      break;

    case 'customer.subscription.deleted':
      await this.handleSubscriptionDeleted(event.data.object);
      break;

    case 'invoice.paid':
      await this.handleInvoicePaid(event.data.object);
      break;

    case 'invoice.payment_failed':
      await this.handleInvoicePaymentFailed(event.data.object);
      break;

    default:
      console.log(`Unhandled event type: ${event.type}`);
  }
}
```

**æ¥æº**: `src/payment/provider/stripe.ts`

### ğŸ”„ æ”¯ä»˜æµç¨‹è®¾è®¡

#### æµç¨‹ 1: è®¢é˜…è®¡åˆ’æ”¯ä»˜

```
ç”¨æˆ·ç‚¹å‡»"è®¢é˜… Pro"
    â”‚
    â”œâ”€â”€â–º å‰ç«¯è°ƒç”¨ createCheckoutAction
    â”‚     - å‚æ•°: planId, priceId
    â”‚     - è¿”å›: checkout URL
    â”‚
    â”œâ”€â”€â–º ç”¨æˆ·è·³è½¬åˆ° Stripe Checkout
    â”‚     - Stripe æ‰˜ç®¡çš„å®‰å…¨æ”¯ä»˜é¡µé¢
    â”‚     - è¾“å…¥ä¿¡ç”¨å¡ä¿¡æ¯
    â”‚     - å®Œæˆæ”¯ä»˜
    â”‚
    â”œâ”€â”€â–º Stripe è§¦å‘ Webhook
    â”‚     - Event: checkout.session.completed
    â”‚     - POST /api/webhooks/stripe
    â”‚
    â”œâ”€â”€â–º Webhook å¤„ç†å™¨
    â”‚     â”œâ”€ éªŒè¯ç­¾å
    â”‚     â”œâ”€ åˆ›å»º payment è®°å½•
    â”‚     â”œâ”€ æ›´æ–° user.customerId
    â”‚     â”œâ”€ å‘æ”¾ç§¯åˆ†
    â”‚     â””â”€ å‘é€é€šçŸ¥
    â”‚
    â”œâ”€â”€â–º ç”¨æˆ·è¿”å›æˆåŠŸé¡µé¢
    â”‚     - success_url
    â”‚     - æ˜¾ç¤ºè®¢é˜…æˆåŠŸæ¶ˆæ¯
    â”‚
    â””â”€â”€â–º å‰ç«¯è½®è¯¢æ”¯ä»˜çŠ¶æ€
          - checkPaymentCompletionAction
          - ç¡®è®¤æ”¯ä»˜å®Œæˆåè·³è½¬
```

#### æµç¨‹ 2: ç§¯åˆ†åŒ…è´­ä¹°

```
ç”¨æˆ·ç‚¹å‡»"è´­ä¹° 100 ç§¯åˆ†"
    â”‚
    â”œâ”€â”€â–º å‰ç«¯è°ƒç”¨ createCreditCheckoutAction
    â”‚     - å‚æ•°: packageId, priceId
    â”‚     - è¿”å›: checkout URL
    â”‚
    â”œâ”€â”€â–º ç”¨æˆ·è·³è½¬åˆ° Stripe Checkout
    â”‚     - ä¸€æ¬¡æ€§æ”¯ä»˜
    â”‚
    â”œâ”€â”€â–º Stripe è§¦å‘ Webhook
    â”‚     - Event: checkout.session.completed
    â”‚
    â”œâ”€â”€â–º Webhook å¤„ç†å™¨
    â”‚     â”œâ”€ åˆ›å»º payment è®°å½•ï¼ˆscene: 'credit'ï¼‰
    â”‚     â”œâ”€ åˆ›å»º creditTransaction è®°å½•
    â”‚     â”œâ”€ æ›´æ–° userCredit.currentCredits
    â”‚     â””â”€ å‘é€é€šçŸ¥
    â”‚
    â””â”€â”€â–º ç”¨æˆ·è¿”å›æˆåŠŸé¡µé¢
          - ç§¯åˆ†å·²åˆ°è´¦
```

#### æµç¨‹ 3: è®¢é˜…ç®¡ç†

```
ç”¨æˆ·ç‚¹å‡»"ç®¡ç†è®¢é˜…"
    â”‚
    â”œâ”€â”€â–º å‰ç«¯è°ƒç”¨ createCustomerPortalAction
    â”‚     - å‚æ•°: returnUrl
    â”‚     - è¿”å›: portal URL
    â”‚
    â”œâ”€â”€â–º ç”¨æˆ·è·³è½¬åˆ° Stripe å®¢æˆ·é—¨æˆ·
    â”‚     - æŸ¥çœ‹è®¢é˜…è¯¦æƒ…
    â”‚     - æ›´æ–°æ”¯ä»˜æ–¹å¼
    â”‚     - å–æ¶ˆè®¢é˜…
    â”‚
    â”œâ”€â”€â–º ç”¨æˆ·æ“ä½œï¼ˆå¦‚å–æ¶ˆè®¢é˜…ï¼‰
    â”‚
    â”œâ”€â”€â–º Stripe è§¦å‘ Webhook
    â”‚     - Event: customer.subscription.deleted
    â”‚
    â”œâ”€â”€â–º Webhook å¤„ç†å™¨
    â”‚     - æ›´æ–° payment.status = 'canceled'
    â”‚     - åœæ­¢å‘æ”¾ç§¯åˆ†
    â”‚
    â””â”€â”€â–º ç”¨æˆ·è¿”å›åº”ç”¨
          - returnUrl
```

### ğŸ“Š æ•°æ®åº“è®¾è®¡

#### Payment è¡¨

**æ–‡ä»¶**: `src/db/schema.ts`

```typescript
export const payment = pgTable('payment', {
  id: text('id').primaryKey(),
  priceId: text('priceId').notNull(),

  // æ”¯ä»˜ç±»å‹
  type: text('type').notNull(),            // 'subscription' | 'one_time'
  scene: text('scene').notNull(),          // 'lifetime' | 'credit' | 'subscription'

  // ç”¨æˆ·å…³è”
  userId: text('userId').notNull().references(() => user.id),
  customerId: text('customerId').notNull(),

  // è®¢é˜…ä¿¡æ¯
  subscriptionId: text('subscriptionId'),
  status: text('status').notNull(),        // Stripe è®¢é˜…çŠ¶æ€
  paid: boolean('paid').default(false),

  // å‘¨æœŸ
  periodStart: timestamp('periodStart'),
  periodEnd: timestamp('periodEnd'),
  trialStart: timestamp('trialStart'),
  trialEnd: timestamp('trialEnd'),

  // å–æ¶ˆ
  cancelAtPeriodEnd: boolean('cancelAtPeriodEnd').default(false),

  // å‘ç¥¨ï¼ˆé˜²æ­¢é‡å¤å¤„ç†ï¼‰
  invoiceId: text('invoiceId').unique(),

  createdAt: timestamp('createdAt').notNull().defaultNow(),
  updatedAt: timestamp('updatedAt').notNull().defaultNow()
}, (table) => ({
  // 8 ä¸ªç´¢å¼•ç”¨äºå„ç§æŸ¥è¯¢
  paymentUserIdIdx: index('payment_user_id_idx').on(table.userId),
  paymentCustomerIdIdx: index('payment_customer_id_idx').on(table.customerId),
  paymentSubscriptionIdIdx: index('payment_subscription_id_idx').on(table.subscriptionId),
  paymentInvoiceIdIdx: index('payment_invoice_id_idx').on(table.invoiceId),
  paymentStatusIdx: index('payment_status_idx').on(table.status),
  paymentTypeIdx: index('payment_type_idx').on(table.type),
  paymentSceneIdx: index('payment_scene_idx').on(table.scene),
  paymentPaidIdx: index('payment_paid_idx').on(table.paid)
}));
```

**æ¥æº**: `src/db/schema.ts`

**å…³é”®è®¾è®¡**:
- âœ… `invoiceId` å”¯ä¸€çº¦æŸ - é˜²æ­¢ Webhook é‡å¤å¤„ç†
- âœ… 8 ä¸ªç´¢å¼• - è¦†ç›–å„ç§æŸ¥è¯¢åœºæ™¯
- âœ… `scene` å­—æ®µ - åŒºåˆ†æ”¯ä»˜åœºæ™¯
- âœ… `paid` å­—æ®µ - æ ‡è®°æ˜¯å¦å·²æ”¯ä»˜ï¼ˆinvoice.paid äº‹ä»¶è®¾ç½®ï¼‰

### ğŸ” å®‰å…¨è®¾è®¡

#### 1. Webhook ç­¾åéªŒè¯

**æ–‡ä»¶**: `src/app/api/webhooks/stripe/route.ts`

```typescript
export async function POST(request: Request) {
  const body = await request.text();
  const signature = request.headers.get('stripe-signature')!;

  let event: Stripe.Event;

  try {
    // éªŒè¯ç­¾å
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    );
  } catch (err) {
    console.error('Webhook signature verification failed:', err);
    return Response.json({ error: 'Invalid signature' }, { status: 400 });
  }

  // ç­¾åæœ‰æ•ˆï¼Œå¤„ç†äº‹ä»¶
  await paymentProvider.handleWebhookEvent(event);

  return Response.json({ received: true });
}
```

**æ¥æº**: `src/app/api/webhooks/stripe/route.ts`

#### 2. å¹‚ç­‰æ€§ä¿è¯

**é˜²æ­¢é‡å¤å¤„ç†**:

```typescript
// ä½¿ç”¨ invoiceId ä½œä¸ºå”¯ä¸€æ ‡è¯†
await db.insert(payment).values({
  id: nanoid(),
  invoiceId: invoice.id,  // å”¯ä¸€çº¦æŸ
  // ... å…¶ä»–å­—æ®µ
});

// å¦‚æœ invoiceId å·²å­˜åœ¨ï¼Œæ•°æ®åº“ä¼šæŠ›å‡ºé”™è¯¯
```

**æŸ¥è¯¢è€Œéåˆ›å»º**:

```typescript
// å…ˆæŸ¥è¯¢æ˜¯å¦å·²å­˜åœ¨
const existingPayment = await db
  .select()
  .from(payment)
  .where(eq(payment.invoiceId, invoice.id))
  .limit(1);

if (existingPayment.length > 0) {
  console.log('Payment already processed');
  return;
}

// ä¸å­˜åœ¨æ‰åˆ›å»º
```

#### 3. äº‹åŠ¡å®‰å…¨

```typescript
await db.transaction(async (tx) => {
  // 1. åˆ›å»ºæ”¯ä»˜è®°å½•
  await tx.insert(payment).values({...});

  // 2. å‘æ”¾ç§¯åˆ†
  await tx.update(userCredit)
    .set({ currentCredits: currentCredits + amount })
    .where(eq(userCredit.userId, userId));

  // 3. è®°å½•ç§¯åˆ†äº¤æ˜“
  await tx.insert(creditTransaction).values({...});
});

// è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
```

### ğŸ¯ æ”¯ä»˜ä¼˜åŒ–

#### 1. å¿«é€Ÿå“åº” Webhook

```typescript
// ç«‹å³è¿”å› 200ï¼Œé¿å… Stripe é‡è¯•
handleStripeEvent(event).catch((error) => {
  console.error('Webhook handler failed:', error);
});

return Response.json({ received: true });
```

#### 2. é‡è¯•æœºåˆ¶ï¼ˆStripe è‡ªåŠ¨ï¼‰

**Stripe é‡è¯•ç­–ç•¥**:
- é¦–æ¬¡å¤±è´¥: ç«‹å³é‡è¯•
- åç»­å¤±è´¥: æŒ‡æ•°é€€é¿ï¼ˆ1h, 2h, 4h, 8h...ï¼‰
- æœ€å¤šé‡è¯•: 3 å¤©

#### 3. æ”¯ä»˜è½®è¯¢

**å‰ç«¯è½®è¯¢**: `src/actions/check-payment-completion.ts`

```typescript
const PAYMENT_POLL_INTERVAL = 2000;      // 2 ç§’
const PAYMENT_MAX_POLL_TIME = 60000;     // æœ€å¤§ 60 ç§’
```

**æµç¨‹**:
```
æ”¯ä»˜æˆåŠŸ â†’ Webhook (å¯èƒ½å»¶è¿Ÿ) â†’ æ•°æ®åº“æ›´æ–° â†’ è½®è¯¢æ£€æµ‹ â†’ è·³è½¬
```

**æ¥æº**: `src/lib/constants.ts`, `src/actions/check-payment-completion.ts`

### ğŸ’° æ”¶ç›Šåˆ†æ

#### Stripe è´¹ç”¨

**æ ‡å‡†è´¹ç‡**:
- 2.9% + $0.30/ç¬”ï¼ˆç¾å›½ï¼‰
- 3.4% + $0.30/ç¬”ï¼ˆå›½é™…ï¼‰

**ç¤ºä¾‹**:
```
$9.90 Pro æœˆä»˜
- Stripe è´¹ç”¨: $0.59 (6%)
- å‡€æ”¶å…¥: $9.31

$99.00 Pro å¹´ä»˜
- Stripe è´¹ç”¨: $3.17 (3.2%)
- å‡€æ”¶å…¥: $95.83

$199.00 ç»ˆèº«è®¡åˆ’
- Stripe è´¹ç”¨: $6.07 (3.05%)
- å‡€æ”¶å…¥: $192.93
```

**è§‚å¯Ÿ**: å¤§é¢äº¤æ˜“çš„è´¹ç‡æ›´ä½ï¼ˆæ¥è¿‘ 3%ï¼‰

#### æ”¶å…¥ç¡®è®¤

**è®¢é˜…æ”¶å…¥**: æŒ‰æœˆç¡®è®¤
```
Pro æœˆä»˜: $9.31/æœˆ
Pro å¹´ä»˜: $95.83/12 = $7.99/æœˆ
```

**ä¸€æ¬¡æ€§æ”¶å…¥**: ç«‹å³ç¡®è®¤
```
ç»ˆèº«è®¡åˆ’: $192.93ï¼ˆä¸€æ¬¡æ€§ï¼‰
```

### ğŸ“Š æ”¯ä»˜ç›‘æ§

#### 1. æ”¯ä»˜é€šçŸ¥

**Discord/é£ä¹¦é€šçŸ¥**: `src/notification/`

```typescript
await sendNotification(
  sessionId,
  customerId,
  userName,
  amount
);
```

**è§¦å‘æ—¶æœº**:
- æ”¯ä»˜æˆåŠŸ
- è®¢é˜…æ›´æ–°
- æ”¯ä»˜å¤±è´¥

**æ¥æº**: `src/notification/`

#### 2. æ”¯ä»˜ä»ªè¡¨æ¿

**æ¨èæŒ‡æ ‡**:
- ä»Šæ—¥æ”¶å…¥
- æœˆæ”¶å…¥
- æ–°è®¢é˜…æ•°
- å–æ¶ˆè®¢é˜…æ•°
- æµå¤±ç‡
- ARPU

**å®ç°**: ä½¿ç”¨ Stripe Dashboard æˆ–è‡ªå»º

### ğŸš€ æ‰©å±•æ€§

#### æ·»åŠ æ–°æ”¯ä»˜æä¾›å•†

**ç¤ºä¾‹**: æ·»åŠ  Lemon Squeezy

```typescript
// 1. åˆ›å»ºæä¾›å•†ç±»
class LemonSqueezyProvider implements PaymentProvider {
  async createCheckout(params) {
    // å®ç° Lemon Squeezy Checkout
  }

  async handleWebhookEvent(event) {
    // å®ç° Lemon Squeezy Webhook å¤„ç†
  }

  // ... å…¶ä»–æ–¹æ³•
}

// 2. åœ¨å·¥å‚ä¸­æ³¨å†Œ
switch (providerType) {
  case 'stripe':
    this.instance = new StripeProvider();
    break;
  case 'lemon-squeezy':
    this.instance = new LemonSqueezyProvider();
    break;
}
```

## ğŸ“ ä¿¡æ¯æ¥æº
- `src/payment/` - æ”¯ä»˜ç³»ç»Ÿå®ç°
- `src/db/schema.ts` - Payment è¡¨ç»“æ„
- `src/app/api/webhooks/stripe/route.ts` - Webhook å¤„ç†
- `src/actions/` - æ”¯ä»˜ç›¸å…³ Server Actions
- `src/config/website.tsx` - å®šä»·é…ç½®
- `src/notification/` - æ”¯ä»˜é€šçŸ¥
- `env.example` - Stripe é…ç½®
- Stripe å®˜æ–¹æ–‡æ¡£ - API å’Œ Webhook
