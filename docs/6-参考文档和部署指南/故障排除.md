# 故障排除

常见问题、调试技巧和解决方案。

---

## 快速导航

```
常见错误 (30+)              调试技巧               性能优化
├─ 数据库错误 (5)           ├─ 日志查看             ├─ 数据库优化
├─ 认证错误 (5)             ├─ 浏览器工具           ├─ API 优化
├─ 支付错误 (5)             ├─ Server 调试          ├─ 前端优化
├─ API 错误 (5)             └─ 性能分析             └─ 缓存策略
├─ 部署错误 (5)
└─ 其他错误 (5)
```

---

## 常见错误和解决方案

### 数据库错误

#### `Error: ECONNREFUSED 127.0.0.1:5432`

**原因:** 数据库服务未启动或连接失败

**解决方案:**
```bash
# 1. 启动 PostgreSQL
brew services start postgresql  # macOS
systemctl start postgresql      # Linux
docker-compose up postgres      # Docker

# 2. 检查连接字符串
echo $DATABASE_URL

# 3. 测试连接
psql $DATABASE_URL

# 4. 检查端口
lsof -i :5432
```

---

#### `Error: timezone error`

**原因:** 时区配置不正确

**解决方案:**
```bash
# 设置 postgres 时区
ALTER DATABASE mk_saas SET TIMEZONE = 'UTC'

# 或在连接字符串添加
DATABASE_URL=postgresql://...?timezone=UTC
```

---

#### `Error: permission denied`

**原因:** 数据库用户权限不足

**解决方案:**
```bash
# 授予权限
psql -U postgres
ALTER USER postgres CREATEDB;
GRANT ALL PRIVILEGES ON DATABASE mk_saas TO postgres;

# 验证
\l  # 列出数据库
\du # 列出用户
```

---

#### `Error: relation not found`

**原因:** 迁移没有运行

**解决方案:**
```bash
# 运行迁移
pnpm db:migrate

# 检查迁移状态
pnpm db:studio

# 重新生成迁移
pnpm db:generate
pnpm db:migrate
```

---

#### `Error: duplicate key value`

**原因:** 唯一约束冲突（如邮箱重复）

**解决方案:**
```typescript
// 检查是否已存在
const existing = await db.query.user.findFirst({
  where: eq(user.email, email),
})

if (existing) {
  throw new Error('邮箱已存在')
}

// 删除重复数据
DELETE FROM "user" WHERE id = 'duplicate_id';
```

---

### 认证错误

#### `Error: Invalid token`

**原因:** JWT token 过期或格式错误

**解决方案:**
```typescript
// 检查 AUTH_SECRET 环境变量
echo $AUTH_SECRET  # 应该是 32 字符以上

// 重新生成 token
const session = await auth()
if (!session?.user) {
  // 清除 cookies 并重新登录
  redirect('/auth/login')
}
```

---

#### `Error: CSRF token validation failed`

**原因:** CSRF token 过期或不匹配

**解决方案:**
```typescript
// 确保表单包含隐藏的 CSRF token
<input type="hidden" name="csrf" value={csrfToken} />

// 或使用 Server Action（自动处理）
export async function safeAction(data: unknown) {
  'use server'
  // 自动验证 CSRF
}
```

---

#### `Error: Session expired`

**原因:** Session 过期（7 天）

**解决方案:**
```typescript
// 在中间件中检查
export async function middleware(request: NextRequest) {
  const session = await auth()

  if (!session && request.nextUrl.pathname.startsWith('/dashboard')) {
    return NextResponse.redirect(new URL('/auth/login', request.url))
  }
}
```

---

#### `Error: Email verification failed`

**原因:** 验证链接过期或邮件未送达

**解决方案:**
```typescript
// 检查邮件是否真的发送了
// 1. 查看 Resend 仪表板
// 2. 检查垃圾邮箱
// 3. 重新发送验证邮件

// 跳过邮件验证（仅开发用）
await db.update(user).set({
  emailVerified: true,
})
```

---

### 支付错误

#### `Error: Invalid API Key`

**原因:** Stripe API 密钥不正确或过期

**解决方案:**
```bash
# 检查环境变量
echo $STRIPE_SECRET_KEY
echo $STRIPE_PUBLISHABLE_KEY

# 从 Stripe 仪表板重新获取
# https://dashboard.stripe.com/apikeys

# 在 .env.local 更新
STRIPE_SECRET_KEY=sk_live_...
```

---

#### `Error: Payment Intent expired`

**原因:** 支付链接超过 24 小时

**解决方案:**
```typescript
// 在 Checkout Session 中设置过期时间
const session = await stripe.checkout.sessions.create({
  expires_at: Math.floor(Date.now() / 1000) + 86400, // 24 小时
})

// 用户需要重新发起支付
```

---

#### `Error: Webhook signature verification failed`

**原因:** Webhook 密钥不正确

**解决方案:**
```bash
# 获取正确的 Webhook 密钥
# 1. 在 Stripe 仪表板
# 2. Developers → Webhooks
# 3. 点击 endpoint
# 4. 复制 Signing secret

# 更新 .env
STRIPE_WEBHOOK_SECRET=whsec_...
```

---

#### `Error: Card declined`

**原因:** 用户的支付方式被拒

**解决方案:**
```typescript
// 捕获 Stripe 错误
try {
  const paymentIntent = await stripe.paymentIntents.create(...)
} catch (error) {
  if (error.type === 'StripeCardError') {
    return {
      error: error.message, // 显示给用户
    }
  }
}
```

---

### API 错误

#### `Error: CORS policy`

**原因:** 跨域请求被阻止

**解决方案:**
```typescript
// 检查 API 路由的 CORS 头
export async function GET(request: NextRequest) {
  const response = NextResponse.json({ data: [] })

  response.headers.set(
    'Access-Control-Allow-Origin',
    process.env.ALLOWED_ORIGINS || '*'
  )

  return response
}
```

---

#### `Error: 404 Not Found`

**原因:** API 端点不存在

**解决方案:**
```bash
# 检查文件路径
# 应该是: src/app/api/posts/route.ts

# 验证端点
curl http://localhost:3000/api/posts

# 查看完整的路由列表
find src/app/api -name "route.ts" -type f
```

---

#### `Error: 500 Internal Server Error`

**原因:** Server Action 或 API 路由中有未处理的错误

**解决方案:**
```typescript
// 1. 查看服务器日志
// 在终端中查看 pnpm dev 的输出

// 2. 添加更详细的错误日志
try {
  // 业务逻辑
} catch (error) {
  console.error('详细错误:', error)
  throw error
}

// 3. 使用 Sentry 捕获错误
Sentry.captureException(error)
```

---

#### `Error: 413 Payload Too Large`

**原因:** 请求体太大

**解决方案:**
```typescript
// 增加 payload 限制
export const config = {
  api: {
    bodyParser: {
      sizeLimit: '10mb',
    },
  },
}

// 或在表单中分块上传
const formData = new FormData()
formData.append('file', file)

const response = await fetch('/api/uploads', {
  method: 'POST',
  body: formData,
})
```

---

### 部署错误

#### `Error: Build failed`

**原因:** 构建期间出错

**解决方案:**
```bash
# 1. 本地构建测试
pnpm build

# 2. 检查构建错误
# 查看 Vercel 部署日志

# 3. 常见原因
# - TypeScript 错误
# - 缺少环境变量
# - 依赖问题

# 修复方法
pnpm install
pnpm type-check
pnpm build
```

---

#### `Error: Deployment timeout`

**原因:** 部署超过时间限制（15 分钟）

**解决方案:**
```bash
# 1. 优化构建时间
# - 移除未使用的依赖
# - 缓存层优化

# 2. 检查 vercel.json
{
  "buildCommand": "pnpm build",
  "env": { ... },
  "functions": {
    "api/**": {
      "maxDuration": 60
    }
  }
}

# 3. 并行化构建
pnpm build  # 应该 < 5 分钟
```

---

#### `Error: Environmental variable not found`

**原因:** 环境变量未在 Vercel 中配置

**解决方案:**
```bash
# 1. 在 Vercel 仪表板添加
# Settings → Environment Variables

# 2. 或使用 Vercel CLI
vercel env pull

# 3. 验证变量已添加
# 查看日志中的环境变量
```

---

## 调试技巧

### 1. 日志记录

```typescript
// src/lib/logger.ts
const isDev = process.env.NODE_ENV === 'development'

export function log(message: string, data?: any) {
  if (isDev) {
    console.log(`[LOG] ${message}`, data || '')
  }
}

export function error(message: string, err?: Error) {
  console.error(`[ERROR] ${message}`, err)
  if (typeof window !== 'undefined') {
    // 浏览器环境
    Sentry.captureException(err)
  }
}

// 使用
log('用户登录', { userId: user.id })
error('数据库查询失败', err)
```

---

### 2. 浏览器开发者工具

```
Chrome DevTools 快捷键:
- F12 或 Cmd+Option+I: 打开开发者工具
- Cmd+Option+J: 打开 Console
- Cmd+Option+U: 查看网页源代码
- Cmd+Shift+J: 打开 Console
- Network 标签: 查看网络请求
- Sources 标签: 调试 JavaScript
```

**常见任务:**

```javascript
// 在 Console 中执行
// 1. 检查 localStorage
localStorage.getItem('auth_token')

// 2. 检查网络请求
fetch('/api/users')
  .then(r => r.json())
  .then(console.log)

// 3. 设置断点
debugger  // 代码中添加

// 4. 查看 Redux 状态
window.__REDUX_DEVTOOLS_EXTENSION_COMPOSE__
```

---

### 3. Server 日志

```bash
# 查看实时日志
pnpm dev

# 或使用 tail
tail -f .next/output.log

# 检查具体的 API 调用
curl -v http://localhost:3000/api/posts
```

---

### 4. 数据库查询调试

```typescript
// 启用 Drizzle 调试
import { sql } from 'drizzle-orm'

const result = await db
  .select()
  .from(user)
  .where(eq(user.id, 'user123'))
  .toSQL()  // 查看生成的 SQL

// 使用 db:studio 可视化
pnpm db:studio

// 执行原始 SQL
const users = await sql`SELECT * FROM "user" LIMIT 10`
```

---

### 5. 性能分析

```typescript
// 测量执行时间
const start = performance.now()

// ... 执行代码

const end = performance.now()
console.log(`执行时间: ${end - start}ms`)

// 使用 Chrome DevTools Performance 标签
// 1. 打开 DevTools
// 2. Performance 标签
// 3. 点击 Record
// 4. 进行操作
// 5. 停止 Record
// 6. 分析结果
```

---

## 性能优化

### 1. 数据库查询优化

```typescript
// ❌ 不优化：N+1 查询
const users = await db.query.user.findMany()
for (const user of users) {
  const posts = await db.query.post.findMany({
    where: eq(post.userId, user.id),
  })
}

// ✅ 优化：一次查询关联数据
const users = await db.query.user.findMany({
  with: {
    posts: true,
  },
})

// ✅ 使用索引
// 确保有索引在常用查询字段
CREATE INDEX idx_user_email ON "user"(email);
CREATE INDEX idx_post_user_id ON "post"(user_id);
```

---

### 2. API 响应优化

```typescript
// ❌ 返回所有字段
const users = await db.query.user.findMany()

// ✅ 只返回必需字段
const users = await db.query.user.findMany()
  .select({
    id: true,
    email: true,
    name: true,
  })

// ✅ 添加分页
const limit = 10
const page = 1
const offset = (page - 1) * limit

const users = await db.query.user.findMany({
  limit,
  offset,
})
```

---

### 3. 前端优化

```typescript
// ❌ 不优化
export function ExpensiveComponent() {
  const items = list.map(item => ({...item}))  // 每次都创建新对象
  return <div>{items.map(...)} </div>
}

// ✅ 优化
export const ExpensiveComponent = React.memo(function Component({ list }) {
  const items = useMemo(() =>
    list.map(item => ({...item})),
    [list]
  )
  return <div>{items.map(...)} </div>
})
```

---

### 4. 缓存策略

```typescript
// ISR - 静态生成 + 增量更新
export const revalidate = 3600  // 1 小时

// 客户端缓存
const { data, isLoading } = useFetch('/api/users', {
  cacheTime: 5 * 60 * 1000,  // 5 分钟
})

// API 缓存
const response = await fetch('/api/posts', {
  next: { revalidate: 300 },  // 5 分钟
})
```

---

## 最佳实践

✅ **定期检查日志** - 及时发现问题
✅ **使用错误追踪** - Sentry, DataDog
✅ **监控关键指标** - 性能、错误率
✅ **设置告警** - 及时通知
✅ **定期备份** - 数据安全
✅ **性能测试** - Lighthouse, WebPageTest

---

**相关文档:**
- [部署指南](./部署指南.md)
- [环境变量参考](./环境变量参考.md)

**最后更新:** 2025-11-18
