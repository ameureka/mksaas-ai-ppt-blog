# 环境变量参考

所有应用配置变量的完整参考。

---

## 快速导航

```
必需变量 (10+)         可选变量 (15+)          第三方服务 (10+)
├─ 数据库              ├─ 日志级别             ├─ Stripe
├─ 认证                ├─ 日志输出             ├─ Resend
├─ 应用                ├─ 缓存                 ├─ GitHub
├─ Next.js             └─ 功能开关             ├─ Google
└─ 安全                                        ├─ Sentry
                                                ├─ DataDog
                                                └─ 等
```

---

## 必需变量

### 数据库

#### `DATABASE_URL`

```
格式: postgresql://user:password@host:port/database
例子: postgresql://postgres:password@localhost:5432/mk_saas

说明:
- 主数据库连接字符串
- PostgreSQL 15+
- 开发和生产都需要

应用:
- 服务器端数据库查询
- 数据迁移
- 所有 ORM 操作
```

---

#### `POSTGRES_URL_NON_POOLING`

```
格式: postgresql://user:password@host:port/database
例子: postgresql://postgres:password@localhost:5432/mk_saas

说明:
- 用于长连接（如数据库迁移）
- 避免连接池超限
- Vercel 推荐配置

应用:
- Drizzle 迁移
- 数据库初始化
```

---

### 认证

#### `AUTH_SECRET`

```
长度: 至少 32 字符（推荐 256 位）
格式: 随机生成的字符串

生成方法:
# Linux/macOS
openssl rand -base64 32

# Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"

说明:
- JWT token 签名密钥
- 生产环境务必强加密
- 修改此值将使所有 token 失效

环境:
- development: 任何字符串（如 "dev-secret"）
- production: 强随机密钥
```

---

#### `AUTH_TRUST_HOST`

```
格式: 域名列表
例子: localhost:3000,yourdomain.com,www.yourdomain.com

说明:
- 认证系统信任的主机列表
- 防止 CSRF 攻击
- 多个域名用逗号分隔

环境:
- development: localhost:3000
- production: yourdomain.com,www.yourdomain.com
```

---

### 应用

#### `NEXT_PUBLIC_API_URL`

```
格式: https://yourdomain.com
例子: https://yourdomain.com

说明:
- 前端 API 基础 URL
- NEXT_PUBLIC_ 前缀表示客户端可见
- 用于跨域请求

环境:
- development: http://localhost:3000
- production: https://yourdomain.com
```

---

#### `NEXT_PUBLIC_APP_NAME`

```
格式: 字符串
例子: MkSaaS Blog

说明:
- 应用名称
- 用于页面标题、邮件等
```

---

### Stripe

#### `STRIPE_SECRET_KEY`

```
格式: sk_live_... (生产) 或 sk_test_... (测试)
例子: sk_live_51234567890abcdef

说明:
- Stripe 密钥
- 仅在服务器端使用
- 永远不要在客户端暴露
- 不同环境使用不同密钥

获取:
1. 访问 https://dashboard.stripe.com/apikeys
2. 复制 Secret Key
3. 复制 Publishable Key
```

---

#### `STRIPE_PUBLISHABLE_KEY`

```
格式: pk_live_... (生产) 或 pk_test_... (测试)
例子: pk_live_fedcba0987654321

说明:
- 客户端可见的密钥
- 用于前端 Stripe 集成
- 可安全地提交到代码库（前缀 NEXT_PUBLIC_）
```

---

#### `STRIPE_WEBHOOK_SECRET`

```
格式: whsec_...
例子: whsec_test_secret1234567890

说明:
- Webhook 签名密钥
- 验证来自 Stripe 的请求真实性
- 从 Stripe 仪表板获取

获取:
1. https://dashboard.stripe.com/webhooks
2. 点击 endpoint
3. 复制 Signing secret
```

---

## 可选变量

### 日志和调试

#### `LOG_LEVEL`

```
值: debug | info | warn | error
默认: info
例子: LOG_LEVEL=debug

说明:
- 日志级别控制
- debug: 最详细
- error: 仅错误
```

---

#### `NODE_ENV`

```
值: development | production | test
默认: development

说明:
- Node.js 环境标识
- 自动由构建工具设置
- 一般不需要手动配置
```

---

### 功能开关

#### `ENABLE_EMAIL_VERIFICATION`

```
值: true | false
默认: true

说明:
- 是否启用邮箱验证
- false: 跳过验证直接激活账户
- 仅用于开发环境
```

---

#### `ENABLE_STRIPE_WEBHOOK`

```
值: true | false
默认: true

说明:
- 是否处理 Stripe webhook
- false: 测试时跳过 webhook
```

---

### 缓存

#### `NEXT_PUBLIC_CACHE_TIME`

```
值: 毫秒数
默认: 300000 (5 分钟)

说明:
- API 响应缓存时间
- 用于 ISR 和数据缓存
```

---

## 第三方服务

### Email

#### `RESEND_API_KEY`

```
格式: re_...
例子: re_123abc456def

说明:
- Resend 邮件服务 API 密钥
- 用于发送邮件（欢迎、验证、重置密码等）
- 获取: https://resend.com/api-keys

功能:
- 欢迎邮件
- 邮箱验证
- 密码重置
- 订阅确认
```

---

### GitHub OAuth

#### `GITHUB_ID`

```
格式: 数字 ID
例子: 1234567

说明:
- GitHub OAuth 应用 ID
- 用于社交登录

获取:
1. https://github.com/settings/developers
2. OAuth Apps
3. New OAuth App
4. 填写信息
5. 复制 Client ID
```

---

#### `GITHUB_SECRET`

```
格式: 随机字符串
例子: 8d4c7b9a2e5f...

说明:
- GitHub OAuth 应用密钥
- 仅在服务器端使用

获取:
1. 同上
2. 复制 Client Secret
3. 妥善保管（永不公开）
```

---

### Google OAuth

#### `GOOGLE_CLIENT_ID`

```
格式: ...apps.googleusercontent.com
例子: 123456789-abc...@apps.googleusercontent.com

说明:
- Google OAuth 客户端 ID
- 用于 Google 登录
```

---

#### `GOOGLE_CLIENT_SECRET`

```
格式: 随机字符串
例子: GOCSPX-abc...

说明:
- Google OAuth 客户端密钥
- 服务器端使用
```

---

### 错误追踪

#### `SENTRY_DSN`

```
格式: https://...@sentry.io/...
例子: https://abc123@sentry.io/9876543

说明:
- Sentry 错误追踪服务 DSN
- 可选，用于生产环境错误收集

功能:
- 自动捕获异常
- 性能监控
- 会话追踪
```

---

#### `SENTRY_ENVIRONMENT`

```
值: development | production | staging
默认: production

说明:
- 指定 Sentry 环境标签
- 便于区分不同环境的错误
```

---

### 性能监控

#### `DATADOG_API_KEY`

```
格式: 长随机字符串
例子: abc123def456...

说明:
- DataDog APM API 密钥
- 可选，用于性能监控

功能:
- 应用性能监控 (APM)
- 实时告警
- 日志聚合
```

---

#### `DATADOG_SITE`

```
值: datadoghq.com | datadoghq.eu
默认: datadoghq.com

说明:
- DataDog 数据中心位置
- EU 用户用 datadoghq.eu
```

---

### 分析

#### `NEXT_PUBLIC_GA_ID`

```
格式: G-...
例子: G-1ABC2DEF3GH

说明:
- Google Analytics 4 ID
- 客户端可见（NEXT_PUBLIC_）
- 可选
```

---

## 配置文件示例

### .env.local (本地开发)

```env
# 数据库
DATABASE_URL=postgresql://postgres:password@localhost:5432/mk_saas
POSTGRES_URL_NON_POOLING=postgresql://postgres:password@localhost:5432/mk_saas

# 认证
AUTH_SECRET=dev-secret-key-at-least-32-characters-long!
AUTH_TRUST_HOST=localhost:3000

# 应用
NEXT_PUBLIC_API_URL=http://localhost:3000
NEXT_PUBLIC_APP_NAME=MkSaaS Blog

# Stripe (测试密钥)
STRIPE_SECRET_KEY=sk_test_123456789...
STRIPE_PUBLISHABLE_KEY=pk_test_987654321...
STRIPE_WEBHOOK_SECRET=whsec_test_123456...

# Resend
RESEND_API_KEY=re_test_abc123...

# GitHub
GITHUB_ID=1234567
GITHUB_SECRET=gh_secret_abc123...

# 功能开关
ENABLE_EMAIL_VERIFICATION=false
LOG_LEVEL=debug
```

---

### .env.staging (暂存环境)

```env
# 数据库 (暂存数据库)
DATABASE_URL=postgresql://user:password@staging-db:5432/mk_saas
POSTGRES_URL_NON_POOLING=postgresql://user:password@staging-db:5432/mk_saas

# 认证
AUTH_SECRET=<strong-random-key-from-vault>
AUTH_TRUST_HOST=staging.yourdomain.com

# 应用
NEXT_PUBLIC_API_URL=https://staging.yourdomain.com
NEXT_PUBLIC_APP_NAME=MkSaaS Blog (Staging)

# Stripe (测试账户)
STRIPE_SECRET_KEY=sk_test_123456789...
STRIPE_PUBLISHABLE_KEY=pk_test_987654321...

# Resend
RESEND_API_KEY=re_staging_abc123...

# Sentry
SENTRY_DSN=https://...@sentry.io/...
SENTRY_ENVIRONMENT=staging

# 日志
LOG_LEVEL=info
```

---

### .env.production (生产环境)

```env
# 数据库 (生产数据库)
DATABASE_URL=postgresql://user:password@prod-db:5432/mk_saas
POSTGRES_URL_NON_POOLING=postgresql://user:password@prod-db:5432/mk_saas

# 认证
AUTH_SECRET=<very-strong-random-key-from-secure-vault>
AUTH_TRUST_HOST=yourdomain.com,www.yourdomain.com

# 应用
NEXT_PUBLIC_API_URL=https://yourdomain.com
NEXT_PUBLIC_APP_NAME=MkSaaS Blog

# Stripe (生产账户)
STRIPE_SECRET_KEY=sk_live_123456789...
STRIPE_PUBLISHABLE_KEY=pk_live_987654321...
STRIPE_WEBHOOK_SECRET=whsec_live_123456...

# Resend
RESEND_API_KEY=re_live_abc123...

# GitHub & Google
GITHUB_ID=1234567
GITHUB_SECRET=<from-vault>
GOOGLE_CLIENT_ID=...@apps.googleusercontent.com
GOOGLE_CLIENT_SECRET=<from-vault>

# 监控
SENTRY_DSN=https://...@sentry.io/...
SENTRY_ENVIRONMENT=production
DATADOG_API_KEY=<from-vault>

# 分析
NEXT_PUBLIC_GA_ID=G-1ABC2DEF3GH

# 日志
LOG_LEVEL=warn
```

---

## 密钥管理最佳实践

### ✅ Do's

- 使用安全的密钥存储（1Password, Vault, AWS Secrets Manager）
- 定期轮换密钥
- 每个环境使用不同的密钥
- 使用强大的随机密钥（32+ 字符）
- 在 .gitignore 中忽略 .env.local
- 使用环境变量而不是硬编码

### ❌ Don'ts

- 不要在代码中硬编码密钥
- 不要在 Git 中提交 .env 文件
- 不要在日志中打印密钥
- 不要在客户端存储敏感密钥（除非前缀 NEXT_PUBLIC_）
- 不要重用跨环境的密钥
- 不要在 Slack 等非安全渠道分享密钥

---

## Vercel 环境变量配置

### 通过 CLI

```bash
# 拉取生产环境变量到本地
vercel env pull

# 推送本地环境变量到 Vercel
vercel env push
```

---

### 通过仪表板

```
Vercel 仪表板
→ 项目设置
→ Environment Variables
→ 添加变量

选择环境: Production, Preview, Development
输入名称和值
点击 "Save"
```

---

## 验证配置

```bash
# 检查环境变量是否正确加载
node -e "console.log(process.env.DATABASE_URL)"

# 测试数据库连接
psql $DATABASE_URL -c "SELECT 1"

# 验证应用启动
pnpm dev
# 访问 http://localhost:3000
```

---

## 常见问题

### Q: 生产环境某个环境变量为 undefined？

**A:**
1. 检查 Vercel 仪表板是否添加了变量
2. 确保没有拼写错误
3. 检查变量是否选择了正确的环境（Production）
4. 重新部署: `vercel deploy --prod`

---

### Q: 如何安全地分享密钥给团队成员？

**A:**
1. 使用 1Password Teams 或 Vault
2. 通过私密链接分享（非邮件）
3. 每个成员使用自己的 Vercel 账户
4. 设置 RBAC（基于角色的访问控制）

---

### Q: 如何在本地测试生产密钥？

**A:**
```bash
# 创建 .env.production.local（不要提交）
cp .env.example .env.production.local

# 修改值为生产密钥
# 测试
NODE_ENV=production pnpm dev

# 完成后删除
rm .env.production.local
```

---

## 总结

✅ **必需变量** - DATABASE_URL, AUTH_SECRET, Stripe 密钥
✅ **可选变量** - 日志、功能开关、缓存
✅ **第三方服务** - Resend, GitHub, Google, Sentry, DataDog
✅ **密钥管理** - 安全存储、环境隔离、定期轮换

---

**相关文档:**
- [部署指南](./部署指南.md)
- [故障排除](./故障排除.md)

**最后更新:** 2025-11-18
