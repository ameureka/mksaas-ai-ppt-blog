# 2. 核心概念

深入理解 mk-saas-blog 的核心业务系统：用户认证、支付处理、积分管理、国际化和数据库设计。

---

## 📑 本章内容

本章包含以下文档，帮助你掌握项目的核心业务逻辑和系统设计：

### 1. [用户认证深度解析](./用户认证深度解析.md)

**覆盖内容:**
- Better Auth 框架详解
- 邮箱/密码认证流程
- OAuth 社交登录 (Google、GitHub)
- 会话管理和安全
- 邮件验证机制
- 密码重置流程
- 错误处理和安全考虑

**关键代码实现:**
- Better Auth 配置和初始化
- 登录和注册 Server Action
- 会话验证中间件
- 邮件发送集成

**推荐阅读时间:** 30-40 分钟

---

### 2. [支付系统详解](./支付系统详解.md)

**覆盖内容:**
- Stripe 集成架构
- 三种订阅模式 (月付、年付、一次性购买)
- Checkout Session 创建
- Webhook 事件处理
- 订阅状态管理
- 续期和取消流程
- 退款和争议处理
- 美国销税考虑

**核心流程:**
1. 用户选择计划
2. 创建 Checkout Session
3. 用户支付
4. Webhook 事件 (checkout.session.completed)
5. 更新用户订阅状态
6. 授予高级功能

**推荐阅读时间:** 35-45 分钟

---

### 3. [积分系统运作](./积分系统运作.md)

**覆盖内容:**
- 积分的定义和用途
- 积分包 (Package) 购买
- 积分生命周期
  - 赠送阶段 (欢迎奖励)
  - 消费阶段 (功能使用)
  - 过期阶段 (30天未使用)
- 积分消费规则
- 交易记录追踪
- 余额管理
- 高级功能的积分消耗

**核心模型:**
```
用户注册 → 获得初始积分 (100)
    ↓
使用功能 → 消费积分 (按使用量)
    ↓
购买积分包 → 增加积分 (100/500/1000)
    ↓
30天未使用 → 积分过期 (自动清空)
```

**推荐阅读时间:** 25-35 分钟

---

### 4. [国际化实现](./国际化实现.md)

**覆盖内容:**
- next-intl 框架配置
- 支持语言: English (en) 和 中文 (zh)
- 动态语言切换
- 消息翻译系统
- 日期和货币本地化
- URL 路由国际化 (/en/*, /zh/*)
- 语言检测和默认值
- SEO 考虑

**关键特性:**
- 无缝语言切换
- 路由级别的国际化
- 服务器和客户端双支持
- 完整的翻译覆盖

**推荐阅读时间:** 20-30 分钟

---

### 5. [数据库设计深度讲解](./数据库设计深度讲解.md)

**覆盖内容:**
- 6 个核心数据表设计
  - user (用户表)
  - session (会话表)
  - account (OAuth 账户表)
  - payment (支付表)
  - userCredit (用户积分表)
  - creditTransaction (积分交易表)
- 表关系和约束
- 索引策略
- 查询优化
- 事务处理
- 数据一致性保证
- 迁移管理

**关键概念:**
- 外键关系
- 唯一性约束
- 级联删除
- 事务隔离级别
- 查询执行计划

**推荐阅读时间:** 30-40 分钟

---

## 🎯 快速开始指南

### 初级开发者 (新入职)

```
推荐阅读顺序:

1. 用户认证深度解析 (35 分钟)
   ↓ 理解登录机制
2. 支付系统详解 (40 分钟)
   ↓ 理解订阅流程
3. 积分系统运作 (30 分钟)
   ↓ 理解积分消费
4. 国际化实现 (25 分钟)
   ↓ 理解多语言支持

总耗时: ~2.5 小时
→ 掌握所有核心业务流程
```

### 中级开发者 (1-3 个月经验)

```
推荐阅读:

1. 快速浏览 1-2 (20 分钟)
2. 深入学习 3-4 (1 小时)
3. 参考 5 解决数据库问题 (按需)

目标: 能够修改和扩展现有功能
```

### 数据库工程师

```
重点阅读:

1. 数据库设计深度讲解 (完整)
2. 支付和积分数据设计部分
3. 查询优化和索引策略

目标: 能够进行数据库优化和维护
```

---

## 📊 核心系统全景图

```
┌─────────────────────────────────────────────────────────┐
│                  用户会话 (Session)                      │
├─────────────────────────────────────────────────────────┤
│ Better Auth 维护安全的会话，支持邮箱和 OAuth         │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              用户订阅 (Subscription)                     │
├─────────────────────────────────────────────────────────┤
│ Stripe 处理支付，管理三种订阅模式                     │
│ Free → Pro → Lifetime                                 │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              用户积分 (Credits)                          │
├─────────────────────────────────────────────────────────┤
│ 积分用于消费高级功能                                  │
│ 购买 → 消费 → 过期                                   │
└─────────────────────────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────┐
│              用户数据 (PostgreSQL)                       │
├─────────────────────────────────────────────────────────┤
│ Drizzle ORM 提供类型安全的数据库访问                 │
└─────────────────────────────────────────────────────────┘
```

---

## 🔄 系统交互流程

### 新用户注册

```
用户注册
  ↓ (邮箱/密码或 OAuth)
Better Auth 创建账户
  ↓
发送验证邮件
  ↓ (用户点击链接)
邮箱验证成功
  ↓
自动赠送初始积分 (100)
  ↓
可开始使用应用
```

### 升级到付费版

```
用户点击升级
  ↓
选择订阅计划
  ↓
创建 Stripe Checkout Session
  ↓
跳转到 Stripe 支付页面
  ↓ (用户支付)
Stripe 触发 Webhook
  ↓
更新用户订阅状态
  ↓
解锁付费功能
```

### 使用积分消费功能

```
用户使用高级功能
  ↓
检查用户积分
  ↓ (足够)
执行功能
  ↓
扣除相应积分
  ↓
记录交易日志
  ↓
更新用户余额
```

---

## 🛠️ 核心技术栈

| 系统 | 技术 | 版本 | 用途 |
|------|------|------|------|
| **认证** | Better Auth | 1.1 | 用户认证和会话管理 |
| | OAuth | Google/GitHub | 社交登录 |
| | Bcrypt | - | 密码加密 |
| **支付** | Stripe | 17.6 | 支付处理 |
| | Stripe Webhook | - | 事件通知 |
| **积分** | PostgreSQL | 14+ | 数据存储 |
| | Drizzle ORM | 0.39 | 数据库访问 |
| **国际化** | next-intl | 4.0 | 多语言支持 |
| **数据库** | PostgreSQL | 14+ | 关系数据库 |
| | Drizzle Kit | 0.30 | 迁移管理 |

---

## 💡 关键设计决策

### 为什么分离认证和积分系统？

**认证系统** (Better Auth)
- 管理用户身份和会话
- 处理登录/注册
- 维护安全性

**积分系统** (自定义)
- 管理消费模型
- 追踪使用情况
- 处理业务逻辑

分离的好处：
- ✅ 关注点分离
- ✅ 各自独立扩展
- ✅ 逻辑清晰

### 为什么使用 Stripe 而不是自建支付？

✅ **安全性** - 符合 PCI DSS 标准
✅ **合规性** - 自动处理税务和合规
✅ **功能完整** - 订阅、退款、发票等
✅ **运营效率** - 无需维护支付基础设施

### 为什么选择 PostgreSQL？

✅ **可靠性** - 成熟稳定
✅ **功能完整** - JSONB、数组、全文搜索等
✅ **性能** - 适合中等规模应用
✅ **成本** - 开源免费

---

## 📚 相关章节链接

- [1-架构与设计](../1-架构与设计/) - 整体系统架构
- [3-开发指南](../3-开发指南/) - 如何修改和扩展这些系统
- [0-快速开始](../0-快速开始/) - 快速参考和常见问题

---

## 🎓 学习路径

```
完全新手
  ↓
阅读本章 README (15 分钟)
  ↓
按顺序阅读 5 个详细文档 (2-2.5 小时)
  ↓
查看 FAQ 中的相关问题
  ↓
参考代码实现
  ↓
修改和测试
```

---

## 📈 学习成果

完成本章学习后，你将能够：

✅ 理解用户认证的完整流程
✅ 理解支付系统如何处理订阅
✅ 理解积分系统如何控制功能访问
✅ 理解多语言国际化的实现
✅ 理解数据库如何存储和管理这些数据
✅ 能够修改这些系统的配置
✅ 能够添加新的功能逻辑

---

**相关文档:**
- [用户认证深度解析](./用户认证深度解析.md) - 详细流程和代码
- [支付系统详解](./支付系统详解.md) - Stripe 集成
- [积分系统运作](./积分系统运作.md) - 积分管理
- [国际化实现](./国际化实现.md) - 多语言支持
- [数据库设计深度讲解](./数据库设计深度讲解.md) - 数据存储

**最后更新:** 2025-11-18
**维护者:** AI Assistant
