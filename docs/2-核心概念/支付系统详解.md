# 支付系统详解

深入讲解 mk-saas-blog 如何使用 Stripe 处理支付、管理订阅和处理 Webhook 事件。

---

## 📋 目录

- [支付系统架构](#支付系统架构)
- [Stripe 集成](#stripe-集成)
- [三种订阅模式](#三种订阅模式)
- [Checkout Session](#checkout-session)
- [Webhook 处理](#webhook-处理)
- [订阅管理](#订阅管理)
- [安全考虑](#安全考虑)

---

## 支付系统架构

### 系统流程图

```
┌────────────────────────────────────────────────┐
│           支付系统 (Payment System)            │
├────────────────────────────────────────────────┤
│                                                │
│  前端                   后端           Stripe │
│  ├─ 定价页              ├─ Server Action │   │
│  ├─ 选择计划            ├─ Checkout 创建 ├──→│
│  └─ 支付                ├─ Session ID 返回│  │
│     ↓                   │                │   │
│  ┌────────┐             │         ┌──────┴──┐│
│  │跳转    │────────────→├─→返回  │支付页面││
│  │Stripe  │   Session  │ link   │       ││
│  │Checkout│────────────│        │       ││
│  └────────┘             │        └───────┬┘│
│     ↑                   │            ↓    │
│     └───────────────────┼────返回────┘    │
│       支付成功/取消     │                  │
│                         │                  │
│                    ┌────┴────┐             │
│                    │Webhook  │             │
│       ←────────────│处理事件 │←────────────┤
│       更新用户    └────────┘   payment.  │
│                                 succeeded│
│                                          │
└────────────────────────────────────────────────┘
```

### 数据表关系

```
user
├─ id
├─ email
├─ tier (free, pro, lifetime)
├─ stripeCustomerId (关联到 Stripe)
└─ subscriptionId (当前活跃订阅)
  ↓
payment (支付记录)
├─ id
├─ userId
├─ stripeId (Stripe Session ID)
├─ amount (金额，美分)
├─ status (pending, completed, failed)
├─ tier (pro, lifetime)
└─ createdAt
```

---

## Stripe 集成

### 初始化

```typescript
// src/lib/stripe.ts
import Stripe from 'stripe'

export const stripe = new Stripe(
  process.env.STRIPE_SECRET_KEY!,
  {
    apiVersion: '2024-04-10',
    appInfo: {
      name: 'MkSaaS Blog',
      version: '1.0.0',
    },
  }
)

// 定义产品 ID（在 Stripe 仪表板配置）
export const STRIPE_PRODUCTS = {
  PRO_MONTHLY: 'price_1OZ...', // Pro 月订阅
  PRO_YEARLY: 'price_1P0...', // Pro 年订阅
  LIFETIME: 'price_1P1...', // 终身订阅
  CREDITS_100: 'price_1P2...', // 100 积分
  CREDITS_500: 'price_1P3...', // 500 积分
}
```

### 环境配置

```bash
# .env.local
STRIPE_PUBLIC_KEY=pk_test_...       # 可以公开
STRIPE_SECRET_KEY=sk_test_...       # 保密
STRIPE_WEBHOOK_SECRET=whsec_test_... # Webhook 验证用
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...
```

---

## 三种订阅模式

### 模式对比

| 模式 | 价格 | 周期 | 特点 | 使用场景 |
|------|------|------|------|---------|
| **Pro 月付** | $9.99 | 1 月 | 灵活、随时取消 | 尝试用户 |
| **Pro 年付** | $79.99 | 1 年 | 优惠 20% | 承诺用户 |
| **终身订阅** | $299.99 | 永久 | 一次性支付 | 忠实用户 |

### 定价表

```typescript
// src/config/pricing.ts
export const PRICING_PLANS = [
  {
    id: 'free',
    name: 'Free',
    price: 0,
    description: '适合个人和小项目',
    features: [
      '基础功能',
      '10 个项目',
      '社区支持',
    ],
    stripePriceId: null,
  },
  {
    id: 'pro-monthly',
    name: 'Pro 月付',
    price: 999, // 美分
    currency: 'usd',
    period: 'month',
    description: '用于成长中的业务',
    features: [
      '所有基础功能',
      '无限项目',
      '优先支持',
      'API 访问',
      'AI 功能',
    ],
    stripePriceId: STRIPE_PRODUCTS.PRO_MONTHLY,
  },
  {
    id: 'pro-yearly',
    name: 'Pro 年付',
    price: 7999,
    currency: 'usd',
    period: 'year',
    discount: '20% 优惠',
    description: '最经济的选择',
    features: [
      '所有 Pro 功能',
      '额外 30% 积分奖励',
    ],
    stripePriceId: STRIPE_PRODUCTS.PRO_YEARLY,
  },
  {
    id: 'lifetime',
    name: '终身订阅',
    price: 29999,
    currency: 'usd',
    period: 'once',
    description: '一次性终身访问',
    features: [
      '所有功能',
      '终身更新',
      'VIP 支持',
      '优先新功能',
    ],
    stripePriceId: STRIPE_PRODUCTS.LIFETIME,
  },
]
```

---

## Checkout Session

### 创建 Checkout Session

```typescript
// src/actions/payment.ts
'use server'

import { stripe, STRIPE_PRODUCTS } from '@/lib/stripe'
import { getSession } from '@/lib/auth'
import { db } from '@/db'
import { user } from '@/db/schema'
import { eq } from 'drizzle-orm'

export async function createCheckoutSession(plan: 'pro-monthly' | 'pro-yearly' | 'lifetime') {
  try {
    // 获取当前用户
    const session = await getSession()
    if (!session?.user) {
      return { error: '请先登录' }
    }

    const userId = session.user.id

    // 获取或创建 Stripe 客户
    let userRecord = await db.query.user.findFirst({
      where: eq(user.id, userId),
    })

    let stripeCustomerId = userRecord?.stripeCustomerId

    if (!stripeCustomerId) {
      // 创建新的 Stripe 客户
      const customer = await stripe.customers.create({
        email: session.user.email,
        name: session.user.name,
        metadata: {
          userId,
        },
      })
      stripeCustomerId = customer.id

      // 保存到数据库
      await db.update(user)
        .set({ stripeCustomerId })
        .where(eq(user.id, userId))
    }

    // 映射计划到 Stripe Price ID
    const priceIdMap = {
      'pro-monthly': STRIPE_PRODUCTS.PRO_MONTHLY,
      'pro-yearly': STRIPE_PRODUCTS.PRO_YEARLY,
      'lifetime': STRIPE_PRODUCTS.LIFETIME,
    }

    // 创建 Checkout Session
    const checkoutSession = await stripe.checkout.sessions.create({
      customer: stripeCustomerId,
      mode: plan === 'lifetime' ? 'payment' : 'subscription',
      payment_method_types: ['card'],
      line_items: [
        {
          price: priceIdMap[plan],
          quantity: 1,
        },
      ],
      // 成功页面
      success_url: `${process.env.NEXT_PUBLIC_APP_URL}/checkout/success?session_id={CHECKOUT_SESSION_ID}`,
      // 取消页面
      cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/pricing?cancelled=true`,
      metadata: {
        userId,
        plan,
      },
    })

    return {
      success: true,
      url: checkoutSession.url,
      sessionId: checkoutSession.id,
    }
  } catch (error) {
    console.error('创建 Checkout Session 失败:', error)
    return { error: '创建支付会话失败' }
  }
}
```

### 前端集成

```typescript
// src/components/pricing-card.tsx
'use client'

import { createCheckoutSession } from '@/actions/payment'

export function PricingCard({ plan }: { plan: 'pro-monthly' | 'pro-yearly' | 'lifetime' }) {
  const handleUpgrade = async () => {
    const result = await createCheckoutSession(plan)

    if (result.success && result.url) {
      // 重定向到 Stripe Checkout
      window.location.href = result.url
    } else {
      alert(result.error || '升级失败')
    }
  }

  return (
    <div className="pricing-card">
      {/* 定价内容 */}
      <button onClick={handleUpgrade}>升级</button>
    </div>
  )
}
```

---

## Webhook 处理

### 事件类型

| 事件 | 触发时机 | 处理操作 |
|------|---------|---------|
| `checkout.session.completed` | 用户支付成功 | 更新用户订阅状态 |
| `invoice.payment_succeeded` | 订阅续期支付成功 | 确保订阅保持活跃 |
| `invoice.payment_failed` | 订阅续期支付失败 | 发送提醒邮件 |
| `customer.subscription.deleted` | 用户取消订阅 | 降级用户到 Free |
| `charge.refunded` | 退款发生 | 更新订阅状态 |

### Webhook 处理器

```typescript
// src/app/api/webhooks/stripe/route.ts
import { stripe } from '@/lib/stripe'
import { db } from '@/db'
import { user, payment } from '@/db/schema'
import { eq } from 'drizzle-orm'
import Stripe from 'stripe'

export async function POST(request: Request) {
  const body = await request.text()
  const signature = request.headers.get('stripe-signature')!

  // 验证 Webhook 签名
  let event: Stripe.Event

  try {
    event = stripe.webhooks.constructEvent(
      body,
      signature,
      process.env.STRIPE_WEBHOOK_SECRET!
    )
  } catch (error) {
    console.error('Webhook 签名验证失败:', error)
    return new Response('Webhook 签名无效', { status: 400 })
  }

  try {
    // 处理不同的事件
    switch (event.type) {
      case 'checkout.session.completed':
        await handleCheckoutSessionCompleted(event.data.object)
        break

      case 'invoice.payment_succeeded':
        await handleInvoicePaymentSucceeded(event.data.object)
        break

      case 'invoice.payment_failed':
        await handleInvoicePaymentFailed(event.data.object)
        break

      case 'customer.subscription.deleted':
        await handleSubscriptionDeleted(event.data.object)
        break

      default:
        console.log(`未处理的事件类型: ${event.type}`)
    }

    return new Response('Webhook 已处理', { status: 200 })
  } catch (error) {
    console.error('处理 Webhook 时出错:', error)
    return new Response('内部服务器错误', { status: 500 })
  }
}

// 处理支付成功事件
async function handleCheckoutSessionCompleted(
  session: Stripe.Checkout.Session
) {
  const userId = session.metadata?.userId
  const plan = session.metadata?.plan

  if (!userId || !plan) {
    console.error('Webhook 元数据不完整')
    return
  }

  // 确定订阅等级
  const tier = plan === 'lifetime' ? 'lifetime' : 'pro'

  // 更新用户
  await db.update(user)
    .set({
      tier,
      subscriptionId: session.subscription as string,
      stripeCustomerId: session.customer as string,
    })
    .where(eq(user.id, userId))

  // 记录支付
  await db.insert(payment).values({
    userId,
    stripeId: session.id,
    amount: session.amount_total || 0,
    status: 'completed',
    tier,
  })

  console.log(`用户 ${userId} 升级到 ${tier}`)
}

// 处理续期支付成功
async function handleInvoicePaymentSucceeded(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string

  // 获取客户信息
  const customer = await stripe.customers.retrieve(customerId)

  // 查找关联的用户
  const userRecord = await db.query.user.findFirst({
    where: eq(user.stripeCustomerId, customerId),
  })

  if (userRecord) {
    console.log(`用户 ${userRecord.id} 的续期支付成功`)
    // 确保用户仍是 Pro
    if (userRecord.tier !== 'lifetime') {
      await db.update(user)
        .set({ tier: 'pro' })
        .where(eq(user.id, userRecord.id))
    }
  }
}

// 处理支付失败
async function handleInvoicePaymentFailed(invoice: Stripe.Invoice) {
  const customerId = invoice.customer as string

  const userRecord = await db.query.user.findFirst({
    where: eq(user.stripeCustomerId, customerId),
  })

  if (userRecord) {
    console.log(`用户 ${userRecord.id} 的续期支付失败`)
    // 发送提醒邮件
    await sendPaymentFailedEmail(userRecord.email, userRecord.name)
  }
}

// 处理订阅取消
async function handleSubscriptionDeleted(
  subscription: Stripe.Subscription
) {
  const customerId = subscription.customer as string

  const userRecord = await db.query.user.findFirst({
    where: eq(user.stripeCustomerId, customerId),
  })

  if (userRecord) {
    // 降级到 Free
    await db.update(user)
      .set({ tier: 'free', subscriptionId: null })
      .where(eq(user.id, userRecord.id))

    console.log(`用户 ${userRecord.id} 已取消订阅，降级到 Free`)
  }
}
```

### 配置 Webhook

**本地开发:**

```bash
# 安装 Stripe CLI
brew install stripe/stripe-cli/stripe

# 登录
stripe login

# 监听 Webhook 事件
stripe listen --forward-to localhost:3005/api/webhooks/stripe

# 获取 Webhook 密钥
# 输出示例:
# Ready! Your webhook signing secret is whsec_test_...
```

**生产环境:**

1. 访问 Stripe Dashboard → Webhooks
2. 添加 Endpoint: `https://yourdomain.com/api/webhooks/stripe`
3. 选择事件类型：
   - `checkout.session.completed`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`
   - `customer.subscription.deleted`
   - `charge.refunded`
4. 复制 Webhook 密钥到环境变量

---

## 订阅管理

### 获取订阅信息

```typescript
export async function getSubscription(userId: string) {
  const userRecord = await db.query.user.findFirst({
    where: eq(user.id, userId),
  })

  if (!userRecord?.subscriptionId) {
    return null
  }

  // 从 Stripe 获取订阅详情
  const subscription = await stripe.subscriptions.retrieve(
    userRecord.subscriptionId
  )

  return {
    id: subscription.id,
    status: subscription.status,
    currentPeriodStart: new Date(subscription.current_period_start * 1000),
    currentPeriodEnd: new Date(subscription.current_period_end * 1000),
    items: subscription.items.data,
  }
}
```

### 取消订阅

```typescript
export async function cancelSubscription(userId: string) {
  const userRecord = await db.query.user.findFirst({
    where: eq(user.id, userId),
  })

  if (!userRecord?.subscriptionId) {
    return { error: '没有活跃订阅' }
  }

  try {
    // 在周期结束时取消（不立即）
    await stripe.subscriptions.update(
      userRecord.subscriptionId,
      { cancel_at_period_end: true }
    )

    return { success: true }
  } catch (error) {
    console.error('取消订阅失败:', error)
    return { error: '取消失败' }
  }
}
```

### 管理支付方式

```typescript
export async function createPaymentMethodSetupSession(userId: string) {
  const userRecord = await db.query.user.findFirst({
    where: eq(user.id, userId),
  })

  if (!userRecord?.stripeCustomerId) {
    return { error: '用户不存在' }
  }

  const setupSession = await stripe.checkout.sessions.create({
    payment_method_types: ['card'],
    mode: 'setup',
    customer: userRecord.stripeCustomerId,
    success_url: `${process.env.NEXT_PUBLIC_APP_URL}/settings/billing?setup=success`,
    cancel_url: `${process.env.NEXT_PUBLIC_APP_URL}/settings/billing?setup=cancelled`,
  })

  return { url: setupSession.url }
}
```

---

## 安全考虑

### API 密钥安全

```typescript
// ❌ 不要在客户端暴露 Secret Key
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY) // 服务器端只

// ✅ 客户端只使用 Publishable Key
const stripePromise = loadStripe(
  process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
)
```

### Webhook 验证

```typescript
// 总是验证 Webhook 签名
const event = stripe.webhooks.constructEvent(
  body,
  signature,
  process.env.STRIPE_WEBHOOK_SECRET!
)
```

### 金额处理

```typescript
// ❌ 不要在客户端计算金额
const amount = price * quantity // 客户端可以篡改

// ✅ 在服务器端验证金额
export async function validateCheckoutAmount(
  plan: string,
  quantity: number
) {
  const planConfig = PRICING_PLANS.find(p => p.id === plan)
  const expectedAmount = planConfig.price * quantity
  // 验证客户端发送的金额是否匹配
}
```

---

## 常见问题

### Q1: 测试模式和生产模式?

Stripe 提供 Test Keys 和 Live Keys：
- Test Keys：用于开发和测试，支付不会真实发生
- Live Keys：生产环境，处理真实支付

### Q2: 如何处理货币转换?

Stripe 默认使用 USD。如需多货币支持：
1. 在 Stripe 中配置多种货币价格
2. 根据用户位置选择货币
3. 显示相应的定价

### Q3: 如何处理税务?

Stripe Tax 自动计算销税：
1. 启用 Stripe Tax
2. Checkout Session 自动包含税额
3. 发票自动显示税额

---

## 总结

mk-saas-blog 的支付系统提供：

✅ **灵活的订阅模式** - 月付、年付、终身
✅ **安全的支付处理** - Stripe 处理所有支付
✅ **自动化的 Webhook** - 自动更新用户状态
✅ **订阅管理** - 用户可以升级、降级、取消
✅ **完整的错误处理** - 处理支付失败和其他异常

---

**相关文档:**
- [用户认证深度解析](./用户认证深度解析.md)
- [积分系统运作](./积分系统运作.md)
- [数据库设计深度讲解](./数据库设计深度讲解.md)

**最后更新:** 2025-11-18
