# ç§¯åˆ†ç³»ç»Ÿè¿ä½œ

è¯¦ç»†è®²è§£ mk-saas-blog çš„ç§¯åˆ†ï¼ˆCreditsï¼‰ç³»ç»Ÿï¼šç”Ÿå‘½å‘¨æœŸã€æ¶ˆè´¹è§„åˆ™å’Œäº¤æ˜“è¿½è¸ªã€‚

---

## ğŸ“‹ ç›®å½•

- [ç§¯åˆ†ç³»ç»Ÿæ¦‚è§ˆ](#ç§¯åˆ†ç³»ç»Ÿæ¦‚è§ˆ)
- [ç§¯åˆ†çš„å®šä¹‰](#ç§¯åˆ†çš„å®šä¹‰)
- [ç”Ÿå‘½å‘¨æœŸ](#ç”Ÿå‘½å‘¨æœŸ)
- [æ¶ˆè´¹è§„åˆ™](#æ¶ˆè´¹è§„åˆ™)
- [è´­ä¹°ç§¯åˆ†åŒ…](#è´­ä¹°ç§¯åˆ†åŒ…)
- [äº¤æ˜“è®°å½•](#äº¤æ˜“è®°å½•)
- [API å®ç°](#api-å®ç°)

---

## ç§¯åˆ†ç³»ç»Ÿæ¦‚è§ˆ

### æ ¸å¿ƒæ¦‚å¿µ

```
ç§¯åˆ†æ˜¯é«˜çº§åŠŸèƒ½çš„è™šæ‹Ÿè´§å¸

å®šä¹‰: ç”¨æˆ·è´­ä¹°æˆ–èµ é€çš„è™šæ‹Ÿèµ„äº§
ç”¨é€”: æ¶ˆè´¹é«˜çº§åŠŸèƒ½ï¼ˆå¦‚ AI å›¾åƒç”Ÿæˆï¼‰
ç‰¹ç‚¹: æœ‰æœ‰æ•ˆæœŸé™åˆ¶ï¼ˆ30 å¤©æœªä½¿ç”¨è‡ªåŠ¨è¿‡æœŸï¼‰
```

### ä¸‰ä¸ªé˜¶æ®µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç§¯åˆ†ç”Ÿå‘½å‘¨æœŸ (3 ä¸ªé˜¶æ®µ)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  1ï¸âƒ£ è·å–é˜¶æ®µ (Acquisition)              â”‚
â”‚     â”œâ”€ æ³¨å†Œèµ é€: +100 ç§¯åˆ†               â”‚
â”‚     â””â”€ è´­ä¹°ç§¯åˆ†åŒ…: +100/500/1000         â”‚
â”‚                                          â”‚
â”‚  2ï¸âƒ£ æ¶ˆè´¹é˜¶æ®µ (Consumption)              â”‚
â”‚     â”œâ”€ ä½¿ç”¨åŠŸèƒ½: -10/50/100/200          â”‚
â”‚     â””â”€ æ¯ä¸ªæ“ä½œè‡ªåŠ¨æ‰£è´¹                 â”‚
â”‚                                          â”‚
â”‚  3ï¸âƒ£ è¿‡æœŸé˜¶æ®µ (Expiration)               â”‚
â”‚     â”œâ”€ 30 å¤©æœªä½¿ç”¨                      â”‚
â”‚     â””â”€ è‡ªåŠ¨æ¸…é›¶                         â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ç§¯åˆ†çš„å®šä¹‰

### æ•°æ®ç»“æ„

```typescript
// src/db/schema.ts

// ç”¨æˆ·ç§¯åˆ†æ€»é¢
export const userCredit = pgTable('user_credit', {
  id: text('id').primaryKey().default(sql`uuid_generate_v4()`),
  userId: text('user_id')
    .notNull()
    .references(() => user.id, { onDelete: 'cascade' }),
  balance: integer('balance').notNull().default(0),
  lastUsedAt: timestamp('last_used_at'),
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
})

// ç§¯åˆ†äº¤æ˜“è®°å½•
export const creditTransaction = pgTable('credit_transaction', {
  id: text('id').primaryKey().default(sql`uuid_generate_v4()`),
  userId: text('user_id')
    .notNull()
    .references(() => user.id, { onDelete: 'cascade' }),
  amount: integer('amount').notNull(), // æ­£æ•°=è·å¾—ï¼Œè´Ÿæ•°=æ¶ˆè´¹
  type: text('type').notNull(), // 'purchase', 'grant', 'consumption', 'refund'
  reason: text('reason'), // äº¤æ˜“åŸå› æè¿°
  relatedEntityId: text('related_entity_id'), // å…³è”çš„æ“ä½œ ID
  balanceAfter: integer('balance_after').notNull(), // äº¤æ˜“åçš„ä½™é¢
  expiresAt: timestamp('expires_at'), // è¯¥æ‰¹ç§¯åˆ†çš„è¿‡æœŸæ—¶é—´
  createdAt: timestamp('created_at').defaultNow(),
})
```

### ç§¯åˆ†ç±»å‹

```typescript
type CreditType =
  | 'purchase'     // è´­ä¹°
  | 'grant'        // èµ é€ï¼ˆæ¬¢è¿å¥–åŠ±ï¼‰
  | 'consumption'  // æ¶ˆè´¹
  | 'refund'       // é€€æ¬¾

// ç§¯åˆ†åŒ…é€‰é¡¹
export const CREDIT_PACKAGES = [
  { id: 'credits-100', amount: 100, price: 499, priceLabel: '$4.99' },
  { id: 'credits-500', amount: 500, price: 1999, priceLabel: '$19.99' },
  { id: 'credits-1000', amount: 1000, price: 3499, priceLabel: '$34.99' },
]

// åŠŸèƒ½æ¶ˆè´¹è§„åˆ™
export const FEATURE_COSTS = {
  'ai-image-generation': 50,    // ç”Ÿæˆä¸€å¼ å›¾
  'bulk-export': 100,            // æ‰¹é‡å¯¼å‡º
  'api-call': 10,                // API è°ƒç”¨
  'storage-extra': 200,          // é¢å¤–å­˜å‚¨
}
```

---

## ç”Ÿå‘½å‘¨æœŸ

### é˜¶æ®µ 1: è·å–ï¼ˆAcquisitionï¼‰

#### æ³¨å†Œèµ é€

```typescript
// src/actions/auth.ts
export async function signUp(input: SignUpInput) {
  // ... åˆ›å»ºç”¨æˆ· ...

  const userId = newUser.id

  // èµ é€æ¬¢è¿ç§¯åˆ†
  await db.insert(userCredit).values({
    userId,
    balance: 100,
  })

  // è®°å½•äº¤æ˜“
  await db.insert(creditTransaction).values({
    userId,
    amount: 100,
    type: 'grant',
    reason: 'æ¬¢è¿å¥–åŠ±',
    balanceAfter: 100,
    expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 å¤©å
  })

  return { success: true }
}
```

#### è´­ä¹°ç§¯åˆ†åŒ…

```typescript
// src/actions/credits.ts
'use server'

import { userActionClient } from '@/lib/auth'

export const purchaseCredits = userActionClient
  .schema(z.object({ packageId: z.string() }))
  .action(async ({ parsedInput, ctx }) => {
    const { packageId } = parsedInput
    const userId = ctx.session.user.id

    // æŸ¥æ‰¾ç§¯åˆ†åŒ…
    const package_ = CREDIT_PACKAGES.find(p => p.id === packageId)
    if (!package_) {
      return { error: 'ç§¯åˆ†åŒ…ä¸å­˜åœ¨' }
    }

    try {
      // åˆ›å»ºæ”¯ä»˜ Sessionï¼ˆé€šè¿‡ Stripeï¼‰
      const checkout = await createCheckoutSession({
        items: [{
          name: `${package_.amount} ç§¯åˆ†`,
          amount: package_.price,
          quantity: 1,
        }],
        metadata: {
          userId,
          packageId,
          creditAmount: package_.amount,
        },
      })

      return { success: true, url: checkout.url }
    } catch (error) {
      return { error: 'è´­ä¹°å¤±è´¥' }
    }
  })
```

#### Webhook å¤„ç†ï¼ˆæ”¯ä»˜å®Œæˆåï¼‰

```typescript
// src/app/api/webhooks/stripe/route.ts
async function handleCheckoutSessionCompleted(session: Stripe.Checkout.Session) {
  const userId = session.metadata?.userId
  const creditAmount = parseInt(session.metadata?.creditAmount || '0')

  if (!userId || !creditAmount) return

  const userRecord = await db.query.userCredit.findFirst({
    where: eq(userCredit.userId, userId),
  })

  // æ›´æ–°ä½™é¢
  const newBalance = (userRecord?.balance || 0) + creditAmount

  await db.update(userCredit)
    .set({ balance: newBalance })
    .where(eq(userCredit.userId, userId))

  // è®°å½•äº¤æ˜“
  await db.insert(creditTransaction).values({
    userId,
    amount: creditAmount,
    type: 'purchase',
    reason: `è´­ä¹° ${creditAmount} ç§¯åˆ†`,
    balanceAfter: newBalance,
    expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
  })
}
```

---

### é˜¶æ®µ 2: æ¶ˆè´¹ï¼ˆConsumptionï¼‰

#### æ£€æŸ¥å¹¶æ¶ˆè´¹ç§¯åˆ†

```typescript
export async function consumeCredits(
  userId: string,
  feature: keyof typeof FEATURE_COSTS,
  quantity: number = 1
) {
  const cost = FEATURE_COSTS[feature] * quantity

  // å¼€å¯äº‹åŠ¡
  const result = await db.transaction(async (tx) => {
    // æŸ¥è¯¢å½“å‰ä½™é¢
    const userCredits = await tx.query.userCredit.findFirst({
      where: eq(userCredit.userId, userId),
    })

    if (!userCredits || userCredits.balance < cost) {
      throw new Error('ç§¯åˆ†ä¸è¶³')
    }

    // æ‰£è´¹
    const newBalance = userCredits.balance - cost
    await tx.update(userCredit)
      .set({
        balance: newBalance,
        lastUsedAt: new Date(), // æ›´æ–°æœ€åä½¿ç”¨æ—¶é—´
      })
      .where(eq(userCredit.userId, userId))

    // è®°å½•æ¶ˆè´¹
    await tx.insert(creditTransaction).values({
      userId,
      amount: -cost,
      type: 'consumption',
      reason: `ä½¿ç”¨åŠŸèƒ½: ${feature}`,
      balanceAfter: newBalance,
    })

    return newBalance
  })

  return result
}
```

#### åœ¨åŠŸèƒ½ä¸­ä½¿ç”¨

```typescript
// src/actions/features.ts
export const generateImage = userActionClient
  .schema(z.object({ prompt: z.string() }))
  .action(async ({ parsedInput, ctx }) => {
    const { prompt } = parsedInput
    const userId = ctx.session.user.id

    try {
      // æ¶ˆè´¹ç§¯åˆ†
      await consumeCredits(userId, 'ai-image-generation')

      // æ‰§è¡ŒåŠŸèƒ½
      const image = await generateImageWithAI(prompt)

      return { success: true, image }
    } catch (error) {
      if (error.message === 'ç§¯åˆ†ä¸è¶³') {
        return { error: 'ç§¯åˆ†ä¸è¶³ï¼Œè¯·è´­ä¹°æ›´å¤šç§¯åˆ†' }
      }
      return { error: 'ç”Ÿæˆå¤±è´¥' }
    }
  })
```

---

### é˜¶æ®µ 3: è¿‡æœŸï¼ˆExpirationï¼‰

#### æ£€æŸ¥è¿‡æœŸ

```typescript
export async function checkAndExpireCredits(userId: string) {
  const now = new Date()

  // æ‰¾å‡ºæ‰€æœ‰å·²è¿‡æœŸçš„äº¤æ˜“å¯¹åº”çš„ç§¯åˆ†
  const expiredTransactions = await db.query.creditTransaction.findMany({
    where: and(
      eq(creditTransaction.userId, userId),
      lt(creditTransaction.expiresAt, now),
      isNotNull(creditTransaction.expiresAt),
    ),
  })

  if (expiredTransactions.length === 0) {
    return // æ²¡æœ‰è¿‡æœŸçš„
  }

  // è®¡ç®—è¿‡æœŸçš„æ€»æ•°
  const expiredAmount = expiredTransactions.reduce(
    (sum, t) => sum + Math.max(0, t.amount),
    0
  )

  if (expiredAmount === 0) return

  // æ›´æ–°ä½™é¢
  const userCredits = await db.query.userCredit.findFirst({
    where: eq(userCredit.userId, userId),
  })

  const newBalance = Math.max(0, (userCredits?.balance || 0) - expiredAmount)

  await db.update(userCredit)
    .set({ balance: newBalance })
    .where(eq(userCredit.userId, userId))

  // è®°å½•è¿‡æœŸ
  await db.insert(creditTransaction).values({
    userId,
    amount: -expiredAmount,
    type: 'consumption',
    reason: `ç§¯åˆ†è¿‡æœŸï¼ˆ30 å¤©æœªä½¿ç”¨ï¼‰`,
    balanceAfter: newBalance,
  })
}

// å®šæ—¶ä»»åŠ¡ï¼ˆä¾‹å¦‚æ¯å¤©è¿è¡Œä¸€æ¬¡ï¼‰
// ä½¿ç”¨ cron job æˆ– AWS Lambda ç­‰
```

#### æ‰‹åŠ¨æ¸…ç†è¿‡æœŸ

```bash
# é€šè¿‡ API ç«¯ç‚¹è§¦å‘
# POST /api/admin/credits/expire-check

export async function expireUnusedCredits() {
  // æ‰¾å‡ºæ‰€æœ‰ 30 å¤©æœªä½¿ç”¨çš„ç”¨æˆ·
  const users = await db.query.user.findMany({
    where: lt(user.lastUsedAt, new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)),
  })

  for (const user_ of users) {
    await checkAndExpireCredits(user_.id)
  }
}
```

---

## æ¶ˆè´¹è§„åˆ™

### åŠŸèƒ½æˆæœ¬è¡¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       åŠŸèƒ½æ¶ˆè´¹è§„åˆ™                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚ ğŸ“Š æ•°æ®å¤„ç†                              â”‚
â”‚  â”œâ”€ ç”Ÿæˆå›¾åƒ(AI)        50 ç§¯åˆ†/æ¬¡     â”‚
â”‚  â”œâ”€ æ‰¹é‡å¯¼å‡º           100 ç§¯åˆ†/æ¬¡     â”‚
â”‚  â”œâ”€ æ–‡æœ¬åˆ†æ            20 ç§¯åˆ†/æ¬¡     â”‚
â”‚  â””â”€ æ•°æ®è½¬æ¢            30 ç§¯åˆ†/æ¬¡     â”‚
â”‚                                          â”‚
â”‚ ğŸ’¾ å­˜å‚¨æ‰©å±•                              â”‚
â”‚  â”œâ”€ é¢å¤– 1GB å­˜å‚¨      200 ç§¯åˆ†/æœˆ     â”‚
â”‚  â””â”€ é«˜çº§å¤‡ä»½             50 ç§¯åˆ†/æ¬¡     â”‚
â”‚                                          â”‚
â”‚ ğŸ”Œ API è®¿é—®                              â”‚
â”‚  â”œâ”€ API è°ƒç”¨             10 ç§¯åˆ†/100    â”‚
â”‚  â””â”€ Webhook            20 ç§¯åˆ†/æ¡      â”‚
â”‚                                          â”‚
â”‚ ğŸš€ é«˜çº§åŠŸèƒ½                              â”‚
â”‚  â”œâ”€ ä¼˜å…ˆçº§å¤„ç†           80 ç§¯åˆ†/æ¬¡     â”‚
â”‚  â””â”€ è‡ªå®šä¹‰å“ç‰Œ            100 ç§¯åˆ†/æ¬¡     â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æˆæœ¬è®¡ç®—

```typescript
export function calculateTotalCost(
  features: { feature: string; quantity: number }[]
): number {
  return features.reduce((total, { feature, quantity }) => {
    const cost = FEATURE_COSTS[feature as keyof typeof FEATURE_COSTS] || 0
    return total + cost * quantity
  }, 0)
}

// ç¤ºä¾‹
const cost = calculateTotalCost([
  { feature: 'ai-image-generation', quantity: 3 }, // 3 Ã— 50 = 150
  { feature: 'bulk-export', quantity: 1 },         // 1 Ã— 100 = 100
])
// cost = 250
```

---

## äº¤æ˜“è®°å½•

### æŸ¥è¯¢äº¤æ˜“å†å²

```typescript
export async function getTransactionHistory(
  userId: string,
  limit: number = 50
) {
  return await db.query.creditTransaction.findMany({
    where: eq(creditTransaction.userId, userId),
    orderBy: desc(creditTransaction.createdAt),
    limit,
  })
}
```

### äº¤æ˜“æ˜ç»†

```
äº¤æ˜“ç±»å‹      é‡‘é¢      ä½™é¢      è¯´æ˜
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
grant        +100     100      æ¬¢è¿å¥–åŠ±
consumption  -50       50      ç”Ÿæˆå›¾åƒ 1 å¼ 
purchase     +500     550      è´­ä¹° 500 ç§¯åˆ†
consumption  -100     450      æ‰¹é‡å¯¼å‡º
consumption  -450       0      ç§¯åˆ†è¿‡æœŸï¼ˆ30å¤©æœªä½¿ç”¨ï¼‰
```

---

## API å®ç°

### ç”¨æˆ·ç«¯ API

```typescript
// è·å–ç§¯åˆ†ä½™é¢
export async function getCreditsBalance(userId: string) {
  const credits = await db.query.userCredit.findFirst({
    where: eq(userCredit.userId, userId),
  })
  return credits?.balance || 0
}

// è·å–äº¤æ˜“å†å²
export async function getCreditsTransactions(userId: string) {
  return await db.query.creditTransaction.findMany({
    where: eq(creditTransaction.userId, userId),
    orderBy: desc(creditTransaction.createdAt),
    limit: 100,
  })
}

// è´­ä¹°ç§¯åˆ†
export const purchaseCredits = userActionClient
  .schema(z.object({ packageId: z.string() }))
  .action(async ({ parsedInput, ctx }) => {
    // ... å¤„ç†è´­ä¹° ...
  })
```

### ç®¡ç†ç«¯ API

```typescript
// æŸ¥çœ‹ç”¨æˆ·ç§¯åˆ†
export async function adminGetUserCredits(userId: string) {
  return await db.query.userCredit.findFirst({
    where: eq(userCredit.userId, userId),
  })
}

// æ‰‹åŠ¨è°ƒæ•´ç§¯åˆ†ï¼ˆç®¡ç†å‘˜ï¼‰
export const adminAdjustCredits = adminActionClient
  .schema(z.object({
    userId: z.string(),
    amount: z.number().int(),
    reason: z.string(),
  }))
  .action(async ({ parsedInput }) => {
    const { userId, amount, reason } = parsedInput

    // æ›´æ–°ä½™é¢
    const credits = await db.query.userCredit.findFirst({
      where: eq(userCredit.userId, userId),
    })

    const newBalance = (credits?.balance || 0) + amount

    await db.update(userCredit)
      .set({ balance: newBalance })
      .where(eq(userCredit.userId, userId))

    // è®°å½•
    await db.insert(creditTransaction).values({
      userId,
      amount,
      type: amount > 0 ? 'grant' : 'consumption',
      reason: `ç®¡ç†å‘˜: ${reason}`,
      balanceAfter: newBalance,
    })

    return { success: true }
  })
```

---

## æ€»ç»“

mk-saas-blog çš„ç§¯åˆ†ç³»ç»Ÿæä¾›ï¼š

âœ… **çµæ´»çš„ç§¯åˆ†è·å–** - èµ é€ + è´­ä¹°
âœ… **è‡ªåŠ¨åŒ–çš„æ¶ˆè´¹** - æŒ‰åŠŸèƒ½è‡ªåŠ¨æ‰£è´¹
âœ… **è‡ªåŠ¨è¿‡æœŸæœºåˆ¶** - 30 å¤©æœªä½¿ç”¨è‡ªåŠ¨æ¸…é›¶
âœ… **å®Œæ•´çš„äº¤æ˜“è®°å½•** - è¿½è¸ªæ¯ä¸€æ¬¡ç§¯åˆ†å˜åŠ¨
âœ… **ç®¡ç†å‘˜æ§åˆ¶** - æ‰‹åŠ¨è°ƒæ•´å’Œç›‘æ§

---

**ç›¸å…³æ–‡æ¡£:**
- [ç”¨æˆ·è®¤è¯æ·±åº¦è§£æ](./ç”¨æˆ·è®¤è¯æ·±åº¦è§£æ.md)
- [æ”¯ä»˜ç³»ç»Ÿè¯¦è§£](./æ”¯ä»˜ç³»ç»Ÿè¯¦è§£.md)
- [æ•°æ®åº“è®¾è®¡æ·±åº¦è®²è§£](./æ•°æ®åº“è®¾è®¡æ·±åº¦è®²è§£.md)

**æœ€åæ›´æ–°:** 2025-11-18
