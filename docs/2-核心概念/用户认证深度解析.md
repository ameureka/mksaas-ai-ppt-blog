# ç”¨æˆ·è®¤è¯æ·±åº¦è§£æ

è¯¦ç»†è®²è§£ mk-saas-blog å¦‚ä½•ä½¿ç”¨ Better Auth å®ç°å®‰å…¨çš„ç”¨æˆ·è®¤è¯ã€ä¼šè¯ç®¡ç†å’Œç¤¾äº¤ç™»å½•ã€‚

---

## ğŸ“‹ ç›®å½•

- [è®¤è¯ç³»ç»Ÿæ¦‚è§ˆ](#è®¤è¯ç³»ç»Ÿæ¦‚è§ˆ)
- [Better Auth æ¡†æ¶](#better-auth-æ¡†æ¶)
- [é‚®ç®±å¯†ç è®¤è¯](#é‚®ç®±å¯†ç è®¤è¯)
- [OAuth ç¤¾äº¤ç™»å½•](#oauth-ç¤¾äº¤ç™»å½•)
- [ä¼šè¯ç®¡ç†](#ä¼šè¯ç®¡ç†)
- [é‚®ä»¶éªŒè¯](#é‚®ä»¶éªŒè¯)
- [å¯†ç é‡ç½®](#å¯†ç é‡ç½®)
- [å®‰å…¨è€ƒè™‘](#å®‰å…¨è€ƒè™‘)

---

## è®¤è¯ç³»ç»Ÿæ¦‚è§ˆ

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ç”¨æˆ·è®¤è¯ç³»ç»Ÿ (Authentication)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  Better Auth æ ¸å¿ƒ                              â”‚
â”‚  â”œâ”€ é‚®ç®±/å¯†ç è®¤è¯                              â”‚
â”‚  â”œâ”€ OAuth é›†æˆ (Google, GitHub)               â”‚
â”‚  â”œâ”€ ä¼šè¯ç®¡ç†                                    â”‚
â”‚  â””â”€ é‚®ä»¶éªŒè¯å’Œå¯†ç é‡ç½®                        â”‚
â”‚                                                 â”‚
â”‚  æ•°æ®å­˜å‚¨                                       â”‚
â”‚  â”œâ”€ user (ç”¨æˆ·è´¦æˆ·)                           â”‚
â”‚  â”œâ”€ session (æ´»è·ƒä¼šè¯)                        â”‚
â”‚  â””â”€ account (OAuth è´¦æˆ·å…³è”)                  â”‚
â”‚                                                 â”‚
â”‚  å®‰å…¨æœºåˆ¶                                       â”‚
â”‚  â”œâ”€ å¯†ç åŠ å¯† (Bcrypt)                        â”‚
â”‚  â”œâ”€ CSRF ä»¤ç‰Œ                                  â”‚
â”‚  â”œâ”€ Secure Cookies                           â”‚
â”‚  â””â”€ ä¼šè¯ä»¤ç‰Œ                                    â”‚
â”‚                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ”¯æŒçš„è®¤è¯æ–¹å¼

| æ–¹å¼ | æµç¨‹ | ä¼˜åŠ¿ | ä½¿ç”¨åœºæ™¯ |
|------|------|------|---------|
| **é‚®ç®±/å¯†ç ** | æ³¨å†Œ â†’ éªŒè¯ â†’ ç™»å½• | å®Œå…¨æ§åˆ¶ | ä¼ ç»Ÿåº”ç”¨ |
| **Google OAuth** | æˆæƒ â†’ åˆ›å»ºç”¨æˆ· | æ— éœ€å¯†ç  | å¿«é€Ÿæ³¨å†Œ |
| **GitHub OAuth** | æˆæƒ â†’ åˆ›å»ºç”¨æˆ· | å¼€å‘è€…å‹å¥½ | æŠ€æœ¯ç”¨æˆ· |

---

## Better Auth æ¡†æ¶

### åˆå§‹åŒ–å’Œé…ç½®

```typescript
// src/lib/auth.ts
import { betterAuth } from 'better-auth'
import { drizzleAdapter } from 'better-auth/adapters/drizzle'
import { db } from '@/db'
import { admin } from 'better-auth/plugins'

export const auth = betterAuth({
  // æ•°æ®åº“é…ç½®
  database: {
    db: db,
    provider: 'postgresql',
  },

  // åº”ç”¨ä¿¡æ¯
  appName: 'MkSaaS Blog',
  appLogo: '/logo.png',

  // åŸºæœ¬è·¯ç”±
  basePath: '/api/auth',

  // æ•°æ®åº“è¡¨å‰ç¼€
  tablePrefix: '',

  // é‚®ç®±å’Œå¯†ç è®¤è¯
  emailAndPassword: {
    enabled: true,
    autoSignInAfterVerification: false, // éªŒè¯åéœ€è¦å†æ¬¡ç™»å½•
    sendVerificationEmail: true,
  },

  // OAuth æä¾›å•†
  socialProviders: {
    google: {
      clientId: process.env.AUTH_GOOGLE_ID!,
      clientSecret: process.env.AUTH_GOOGLE_SECRET!,
    },
    github: {
      clientId: process.env.AUTH_GITHUB_ID!,
      clientSecret: process.env.AUTH_GITHUB_SECRET!,
    },
  },

  // æ’ä»¶
  plugins: [
    admin(), // ç®¡ç†å‘˜åŠŸèƒ½
  ],

  // å›è°ƒé’©å­
  callbacks: {
    async onSuccess(context) {
      // ç”¨æˆ·æˆåŠŸæ³¨å†Œæˆ–ç™»å½•æ—¶è§¦å‘
      console.log('User authenticated:', context.user)
    },
    async onError(context) {
      // è®¤è¯å¤±è´¥æ—¶è§¦å‘
      console.error('Auth error:', context.error)
    },
  },
})
```

### æ ¸å¿ƒç±»å‹

```typescript
// ç”¨æˆ·ç±»å‹
type User = {
  id: string
  email: string
  emailVerified: boolean
  name: string
  image?: string
  createdAt: Date
  updatedAt: Date
}

// ä¼šè¯ç±»å‹
type Session = {
  id: string
  userId: string
  token: string
  expiresAt: Date
  createdAt: Date
  updatedAt: Date
}

// è´¦æˆ·ç±»å‹ (OAuth)
type Account = {
  id: string
  userId: string
  accountId: string // æä¾›å•†çš„ç”¨æˆ· ID
  provider: 'google' | 'github'
  providerAccountId: string
  refreshToken?: string
  accessToken?: string
  expiresAt?: Date
  scope?: string
  tokenType?: string
  createdAt: Date
  updatedAt: Date
}
```

---

## é‚®ç®±å¯†ç è®¤è¯

### ç”¨æˆ·æ³¨å†Œæµç¨‹

```
ç”¨æˆ·è®¿é—® /auth/register
  â†“
è¾“å…¥é‚®ç®±ã€å¯†ç ã€ç¡®è®¤å¯†ç 
  â†“
å®¢æˆ·ç«¯éªŒè¯ (Zod Schema)
  â†“
æäº¤åˆ° /api/auth/sign-up
  â†“
æœåŠ¡å™¨éªŒè¯
  â”œâ”€ é‚®ç®±æ ¼å¼æ£€æŸ¥
  â”œâ”€ å¯†ç å¼ºåº¦æ£€æŸ¥ (8+ å­—ç¬¦ï¼Œå¤§å°å†™ã€æ•°å­—ã€ç¬¦å·)
  â””â”€ é‚®ç®±å”¯ä¸€æ€§æ£€æŸ¥
  â†“ æˆåŠŸ
ä½¿ç”¨ Bcrypt åŠ å¯†å¯†ç 
  â†“
åœ¨ user è¡¨åˆ›å»ºè®°å½•
  â†“
ç”ŸæˆéªŒè¯ä»¤ç‰Œ
  â†“
å‘é€éªŒè¯é‚®ä»¶
  â†“
è¿”å›æˆåŠŸæ¶ˆæ¯
```

### æ³¨å†Œ Server Action

```typescript
// src/actions/auth.ts
'use server'

import { z } from 'zod'
import { auth } from '@/lib/auth'
import { db } from '@/db'
import { user } from '@/db/schema'
import { eq } from 'drizzle-orm'

// éªŒè¯ Schema
const SignUpSchema = z.object({
  email: z.string().email('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®'),
  password: z
    .string()
    .min(8, 'å¯†ç è‡³å°‘ 8 ä¸ªå­—ç¬¦')
    .regex(/[A-Z]/, 'å¯†ç éœ€åŒ…å«å¤§å†™å­—æ¯')
    .regex(/[a-z]/, 'å¯†ç éœ€åŒ…å«å°å†™å­—æ¯')
    .regex(/[0-9]/, 'å¯†ç éœ€åŒ…å«æ•°å­—')
    .regex(/[^a-zA-Z0-9]/, 'å¯†ç éœ€åŒ…å«ç‰¹æ®Šå­—ç¬¦'),
  name: z.string().min(2, 'åå­—è‡³å°‘ 2 ä¸ªå­—ç¬¦'),
})

export async function signUp(input: z.infer<typeof SignUpSchema>) {
  // éªŒè¯è¾“å…¥
  const parsed = SignUpSchema.safeParse(input)
  if (!parsed.success) {
    return { error: 'è¾“å…¥éªŒè¯å¤±è´¥' }
  }

  const { email, password, name } = parsed.data

  try {
    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    const existingUser = await db.query.user.findFirst({
      where: eq(user.email, email),
    })

    if (existingUser) {
      return { error: 'é‚®ç®±å·²è¢«æ³¨å†Œ' }
    }

    // ä½¿ç”¨ Better Auth åˆ›å»ºç”¨æˆ·
    const response = await auth.api.signUpEmail({
      email,
      password,
      name,
    })

    if (!response.ok) {
      return { error: 'æ³¨å†Œå¤±è´¥' }
    }

    // å¦‚æœéœ€è¦ï¼Œåœ¨ user è¡¨ä¸­æ·»åŠ é¢å¤–å­—æ®µ
    // await db.update(user)
    //   .set({ initializedAt: new Date() })
    //   .where(eq(user.email, email))

    return {
      success: true,
      message: 'æ³¨å†ŒæˆåŠŸï¼Œè¯·æ£€æŸ¥é‚®ç®±éªŒè¯é‚®ä»¶'
    }
  } catch (error) {
    console.error('Sign up error:', error)
    return { error: 'æ³¨å†Œè¿‡ç¨‹ä¸­å‡ºé”™' }
  }
}
```

### ç”¨æˆ·ç™»å½•æµç¨‹

```
ç”¨æˆ·è®¿é—® /auth/login
  â†“
è¾“å…¥é‚®ç®±å’Œå¯†ç 
  â†“
æäº¤åˆ° /api/auth/sign-in
  â†“
æœåŠ¡å™¨éªŒè¯
  â”œâ”€ æŸ¥æ‰¾ç”¨æˆ·
  â”œâ”€ æ¯”è¾ƒå¯†ç  (Bcrypt)
  â””â”€ æ£€æŸ¥é‚®ç®±æ˜¯å¦éªŒè¯
  â†“ æˆåŠŸ
ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
  â†“
è®¾ç½® Secure Cookie
  â†“
é‡å®šå‘åˆ°ä»ªè¡¨æ¿
```

### ç™»å½• Server Action

```typescript
export async function signIn(email: string, password: string) {
  try {
    // æŸ¥æ‰¾ç”¨æˆ·
    const userRecord = await db.query.user.findFirst({
      where: eq(user.email, email),
    })

    if (!userRecord) {
      return { error: 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®' }
    }

    if (!userRecord.emailVerified) {
      return { error: 'è¯·å…ˆéªŒè¯é‚®ç®±' }
    }

    // ä½¿ç”¨ Better Auth éªŒè¯å¯†ç å¹¶åˆ›å»ºä¼šè¯
    const response = await auth.api.signInEmail({
      email,
      password,
    })

    if (!response.ok) {
      return { error: 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®' }
    }

    return { success: true }
  } catch (error) {
    console.error('Sign in error:', error)
    return { error: 'ç™»å½•è¿‡ç¨‹ä¸­å‡ºé”™' }
  }
}
```

---

## OAuth ç¤¾äº¤ç™»å½•

### Google OAuth æµç¨‹

```
ç”¨æˆ·ç‚¹å‡» "ç”¨ Google ç™»å½•"
  â†“
é‡å®šå‘åˆ° /api/auth/signin/google
  â†“ (Better Auth å¤„ç†)
é‡å®šå‘åˆ° Google ç™»å½•é¡µ
  â†“
ç”¨æˆ·è¾“å…¥ Google å‡­è¯
  â†“
Google éªŒè¯æˆåŠŸ
  â†“
é‡å®šå‘å›åº”ç”¨ /api/auth/callback/google?code=xxx
  â†“ (Better Auth å¤„ç†)
ä½¿ç”¨ code äº¤æ¢ access token
  â†“
ä» Google è·å–ç”¨æˆ·ä¿¡æ¯ (é‚®ç®±ã€åå­—ã€å¤´åƒ)
  â†“
æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
  â”œâ”€ å¦‚æœå­˜åœ¨: æ›´æ–°ä¼šè¯
  â””â”€ å¦‚æœä¸å­˜åœ¨: åˆ›å»ºæ–°ç”¨æˆ·
  â†“
ç”Ÿæˆä¼šè¯ä»¤ç‰Œ
  â†“
é‡å®šå‘åˆ°ä»ªè¡¨æ¿
```

### é…ç½® OAuth å‡­è¯

**Google OAuth è®¾ç½®:**

1. è®¿é—® [Google Cloud Console](https://console.cloud.google.com)
2. åˆ›å»ºæ–°é¡¹ç›®
3. å¯ç”¨ Google+ API
4. åˆ›å»º OAuth 2.0 å‡­è¯
   - åº”ç”¨ç±»å‹: Web application
   - æˆæƒçš„é‡å®šå‘ URI: `http://localhost:3005/api/auth/callback/google`
5. å¤åˆ¶ Client ID å’Œ Client Secret

```bash
# .env.local
AUTH_GOOGLE_ID=your-google-client-id
AUTH_GOOGLE_SECRET=your-google-client-secret
```

**GitHub OAuth è®¾ç½®:**

1. è®¿é—® [GitHub Developer Settings](https://github.com/settings/developers)
2. åˆ›å»ºæ–°çš„ OAuth App
3. å¡«å†™ä¿¡æ¯
   - åç§°: MkSaaS Blog
   - Authorization callback URL: `http://localhost:3005/api/auth/callback/github`
4. å¤åˆ¶ Client ID å’Œ Client Secret

```bash
# .env.local
AUTH_GITHUB_ID=your-github-client-id
AUTH_GITHUB_SECRET=your-github-client-secret
```

### OAuth é“¾æ¥å‰ç«¯

```typescript
// src/components/oauth-buttons.tsx
'use client'

export function GoogleSignInButton() {
  const handleSignIn = async () => {
    // Better Auth è‡ªåŠ¨å¤„ç†é‡å®šå‘
    window.location.href = '/api/auth/signin/google'
  }

  return (
    <button onClick={handleSignIn} className="btn-google">
      ç”¨ Google ç™»å½•
    </button>
  )
}

export function GitHubSignInButton() {
  const handleSignIn = async () => {
    window.location.href = '/api/auth/signin/github'
  }

  return (
    <button onClick={handleSignIn} className="btn-github">
      ç”¨ GitHub ç™»å½•
    </button>
  )
}
```

---

## ä¼šè¯ç®¡ç†

### ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸ

```
ç”¨æˆ·ç™»å½•
  â†“
ç”Ÿæˆå”¯ä¸€çš„ä¼šè¯ ID
  â†“
åˆ›å»º Session è®°å½•
  â”œâ”€ id: å”¯ä¸€æ ‡è¯†
  â”œâ”€ userId: å…³è”ç”¨æˆ·
  â”œâ”€ token: åŠ å¯†çš„ä¼šè¯ä»¤ç‰Œ
  â”œâ”€ expiresAt: è¿‡æœŸæ—¶é—´ (7 å¤©)
  â””â”€ createdAt: åˆ›å»ºæ—¶é—´
  â†“
è®¾ç½® Secure HttpOnly Cookie
  â”œâ”€ Name: auth.session
  â”œâ”€ Value: ä¼šè¯ä»¤ç‰Œ
  â”œâ”€ Secure: true (ä»… HTTPS)
  â”œâ”€ HttpOnly: true (JavaScript æ— æ³•è®¿é—®)
  â”œâ”€ SameSite: Strict (CSRF é˜²æŠ¤)
  â””â”€ Max-Age: 604800 (7 å¤©)
  â†“
æ¯æ¬¡è¯·æ±‚è‡ªåŠ¨æºå¸¦ Cookie
  â†“ (7 å¤©å)
ä¼šè¯è¿‡æœŸ
  â†“
ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
```

### è·å–å½“å‰ä¼šè¯

```typescript
// src/lib/auth-utils.ts
import { auth } from '@/lib/auth'
import { headers } from 'next/headers'

// æœåŠ¡å™¨ç«¯è·å–ä¼šè¯
export async function getSession() {
  const headersList = await headers()
  const session = await auth.api.getSession({
    headers: headersList,
  })
  return session?.session ?? null
}

// è·å–å½“å‰ç”¨æˆ·
export async function getCurrentUser() {
  const session = await getSession()
  return session?.user ?? null
}

// éªŒè¯ç”¨æˆ·æ˜¯å¦ç™»å½• (Server Component)
export async function ProtectedComponent() {
  const user = await getCurrentUser()

  if (!user) {
    return <LoginPrompt />
  }

  return <Dashboard user={user} />
}
```

### å®¢æˆ·ç«¯ä¼šè¯æ£€æŸ¥

```typescript
// src/hooks/use-auth.ts
'use client'

import { useEffect, useState } from 'react'

export function useAuth() {
  const [user, setUser] = useState(null)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    // ä»å®¢æˆ·ç«¯æ£€æŸ¥ä¼šè¯
    // Better Auth é€šå¸¸åœ¨ Server Component ä¸­å¤„ç†
    // ä½†ä¹Ÿå¯ä»¥é€šè¿‡ API ç«¯ç‚¹åœ¨å®¢æˆ·ç«¯è·å–
  }, [])

  return { user, isLoading }
}
```

### ç™»å‡ºæµç¨‹

```typescript
export async function signOut() {
  try {
    await auth.api.signOut()
    // é‡å®šå‘åˆ°é¦–é¡µ
    window.location.href = '/'
  } catch (error) {
    console.error('Sign out error:', error)
    return { error: 'ç™»å‡ºå¤±è´¥' }
  }
}
```

---

## é‚®ä»¶éªŒè¯

### éªŒè¯æµç¨‹

```
ç”¨æˆ·æ³¨å†Œ
  â†“
Better Auth ç”ŸæˆéªŒè¯ä»¤ç‰Œ
  â†“
é€šè¿‡ Resend å‘é€éªŒè¯é‚®ä»¶
  â”œâ”€ æ”¶ä»¶äºº: ç”¨æˆ·é‚®ç®±
  â”œâ”€ ä¸»é¢˜: éªŒè¯ä½ çš„é‚®ç®±åœ°å€
  â””â”€ å†…å®¹: åŒ…å«éªŒè¯é“¾æ¥
  â†“
ç”¨æˆ·åœ¨é‚®ä»¶ä¸­ç‚¹å‡»é“¾æ¥
  â†“
é“¾æ¥æŒ‡å‘ /api/auth/verify-email?token=xxx
  â†“
Better Auth éªŒè¯ä»¤ç‰Œ
  â”œâ”€ æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆ
  â”œâ”€ æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ (é€šå¸¸ 24 å°æ—¶)
  â””â”€ æ£€æŸ¥æ˜¯å¦å·²éªŒè¯è¿‡
  â†“ æˆåŠŸ
æ›´æ–° user.emailVerified = true
  â†“
é‡å®šå‘åˆ°ç™»å½•é¡µ
```

### éªŒè¯é‚®ä»¶æ¨¡æ¿

```typescript
// src/mail/templates/verify-email.tsx
import * as React from 'react'
import {
  Html,
  Body,
  Container,
  Heading,
  Text,
  Link,
  Button,
} from '@react-email/components'

interface VerifyEmailProps {
  verificationLink: string
  userName: string
}

export const VerifyEmailTemplate: React.FC<VerifyEmailProps> = ({
  verificationLink,
  userName,
}) => (
  <Html>
    <Body style={{ fontFamily: 'sans-serif' }}>
      <Container>
        <Heading>éªŒè¯ä½ çš„é‚®ç®±åœ°å€</Heading>
        <Text>ä½ å¥½ {userName}ï¼Œ</Text>
        <Text>
          æ„Ÿè°¢æ³¨å†Œ MkSaaS Blogã€‚è¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥éªŒè¯ä½ çš„é‚®ç®±åœ°å€ã€‚
        </Text>
        <Button
          href={verificationLink}
          style={{
            background: '#007bff',
            color: 'white',
            padding: '12px 24px',
            borderRadius: '4px',
            textDecoration: 'none',
          }}
        >
          éªŒè¯é‚®ç®±
        </Button>
        <Text>
          å¦‚æœä¸Šæ–¹æŒ‰é’®æ— æ•ˆï¼Œè¯·å¤åˆ¶æ­¤é“¾æ¥åˆ°æµè§ˆå™¨ï¼š
        </Text>
        <Text>{verificationLink}</Text>
        <Text style={{ fontSize: '12px', color: '#666' }}>
          æ­¤é“¾æ¥ 24 å°æ—¶åè¿‡æœŸã€‚
        </Text>
      </Container>
    </Body>
  </Html>
)
```

### å‘é€éªŒè¯é‚®ä»¶

```typescript
// src/lib/email.ts
import { Resend } from 'resend'
import { VerifyEmailTemplate } from '@/mail/templates/verify-email'

const resend = new Resend(process.env.RESEND_API_KEY)

export async function sendVerificationEmail(
  email: string,
  userName: string,
  verificationLink: string
) {
  try {
    await resend.emails.send({
      from: 'noreply@mksaasblog.com',
      to: email,
      subject: 'éªŒè¯ä½ çš„é‚®ç®±åœ°å€',
      react: VerifyEmailTemplate({
        verificationLink,
        userName,
      }),
    })
  } catch (error) {
    console.error('å‘é€éªŒè¯é‚®ä»¶å¤±è´¥:', error)
    throw error
  }
}
```

---

## å¯†ç é‡ç½®

### å¯†ç é‡ç½®æµç¨‹

```
ç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢
  â†“
ç‚¹å‡» "å¿˜è®°å¯†ç "
  â†“
è¾“å…¥é‚®ç®±åœ°å€
  â†“
æäº¤åˆ° /api/auth/forgot-password
  â†“
æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨
  â”œâ”€ ä¸å­˜åœ¨: è¿”å›æˆåŠŸ (å®‰å…¨è€ƒè™‘ï¼Œä¸æš´éœ²ç”¨æˆ·ä¿¡æ¯)
  â””â”€ å­˜åœ¨: ç»§ç»­
  â†“
ç”Ÿæˆå¯†ç é‡ç½®ä»¤ç‰Œ
  â†“
å‘é€é‡ç½®é“¾æ¥é‚®ä»¶
  â†“
ç”¨æˆ·åœ¨é‚®ä»¶ä¸­ç‚¹å‡»é“¾æ¥
  â†“
é“¾æ¥æŒ‡å‘ /auth/reset-password?token=xxx
  â†“
ç”¨æˆ·è¾“å…¥æ–°å¯†ç 
  â†“
æäº¤åˆ° /api/auth/reset-password
  â†“
Better Auth éªŒè¯ä»¤ç‰Œ
  â”œâ”€ æ£€æŸ¥ä»¤ç‰Œæœ‰æ•ˆæ€§
  â””â”€ æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ (30 åˆ†é’Ÿ)
  â†“ æˆåŠŸ
æ›´æ–°å¯†ç 
  â†“
ä½¿æ—§ä¼šè¯å¤±æ•ˆ (å¼ºåˆ¶é‡æ–°ç™»å½•)
  â†“
é‡å®šå‘åˆ°ç™»å½•é¡µé¢
```

### å¯†ç é‡ç½® Server Action

```typescript
export async function requestPasswordReset(email: string) {
  try {
    // æ£€æŸ¥é‚®ç®±æ˜¯å¦å­˜åœ¨ï¼ˆä¸æš´éœ²ä¿¡æ¯ï¼‰
    const user = await db.query.user.findFirst({
      where: eq(user.email, email),
    })

    if (!user) {
      // è¿”å›æˆåŠŸä»¥éšè—ç”¨æˆ·ä¿¡æ¯
      return { success: true }
    }

    // ç”Ÿæˆé‡ç½®ä»¤ç‰Œå’Œé“¾æ¥
    const resetToken = generateToken()
    const resetLink = `${process.env.NEXT_PUBLIC_APP_URL}/auth/reset-password?token=${resetToken}`

    // ä¿å­˜ä»¤ç‰Œåˆ°æ•°æ®åº“ï¼ˆè®¾ç½® 30 åˆ†é’Ÿè¿‡æœŸï¼‰
    await savePasswordResetToken(user.id, resetToken, 30 * 60)

    // å‘é€é‚®ä»¶
    await sendPasswordResetEmail(email, user.name, resetLink)

    return { success: true }
  } catch (error) {
    console.error('å¯†ç é‡ç½®è¯·æ±‚å¤±è´¥:', error)
    return { error: 'è¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' }
  }
}

export async function resetPassword(token: string, newPassword: string) {
  try {
    // éªŒè¯ä»¤ç‰Œ
    const resetRecord = await verifyPasswordResetToken(token)
    if (!resetRecord) {
      return { error: 'æ— æ•ˆæˆ–è¿‡æœŸçš„é‡ç½®é“¾æ¥' }
    }

    // æ›´æ–°å¯†ç 
    await db.update(user)
      .set({ password: hashPassword(newPassword) })
      .where(eq(user.id, resetRecord.userId))

    // åˆ é™¤å·²ä½¿ç”¨çš„ä»¤ç‰Œ
    await deletePasswordResetToken(token)

    // ä½¿æ‰€æœ‰ä¼šè¯å¤±æ•ˆ
    await invalidateUserSessions(resetRecord.userId)

    return { success: true, message: 'å¯†ç å·²é‡ç½®ï¼Œè¯·é‡æ–°ç™»å½•' }
  } catch (error) {
    console.error('å¯†ç é‡ç½®å¤±è´¥:', error)
    return { error: 'é‡ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•' }
  }
}
```

---

## å®‰å…¨è€ƒè™‘

### å¯†ç å®‰å…¨

```typescript
// ä½¿ç”¨ Bcrypt åŠ å¯†å¯†ç 
import bcrypt from 'bcrypt'

const SALT_ROUNDS = 12 // è°ƒæ•´ä»¥å¹³è¡¡å®‰å…¨å’Œæ€§èƒ½

export async function hashPassword(password: string) {
  return await bcrypt.hash(password, SALT_ROUNDS)
}

export async function verifyPassword(
  password: string,
  hash: string
) {
  return await bcrypt.compare(password, hash)
}
```

### CSRF é˜²æŠ¤

Better Auth è‡ªåŠ¨åœ¨æ‰€æœ‰çŠ¶æ€æ”¹å˜çš„æ“ä½œä¸­æ·»åŠ  CSRF ä»¤ç‰Œï¼š

```typescript
// Server Action è‡ªåŠ¨åŒ…å« CSRF éªŒè¯
'use server'

export async function signOut() {
  // Better Auth éªŒè¯ CSRF ä»¤ç‰Œ
  await auth.api.signOut()
}
```

### Session å®‰å…¨

```typescript
// Secure Cookie é…ç½®
const sessionCookie = {
  // ä»…é€šè¿‡ HTTPS ä¼ è¾“
  secure: process.env.NODE_ENV === 'production',

  // JavaScript æ— æ³•è®¿é—®ï¼ˆé˜² XSSï¼‰
  httpOnly: true,

  // ä»…åœ¨åŒä¸€ç«™ç‚¹å‘é€ï¼ˆé˜² CSRFï¼‰
  sameSite: 'strict' as const,

  // 7 å¤©è¿‡æœŸ
  maxAge: 7 * 24 * 60 * 60,
}
```

### é‚®ä»¶éªŒè¯ä»¤ç‰Œ

```typescript
// ä»¤ç‰Œåº”è¯¥ï¼š
// 1. éšæœºç”Ÿæˆï¼ˆåŠ å¯†å¼ºåº¦é«˜ï¼‰
// 2. æœ‰è¿‡æœŸæ—¶é—´ï¼ˆ24 å°æ—¶ï¼‰
// 3. ä¸€æ¬¡æ€§ä½¿ç”¨ï¼ˆéªŒè¯ååˆ é™¤ï¼‰
// 4. ä¸å¯é¢„æµ‹ï¼ˆä¸èƒ½é€šè¿‡æ¨¡å¼æ¨å¯¼ï¼‰

export function generateVerificationToken(): string {
  return crypto.randomBytes(32).toString('hex')
}
```

### é€Ÿç‡é™åˆ¶

```typescript
// é˜²æ­¢æš´åŠ›ç ´è§£
const rateLimitConfig = {
  signIn: {
    maxAttempts: 5,
    windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  },
  signUp: {
    maxAttempts: 3,
    windowMs: 60 * 60 * 1000, // 1 å°æ—¶
  },
  passwordReset: {
    maxAttempts: 3,
    windowMs: 60 * 60 * 1000, // 1 å°æ—¶
  },
}
```

### æ•æ„Ÿä¿¡æ¯å¤„ç†

```typescript
// âŒ ä¸è¦åœ¨æ—¥å¿—ä¸­è®°å½•å¯†ç æˆ–ä»¤ç‰Œ
console.log({ email, password }) // å±é™©ï¼

// âœ… åªè®°å½•å¿…è¦çš„ä¿¡æ¯
console.log({ userId, action: 'sign-in', timestamp })

// âŒ ä¸è¦åœ¨é”™è¯¯æ¶ˆæ¯ä¸­æ³„éœ²ç”¨æˆ·ä¿¡æ¯
return { error: 'é‚®ç®± test@example.com ä¸å­˜åœ¨' } // å±é™©ï¼

// âœ… ä½¿ç”¨é€šç”¨é”™è¯¯æ¶ˆæ¯
return { error: 'é‚®ç®±æˆ–å¯†ç ä¸æ­£ç¡®' }
```

---

## å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### Q1: ç”¨æˆ·æ— æ³•æ”¶åˆ°éªŒè¯é‚®ä»¶ï¼Ÿ

**åŸå› å’Œè§£å†³:**
1. æ£€æŸ¥ RESEND_API_KEY æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥é‚®ä»¶æ˜¯å¦è¿›å…¥åƒåœ¾ç®±
3. æŸ¥çœ‹åº”ç”¨æ—¥å¿—ä¸­çš„é‚®ä»¶å‘é€é”™è¯¯
4. ç¡®ä¿ Resend è´¦æˆ·å¤„äºæ´»è·ƒçŠ¶æ€

### Q2: OAuth ç™»å½•ä¸å·¥ä½œï¼Ÿ

**åŸå› å’Œè§£å†³:**
1. æ£€æŸ¥ CLIENT_ID å’Œ CLIENT_SECRET æ˜¯å¦æ­£ç¡®
2. æ£€æŸ¥å›è°ƒ URL æ˜¯å¦ä¸ OAuth åº”ç”¨è®¾ç½®ä¸€è‡´
3. ç¡®ä¿åº”ç”¨å·²æˆæƒä½¿ç”¨ OAuth API
4. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°ä¸­çš„é‡å®šå‘é”™è¯¯

### Q3: ä¼šè¯åœ¨åˆ·æ–°åä¸¢å¤±ï¼Ÿ

**åŸå› å’Œè§£å†³:**
1. æ£€æŸ¥ Cookie æ˜¯å¦æ­£ç¡®è®¾ç½®
2. ç¡®ä¿æµè§ˆå™¨æ¥å— Cookie
3. æ£€æŸ¥ Secure æ ‡å¿—ï¼ˆæœ¬åœ°å¼€å‘éœ€è¦å…³é—­ï¼‰
4. ç¡®ä¿ä¼šè¯æœªè¿‡æœŸ

---

## æ€»ç»“

mk-saas-blog çš„è®¤è¯ç³»ç»Ÿé€šè¿‡ Better Auth æä¾›ï¼š

âœ… **å¤šç§è®¤è¯æ–¹å¼** - é‚®ç®±/å¯†ç å’Œ OAuth
âœ… **å®‰å…¨çš„ä¼šè¯ç®¡ç†** - Secure HttpOnly Cookies
âœ… **é‚®ä»¶éªŒè¯** - ç¡®ä¿é‚®ç®±æœ‰æ•ˆ
âœ… **å¯†ç é‡ç½®** - å®‰å…¨çš„å¯†ç æ¢å¤
âœ… **è‡ªåŠ¨çš„ CSRF é˜²æŠ¤** - é˜²æ­¢è·¨ç«™è¯·æ±‚
âœ… **å®Œæ•´çš„é”™è¯¯å¤„ç†** - ç”¨æˆ·å‹å¥½çš„æç¤º

---

**ç›¸å…³æ–‡æ¡£:**
- [æ”¯ä»˜ç³»ç»Ÿè¯¦è§£](./æ”¯ä»˜ç³»ç»Ÿè¯¦è§£.md)
- [ç§¯åˆ†ç³»ç»Ÿè¿ä½œ](./ç§¯åˆ†ç³»ç»Ÿè¿ä½œ.md)
- [æ•°æ®åº“è®¾è®¡æ·±åº¦è®²è§£](./æ•°æ®åº“è®¾è®¡æ·±åº¦è®²è§£.md)

**æœ€åæ›´æ–°:** 2025-11-18
