# 国际化实现

详细讲解 mk-saas-blog 如何使用 next-intl 实现多语言支持。

---

## 快速概览

```
支持语言: 英文 (en) + 中文 (zh)
实现库: next-intl
实现方式: URL 路由级别
URL 格式: /en/dashboard, /zh/dashboard
自动检测: 根据浏览器语言偏好
切换方式: 下拉菜单或按钮
```

---

## 配置

### i18n.config.ts

```typescript
// src/config/i18n.ts
export const i18n = {
  defaultLocale: 'en' as const,
  locales: ['en', 'zh'] as const,
} satisfies Config

export type Locale = (typeof i18n)['locales'][number]

export const localeNames: Record<Locale, string> = {
  en: 'English',
  zh: '中文',
}
```

### 翻译文件结构

```
messages/
├── en.json          # 英文翻译
├── zh.json          # 中文翻译
├── auth/
│   ├── en.json
│   └── zh.json
└── common/
    ├── en.json
    └── zh.json
```

### 英文翻译示例

```json
{
  "nav": {
    "home": "Home",
    "dashboard": "Dashboard",
    "pricing": "Pricing",
    "blog": "Blog",
    "auth": {
      "signin": "Sign In",
      "signup": "Sign Up",
      "signout": "Sign Out"
    }
  },
  "pricing": {
    "free": "Free",
    "pro": "Professional",
    "lifetime": "Lifetime Access",
    "per_month": "per month",
    "per_year": "per year"
  }
}
```

### 中文翻译示例

```json
{
  "nav": {
    "home": "首页",
    "dashboard": "仪表板",
    "pricing": "定价",
    "blog": "博客",
    "auth": {
      "signin": "登录",
      "signup": "注册",
      "signout": "登出"
    }
  },
  "pricing": {
    "free": "免费版",
    "pro": "专业版",
    "lifetime": "终身访问",
    "per_month": "每月",
    "per_year": "每年"
  }
}
```

---

## 路由设置

### App Router 配置

```
app/
├── [lang]/
│   ├── layout.tsx           # 语言布局
│   ├── page.tsx             # / 页面
│   ├── dashboard/
│   │   └── page.tsx         # /dashboard 页面
│   ├── pricing/
│   │   └── page.tsx         # /pricing 页面
│   └── auth/
│       ├── login/
│       │   └── page.tsx     # /auth/login
│       └── register/
│           └── page.tsx     # /auth/register
└── api/
    └── [lang]/              # API 路由也支持国际化
```

### Layout 配置

```typescript
// app/[lang]/layout.tsx
import { notFound } from 'next/navigation'
import { getMessages } from 'next-intl/server'
import { NextIntlClientProvider } from 'next-intl'
import { i18n } from '@/config/i18n'

export function generateStaticParams() {
  return i18n.locales.map((locale) => ({ lang: locale }))
}

export default async function RootLayout({
  children,
  params: { lang },
}: {
  children: React.ReactNode
  params: { lang: string }
}) {
  // 验证语言参数
  if (!i18n.locales.includes(lang as never)) {
    notFound()
  }

  // 获取该语言的翻译
  const messages = await getMessages(lang)

  return (
    <html lang={lang}>
      <body>
        <NextIntlClientProvider messages={messages} locale={lang}>
          {children}
        </NextIntlClientProvider>
      </body>
    </html>
  )
}
```

---

## 组件中使用翻译

### Server Component

```typescript
// app/[lang]/dashboard/page.tsx
import { useTranslations } from 'next-intl'

export default function DashboardPage() {
  const t = useTranslations()

  return (
    <div>
      <h1>{t('nav.dashboard')}</h1>
      <p>{t('common.welcome')}</p>
    </div>
  )
}
```

### Client Component

```typescript
// components/language-switcher.tsx
'use client'

import { useRouter } from 'next/navigation'
import { useLocale } from 'next-intl'
import { i18n, localeNames } from '@/config/i18n'

export function LanguageSwitcher() {
  const router = useRouter()
  const currentLocale = useLocale()

  const handleChange = (newLocale: string) => {
    // 获取当前路径，替换语言部分
    const path = window.location.pathname.replace(
      `/${currentLocale}`,
      `/${newLocale}`
    )
    router.push(path)
  }

  return (
    <select
      value={currentLocale}
      onChange={(e) => handleChange(e.target.value)}
    >
      {i18n.locales.map((locale) => (
        <option key={locale} value={locale}>
          {localeNames[locale]}
        </option>
      ))}
    </select>
  )
}
```

---

## 日期和数字本地化

### 日期格式化

```typescript
import { useFormatter } from 'next-intl'

export function DateDisplay({ date }: { date: Date }) {
  const format = useFormatter()

  return (
    <div>
      {format.dateTime(date, {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
      })}
    </div>
  )
}

// 输出:
// en: November 18, 2024
// zh: 2024年11月18日
```

### 数字和货币格式

```typescript
export function PriceDisplay({ amount }: { amount: number }) {
  const format = useFormatter()

  return (
    <div>
      {format.number(amount / 100, {
        style: 'currency',
        currency: 'USD',
      })}
    </div>
  )
}

// 输出:
// en: $9.99
// zh: $9.99
```

---

## 语言检测和重定向

### 中间件自动重定向

```typescript
// middleware.ts
import { NextRequest, NextResponse } from 'next/server'
import { i18n } from '@/config/i18n'

export function middleware(request: NextRequest) {
  const pathname = request.nextUrl.pathname

  // 如果路径不包含语言代码，进行重定向
  const pathnameHasLocale = i18n.locales.some(
    (locale) => pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`
  )

  if (pathnameHasLocale) return

  // 获取首选语言
  const locale =
    request.headers
      .get('accept-language')
      ?.split(',')?.[0]
      ?.split('-')?.[0] || i18n.defaultLocale

  // 重定向到 /[locale]/pathname
  return NextResponse.redirect(
    new URL(
      `/${i18n.locales.includes(locale as any) ? locale : i18n.defaultLocale}${pathname}`,
      request.url
    )
  )
}

export const config = {
  matcher: [
    // 除了 API 和特殊文件
    '/((?!api|_next|.*\\.[\\w]+$).*)',
  ],
}
```

---

## SEO 优化

### hreflang 链接

```typescript
// app/[lang]/layout.tsx
export default function RootLayout({
  children,
  params: { lang },
}: {
  children: React.ReactNode
  params: { lang: string }
}) {
  return (
    <html lang={lang}>
      <head>
        {/* 所有语言版本的链接 */}
        {i18n.locales.map((locale) => (
          <link
            key={locale}
            rel="alternate"
            hrefLang={locale}
            href={`${process.env.NEXT_PUBLIC_APP_URL}/${locale}`}
          />
        ))}
      </head>
      <body>{children}</body>
    </html>
  )
}
```

### Meta 标签本地化

```typescript
// app/[lang]/page.tsx
import { useTranslations } from 'next-intl'

export function generateMetadata({ params: { lang } }) {
  return {
    title:
      lang === 'zh'
        ? '欢迎来到 MkSaaS Blog'
        : 'Welcome to MkSaaS Blog',
    description:
      lang === 'zh'
        ? '完整的 SaaS 应用文档和示例'
        : 'Complete SaaS application documentation and examples',
  }
}
```

---

## 常见问题

### Q1: 如何添加新语言?

1. 在 `i18n.ts` 添加语言代码
2. 创建翻译文件 `messages/[lang].json`
3. 更新 `generateStaticParams()`

### Q2: 动态内容的翻译?

对于数据库中的内容，使用两个字段：

```typescript
// 博客文章表
{
  id: '1',
  titleEn: 'Getting Started',
  titleZh: '快速开始',
  contentEn: '...',
  contentZh: '...',
  locale: 'both', // 两种语言都有
}

// 查询时根据语言过滤
const post = await db.query.post.findFirst({
  where: and(
    eq(post.id, '1'),
    or(
      eq(post.locale, 'both'),
      eq(post.locale, lang)
    )
  )
})
```

---

## 总结

mk-saas-blog 的国际化支持：

✅ **多语言** - 英文和中文
✅ **URL 级别** - /en/... 和 /zh/...
✅ **自动检测** - 浏览器语言偏好
✅ **完整本地化** - 日期、数字、货币
✅ **SEO 友好** - hreflang 链接

---

**最后更新:** 2025-11-18
