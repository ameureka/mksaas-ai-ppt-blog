# 下载组件结构与时序（草案）

## 1) 组件概览
- `DownloadModal`（详情页调用）
  - 步骤：选择方式 -> 确认 -> 下载
  - 方法选项：首免（firstFree）、积分（credits）、广告（ad）、注册（register）
  - 状态：loading/error/link/expires，登录状态（authClient）
- `DownloadOptionsModal`（同类 UI，用卡片形式选择下载方式）
- 下载接口：`POST /api/ppts/[id]/download`（或 server action）

## 2) 组件层次 ASCII
```
[DownloadModal]
 ├─ Stepper (1/2/3)
 ├─ Option list (首免 / 积分 / 广告 / 注册)
 ├─ Actions:
 │    - 继续 (handleContinue)
 │    - 确认 (handleConfirmMethod)
 ├─ Link display (step 3)
 └─ Terms checkbox / Tips

[DownloadOptionsModal]
 ├─ Stepper (1/2/3)
 ├─ OptionCard[] (同上，卡片布局)
 ├─ CTA buttons (确认/取消)
 └─ Link display / Copy / Open
```

## 3) 时序（首免/积分同一接口）
```
用户点击下载按钮
  ↓
[前端] 检查 pptRequireLoginForDownload & session
  ├─ 开关=true 且未登录 → 弹 LoginModal，终止
  └─ 通过 → 进入 DownloadModal
      ↓ 选择方式 (首免/积分/广告/注册)
      ↓ handleContinue / handleConfirmMethod
      ↓ 调用 /api/ppts/{id}/download (POST)
         ├─ 后端：读取开关 → 查 PPT → 计费/积分/首免校验(TODO) → recordDownload → 返回 fileUrl
         └─ 返回 { success, data.fileUrl } 或错误
      ↓ 前端：success → 显示链接 & 触发下载 / window.open(fileUrl)
               error → toast 提示
```

## 4) 待接入/调整
- 将 DownloadModal/DownloadOptionsModal 的生成链接逻辑改为调用 `/api/ppts/[id]/download`，去掉 mock 链接/延时。
- 详情页传入 ppt id/title，以及开关值，未登录时拦截。
- 处理缺失 file_url 的错误：接口返回 error，前端禁用下载并提示“资源不可用”。
- 保留积分/订阅/广告入口，但当前全部走同一下载接口（未来在接口中区分扣费/首免）。

## 5) 后续扩展
- 签名/防盗链：下载接口生成短期签名 URL 或后端代理。
- 计费/积分：在接口中扣减积分/校验订阅，写 download_record。
- 限流：按 user/IP 速率限制。
