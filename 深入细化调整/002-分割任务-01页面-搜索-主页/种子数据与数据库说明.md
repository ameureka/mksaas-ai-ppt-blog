# /ppt 种子数据与数据库说明（设计区）

> **文档状态**: ✅ 已根据实际代码修正 (2025-11-28)
>
> 本文档记录 `ppt` 表的实际字段结构、种子数据方案与验证方法，供后续开发参考。

## 1. 表结构要点（ppt）

### 1.1 实际 Schema 定义
**文件**: `src/db/schema.ts` (第 127+ 行)

**完整字段列表**:
- **主键**: `id` (text, PRIMARY KEY)
- **租户**: `tenantId` (text, 可空) - 多租户支持字段
- **核心字段**:
  - `title` (text, NOT NULL) - 标题
  - `author` (text, 可空) - 作者
  - `category` (text, 可空) - 分类 slug
  - `tags` (text[], 可空) - 标签数组 ⚠️
  - `language` (text, 可空) - 语言（zh/en）⚠️
- **文件信息**:
  - `fileUrl` (text, NOT NULL) - 文件下载链接
  - `coverImageUrl` (text, 可空) - 封面图
  - `thumbnailUrl` (text, 可空) - 缩略图
  - `slidesCount` (integer, default 0) - 幻灯片数量
  - ⚠️ **注意**: 数据库中 **没有** `fileSize` 和 `description` 字段
- **统计字段**:
  - `downloadCount` (integer, default 0) - 下载次数
  - `viewCount` (integer, default 0) - 浏览次数
- **状态与权限**:
  - `status` (text, default 'draft') - 状态：draft/published/archived
  - `visibility` (text, 可空) - 可见性控制
  - `reviewStatus` (text, 可空) - 审核状态 ⚠️
- **向量化相关** ⚠️:
  - `embeddingId` (text, 可空) - 向量 ID
  - `embeddingModel` (text, 可空) - 向量模型
- **时间戳**:
  - `createdAt` (timestamp, default NOW())
  - `updatedAt` (timestamp, default NOW())

### 1.2 字段命名映射
| TypeScript (camelCase) | Database (snake_case) | 说明 |
|------------------------|----------------------|------|
| `slidesCount` | `slides_count` | 幻灯片数量 |
| `fileUrl` | `file_url` | 文件链接 |
| `coverImageUrl` | `cover_image_url` | 封面图 |
| `thumbnailUrl` | `thumbnail_url` | 缩略图 |
| `downloadCount` | `download_count` | 下载次数 |
| `viewCount` | `view_count` | 浏览次数 |
| `tenantId` | `tenant_id` | 租户 ID |
| `embeddingId` | `embedding_id` | 向量 ID |
| `embeddingModel` | `embedding_model` | 向量模型 |
| `reviewStatus` | `review_status` | 审核状态 |
| `createdAt` | `created_at` | 创建时间 |
| `updatedAt` | `updated_at` | 更新时间 |

### 1.3 索引列表
实际数据库中的索引（基于 Schema 定义）：
- `ppt_pkey` - PRIMARY KEY (id)
- `ppt_category_idx` - INDEX (category)
- `ppt_download_count_idx` - INDEX (download_count)
- `ppt_view_count_idx` - INDEX (view_count)
- `ppt_created_at_idx` - INDEX (created_at)

## 2. 现有数据状态

### 2.1 实际数据量
**验证方法**: 连接 Neon 数据库执行查询
```sql
SELECT COUNT(*) FROM ppt;
```
**结果**: ✅ 68 条 PPT 记录

### 2.2 数据来源
- **数据库**: Neon PostgreSQL (ap-southeast-1)
- **连接**: 通过 `DATABASE_URL` 环境变量
- **状态**: 数据库已有可用数据，无需额外导入种子数据

## 3. 字段与枚举说明

### 3.1 分类 Slug (category)
**实际使用的分类** (基于类型定义 `src/lib/types/ppt/ppt.ts`):
```typescript
type PPTCategory =
  | 'business'      // 商务汇报
  | 'product'       // 产品相关
  | 'education'     // 教育培训
  | 'technology'    // 技术报告
  | 'creative'      // 创意设计
  | 'marketing'     // 产品营销
  | 'medical'       // 医疗健康
  | 'finance'       // 金融财务
  | 'hr'            // 人力资源
  | 'lifestyle'     // 生活方式
  | 'general';      // 通用/其他
```

⚠️ **注意**: 首页 `page.tsx` 中使用的分类存在 **slug 重复**问题：
- `education` 用于"教育培训"和"培训课件"
- `business` 用于"商务汇报"和"述职报告"
- `marketing` 用于"产品营销"和"营销方案"

**建议**: 后续统一分类 slug，避免重复。

### 3.2 语言 (language)
**字段**: ✅ 数据库中存在 `language` 字段
**枚举值**: `zh` (中文) | `en` (英文)
**默认值**: 建议使用 `zh`

⚠️ **问题**:
- DTO 转换层（`toPPTDto`）**未返回** `language` 字段
- API Route **未传递** `language` 参数给 Server Action
- Server Action 的 `buildWhere` **未处理** `language` 过滤

### 3.3 状态 (status)
**枚举值**: `draft` | `published` | `archived`
**默认值**: `draft`

### 3.4 标签 (tags)
**字段类型**: ✅ `text[]` 数组类型
**用途**: 支持多标签搜索和筛选

⚠️ **问题**: DTO 转换层**未返回** `tags` 字段

## 4. 种子数据方案（仅供参考）

### 4.1 导出现有数据
```sql
COPY (
  SELECT
    id, tenant_id, title, author, category, tags, language,
    slides_count, file_url, cover_image_url, thumbnail_url,
    download_count, view_count, status, visibility, review_status,
    embedding_id, embedding_model, created_at, updated_at
  FROM ppt
) TO STDOUT WITH CSV HEADER;
```

### 4.2 导入数据
```bash
psql $DATABASE_URL -c "\\copy ppt FROM 'ppt_seed.csv' CSV HEADER"
```

### 4.3 插入示例（单条）
```sql
INSERT INTO ppt (
  id, title, category, author, tags, language,
  slides_count, file_url, thumbnail_url, cover_image_url,
  download_count, view_count, status,
  created_at, updated_at
) VALUES (
  'ppt_' || gen_random_uuid(),
  '年度商务汇报模板',
  'business',
  'Admin',
  ARRAY['商务', '汇报', '年度总结'],
  'zh',
  24,
  'https://cdn.example.com/ppt/business/report-2024.pptx',
  'https://cdn.example.com/ppt/business/report-2024-thumb.webp',
  'https://cdn.example.com/ppt/business/report-2024-cover.webp',
  0,
  0,
  'published',
  NOW(),
  NOW()
);
```

⚠️ **注意**: 数据库中**没有** `file_size` 和 `description` 字段，插入时不要包含这些字段。

## 5. 验证清单

### 5.1 数据完整性验证
```sql
-- 1. 检查数据量
SELECT COUNT(*) FROM ppt;
-- ✅ 预期结果: 68

-- 2. 检查必填字段
SELECT COUNT(*) FROM ppt WHERE title IS NULL OR file_url IS NULL;
-- ✅ 预期结果: 0

-- 3. 检查分类分布
SELECT category, COUNT(*) as count
FROM ppt
GROUP BY category
ORDER BY count DESC;

-- 4. 检查语言分布
SELECT language, COUNT(*) as count
FROM ppt
GROUP BY language;

-- 5. 检查标签使用
SELECT COUNT(*) FROM ppt WHERE tags IS NOT NULL AND array_length(tags, 1) > 0;
```

### 5.2 索引验证
```sql
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'ppt'
ORDER BY indexname;
```
**预期索引**:
- `ppt_pkey` (PRIMARY KEY)
- `ppt_category_idx`
- `ppt_created_at_idx`
- `ppt_download_count_idx`
- `ppt_view_count_idx`

### 5.3 触发器验证
```sql
-- 检查 updated_at 自动更新
UPDATE ppt SET title = title WHERE id = (SELECT id FROM ppt LIMIT 1);
SELECT id, updated_at FROM ppt LIMIT 1;
-- updated_at 应该自动更新为当前时间
```

## 6. 已知问题与修复建议

### 6.1 字段缺失问题
❌ **缺失字段**:
- `file_size` - 文件大小（设计文档中提到，但数据库中不存在）
- `description` - 描述（设计文档中提到，但数据库中不存在）

**影响**:
- DTO 转换时返回空字符串或 undefined
- 前端显示时需要兜底处理（显示"暂无"或隐藏）

**建议**:
- 如需这些字段，通过迁移添加：
```sql
ALTER TABLE ppt ADD COLUMN file_size TEXT;
ALTER TABLE ppt ADD COLUMN description TEXT;
```

### 6.2 DTO 返回字段不完整
❌ **问题**: `toPPTDto` 函数未返回以下字段：
- `tags` (数据库有，但未返回)
- `language` (数据库有，但未返回)

**影响**:
- 前端无法使用这些字段进行过滤和显示
- 首页的语言过滤功能失效

**修复方案**: 参见 `09-首页现状分析报告.md` 第九章

### 6.3 API 参数传递不完整
❌ **问题**: API Route 未传递以下参数：
- `language`
- `dateFrom`
- `dateTo`

**影响**:
- 即使 Server Action 支持这些参数，前端也无法使用

**修复方案**: 参见 `09-首页现状分析报告.md` 第九章

## 7. 使用方法

### 7.1 连接数据库
```typescript
// 使用 Drizzle ORM
import { getDb } from '@/db';
import { ppt as pptTable } from '@/db/schema';

const db = await getDb();
const results = await db.select().from(pptTable).limit(10);
```

### 7.2 查询示例
```typescript
// 按分类查询
const businessPPTs = await db
  .select()
  .from(pptTable)
  .where(eq(pptTable.category, 'business'))
  .limit(10);

// 搜索标题
const searchResults = await db
  .select()
  .from(pptTable)
  .where(ilike(pptTable.title, '%年终总结%'))
  .limit(10);
```

## 8. 后续扩展（非本次）

### 8.1 待添加字段
- `description` (text) - PPT 描述
- `file_size` (text) - 文件大小

### 8.2 向量化支持
- 已预留 `embeddingId` 和 `embeddingModel` 字段
- 向量检索功能可后续接入

### 8.3 审核流程
- 已预留 `reviewStatus` 字段
- 可实现内容审核工作流

### 8.4 多租户支持
- 已预留 `tenantId` 字段
- 可实现多租户数据隔离

### 8.5 统计增强
- 热门搜索统计
- 下载日志记录
- 用户行为分析

---

**文档修订历史**:
- 2025-11-28: ✅ 根据实际代码分析修正，补充完整字段列表和已知问题
