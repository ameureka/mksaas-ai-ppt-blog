# 下载链路设计（/ppt）

> 聚焦下载流程，作为单独小节，便于落地与验证。

## 目标
- 在 `/ppt/[id]` 提供“下载”操作：检查开关/权限，记录下载，返回文件直链或跳转。
- 兼容当前数据（file_url 直链），后续可扩展签名/计费。

## 方案（首版）
- 接口形式：server action（优先）或 `/api/ppts/[id]/download` route，内部复用 `recordDownload`.
- 流程：
  1) 输入 `pptId`（必要）。
  2) 读取 `websiteConfig.features.pptRequireLoginForDownload`：
     - 如果开启且未登录 -> 返回错误（需登录）。
  3) 查询 PPT（用 `getPPTById` 或内联查询）。
     - 不存在 -> 404。
  4) 调用 `recordDownload(pptId)`。
  5) 返回 `file_url`（可直接 JSON，或 302 重定向）。
- 前端：
  - 详情页按钮调用下载 action，显示加载/错误提示。
  - 开关为 false 时无需登录；为 true 时提示登录。

## 可选增强（后续）
- 防盗链/签名 URL：返回短期签名直链，或由后端代理下载。
- 计费/积分：在下载前调用扣积分/检查订阅。
- 频控：对 IP/user 加限流，防刷下载。
- 审计：记录 `download_record` 表（user_id/ip/hash/user_agent）。

## 返回格式（建议）
```json
// 成功
{ "success": true, "data": { "fileUrl": "https://..." } }
// 失败
{ "success": false, "error": "Need login" }
```

## UI 容错
- 缺少 `file_url`：提示“资源不可用”。
- 下载失败：toast 显示错误，保持页面状态。

## 落地步骤
1) 新增下载 action/route，读取开关、鉴权、记录下载、返回直链。
2) 详情页按钮接入该 action；未登录且开关开时提示登录。
3) QA：开关双态（true/false）；未登录/已登录；无效 id；无 file_url。
