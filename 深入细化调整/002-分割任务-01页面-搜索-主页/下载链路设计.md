# 下载链路设计 (V2.0)

> **文档状态**: 2025-11-28 已基于最新交互逻辑更新
> **核心变更**: 列表页点击仅跳转详情页，下载动作完全收敛至详情页。

## 1. 交互流程 (User Flow)

### 1.1 列表页 (Search/Category Page)
- **动作**: 用户点击 PPT 卡片或“立即下载”按钮。
- **行为**: **纯路由跳转** (`Link` or `router.push`) 至 `/ppt/[id]`。
- **目的**: 增加浏览深度，提升广告曝光。
- **注意**: 列表页不执行任何权限检查或下载 API 调用。

### 1.2 详情页 (Detail Page)
- **入口**: 下载动作的唯一执行点。
- **UI**: 显著的“免费下载”或“积分下载”按钮。
- **行为**:
  1. 用户点击下载按钮。
  2. 前端调用 `useAction(downloadPPT, { id })`。
  3. 显示 Loading 状态。
  4. 处理返回结果 (成功跳转/失败报错)。

---

## 2. 后端逻辑 (Server Action)

**Action**: `downloadPPT(id: string)`

### 2.1 执行步骤
1.  **鉴权 (Auth Check)**:
    - 读取配置 `websiteConfig.features.pptRequireLoginForDownload`。
    - 若开启且用户未登录 -> 返回 `401 Unauthorized`。
2.  **数据查询**: 获取 PPT 记录，确认 `file_url` 存在。
3.  **计数 (Stats)**: 调用 `recordDownload(id)` 原子 +1。
4.  **返回**: 返回 `{ success: true, file_url: "..." }`。

---

## 3. 异常处理
- **未登录**: 弹出登录 Modal 或跳转登录页。
- **资源失效**: 若 `file_url` 为空，返回错误信息“资源暂时不可用”，前端 Toast 提示。
- **积分不足 (V2)**: 提示去充值或完成任务。

---

## 4. 落地任务
1.  **列表页改造**: 将 `PPTCard` 组件中的点击事件统一改为跳转链接。
2.  **详情页开发**: 实现下载按钮组件，绑定 `downloadPPT` Action。
3.  **Action 实现**: 编写后端逻辑，包含开关检查和计数。