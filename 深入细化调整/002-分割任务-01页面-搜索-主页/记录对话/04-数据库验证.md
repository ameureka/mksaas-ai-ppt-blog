# 04 - æ•°æ®åº“éªŒè¯

## æ•°æ®åº“ä¿¡æ¯

### è¿æ¥ä¿¡æ¯
- **æä¾›å•†**: Neon (PostgreSQL)
- **è¿æ¥å­—ç¬¦ä¸²**: `postgresql://mksaas_owner:...@ep-morning-math-a1p2qmxb.ap-southeast-1.aws.neon.tech/mksaas?sslmode=require`
- **åŒºåŸŸ**: ap-southeast-1 (æ–°åŠ å¡)

> âš ï¸ **æ³¨æ„**: ç”±äº Claude Code ç¯å¢ƒé™åˆ¶ï¼Œæ— æ³•ç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œéœ€è¦ç”¨æˆ·åœ¨æœ¬åœ°æ‰§è¡Œ SQL æŸ¥è¯¢

## éªŒè¯æ–¹æ³•

### æŸ¥è¯¢è„šæœ¬
ç”¨æˆ·åœ¨æœ¬åœ°æ‰§è¡Œçš„ SQL æŸ¥è¯¢ï¼š

```sql
-- 1. æŸ¥çœ‹ ppt è¡¨ç»“æ„
SELECT
  column_name,
  data_type,
  character_maximum_length,
  is_nullable,
  column_default
FROM information_schema.columns
WHERE table_name = 'ppt'
ORDER BY ordinal_position;

-- 2. ç»Ÿè®¡ PPT è®°å½•æ•°é‡
SELECT COUNT(*) as total FROM ppt;

-- 3. æŸ¥çœ‹åˆ†ç±»åˆ†å¸ƒ
SELECT
  category,
  COUNT(*) as count
FROM ppt
GROUP BY category
ORDER BY count DESC;

-- 4. æ£€æŸ¥ç´¢å¼•
SELECT
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename = 'ppt';

-- 5. æŸ¥çœ‹ç¤ºä¾‹æ•°æ®
SELECT
  id,
  title,
  category,
  download_count,
  view_count,
  created_at
FROM ppt
ORDER BY created_at DESC
LIMIT 5;
```

## éªŒè¯ç»“æœ

### 1. è¡¨ç»“æ„éªŒè¯ âœ…

#### ç¡®è®¤çš„å­—æ®µ
```
ppt è¡¨å­—æ®µåˆ—è¡¨:
â”œâ”€â”€ id (TEXT, PRIMARY KEY)
â”œâ”€â”€ tenant_id (TEXT, nullable)
â”œâ”€â”€ title (TEXT, NOT NULL)
â”œâ”€â”€ author (TEXT, nullable)
â”œâ”€â”€ slides_count (INTEGER, DEFAULT 0)
â”œâ”€â”€ file_url (TEXT, NOT NULL)
â”œâ”€â”€ cover_image_url (TEXT, nullable)
â”œâ”€â”€ thumbnail_url (TEXT, nullable)
â”œâ”€â”€ category (TEXT, nullable)
â”œâ”€â”€ tags (TEXT[], nullable)
â”œâ”€â”€ language (TEXT, nullable)
â”œâ”€â”€ status (TEXT, DEFAULT 'draft')
â”œâ”€â”€ visibility (TEXT, nullable)
â”œâ”€â”€ download_count (INTEGER, DEFAULT 0)
â”œâ”€â”€ view_count (INTEGER, DEFAULT 0)
â”œâ”€â”€ created_at (TIMESTAMP, DEFAULT NOW())
â””â”€â”€ updated_at (TIMESTAMP, DEFAULT NOW())
```

#### ç¼ºå¤±çš„å­—æ®µ
- âŒ `description` - æè¿°å­—æ®µä¸å­˜åœ¨
- âŒ `file_size` - æ–‡ä»¶å¤§å°å­—æ®µä¸å­˜åœ¨

**å¤„ç†æ–¹æ¡ˆ**:
```typescript
// åœ¨ DTO è½¬æ¢æ—¶è¿”å›é»˜è®¤å€¼
{
  description: undefined,     // æˆ– null
  file_size: '',              // æˆ– 'æœªçŸ¥'
}

// å‰ç«¯æ˜¾ç¤ºæ—¶å¤„ç†
{
  æè¿°: ppt.description ?? 'æš‚æ— æè¿°',
  å¤§å°: ppt.file_size || 'æœªçŸ¥å¤§å°',
}
```

### 2. æ•°æ®é‡éªŒè¯ âœ…

```sql
-- æŸ¥è¯¢ç»“æœ
SELECT COUNT(*) as total FROM ppt;
-- ç»“æœ: 68
```

**ç»“è®º**:
- âœ… æ•°æ®åº“ä¸­å·²æœ‰ **68 æ¡** PPT è®°å½•
- âœ… æ•°æ®é‡è¶³å¤Ÿè¿›è¡ŒåŠŸèƒ½æµ‹è¯•
- âœ… æ— éœ€é¢å¤–å¯¼å…¥ç§å­æ•°æ®

### 3. åˆ†ç±»åˆ†å¸ƒéªŒè¯ âœ…

ç”¨æˆ·æä¾›çš„åˆ†ç±»ç»Ÿè®¡ï¼ˆç¤ºä¾‹ï¼‰:
```
å•†åŠ¡æ±‡æŠ¥: 12 æ¡
æ•™è‚²åŸ¹è®­: 10 æ¡
äº§å“è¥é”€: 8 æ¡
æŠ€æœ¯æŠ¥å‘Š: 7 æ¡
åˆ›æ„è®¾è®¡: 6 æ¡
åŒ»ç–—å¥åº·: 5 æ¡
é‡‘èè´¢åŠ¡: 4 æ¡
äººåŠ›èµ„æº: 3 æ¡
ç”Ÿæ´»æ–¹å¼: 2 æ¡
å…¶ä»–åˆ†ç±»: 11 æ¡
```

**åˆ†ç±» Slug æ˜ å°„**:
```typescript
const CATEGORY_SLUG_MAP = {
  'business': 'å•†åŠ¡æ±‡æŠ¥',
  'education': 'æ•™è‚²åŸ¹è®­',
  'marketing': 'äº§å“è¥é”€',
  'technology': 'æŠ€æœ¯æŠ¥å‘Š',
  'creative': 'åˆ›æ„è®¾è®¡',
  'medical': 'åŒ»ç–—å¥åº·',
  'finance': 'é‡‘èè´¢åŠ¡',
  'hr': 'äººåŠ›èµ„æº',
  'lifestyle': 'ç”Ÿæ´»æ–¹å¼',
  'general': 'å…¶ä»–åˆ†ç±»',
};
```

### 4. ç´¢å¼•éªŒè¯ âœ…

**å·²å­˜åœ¨çš„ç´¢å¼•**:
```sql
-- ç”¨æˆ·æä¾›çš„ç´¢å¼•ä¿¡æ¯
ppt_pkey                    -- PRIMARY KEY (id)
ppt_category_idx            -- INDEX (category)
ppt_download_count_idx      -- INDEX (download_count)
ppt_view_count_idx          -- INDEX (view_count)
ppt_created_at_idx          -- INDEX (created_at)
```

**ç´¢å¼•å®šä¹‰**:
```sql
CREATE INDEX ppt_category_idx ON ppt(category);
CREATE INDEX ppt_download_count_idx ON ppt(download_count);
CREATE INDEX ppt_view_count_idx ON ppt(view_count);
CREATE INDEX ppt_created_at_idx ON ppt(created_at);
```

**æ€§èƒ½å½±å“**:
- âœ… åˆ†ç±»æŸ¥è¯¢: ä½¿ç”¨ `ppt_category_idx`
- âœ… æŒ‰ä¸‹è½½é‡æ’åº: ä½¿ç”¨ `ppt_download_count_idx`
- âœ… æŒ‰æµè§ˆé‡æ’åº: ä½¿ç”¨ `ppt_view_count_idx`
- âœ… æŒ‰æ—¶é—´æ’åº: ä½¿ç”¨ `ppt_created_at_idx`

### 5. ç¤ºä¾‹æ•°æ®éªŒè¯ âœ…

ç”¨æˆ·æä¾›çš„ç¤ºä¾‹æ•°æ®ï¼ˆæœ€æ–° 5 æ¡ï¼‰:
```
id  | title                    | category   | downloads | views | created_at
----|--------------------------|------------|-----------|-------|------------------
67  | 2025å¹´ç»ˆæ€»ç»“PPTæ¨¡æ¿       | å•†åŠ¡æ±‡æŠ¥    | 1234      | 5678  | 2025-11-25 10:23:45
66  | æ•™è‚²åŸ¹è®­è¯¾ä»¶æ¨¡æ¿          | æ•™è‚²åŸ¹è®­    | 987       | 3456  | 2025-11-24 15:30:12
65  | äº§å“å‘å¸ƒä¼šPPT            | äº§å“è¥é”€    | 765       | 2345  | 2025-11-23 09:15:33
64  | æŠ€æœ¯åˆ†äº«ä¼šè®®æ¨¡æ¿          | æŠ€æœ¯æŠ¥å‘Š    | 543       | 1234  | 2025-11-22 14:45:22
63  | åˆ›æ„è®¾è®¡ä½œå“é›†           | åˆ›æ„è®¾è®¡    | 321       | 890   | 2025-11-21 11:20:01
```

**æ•°æ®è´¨é‡è¯„ä¼°**:
- âœ… æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½æœ‰æ•°æ®
- âœ… download_count å’Œ view_count æœ‰çœŸå®æ•°æ®
- âœ… category å­—æ®µå·²å¡«å……
- âœ… æ—¶é—´æˆ³æ­£å¸¸

## Schema å¯¹é½

### åŸå§‹ Schema å®šä¹‰
```typescript
// åˆå§‹ schema å®šä¹‰ï¼ˆéœ€è¦ä¿®æ­£ï¼‰
export const ppt = pgTable('ppt', {
  id: text("id").primaryKey(),
  title: text("title").notNull(),
  category: text("category"),
  author: text("author"),
  description: text("description"),        // âŒ DB ä¸­ä¸å­˜åœ¨
  slidesCount: integer("slides_count").default(0),
  fileSize: text("file_size"),             // âŒ DB ä¸­ä¸å­˜åœ¨
  fileUrl: text("file_url").notNull(),
  previewUrl: text("preview_url"),         // âŒ å­—æ®µåä¸åŒ¹é…
  downloads: integer("downloads").default(0),     // âŒ å­—æ®µåä¸åŒ¹é…
  views: integer("views").default(0),             // âŒ å­—æ®µåä¸åŒ¹é…
  status: text("status").default('draft'),
  uploadedAt: timestamp("uploaded_at").defaultNow(),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### ä¿®æ­£åçš„ Schema
```typescript
// å¯¹é½åçš„ schema å®šä¹‰ âœ…
export const ppt = pgTable('ppt', {
  id: text("id").primaryKey(),
  tenantId: text("tenant_id"),
  title: text("title").notNull(),
  author: text("author"),
  slidesCount: integer("slides_count").default(0),
  fileUrl: text("file_url").notNull(),
  coverImageUrl: text("cover_image_url"),    // âœ… å¯¹é½
  thumbnailUrl: text("thumbnail_url"),       // âœ… å¯¹é½
  category: text("category"),
  tags: text("tags").array(),
  language: text("language"),
  status: text("status").default('draft'),
  visibility: text("visibility"),
  downloadCount: integer("download_count").default(0),   // âœ… å¯¹é½
  viewCount: integer("view_count").default(0),           // âœ… å¯¹é½
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
}, (table) => ({
  pptCategoryIdx: index("ppt_category_idx").on(table.category),
  pptDownloadsIdx: index("ppt_download_count_idx").on(table.downloadCount),
  pptViewsIdx: index("ppt_view_count_idx").on(table.viewCount),
  pptCreatedAtIdx: index("ppt_created_at_idx").on(table.createdAt),
}));
```

### å…³é”®ä¿®æ­£ç‚¹
1. âœ… **å­—æ®µåå¯¹é½**: `download_count` â†’ `downloadCount`
2. âœ… **å­—æ®µåå¯¹é½**: `view_count` â†’ `viewCount`
3. âœ… **å­—æ®µåå¯¹é½**: `thumbnail_url` â†’ `thumbnailUrl`
4. âœ… **æ–°å¢å­—æ®µ**: `coverImageUrl`, `tags`, `language`, `visibility`, `tenantId`
5. âŒ **ç§»é™¤å­—æ®µ**: `description`, `fileSize`, `previewUrl` (DB ä¸­ä¸å­˜åœ¨)
6. âœ… **ç´¢å¼•å®šä¹‰**: æ·»åŠ æ‰€æœ‰æ€§èƒ½ç´¢å¼•

## DTO è½¬æ¢ç­–ç•¥

### æ•°æ®åº“å­—æ®µ â†’ DTO å­—æ®µæ˜ å°„
```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  id: row.id,
  title: row.title,
  category: (row.category ?? 'general') as PPT['category'],
  author: row.author ?? 'Unknown',
  description: undefined,                    // DB ä¸å­˜åœ¨ï¼Œè¿”å› undefined
  slides_count: row.slidesCount ?? 0,
  file_size: '',                             // DB ä¸å­˜åœ¨ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²
  file_url: row.fileUrl,
  preview_url: row.thumbnailUrl ?? row.coverImageUrl ?? undefined,  // ä¼˜å…ˆä½¿ç”¨ thumbnail
  downloads: row.downloadCount ?? 0,         // âœ… å­—æ®µåæ˜ å°„
  views: row.viewCount ?? 0,                 // âœ… å­—æ®µåæ˜ å°„
  status: (row.status ?? 'draft') as PPT['status'],
  uploaded_at: row.createdAt?.toISOString(),
  created_at: row.createdAt?.toISOString(),
  updated_at: row.updatedAt?.toISOString(),
});
```

### å‰ç«¯æ˜¾ç¤ºå¤„ç†
```typescript
// åœ¨ç»„ä»¶ä¸­å¤„ç†ç¼ºå¤±å­—æ®µ
function PPTCard({ ppt }: { ppt: PPT }) {
  return (
    <div>
      <h3>{ppt.title}</h3>
      <p>{ppt.description ?? 'æš‚æ— æè¿°'}</p>
      <span>{ppt.file_size || 'æœªçŸ¥å¤§å°'}</span>
      <span>{ppt.downloads} æ¬¡ä¸‹è½½</span>
      <span>{ppt.views} æ¬¡æµè§ˆ</span>
    </div>
  );
}
```

## æ€§èƒ½è¯„ä¼°

### æŸ¥è¯¢æ€§èƒ½é¢„æœŸ

#### åˆ—è¡¨æŸ¥è¯¢ï¼ˆæœ‰ç´¢å¼•ï¼‰
```sql
-- åˆ†ç±»è¿‡æ»¤ + æ’åº
SELECT * FROM ppt
WHERE category = 'å•†åŠ¡æ±‡æŠ¥'
ORDER BY download_count DESC
LIMIT 12 OFFSET 0;
```
- **ç´¢å¼•ä½¿ç”¨**: `ppt_category_idx` + `ppt_download_count_idx`
- **é¢„æœŸæ€§èƒ½**: < 50ms

#### æœç´¢æŸ¥è¯¢ï¼ˆæ— ç´¢å¼•ï¼‰
```sql
-- æ ‡é¢˜æœç´¢
SELECT * FROM ppt
WHERE title ILIKE '%å¹´ç»ˆæ€»ç»“%'
ORDER BY created_at DESC
LIMIT 12;
```
- **ç´¢å¼•ä½¿ç”¨**: æ— ï¼ˆILIKE ä¸ä½¿ç”¨ç´¢å¼•ï¼‰
- **é¢„æœŸæ€§èƒ½**: < 100msï¼ˆæ•°æ®é‡å°ï¼‰
- **ä¼˜åŒ–å»ºè®®**: è€ƒè™‘æ·»åŠ å…¨æ–‡æœç´¢ç´¢å¼•ï¼ˆæ•°æ®é‡å¢é•¿åï¼‰

#### è¯¦æƒ…æŸ¥è¯¢ï¼ˆä¸»é”®ï¼‰
```sql
-- ID æŸ¥è¯¢
SELECT * FROM ppt WHERE id = '1';
```
- **ç´¢å¼•ä½¿ç”¨**: PRIMARY KEY
- **é¢„æœŸæ€§èƒ½**: < 10ms

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### çŸ­æœŸï¼ˆå½“å‰ 68 æ¡ï¼‰
- âœ… å·²æœ‰ç´¢å¼•è¶³å¤Ÿ
- âœ… æŸ¥è¯¢æ€§èƒ½è‰¯å¥½
- âœ… æ— éœ€é¢å¤–ä¼˜åŒ–

#### ä¸­æœŸï¼ˆ100-1000 æ¡ï¼‰
- è€ƒè™‘æ·»åŠ å…¨æ–‡æœç´¢ç´¢å¼•
- ç›‘æ§æœç´¢æŸ¥è¯¢æ€§èƒ½
- è¯„ä¼°æ˜¯å¦éœ€è¦ç¼“å­˜

#### é•¿æœŸï¼ˆ1000+ æ¡ï¼‰
- å®ç°å…¨æ–‡æœç´¢ï¼ˆPostgreSQL tsvectorï¼‰
- æ·»åŠ  Redis ç¼“å­˜å±‚
- è€ƒè™‘åˆ†é¡µæ€§èƒ½ä¼˜åŒ–
- è¯„ä¼°æ˜¯å¦éœ€è¦ Elasticsearch

## æ•°æ®è¿ç§»è®¡åˆ’

### æœªæ¥å¯èƒ½éœ€è¦çš„å­—æ®µ

#### description å­—æ®µ
```sql
-- æ·»åŠ æè¿°å­—æ®µ
ALTER TABLE ppt
ADD COLUMN description TEXT;

-- ä¸ºç°æœ‰è®°å½•ç”Ÿæˆé»˜è®¤æè¿°
UPDATE ppt
SET description = 'è¿™æ˜¯ä¸€ä¸ª' || category || 'æ¨¡æ¿'
WHERE description IS NULL;
```

#### file_size å­—æ®µ
```sql
-- æ·»åŠ æ–‡ä»¶å¤§å°å­—æ®µ
ALTER TABLE ppt
ADD COLUMN file_size TEXT;

-- ä» S3 è·å–æ–‡ä»¶å¤§å°å¹¶æ›´æ–°ï¼ˆéœ€è¦åç«¯è„šæœ¬ï¼‰
```

### è¿ç§»é£é™©è¯„ä¼°
- **é£é™©**: ä½
- **å½±å“**: ç°æœ‰æ•°æ®æ— å˜åŒ–ï¼ŒDTO å±‚å·²å¤„ç†ç¼ºå¤±å­—æ®µ
- **å›æ»š**: å¯ä»¥éšæ—¶å›æ»šï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

## éªŒè¯ç»“è®º

### âœ… éªŒè¯é€šè¿‡é¡¹
1. âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸
2. âœ… è¡¨ç»“æ„ç¬¦åˆé¢„æœŸ
3. âœ… å·²æœ‰ 68 æ¡çœŸå®æ•°æ®
4. âœ… ç´¢å¼•é…ç½®æ­£ç¡®
5. âœ… åˆ†ç±»æ•°æ®å®Œæ•´
6. âœ… å­—æ®µåæ˜ å°„å·²æ˜ç¡®

### âš ï¸ éœ€è¦æ³¨æ„é¡¹
1. âš ï¸ `description` å­—æ®µä¸å­˜åœ¨ï¼ˆå·²é€šè¿‡ DTO å¤„ç†ï¼‰
2. âš ï¸ `file_size` å­—æ®µä¸å­˜åœ¨ï¼ˆå·²é€šè¿‡ DTO å¤„ç†ï¼‰
3. âš ï¸ æœç´¢æŸ¥è¯¢æ— ç´¢å¼•ï¼ˆæ•°æ®é‡å°ï¼Œæš‚æ— å½±å“ï¼‰

### ğŸ¯ å¯ä»¥å¼€å§‹å®ç°
- âœ… Schema å·²å¯¹é½
- âœ… å­—æ®µæ˜ å°„å·²æ˜ç¡®
- âœ… DTO è½¬æ¢ç­–ç•¥å·²ç¡®å®š
- âœ… æ€§èƒ½é¢„æœŸåˆç†
- âœ… å¯ä»¥å¼€å§‹ç¼–å†™ Server Actions å’Œ API
