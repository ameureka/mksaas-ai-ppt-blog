# 首页现状分析报告

## 分析时间
2025-11-28

## 分析方法
通过代码分析，对比设计文档、数据库 Schema、Server Actions、API Routes 和前端实现

---

## 一、首页实际实现状态

### 1.1 页面基本信息
**文件**: `src/app/[locale]/(marketing)/ppt/page.tsx`
**类型**: Client Component (`'use client'`)
**总行数**: 659 行

### 1.2 使用的 API 端点
首页实际调用了以下 API：

#### 初始数据加载（第 171-188 行）
```typescript
const res = await fetch(
  `/api/ppts?page=1&pageSize=12&sortBy=created_at&sortOrder=desc`
);
```
- **用途**: 加载"编辑精选"和"本周新品"
- **参数**:
  - `page=1`
  - `pageSize=12`
  - `sortBy=created_at`
  - `sortOrder=desc`

#### 搜索功能（第 222-224 行）
```typescript
const res = await fetch(
  `/api/ppts?search=${encodeURIComponent(searchQuery)}`
);
```
- **用途**: 用户搜索
- **参数**:
  - `search=<关键词>`

### 1.3 数据转换层（第 157-168 行）
```typescript
const transform = (items: any[]): PPT[] =>
  items.map((item) => ({
    id: item.id,
    title: item.title,
    tags: item.tags ?? [],
    downloads: item.downloads ?? 0,
    views: item.views ?? 0,
    language: item.language ?? '中文',
    previewUrl: item.preview_url ?? '/placeholder.svg',
    pages: item.slides_count ?? 0,
    category: item.category ?? '其他',
  }));
```

**问题**:
- ⚠️ 前端定义了自己的 `PPT` 接口（第 29-40 行），与类型文件 `src/lib/types/ppt/ppt.ts` 不一致
- ⚠️ 字段映射不完整（缺少 `author`, `status` 等）

---

## 二、数据库 Schema 实际状态

### 2.1 PPT 表结构
**文件**: `src/db/schema.ts` (第 127+ 行)

```typescript
export const ppt = pgTable("ppt", {
  id: text("id").primaryKey(),
  tenantId: text("tenant_id"),
  title: text("title").notNull(),
  author: text("author"),
  slidesCount: integer("slides_count").default(0),
  fileUrl: text("file_url").notNull(),
  coverImageUrl: text("cover_image_url"),
  thumbnailUrl: text("thumbnail_url"),
  category: text("category"),
  tags: text("tags").array(),               // ✅ 数组类型
  language: text("language"),
  status: text("status").default('draft'),
  visibility: text("visibility"),
  downloadCount: integer("download_count").default(0),
  viewCount: integer("view_count").default(0),
  embeddingId: text("embedding_id"),        // ⚠️ 设计文档中未提及
  embeddingModel: text("embedding_model"),  // ⚠️ 设计文档中未提及
  reviewStatus: text("review_status"),      // ⚠️ 设计文档中未提及
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
});
```

### 2.2 与设计文档的差异

| 字段 | 设计文档 | 实际 Schema | 差异说明 |
|------|---------|------------|---------|
| `description` | ❌ 说缺失 | ❌ 确实缺失 | ✅ 一致 |
| `file_size` | ❌ 说缺失 | ❌ 确实缺失 | ✅ 一致 |
| `tags` | ⚠️ 未明确说明 | ✅ 存在（数组） | ⚠️ 文档未提及 |
| `language` | ⚠️ 未明确说明 | ✅ 存在 | ⚠️ 文档未提及 |
| `tenantId` | ❌ 未提及 | ✅ 存在 | ⚠️ 文档遗漏 |
| `visibility` | ❌ 未提及 | ✅ 存在 | ⚠️ 文档遗漏 |
| `embeddingId` | ❌ 未提及 | ✅ 存在 | ⚠️ 文档遗漏 |
| `embeddingModel` | ❌ 未提及 | ✅ 存在 | ⚠️ 文档遗漏 |
| `reviewStatus` | ❌ 未提及 | ✅ 存在 | ⚠️ 文档遗漏 |

---

## 三、Server Actions 实际实现

### 3.1 getPPTs 函数
**文件**: `src/actions/ppt/ppt.ts` (第 115-153 行)

#### 支持的参数
```typescript
interface PPTListParams extends ListParams {
  search?: string;       // ✅ 搜索关键词
  category?: string;     // ✅ 分类
  status?: string;       // ✅ 状态
  dateFrom?: string;     // ✅ 起始日期
  dateTo?: string;       // ✅ 结束日期
  sortBy?: string;       // ✅ 排序字段
  sortOrder?: string;    // ✅ 排序方向
  page?: number;         // ✅ 页码
  pageSize?: number;     // ✅ 每页数量
}
```

#### 搜索实现（第 48-56 行）
```typescript
if (params.search?.trim()) {
  const keyword = `%${params.search.trim()}%`;
  conditions.push(
    or(
      ilike(pptTable.title, keyword),
      ilike(pptTable.author, keyword)  // ✅ 支持作者搜索
    )
  );
}
```

**与设计文档差异**:
- ✅ 支持标题和作者搜索（设计文档只提到标题）
- ❌ **不支持** `language` 参数过滤（设计文档提到）

### 3.2 DTO 转换（第 97-113 行）
```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  id: row.id,
  title: row.title,
  category: (row.category ?? 'general') as PPT['category'],
  author: row.author ?? 'Unknown',
  description: undefined,                    // ❌ 不存在
  slides_count: row.slidesCount ?? 0,
  file_size: '',                             // ❌ 不存在
  file_url: row.fileUrl,
  preview_url: row.thumbnailUrl ?? row.coverImageUrl ?? undefined,
  downloads: row.downloadCount ?? 0,
  views: row.viewCount ?? 0,
  status: (row.status ?? 'draft') as PPT['status'],
  uploaded_at: row.createdAt?.toISOString() ?? '',
  created_at: row.createdAt?.toISOString() ?? '',
  updated_at: row.updatedAt?.toISOString() ?? '',
});
```

**缺失字段处理**:
- ✅ `tags`: **未返回**（虽然数据库有）
- ✅ `language`: **未返回**（虽然数据库有）

---

## 四、API Routes 实际实现

### 4.1 GET /api/ppts
**文件**: `src/app/api/ppts/route.ts` (第 4-23 行)

#### 支持的查询参数
```typescript
{
  search: string | undefined,
  category: string | undefined,
  status: string | undefined,
  sortBy: string | undefined,
  sortOrder: 'asc' | 'desc' | undefined,
  page: number | undefined,
  pageSize: number | undefined,
}
```

#### 与设计文档差异
| 参数 | 设计文档 | 实际实现 | 差异 |
|------|---------|---------|------|
| `search` | ✅ | ✅ | 一致 |
| `category` | ✅ | ✅ | 一致 |
| `language` | ✅ | ❌ | **缺失** |
| `status` | ✅ | ✅ | 一致 |
| `dateFrom` | ✅ | ❌ | **未暴露** |
| `dateTo` | ✅ | ❌ | **未暴露** |
| `sortBy` | ✅ | ✅ | 一致 |
| `sortOrder` | ✅ | ✅ | 一致 |
| `page` | ✅ | ✅ | 一致 |
| `pageSize` | ✅ | ✅ | 一致 |

**问题**:
- ❌ API Route 未传递 `dateFrom` 和 `dateTo` 给 Server Action
- ❌ API Route 未传递 `language` 给 Server Action

---

## 五、首页功能实际使用情况

### 5.1 静态配置数据

#### 分类列表（第 43-100 行）
```typescript
const categories = [
  { name: '商务汇报', slug: 'business', count: 12345, ... },
  { name: '教育培训', slug: 'education', count: 8234, ... },
  { name: '产品营销', slug: 'marketing', count: 6789, ... },
  { name: '年终总结', slug: 'general', count: 15678, ... },
  { name: '项目提案', slug: 'creative', count: 9456, ... },
  { name: '培训课件', slug: 'education', count: 7123, ... },
  { name: '述职报告', slug: 'business', count: 11234, ... },
  { name: '营销方案', slug: 'marketing', count: 5678, ... },
];
```

**问题**:
- ⚠️ 分类数量（count）是硬编码的，**不是真实数据**
- ⚠️ 教育培训、商务汇报、产品营销出现 **重复 slug**

#### 热门关键词（第 102-111 行）
```typescript
const hotKeywords = [
  { text: '年终总结', size: 'large' },
  { text: '工作汇报', size: 'medium' },
  { text: '项目提案', size: 'large' },
  { text: '述职报告', size: 'small' },
  { text: '商业计划', size: 'medium' },
  { text: '培训课件', size: 'small' },
  { text: '产品介绍', size: 'medium' },
  { text: '营销方案', size: 'small' },
];
```

**状态**: ✅ 静态配置（符合设计决策 ADR-009）

### 5.2 客户端过滤逻辑（第 268-293 行）

```typescript
const filteredResults = useMemo(() => {
  if (!hasSearched) return [];

  let filtered = [...results];

  // 按分类筛选
  if (filters.category !== 'all') {
    filtered = filtered.filter((ppt) => ppt.category === filters.category);
  }

  // 按语言筛选
  if (filters.language !== 'all') {
    filtered = filtered.filter((ppt) => ppt.language === filters.language);
  }

  // 排序
  if (filters.sort === 'popular') {
    filtered.sort((a, b) => b.views - a.views);
  } else if (filters.sort === 'newest') {
    filtered.sort((a, b) => b.id.localeCompare(a.id));
  } else if (filters.sort === 'downloads') {
    filtered.sort((a, b) => b.downloads - a.downloads);
  }

  return filtered;
}, [results, filters, hasSearched]);
```

**问题**:
- ⚠️ 客户端过滤和排序（非服务端）
- ⚠️ `language` 过滤依赖 API 返回 `language` 字段，但 **DTO 未返回**
- ⚠️ 排序在客户端执行，服务端已排序被覆盖

### 5.3 下载功能（第 254-260 行）

```typescript
const handleDownload = (ppt: PPT) => {
  toast.success(`正在准备下载《${ppt.title}》...`, {
    description: '下载功能需要后端支持，当前为演示模式',
    duration: 3000,
  });
  logAction('download_attempt', { pptId: ppt.id, title: ppt.title });
};
```

**状态**:
- ❌ **未实现真实下载**
- ❌ 仅记录审计日志（占位）
- ❌ 未调用 `/api/ppts/[id]/download` 端点

---

## 六、核心问题总结

### 6.1 设计文档错误

#### ❌ 错误 1: 字段完整性
**设计文档说**: 数据库缺少 `description` 和 `file_size`
**实际情况**:
- ✅ 确实缺少这两个字段
- ⚠️ 但还缺少了 `tags`, `language`, `tenantId`, `visibility`, `embeddingId`, `embeddingModel`, `reviewStatus` 等字段的说明

#### ❌ 错误 2: API 参数支持
**设计文档说**: API 支持 `language` 参数
**实际情况**:
- ❌ API Route **未传递** `language` 参数
- ❌ Server Action `buildWhere` **未处理** `language` 参数

#### ❌ 错误 3: 分类 Slug 映射
**设计文档说**: 每个分类有唯一的 slug
**实际情况**:
- ❌ 存在重复 slug（`education`, `business`, `marketing`）
- ⚠️ 设计文档的分类列表与首页的分类列表 **不一致**

### 6.2 实现不完整

#### ⚠️ 问题 1: 字段映射不一致
- 前端自定义接口与类型文件不一致
- DTO 返回字段不完整（缺少 `tags`, `language`）
- 首页依赖 `language` 进行过滤，但 API 未返回

#### ⚠️ 问题 2: 客户端过滤
- 分类、语言、排序都在客户端执行
- 服务端排序被忽略
- 大数据量时性能问题

#### ⚠️ 问题 3: 下载功能未实现
- 首页下载按钮只显示 Toast，未真实下载
- 未调用已实现的 `/api/ppts/[id]/download` API

#### ⚠️ 问题 4: 静态数据与真实数据混合
- 分类数量是硬编码（假数据）
- 分类列表静态配置
- 热门关键词静态配置

### 6.3 API 实现不完整

#### ❌ API Route 缺失参数传递
```typescript
// 实际 API Route 代码
const params = {
  search: searchParams.get('search') ?? undefined,
  category: searchParams.get('category') ?? undefined,
  status: searchParams.get('status') ?? undefined,
  sortBy: searchParams.get('sortBy') ?? undefined,
  sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') ?? undefined,
  page: searchParams.get('page') ? Number(searchParams.get('page')) : undefined,
  pageSize: searchParams.get('pageSize') ? Number(searchParams.get('pageSize')) : undefined,
};

// ❌ 缺失：dateFrom, dateTo, language
```

#### ❌ Server Action 未处理 language
```typescript
// buildWhere 函数中没有 language 处理
if (params.category) {
  conditions.push(eq(pptTable.category, params.category));
}

// ❌ 应该有但没有
// if (params.language) {
//   conditions.push(eq(pptTable.language, params.language));
// }
```

---

## 七、数据流分析

### 7.1 实际数据流

```
用户操作
  ↓
首页组件 (Client Component)
  ↓
fetch('/api/ppts?...')
  ↓
API Route (/api/ppts/route.ts)
  ↓ (参数不完整)
Server Action (getPPTs)
  ↓ (buildWhere 不完整)
Drizzle ORM
  ↓
PostgreSQL (Neon)
  ↓
返回数据（字段不完整）
  ↓
DTO 转换 (toPPTDto)
  ↓ (缺少 tags, language)
API Response
  ↓
首页 transform 函数
  ↓ (自定义接口，字段映射)
前端状态 (useState)
  ↓
客户端过滤和排序
  ↓
渲染 PPTCard
```

### 7.2 问题点

1. **API Route → Server Action**: 参数传递不完整（缺 `language`, `dateFrom`, `dateTo`）
2. **Server Action**: `buildWhere` 未处理 `language` 参数
3. **DTO 转换**: 未返回 `tags`, `language` 字段
4. **前端 transform**: 自定义接口，与类型文件不一致
5. **客户端过滤**: 在客户端执行过滤和排序，服务端能力未充分利用

---

## 八、与设计文档对比

### 8.1 设计文档 vs 实际实现

| 项目 | 设计文档 | 实际实现 | 一致性 |
|------|---------|---------|--------|
| Schema 字段 | 列出了主要字段 | 有额外字段未提及 | ⚠️ 部分一致 |
| API 参数 | 支持 10 个参数 | 仅传递 7 个参数 | ❌ 不一致 |
| DTO 转换 | 说明了缺失字段 | 实际缺失更多字段 | ⚠️ 部分一致 |
| 分类系统 | 唯一 slug 映射 | 存在重复 slug | ❌ 不一致 |
| 搜索实现 | 标题搜索 | 标题+作者搜索 | ✅ 超出预期 |
| 下载功能 | 设计了完整流程 | 未实现真实下载 | ❌ 未实现 |
| 热门关键词 | 静态配置 | 静态配置 | ✅ 一致 |

### 8.2 设计决策 vs 实际实现

| ADR | 决策内容 | 实际实现 | 符合度 |
|-----|---------|---------|--------|
| ADR-002 | SSR 优先 | 首页是 Client Component | ❌ 不符合 |
| ADR-003 | API Routes + Server Actions | ✅ 双层架构 | ✅ 符合 |
| ADR-004 | 分类使用 Slug | ✅ 使用 slug | ⚠️ 部分符合（有重复）|
| ADR-006 | TanStack Query | ❌ 使用 fetch + useState | ❌ 不符合 |
| ADR-008 | DTO 转换层 | ✅ 有 DTO 转换 | ⚠️ 部分符合（字段不全）|
| ADR-009 | 热门关键词静态 | ✅ 静态配置 | ✅ 符合 |
| ADR-010 | 国际化 | ❌ 首页未使用 next-intl | ❌ 不符合 |

---

## 九、建议修复优先级

### 🔴 高优先级（立即修复）

#### 1. 修复 API 参数传递
```typescript
// src/app/api/ppts/route.ts
const params = {
  // ... 现有参数
  language: searchParams.get('language') ?? undefined,  // ✅ 添加
  dateFrom: searchParams.get('dateFrom') ?? undefined,  // ✅ 添加
  dateTo: searchParams.get('dateTo') ?? undefined,      // ✅ 添加
};
```

#### 2. 修复 Server Action 支持 language
```typescript
// src/actions/ppt/ppt.ts - buildWhere 函数
if (params.language) {
  conditions.push(eq(pptTable.language, params.language));
}
```

#### 3. 修复 DTO 返回字段
```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  // ... 现有字段
  tags: row.tags ?? [],              // ✅ 添加
  language: row.language ?? 'zh',    // ✅ 添加
});
```

#### 4. 统一前端接口定义
- 移除首页自定义 `PPT` 接口（第 29-40 行）
- 使用 `src/lib/types/ppt/ppt.ts` 中的类型

#### 5. 修复分类 slug 重复
```typescript
const categories = [
  { name: '商务汇报', slug: 'business', ... },
  { name: '教育培训', slug: 'education', ... },
  { name: '产品营销', slug: 'marketing', ... },
  { name: '年终总结', slug: 'general', ... },
  { name: '项目提案', slug: 'proposal', ... },  // 修改为 proposal
  { name: '培训课件', slug: 'training', ... },   // 修改为 training
  { name: '述职报告', slug: 'report', ... },     // 修改为 report
  { name: '营销方案', slug: 'plan', ... },       // 修改为 plan
];
```

### 🟡 中优先级（近期完成）

#### 6. 实现真实下载功能
```typescript
const handleDownload = async (ppt: PPT) => {
  try {
    const res = await fetch(`/api/ppts/${ppt.id}/download`, {
      method: 'POST',
    });
    const data = await res.json();
    if (data.success) {
      window.location.href = data.data.fileUrl;
      toast.success('开始下载...');
    }
  } catch (error) {
    toast.error('下载失败');
  }
};
```

#### 7. 移除客户端过滤，使用服务端过滤
- 分类、语言、排序都应该通过 API 参数传递
- 让服务端处理过滤和排序

#### 8. 使用 TanStack Query 替代 fetch + useState
```typescript
import { useQuery } from '@tanstack/react-query';

const { data, isLoading } = useQuery({
  queryKey: ['ppts', params],
  queryFn: async () => {
    const res = await fetch(`/api/ppts?${new URLSearchParams(params)}`);
    return res.json();
  },
});
```

### 🟢 低优先级（后续优化）

#### 9. 实现真实分类数量统计
- 从数据库统计每个分类的 PPT 数量
- 替换硬编码的 count

#### 10. 考虑首页使用 Server Component
- 按照 ADR-002 的决策，首页应该使用 SSR
- 提升 SEO 和首屏性能

#### 11. 添加国际化支持
- 使用 `next-intl` 的 `useTranslations`
- 所有文本使用翻译 key

---

## 十、修正后的设计文档

### 需要更新的文档

1. **04-数据库验证.md**
   - 补充 `tags`, `language`, `tenantId`, `visibility`, `embeddingId` 等字段说明
   - 更新字段映射表

2. **05-代码实现记录.md**
   - 更正 API 参数支持列表
   - 更正 DTO 字段返回说明
   - 添加实际缺失功能说明

3. **06-下载组件设计.md**
   - 标注下载功能未实现
   - 更新实现状态

4. **07-待办任务清单.md**
   - 添加修复任务
   - 更新优先级

5. **08-关键决策记录.md**
   - 添加 ADR 符合度分析
   - 记录偏离原因

---

## 十一、总结

### 设计文档问题
1. ⚠️ Schema 字段说明不完整
2. ❌ API 参数支持描述不准确
3. ❌ 分类系统设计与实现不一致
4. ⚠️ 部分 ADR 决策未被遵循

### 实际实现问题
1. ❌ API 参数传递不完整
2. ❌ DTO 返回字段缺失
3. ❌ 下载功能未实现
4. ⚠️ 客户端过滤代替服务端
5. ❌ 类型定义不统一
6. ❌ 分类 slug 重复

### 下一步行动
1. **立即**: 修复高优先级问题（API 参数、DTO 字段、分类 slug）
2. **本周**: 实现下载功能、移除客户端过滤
3. **下周**: 使用 TanStack Query、考虑 SSR
4. **后续**: 优化性能、添加国际化

### 修正意见
建议逐步修正，优先修复功能性问题，然后优化架构和性能。
