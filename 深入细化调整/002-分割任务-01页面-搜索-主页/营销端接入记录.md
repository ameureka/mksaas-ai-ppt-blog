# 营销端 /ppt 页面接入记录

> 进入接入阶段前的准备、跟踪与校验记录。代码改动将直接落地到 `src/app/[locale]/(marketing)/ppt/*` 及相关链路，便于追踪。

## 阶段概览
- 设计已完成（见本目录各文档），数据库已确认可用（68 条 ppt 数据，索引/触发器齐全）。
- 当前状态：开始接入真实数据/逻辑，替换 mock。

## 目标范围
- `/ppt` 搜索主页：SSR 取数，分页/搜索/筛选/排序；热门关键词静态兜底。
- `/ppt/category/[name]`：按 slug 调用列表。
- `/ppt/[id]`：详情真实数据；下载按钮走下载链路；可选记录浏览。
- 下载链路：server action 或 `/api/ppts/[id]/download`，检查 `websiteConfig.features.pptRequireLoginForDownload`，通过则记录下载并返回直链。

## 准备清单
- DB：`DATABASE_URL` 可用；ppt 表字段/索引/触发器已检查，有 68 条数据。
- 配置：`websiteConfig.features.pptRequireLoginForDownload=false`（后续后台开关）；热门关键词静态。
- 数据缺口：ppt 表无 `file_size/description`，UI 需容错或隐藏。
- 权限：管理员账号已存在（供后台开关后续使用）。

## 计划步骤（接入阶段）
1) 前台页面接线
   - `/ppt`：改为 RSC 获取列表 + searchParams 控制分页/搜索/筛选/排序；加载/空/错误态基于 action 结果。
   - 分类页：同上，强制 category 参数。
   - 详情页：用 `getPPTById`；下载按钮调用下载链路；可选 `recordView`.
2) 下载链路
   - 新增 server action 或 `/api/ppts/[id]/download`：检查登录开关；未登录报错；成功则 `recordDownload` 并返回 `file_url`（或 302）。
3) 配置读取
   - 使用 `websiteConfig.features.pptRequireLoginForDownload`；热门关键词从静态配置。
4) QA
   - 本地/预发验证：分页/搜索/筛选/排序，详情/下载（开关的两种状态），空态/错误态。

## 校验点
- 列表字段映射：`download_count/view_count` → UI 显示下载/浏览；`thumbnail_url/cover_image_url` → 预览图。
- 错误处理：返回格式 `{ success, data?/error? }`，页面显示友好提示。
- 配置生效：开关为 false 时无需登录下载；后续可切换 true。

## 跟踪
- 所有接入变更记录在此文件；如需回滚，可参考 git 变更集。

## 当前未完成项 / TODO（主页相关）
> 截至本记录，/ppt 搜索主页和分类页已接通真实数据，但相对 spec 仍有以下差距：

1. `/ppt` 搜索主页
   - 仍为纯客户端页面（`use client` + `fetch /api/ppts`），未按计划改为 SSR + Server Actions。
   - 搜索请求仅使用 `search` 参数；`filters` 中的 `category/language/sort` 只在前端对 `results` 做过滤，未传递给后端。
   - 分页 UI 尚未实现，所有请求固定使用 `page=1&pageSize=12`。
   - `retryAfter/RATE_LIMITED` 相关逻辑已无实际用途，可在后续清理。
   - 列表卡片下载按钮仍为演示 toast，没有接入真实下载接口。

2. `/ppt/category/[name]` 分类页
   - 已使用 slug 调用 `/api/ppts?category=...`，分页为真实分页，但排序下拉（“最受欢迎/最新上传/下载最多/评分最高”）未映射到 `sortBy/sortOrder` 参数。
   - 下载按钮仍为 `alert`，未接下载链路。
   - SEO canonical/JSON-LD 中 URL 仍使用中文分类名，后续可统一为 slug 形式。

3. 下载链路（与主页相关部分）
   - `/api/ppts/[id]/download` 已存在，但 `/ppt` / 分类页 的下载入口尚未调用该接口。
   - 登录拦截逻辑（`pptRequireLoginForDownload`）只在接口侧生效，前端按钮尚未根据开关/登录态进行预判提示。

4. UI 容错与文案
   - `description`/`file_size` 缺失时虽有兜底逻辑（用空/“暂无简介”/“未知”），但不同页面的展示文案需要统一规范。
   - 预览图缺失时统一使用 placeholder；后续可考虑根据分类选择更贴合的占位图。

5. 热门关键词 & 管理端
   - 热门关键词仍为静态数组，尚未接入“热门搜索统计”接口（设计已在 `热门搜索设计草案.md` 中）。
   - 管理端 `/admin/ppt` 列表/编辑/创建仍使用旧数据源（mock），未接新的 actions/分页/筛选。

> 后续每完成一小块接入（如：搜索参数打通、详情页下载接线、管理端接线），可以在此 TODO 中打勾并补充简要变更说明。
