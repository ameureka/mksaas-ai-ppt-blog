# 08 - 关键决策记录 (ADR - Architecture Decision Records)

## 决策总览

本文档记录了 PPT 模块开发过程中的所有重要技术和业务决策。

---

## ADR-001: 设计优先原则

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 用户

### 背景
在项目初期，用户要求在开始编码之前，必须先创建完整的设计文档。

### 决策
采用 **设计优先** 的开发流程：
```
需求分析 → 设计文档 → 用户审核 → 代码实现 → 验证测试
```

所有设计文档保存在：`/Users/ameureka/Desktop/mksaas-ai-ppt-blog/深入细化调整/002-分割任务-01页面-搜索-主页/`

### 理由
1. 减少返工：提前发现设计问题
2. 提高质量：充分的设计时间
3. 清晰沟通：文档化的设计便于审核
4. 知识传承：设计文档作为项目文档

### 后果
- ✅ 优点：设计清晰，返工少，质量高
- ⚠️ 缺点：前期时间投入较多
- 📊 结果：成功避免了多次代码返工

### 相关决策
- ADR-002: SSR 优先策略

---

## ADR-002: SSR 优先策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
Next.js 15 支持 Server Components (RSC) 和 Client Components 两种模式。

### 决策
优先使用 **Server Components** 和 **Server Actions**：

```typescript
// 优先：Server Component + Server Action
export default async function PPTPage() {
  const data = await getPPTs(); // Server Action
  return <PPTList data={data} />;
}

// 次选：Client Component + API Route (当需要客户端交互时)
'use client';
export function PPTList() {
  const { data } = useGetPPTs(); // TanStack Query
  return <div>{/* render */}</div>;
}
```

### 理由
1. **SEO 优化**: Server Components 有利于搜索引擎抓取
2. **首屏性能**: 减少客户端 JavaScript
3. **数据安全**: 敏感逻辑在服务端执行
4. **代码简洁**: 减少客户端状态管理

### 后果
- ✅ 优点：SEO 友好，首屏快速，代码简洁
- ⚠️ 缺点：需要注意 Server/Client 边界
- 📊 结果：大部分页面使用 Server Components，交互部分使用 Client Components

### 相关决策
- ADR-003: API Routes 使用策略

---

## ADR-003: API Routes 使用策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
既有 Server Actions 又有 API Routes，需要明确使用场景。

### 决策
**双层架构**:
- **Server Actions**: 主要数据操作层（CRUD）
- **API Routes**: 供前端 Client Components 调用

```
[React Components]
    ↓
[Server Actions] ← 优先使用（Server Components）
    ↓
[Drizzle ORM]
    ↓
[PostgreSQL]

[React Components]
    ↓
[API Routes] ← 次选（Client Components 需要时）
    ↓
[Server Actions]
    ↓
[Drizzle ORM]
    ↓
[PostgreSQL]
```

### 理由
1. **灵活性**: 支持 Server 和 Client 两种场景
2. **复用性**: Server Actions 可被 API Routes 调用
3. **可测试性**: API 端点便于测试
4. **扩展性**: 未来可供移动端调用

### 后果
- ✅ 优点：架构灵活，易于扩展
- ⚠️ 缺点：代码层次增加
- 📊 结果：所有 CRUD 操作在 Server Actions，前端根据需要选择调用方式

### 相关决策
- ADR-002: SSR 优先策略
- ADR-006: Hooks 层设计

---

## ADR-004: 分类系统使用 Slug

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
分类名称是中文（如"商务汇报"），在 URL 中需要编码，影响 SEO 和用户体验。

### 决策
使用 **英文 Slug** 作为路由，映射到中文分类名称：

```typescript
const CATEGORY_SLUG_MAP = {
  'business': '商务汇报',
  'education': '教育培训',
  'technology': '技术报告',
  'creative': '创意设计',
  'marketing': '产品营销',
  'medical': '医疗健康',
  'finance': '金融财务',
  'hr': '人力资源',
  'lifestyle': '生活方式',
  'general': '其他分类',
};
```

**URL 设计**:
```
/ppt/category/business    → 商务汇报
/ppt/category/education   → 教育培训
```

### 理由
1. **SEO 友好**: 英文 URL 更利于搜索引擎
2. **用户体验**: URL 更简洁、易记
3. **国际化**: 便于支持多语言
4. **数据库查询**: 使用 slug 查询更高效

### 后果
- ✅ 优点：URL 简洁，SEO 友好，易扩展
- ⚠️ 缺点：需要维护映射关系
- 📊 结果：所有分类页面使用 slug，体验良好

### 相关决策
- ADR-010: 国际化策略

---

## ADR-005: 下载开关默认为 false

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 用户

### 背景
下载功能可以设置为需要登录或不需要登录。

### 决策
`pptRequireLoginForDownload` **默认为 `false`**（不需要登录）：

```typescript
// src/config/website.tsx
export const websiteConfig = {
  features: {
    pptRequireLoginForDownload: false,  // 默认不需要登录
  },
};
```

### 理由
1. **用户友好**: 降低下载门槛，提高转化率
2. **快速传播**: 方便用户分享和传播
3. **灵活切换**: 可随时通过配置开启登录要求
4. **初期策略**: 先积累用户，后续可调整策略

### 后果
- ✅ 优点：下载门槛低，用户体验好
- ⚠️ 缺点：无法收集用户数据，无法分析下载行为
- 📊 结果：初期采用完全免费策略，后续可根据数据调整

### 相关决策
- ADR-011: 下载流程设计

---

## ADR-006: Hooks 层使用 TanStack Query

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
前端需要调用 Server Actions 或 API，需要统一的数据获取和缓存策略。

### 决策
使用 **TanStack Query (React Query)** 封装所有数据操作：

```typescript
// src/hooks/ppt/use-get-ppts.ts
export function useGetPPTs(params?: PPTListParams) {
  return useQuery({
    queryKey: ['ppts', params],
    queryFn: async () => {
      const res = await fetch(`/api/ppts?${new URLSearchParams(params)}`);
      return res.json();
    },
  });
}

// src/hooks/ppt/use-create-ppt.ts
export function useCreatePPT() {
  return useMutation({
    mutationFn: async (data: CreatePPTInput) => {
      return createPPT(data); // Server Action
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['ppts'] });
    },
  });
}
```

### 理由
1. **缓存管理**: 自动缓存和失效
2. **加载状态**: 统一的 loading/error 状态
3. **乐观更新**: 支持乐观 UI 更新
4. **数据同步**: 自动重新获取和同步

### 后果
- ✅ 优点：状态管理统一，代码简洁，用户体验好
- ⚠️ 缺点：需要学习 TanStack Query API
- 📊 结果：所有数据操作使用 TanStack Query，体验流畅

### 相关决策
- ADR-003: API Routes 使用策略

---

## ADR-007: Schema 字段名对齐数据库

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
数据库使用 snake_case（如 `download_count`），TypeScript 通常使用 camelCase（如 `downloadCount`）。

### 决策
**Drizzle Schema 使用 camelCase，映射到 snake_case**：

```typescript
export const ppt = pgTable('ppt', {
  // TypeScript: camelCase → DB: snake_case
  downloadCount: integer("download_count").default(0),
  viewCount: integer("view_count").default(0),
  thumbnailUrl: text("thumbnail_url"),
  coverImageUrl: text("cover_image_url"),
});
```

### 理由
1. **TypeScript 惯例**: camelCase 符合 TypeScript 命名规范
2. **数据库惯例**: snake_case 符合 PostgreSQL 命名规范
3. **Drizzle 支持**: Drizzle 自动处理映射
4. **类型安全**: TypeScript 类型推断正确

### 后果
- ✅ 优点：代码规范，类型安全
- ⚠️ 缺点：需要注意字段名映射
- 📊 结果：Schema 定义清晰，无映射错误

### 相关决策
- ADR-008: DTO 转换层设计

---

## ADR-008: DTO 转换层设计

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
数据库字段和前端需要的字段不完全一致（如缺失 `description` 字段）。

### 决策
引入 **DTO 转换层**，统一处理字段映射和默认值：

```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  id: row.id,
  title: row.title,
  category: (row.category ?? 'general') as PPT['category'],
  author: row.author ?? 'Unknown',
  description: undefined,                    // DB 不存在，返回 undefined
  slides_count: row.slidesCount ?? 0,
  file_size: '',                             // DB 不存在，返回空字符串
  file_url: row.fileUrl,
  preview_url: row.thumbnailUrl ?? row.coverImageUrl ?? undefined,
  downloads: row.downloadCount ?? 0,         // 字段名映射
  views: row.viewCount ?? 0,                 // 字段名映射
  status: (row.status ?? 'draft') as PPT['status'],
  uploaded_at: row.createdAt?.toISOString(),
  created_at: row.createdAt?.toISOString(),
  updated_at: row.updatedAt?.toISOString(),
});
```

### 理由
1. **解耦**: 数据库 schema 和前端类型解耦
2. **默认值**: 统一处理缺失字段
3. **字段映射**: 统一处理字段名转换
4. **类型安全**: TypeScript 类型检查

### 后果
- ✅ 优点：代码清晰，易于维护
- ⚠️ 缺点：增加一层转换
- 📊 结果：成功处理所有字段映射，无运行时错误

### 相关决策
- ADR-007: Schema 字段名对齐数据库

---

## ADR-009: 热门关键词初期使用静态配置

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
热门关键词可以静态配置或动态统计，需要选择实现方式。

### 决策
**初期使用静态配置，未来扩展为动态统计**：

```typescript
// 当前方案：静态配置
export const HOT_KEYWORDS = [
  '年终总结',
  '商务汇报',
  '教育培训',
  '产品营销',
  // ...
];

// 未来方案：动态统计
SELECT
  search_keyword,
  COUNT(*) as count
FROM search_logs
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY search_keyword
ORDER BY count DESC
LIMIT 10;
```

### 理由
1. **快速实现**: 静态配置无需数据库支持
2. **可控性**: 人工筛选热门关键词
3. **渐进增强**: 未来可升级为动态统计
4. **成本考虑**: 初期无需额外存储和计算

### 后果
- ✅ 优点：实现简单，快速上线
- ⚠️ 缺点：不能反映实际搜索趋势
- 📊 结果：初期使用静态配置，待数据积累后升级

### 相关决策
- ADR-015: 搜索日志记录（未来）

---

## ADR-010: 国际化策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
项目需要支持多语言（英文和中文）。

### 决策
使用 **next-intl** 实现完整的国际化：

```typescript
// 使用翻译
import { useTranslations } from 'next-intl';

export function PPTCard() {
  const t = useTranslations('PPT');

  return (
    <div>
      <h3>{t('card.downloads', { count: ppt.downloads })}</h3>
      <p>{t('card.views', { count: ppt.views })}</p>
    </div>
  );
}
```

**翻译文件**:
```json
// messages/en.json
{
  "PPT": {
    "card": {
      "downloads": "{count} downloads",
      "views": "{count} views"
    }
  }
}

// messages/zh.json
{
  "PPT": {
    "card": {
      "downloads": "{count} 次下载",
      "views": "{count} 次浏览"
    }
  }
}
```

### 理由
1. **完整支持**: next-intl 是 Next.js 官方推荐
2. **类型安全**: TypeScript 类型检查
3. **路由集成**: 支持 `/en/...` 和 `/zh/...` 路由
4. **SEO 友好**: 每种语言独立 URL

### 后果
- ✅ 优点：多语言支持完善，SEO 友好
- ⚠️ 缺点：需要维护多份翻译文件
- 📊 结果：英文和中文支持良好

### 相关决策
- ADR-004: 分类系统使用 Slug

---

## ADR-011: 下载流程设计

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
下载功能需要考虑多种场景：免费、登录、积分、广告等。

### 决策
**设计可扩展的下载流程**：

```
用户点击下载
  ↓
检查 pptRequireLoginForDownload
  ├─ false → 直接下载（当前）
  └─ true  → 检查登录状态
       ├─ 未登录 → 显示登录模态框
       └─ 已登录 → 检查下载条件（未来扩展）
            ├─ 首免 → 免费下载
            ├─ 积分 → 扣除积分
            ├─ 广告 → 观看广告
            └─ 订阅 → 会员下载
```

### 理由
1. **渐进增强**: 从简单到复杂
2. **配置驱动**: 通过配置控制功能
3. **可扩展性**: 预留未来功能接口
4. **用户体验**: 优先保证流畅体验

### 后果
- ✅ 优点：架构灵活，易于扩展
- ⚠️ 缺点：初期功能简单，未充分利用
- 📊 结果：初期实现免费下载，预留扩展接口

### 相关决策
- ADR-005: 下载开关默认为 false
- ADR-016: 积分系统设计（未来）
- ADR-017: 广告激励设计（未来）

---

## ADR-012: 索引策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
PPT 表需要支持多种查询和排序，需要合理的索引策略。

### 决策
添加以下索引：

```sql
CREATE INDEX ppt_category_idx ON ppt(category);
CREATE INDEX ppt_download_count_idx ON ppt(download_count);
CREATE INDEX ppt_view_count_idx ON ppt(view_count);
CREATE INDEX ppt_created_at_idx ON ppt(created_at);
```

### 理由
1. **分类查询**: 频繁按分类筛选
2. **排序优化**: 按下载量、浏览量、时间排序
3. **性能考虑**: 68 条记录暂无压力，但预留扩展
4. **查询模式**: 基于实际查询需求

### 后果
- ✅ 优点：查询性能良好
- ⚠️ 缺点：写入性能略有下降（可忽略）
- 📊 结果：查询响应时间 < 50ms

### 相关决策
- ADR-018: 搜索优化（未来）

---

## ADR-013: 分页策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
列表页需要分页，避免一次加载过多数据。

### 决策
**默认每页 12 条，最大 100 条**：

```typescript
const DEFAULT_PAGE_SIZE = 12;
const MAX_PAGE_SIZE = 100;

function normalizePagination(page?: number, pageSize?: number) {
  return {
    page: Math.max(1, page ?? 1),
    pageSize: Math.min(MAX_PAGE_SIZE, Math.max(1, pageSize ?? DEFAULT_PAGE_SIZE)),
  };
}
```

### 理由
1. **用户体验**: 12 条适合卡片布局（3x4 或 4x3）
2. **性能考虑**: 避免一次加载过多数据
3. **安全限制**: 最大 100 条防止恶意请求
4. **响应式**: 适配不同屏幕尺寸

### 后果
- ✅ 优点：性能良好，用户体验好
- ⚠️ 缺点：需要多次请求查看所有数据
- 📊 结果：页面加载时间 < 500ms

### 相关决策
- ADR-012: 索引策略

---

## ADR-014: 错误处理策略

**日期**: 2025-11-27
**状态**: ✅ 已采纳
**决策者**: 设计团队

### 背景
Server Actions 和 API 需要统一的错误处理。

### 决策
使用 **ServerActionResult** 统一返回格式：

```typescript
type ServerActionResult<T> =
  | { success: true; data: T }
  | { success: false; error: string; code?: string };

// 成功
return successResult(data);

// 失败
return errorResult('Failed to fetch PPTs', 'DATABASE_ERROR');
```

### 理由
1. **类型安全**: TypeScript 类型检查
2. **统一格式**: 前端统一处理
3. **错误分类**: 通过 code 区分错误类型
4. **易于调试**: 错误信息清晰

### 后果
- ✅ 优点：错误处理统一，易于调试
- ⚠️ 缺点：需要每个 Action 返回该格式
- 📊 结果：错误处理清晰，调试效率高

### 相关决策
- ADR-003: API Routes 使用策略

---

## 未来决策（待定）

### ADR-015: 搜索日志记录（未来）
**状态**: ⏳ 待定

**问题**: 是否记录用户搜索行为？

**选项**:
- A. 记录所有搜索（支持热门关键词统计）
- B. 不记录（隐私考虑）
- C. 仅记录关键词（不记录用户 ID）

**建议**: 选项 C（平衡功能和隐私）

---

### ADR-016: 积分系统设计（未来）
**状态**: ⏳ 待定

**问题**: 如何设计积分系统？

**选项**:
- A. 简单积分系统（获取、消费、余额）
- B. 完整积分系统（包含过期、等级、礼包）
- C. 暂不实施

**建议**: 选项 A（初期简单实现）

---

### ADR-017: 广告激励设计（未来）
**状态**: ⏳ 待定

**问题**: 如何集成广告？

**选项**:
- A. Google AdMob
- B. Unity Ads
- C. 自建广告系统
- D. 暂不实施

**建议**: 选项 A 或 D（取决于商业策略）

---

### ADR-018: 搜索优化（未来）
**状态**: ⏳ 待定

**问题**: 如何优化搜索性能？

**选项**:
- A. PostgreSQL tsvector 全文搜索
- B. Elasticsearch
- C. Algolia
- D. 保持现状（ILIKE）

**建议**: 数据量 < 1000 时选项 D，> 1000 时选项 A

---

### ADR-019: 签名 URL 实现（未来）
**状态**: ⏳ 待定

**问题**: 如何防止文件盗链？

**选项**:
- A. S3 Pre-signed URL
- B. 自定义签名机制
- C. CDN 防盗链
- D. 暂不实施

**建议**: 选项 A（AWS/Cloudflare R2 原生支持）

---

## 决策评审流程

### 提出决策
1. 描述背景和问题
2. 列出可选方案
3. 分析利弊
4. 给出建议

### 审核决策
1. 技术可行性评估
2. 成本分析
3. 风险评估
4. 用户影响评估

### 采纳决策
1. 记录在 ADR 文档
2. 更新设计文档
3. 通知开发团队
4. 开始实施

### 回顾决策
1. 定期回顾已采纳的决策
2. 评估决策效果
3. 必要时修订决策
4. 记录经验教训

---

## 总结

### 核心原则
1. **设计优先**: 先设计，后实现
2. **渐进增强**: 从简单到复杂
3. **配置驱动**: 功能可配置
4. **类型安全**: 端到端类型检查
5. **用户体验**: 优先保证流畅体验

### 成功经验
1. ✅ 设计优先避免了多次返工
2. ✅ SSR 优先提升了 SEO 和性能
3. ✅ DTO 转换层成功处理了字段差异
4. ✅ 索引策略保证了查询性能

### 经验教训
1. ⚠️ 前期设计投入较多，但避免了后期返工
2. ⚠️ 字段映射需要仔细对齐，避免运行时错误
3. ⚠️ 功能扩展需要预留接口，避免重构

### 后续改进
1. 完善错误监控和日志
2. 实施性能监控
3. 收集用户反馈
4. 根据数据调整决策
