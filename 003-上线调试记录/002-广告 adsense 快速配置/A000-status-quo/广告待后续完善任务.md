# 广告待后续完善任务（2025-02）

## 状态概览
- 代码与页面广告位已就绪；adReward 开关默认 true，credits 开关默认 false → 看广告仅解锁下载，不写积分流水。
- AdSense 渲染由环境变量控制，Publisher/slot ID 仍为占位；`public/ads.txt` 尚未替换真实 ID。
- 数据库需存在 `ad_watch_record`、`user_download_history`、`user_credit`、`credit_transaction`、`download_record` 等表。

## 立即执行
- 数据库同步：`pnpm db:push` 或 `pnpm db:migrate`，确认上述表均生成。
- 环境变量：填写 `NEXT_PUBLIC_ADSENSE_ENABLED`（生产置 true）、`NEXT_PUBLIC_ADSENSE_TEST_MODE`（预览占位可设 true）、`NEXT_PUBLIC_ADSENSE_PUBLISHER_ID` 及各 slot ID（BLOG_BANNER/SIDEBAR/VERTICAL/MULTIPLEX、PPT_NATIVE 等）。
- ads.txt：将 `public/ads.txt` 的 `pub-XXXXXXXXXXXXXXXX` 替换为真实 Publisher ID 后发布。

## 功能验证（本地/预发）
- 广告位占位/CLS：检查博客详情、PPT 列表/详情、下载弹窗的占位高度是否稳定无抖动。
- 看广告解锁链路：`POST /api/ad/start-watch` → `complete-watch` → `POST /api/ppts/{id}/download`（method=ad, downloadToken）。验证倒计时与 `minWatchDuration` 一致，downloadToken 生效；credits 关闭时返回的积分应为 0。
- 限流与 IP：多次请求 start-watch，确认 `dailyLimitPerUser/IP` 生效，`x-forwarded-for` 有值时限流正常。
- 首免/积分路径：默认 `firstFree` 首次可下，再次需 ad/credits；若未来开启 credits，验证 method=credits 会写入 `credit_transaction` 与 `user_credit`。
- 数据落表：ad_watch_record 状态流转 pending→completed；user_download_history 记录 download_method=ad/firstFree/credits；download_record 计数；（如开启积分）credit_transaction 产生 ad_reward。

## 上线前检查清单
- 填充 Publisher 与 slot IDs，启用 `NEXT_PUBLIC_ADSENSE_ENABLED`，必要时保留 `TEST_MODE` 做预览。
- 部署包含更新后的 `ads.txt`，并确保 CDN/缓存刷新。
- 携带生产 env 运行一次 `pnpm build`，确认无缺失环境变量或类型错误。

## 可选改进
- 防重放：在 `ad_watch_record` 增加 download_token 使用标记，进一步防止重复下载。
- 奖励文案一致性：若开启积分，更新下载弹窗文案提示“看广告得积分+下载”，并校准 `watchDuration`（前端倒计时）与 `minWatchDuration`（后端校验）。
- 观测与报警：为 start/complete-watch 增加日志/埋点，监控失败率与限流命中。
