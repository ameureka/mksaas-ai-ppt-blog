# 广告模块数据库表结构文档

> 导出时间: 2025-12-06
> 数据库: ai-ppt-site (Neon PostgreSQL 17)
> 区域: aws-ap-southeast-1

---

## 表关系概览

```
┌─────────────────┐
│      user       │
└────────┬────────┘
         │
         │ 1:N (ON DELETE CASCADE)
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │  ad_watch_record │  │   user_credit   │  │credit_transaction│ │
│  │  (广告观看记录)   │  │  (用户积分余额)  │  │  (积分交易流水)   │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
│                                                                 │
│  ┌─────────────────────────┐  ┌─────────────────────────┐      │
│  │  user_download_history  │  │     download_record     │      │
│  │    (用户下载历史)        │  │      (下载记录)          │      │
│  └─────────────────────────┘  └─────────────────────────┘      │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1. ad_watch_record (广告观看记录表)

用于记录用户观看广告获取积分的完整流程。

### 表信息
- **表大小**: 0 bytes (空表)
- **索引大小**: 64 kB
- **总大小**: 64 kB

### 字段定义

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | text | NOT NULL | - | 主键 |
| `user_id` | text | NULL | - | 用户ID，外键关联 user(id) |
| `ip_address` | text | NULL | - | 用户IP地址 |
| `ppt_id` | text | NULL | - | 关联的PPT模板ID |
| `watch_token` | text | NOT NULL | - | 观看令牌，唯一标识 |
| `download_token` | text | NULL | - | 下载令牌 |
| `started_at` | timestamp | NOT NULL | now() | 开始观看时间 |
| `completed_at` | timestamp | NULL | - | 完成观看时间 |
| `status` | text | NOT NULL | 'pending' | 状态: pending/completed/expired |
| `credits_awarded` | integer | NULL | 0 | 奖励的积分数量 |
| `created_at` | timestamp | NOT NULL | now() | 记录创建时间 |

### 索引

| 索引名 | 定义 | 大小 |
|--------|------|------|
| `ad_watch_record_pkey` | PRIMARY KEY (id) | 8 kB |
| `ad_watch_record_watch_token_key` | UNIQUE (watch_token) | 8 kB |
| `ad_watch_user_id_idx` | btree (user_id) | 8 kB |
| `ad_watch_ip_idx` | btree (ip_address) | 8 kB |
| `ad_watch_token_idx` | btree (watch_token) | 8 kB |
| `ad_watch_created_idx` | btree (created_at) | 8 kB |
| `ad_watch_status_idx` | btree (status) | 8 kB |

### 约束

| 约束名 | 类型 | 定义 |
|--------|------|------|
| `ad_watch_record_pkey` | PRIMARY KEY | PRIMARY KEY (id) |
| `ad_watch_record_watch_token_key` | UNIQUE | UNIQUE (watch_token) |
| `ad_watch_record_user_id_fkey` | FOREIGN KEY | REFERENCES "user"(id) ON DELETE CASCADE |

### SQL 建表语句

```sql
CREATE TABLE IF NOT EXISTS "ad_watch_record" (
  "id" TEXT PRIMARY KEY,
  "user_id" TEXT REFERENCES "user"("id") ON DELETE CASCADE,
  "ip_address" TEXT,
  "ppt_id" TEXT,
  "watch_token" TEXT NOT NULL UNIQUE,
  "download_token" TEXT,
  "started_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "completed_at" TIMESTAMP,
  "status" TEXT NOT NULL DEFAULT 'pending',
  "credits_awarded" INTEGER DEFAULT 0,
  "created_at" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS "ad_watch_user_id_idx" ON "ad_watch_record"("user_id");
CREATE INDEX IF NOT EXISTS "ad_watch_ip_idx" ON "ad_watch_record"("ip_address");
CREATE INDEX IF NOT EXISTS "ad_watch_token_idx" ON "ad_watch_record"("watch_token");
CREATE INDEX IF NOT EXISTS "ad_watch_created_idx" ON "ad_watch_record"("created_at");
CREATE INDEX IF NOT EXISTS "ad_watch_status_idx" ON "ad_watch_record"("status");
```

---

## 2. user_download_history (用户下载历史表)

记录用户的PPT下载历史，包含下载方式和消耗积分。

### 表信息
- **表大小**: 0 bytes (空表)
- **索引大小**: 48 kB
- **总大小**: 48 kB

### 字段定义

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | text | NOT NULL | - | 主键 |
| `user_id` | text | NULL | - | 用户ID，外键关联 user(id) |
| `ppt_id` | text | NOT NULL | - | PPT模板ID |
| `download_method` | text | NOT NULL | - | 下载方式: ad_watch/credits/free |
| `credits_spent` | integer | NULL | 0 | 消耗的积分数量 |
| `ip_address` | text | NULL | - | 用户IP地址 |
| `downloaded_at` | timestamp | NOT NULL | now() | 下载时间 |

### 索引

| 索引名 | 定义 | 大小 |
|--------|------|------|
| `user_download_history_pkey` | PRIMARY KEY (id) | 8 kB |
| `download_user_ppt_idx` | btree (user_id, ppt_id) | 8 kB |
| `download_user_idx` | btree (user_id) | 8 kB |
| `download_ppt_idx` | btree (ppt_id) | 8 kB |
| `download_method_idx` | btree (download_method) | 8 kB |

### 约束

| 约束名 | 类型 | 定义 |
|--------|------|------|
| `user_download_history_pkey` | PRIMARY KEY | PRIMARY KEY (id) |
| `user_download_history_user_id_fkey` | FOREIGN KEY | REFERENCES "user"(id) ON DELETE CASCADE |

### SQL 建表语句

```sql
CREATE TABLE IF NOT EXISTS "user_download_history" (
  "id" TEXT PRIMARY KEY,
  "user_id" TEXT REFERENCES "user"("id") ON DELETE CASCADE,
  "ppt_id" TEXT NOT NULL,
  "download_method" TEXT NOT NULL,
  "credits_spent" INTEGER DEFAULT 0,
  "ip_address" TEXT,
  "downloaded_at" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS "download_user_ppt_idx" ON "user_download_history"("user_id", "ppt_id");
CREATE INDEX IF NOT EXISTS "download_user_idx" ON "user_download_history"("user_id");
CREATE INDEX IF NOT EXISTS "download_ppt_idx" ON "user_download_history"("ppt_id");
CREATE INDEX IF NOT EXISTS "download_method_idx" ON "user_download_history"("download_method");
```

---

## 3. user_credit (用户积分余额表)

存储用户当前的积分余额。

### 表信息
- **表大小**: 0 bytes (空表)
- **索引大小**: 24 kB
- **总大小**: 24 kB

### 字段定义

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | text | NOT NULL | - | 主键 |
| `user_id` | text | NOT NULL | - | 用户ID，外键关联 user(id) |
| `current_credits` | integer | NOT NULL | 0 | 当前积分余额 |
| `last_refresh_at` | timestamp | NULL | - | 上次刷新时间 |
| `created_at` | timestamp | NOT NULL | now() | 创建时间 |
| `updated_at` | timestamp | NOT NULL | now() | 更新时间 |

### 索引

| 索引名 | 定义 | 大小 |
|--------|------|------|
| `user_credit_pkey` | PRIMARY KEY (id) | 8 kB |
| `user_credit_user_id_idx` | btree (user_id) | 8 kB |

### 约束

| 约束名 | 类型 | 定义 |
|--------|------|------|
| `user_credit_pkey` | PRIMARY KEY | PRIMARY KEY (id) |
| `user_credit_user_id_user_id_fk` | FOREIGN KEY | REFERENCES "user"(id) ON DELETE CASCADE |

### SQL 建表语句

```sql
CREATE TABLE IF NOT EXISTS "user_credit" (
  "id" TEXT PRIMARY KEY,
  "user_id" TEXT NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  "current_credits" INTEGER NOT NULL DEFAULT 0,
  "last_refresh_at" TIMESTAMP,
  "created_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS "user_credit_user_id_idx" ON "user_credit"("user_id");
```

---

## 4. credit_transaction (积分交易流水表)

记录所有积分变动的详细流水。

### 表信息
- **表大小**: 0 bytes (空表)
- **索引大小**: 32 kB
- **总大小**: 32 kB

### 字段定义

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | text | NOT NULL | - | 主键 |
| `user_id` | text | NOT NULL | - | 用户ID，外键关联 user(id) |
| `type` | text | NOT NULL | - | 交易类型: ad_reward/purchase/consume/gift/expire |
| `description` | text | NULL | - | 交易描述 |
| `amount` | integer | NOT NULL | - | 交易金额 (正数增加，负数减少) |
| `remaining_amount` | integer | NULL | - | 剩余可用金额 |
| `payment_id` | text | NULL | - | 关联的支付ID |
| `expiration_date` | timestamp | NULL | - | 过期时间 |
| `expiration_date_processed_at` | timestamp | NULL | - | 过期处理时间 |
| `created_at` | timestamp | NOT NULL | now() | 创建时间 |
| `updated_at` | timestamp | NOT NULL | now() | 更新时间 |

### 索引

| 索引名 | 定义 | 大小 |
|--------|------|------|
| `credit_transaction_pkey` | PRIMARY KEY (id) | 8 kB |
| `credit_transaction_user_id_idx` | btree (user_id) | 8 kB |
| `credit_transaction_type_idx` | btree (type) | 8 kB |

### 约束

| 约束名 | 类型 | 定义 |
|--------|------|------|
| `credit_transaction_pkey` | PRIMARY KEY | PRIMARY KEY (id) |
| `credit_transaction_user_id_user_id_fk` | FOREIGN KEY | REFERENCES "user"(id) ON DELETE CASCADE |

### SQL 建表语句

```sql
CREATE TABLE IF NOT EXISTS "credit_transaction" (
  "id" TEXT PRIMARY KEY,
  "user_id" TEXT NOT NULL REFERENCES "user"("id") ON DELETE CASCADE,
  "type" TEXT NOT NULL,
  "description" TEXT,
  "amount" INTEGER NOT NULL,
  "remaining_amount" INTEGER,
  "payment_id" TEXT,
  "expiration_date" TIMESTAMP,
  "expiration_date_processed_at" TIMESTAMP,
  "created_at" TIMESTAMP NOT NULL DEFAULT NOW(),
  "updated_at" TIMESTAMP NOT NULL DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS "credit_transaction_user_id_idx" ON "credit_transaction"("user_id");
CREATE INDEX IF NOT EXISTS "credit_transaction_type_idx" ON "credit_transaction"("type");
```

---

## 5. download_record (下载记录表)

通用下载记录表，关联 PPT 表。

### 表信息
- **表大小**: 0 bytes (空表)
- **索引大小**: 40 kB
- **总大小**: 40 kB

### 字段定义

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `id` | text | NOT NULL | gen_random_uuid()::text | 主键，自动生成UUID |
| `user_id` | text | NULL | - | 用户ID，外键关联 user(id) |
| `ppt_id` | text | NOT NULL | - | PPT模板ID，外键关联 ppt(id) |
| `ip_address` | text | NULL | - | 用户IP地址 |
| `user_agent` | text | NULL | - | 用户浏览器UA |
| `credits_used` | integer | NULL | 0 | 使用的积分数量 |
| `created_at` | timestamp | NULL | now() | 下载时间 |

### 索引

| 索引名 | 定义 | 大小 |
|--------|------|------|
| `download_record_pkey` | PRIMARY KEY (id) | 8 kB |
| `download_record_user_id_idx` | btree (user_id) | 8 kB |
| `download_record_ppt_id_idx` | btree (ppt_id) | 8 kB |
| `download_record_downloaded_at_idx` | btree (created_at DESC) | 8 kB |

### 约束

| 约束名 | 类型 | 定义 |
|--------|------|------|
| `download_record_pkey` | PRIMARY KEY | PRIMARY KEY (id) |
| `download_record_user_id_fkey` | FOREIGN KEY | REFERENCES "user"(id) ON DELETE SET NULL |
| `download_record_ppt_id_fkey` | FOREIGN KEY | REFERENCES ppt(id) ON DELETE CASCADE |

### SQL 建表语句

```sql
CREATE TABLE IF NOT EXISTS "download_record" (
  "id" TEXT PRIMARY KEY DEFAULT gen_random_uuid()::text,
  "user_id" TEXT REFERENCES "user"("id") ON DELETE SET NULL,
  "ppt_id" TEXT NOT NULL REFERENCES "ppt"("id") ON DELETE CASCADE,
  "ip_address" TEXT,
  "user_agent" TEXT,
  "credits_used" INTEGER DEFAULT 0,
  "created_at" TIMESTAMP DEFAULT NOW()
);

-- 索引
CREATE INDEX IF NOT EXISTS "download_record_user_id_idx" ON "download_record"("user_id");
CREATE INDEX IF NOT EXISTS "download_record_ppt_id_idx" ON "download_record"("ppt_id");
CREATE INDEX IF NOT EXISTS "download_record_downloaded_at_idx" ON "download_record"("created_at" DESC);
```

---

## 业务流程说明

### 广告观看获取积分流程

```
1. 用户点击"观看广告下载"
   → 创建 ad_watch_record (status='pending', watch_token=生成)

2. 用户开始观看广告
   → 更新 started_at

3. 广告观看完成
   → 更新 ad_watch_record (status='completed', completed_at=now())
   → 创建 credit_transaction (type='ad_reward', amount=奖励积分)
   → 更新 user_credit.current_credits
   → 生成 download_token

4. 用户使用 download_token 下载
   → 创建 user_download_history (download_method='ad_watch')
   → 创建 download_record
```

### 积分消费下载流程

```
1. 用户点击"积分下载"
   → 检查 user_credit.current_credits >= 所需积分

2. 扣除积分
   → 创建 credit_transaction (type='consume', amount=-消耗积分)
   → 更新 user_credit.current_credits

3. 记录下载
   → 创建 user_download_history (download_method='credits')
   → 创建 download_record (credits_used=消耗积分)
```

---

## 注意事项

1. **外键级联删除**: 所有表的 user_id 外键都设置了 `ON DELETE CASCADE`，删除用户时会自动清理相关记录
2. **download_record vs user_download_history**:
   - `download_record` 是通用下载记录，关联 ppt 表
   - `user_download_history` 专注于用户下载历史，包含下载方式
3. **积分过期**: `credit_transaction` 表支持积分过期机制，通过 `expiration_date` 和 `expiration_date_processed_at` 字段管理
