# 广告与积分模块接口与数据关系（现状）

> 状态更新：2025-12  
> 基准：`src/db/schema.ts`、`src/config/website.tsx`

## 1) 数据表与字段（Drizzle schema）

- `ad_watch_record`
  - `id` PK，`user_id` FK 可空，`ppt_id` FK
  - `watch_token` UNIQUE，`download_token`
  - `status`: pending/completed/expired
  - `credits_awarded` 默认 0
  - `started_at`，`completed_at`，`created_at`
- `user_download_history`
  - `id` PK，`user_id` FK，`ppt_id` FK
  - `download_method`: ad/credits/firstFree
  - `credits_spent` 默认 0
  - `ip_address`，`downloaded_at`
- `user_credit`
  - `id` PK，`user_id` FK，`current_credits`，`last_refresh_at`，`created_at`，`updated_at`
- `credit_transaction`
  - `id` PK，`user_id` FK，`type`，`amount`，`balance_after`，`created_at`
- 统计表：`download_record`（下载次数按天聚合）

> 备注：积分功能默认关闭（`websiteConfig.credits.enableCredits=false`），但广告看视频解锁下载独立可用。

## 2) 核心流程

### A. 广告解锁下载（Ad-for-Download）
1. **开始观看** `POST /api/ad/start-watch`  
   - 校验 `adReward.enable`、日限额（用户/IP）。  
   - 新建 `ad_watch_record` 状态 pending，返回 `watchToken` + `expiresAt`。
2. **完成观看** `POST /api/ad/complete-watch`  
   - 校验耗时 ≥ `minWatchDuration`（默认 25s）。  
   - 状态改 completed，生成 `downloadToken`；可选记积分交易。  
   - 返回 `downloadToken`。
3. **执行下载** `POST /api/ppts/{id}/download`（method=ad）  
   - 校验 `downloadToken` 有效。  
   - 写 `user_download_history`(method=ad) + `download_record`。  
   - 返回实际文件链接（S3/R2）。

### B. 其他解锁方式
- **首次免费**：method=firstFree（开启时，用户未下载过该 PPT）。  
- **积分下载**：method=credits（需开启积分并余额充足）。

## 3) 配置映射（`websiteConfig.adReward`）

| 键 | 当前值 | 说明 |
|----|--------|------|
| enable | true | 总开关 |
| creditsPerWatch | 5 | 仅积分功能开启时发放 |
| watchDuration | 30 | 前端倒计时展示 |
| minWatchDuration | 25 | 后端耗时校验 |
| dailyLimitPerUser | 10 | 单用户日限 |
| dailyLimitPerIP | 20 | 单 IP 日限 |

## 4) 依赖与注意事项

- 需跑 `pnpm db:migrate` 保证表存在，否则接口 500。  
- 积分关闭时，广告流程仍可用：看广告 → 校验 → 发 `downloadToken`。  
- AdSense 配置与解锁流程解耦：未投放广告也可跑占位/倒计时逻辑。  
- GitHub/Google OAuth 未配置只影响社交登录，不影响广告解锁下载。  
