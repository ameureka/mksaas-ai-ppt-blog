# 需求文档：广告系统增强

## 简介

本文档规定了增强现有 AdSense 广告系统的需求。增强内容包括添加高收益广告类型（垂直广告、外播视频广告、多重推荐广告、锚定广告）并将广告投放扩展到更多页面，同时保持用户体验和 CLS（累积布局偏移）合规性。

## 术语表

- **AdSystem（广告系统）**：负责渲染和管理广告单元的核心广告管理系统
- **DisplayAd（展示广告）**：用于渲染 AdSense 展示广告的基础组件
- **AdSlot（广告位）**：AdSense 提供的广告投放位置的唯一标识符
- **AdFormat（广告格式）**：广告的视觉格式（水平、矩形、垂直、外播、多重推荐、锚定）
- **CLS**：累积布局偏移 - 衡量视觉稳定性的核心 Web 指标
- **LazyLoad（懒加载）**：延迟加载广告直到进入视口的技术
- **ADSENSE_CONFIG**：AdSense 设置的中央配置对象

## 需求

### 需求 1：垂直侧边栏广告

**用户故事：** 作为博客读者，我希望在侧边栏看到相关广告而不干扰我的阅读体验，这样网站可以在我消费内容时实现变现。

#### 验收标准

1. 广告系统应支持尺寸为 300×600 像素的 `vertical` 格式
2. 当渲染 VerticalSidebarAd 组件时，广告系统应预留最小 600px 高度以防止 CLS
3. 当广告进入视口（200px 边距）时，广告系统应通过 IntersectionObserver 触发广告加载
4. 在开发模式下，广告系统应显示带有格式标签的占位符而非真实广告
5. 如果 ADSENSE_CONFIG.enabled 为 false，则广告系统应不渲染任何内容（返回 null）

### 需求 2：外播视频广告

**用户故事：** 作为内容发布者，我希望在文章内容中展示视频广告，这样我可以在不需要自己的视频内容的情况下增加广告收入。

#### 验收标准

1. 广告系统应支持用于文章内视频广告的 `outstream` 格式
2. 当渲染 OutstreamVideoAd 时，广告系统应使用 `data-ad-format="fluid"` 和适当的布局键
3. 当广告容器进入视口时，广告系统应触发懒加载
4. 广告系统应为视频广告预留最小 250px 高度和 16:9 宽高比
5. 在开发模式下，广告系统应显示带有播放图标的视频占位符

### 需求 3：多重推荐广告

**用户故事：** 作为阅读完文章的博客读者，我希望看到相关内容推荐，这样我可以发现更多有趣的内容。

#### 验收标准

1. 广告系统应支持用于推荐样式广告的 `multiplex` 格式
2. 当渲染 MultiplexAd 时，广告系统应使用 `data-ad-format="autorelaxed"` 以获得原生外观
3. 广告系统应为多重推荐广告预留最小 280px 高度
4. 当放置在文章底部时，MultiplexAd 应与网站的视觉风格融合

### 需求 4：锚定（粘性）广告

**用户故事：** 作为内容发布者，我希望在页面底部有一个非侵入性的粘性广告，这样我可以最大化广告可见度而不阻挡内容。

#### 验收标准

1. 广告系统应支持用于粘性底部广告的 `anchor` 格式
2. 当渲染 AnchorAd 时，广告系统应将其固定定位在视口底部
3. AnchorAd 应包含一个可见的关闭按钮供用户关闭
4. 当用户点击关闭按钮时，广告系统应在会话期间隐藏锚定广告
5. AnchorAd 应具有最大 100px 高度以最小化内容遮挡
6. 如果用户已关闭锚定广告，则广告系统在会话期间不应再次显示

### 需求 5：配置扩展

**用户故事：** 作为开发者，我希望所有广告类型都有集中配置，这样我可以轻松管理广告位和设置。

#### 验收标准

1. ADSENSE_CONFIG 应包含以下广告位 ID：blogBanner、blogSidebar、homeBanner、vertical、outstream、multiplex、anchor
2. 当广告组件在没有有效广告位 ID 的情况下渲染时，广告系统在生产环境中应不渲染任何内容
3. 广告系统应从带有 `NEXT_PUBLIC_ADSENSE_` 前缀的环境变量中读取所有广告位 ID
4. 当环境变量缺失时，广告系统应使用空字符串作为默认值

### 需求 6：博客列表页广告

**用户故事：** 作为内容发布者，我希望在博客列表页上有广告，这样我可以在高流量页面上实现变现。

#### 验收标准

1. 当博客列表页（`/blog`）加载时，广告系统应在文章网格上方渲染 BlogBannerAd
2. 当博客分页页面（`/blog/page/[page]`）加载时，广告系统应在文章网格上方渲染 BlogBannerAd
3. 广告投放不应影响页面的初始渲染性能（LCP）

### 需求 7：文章内容广告注入

**用户故事：** 作为内容发布者，我希望广告自动插入到长文章中，这样我可以在不需要在每篇文章中手动放置的情况下实现变现。

#### 验收标准

1. 当文章有 5 个或更多段落时，广告系统应在第 2-3 段后注入一个 OutstreamVideoAd
2. 当文章有 10 个或更多段落时，广告系统应注入第二个广告，间隔至少 4 个段落
3. 无论文章长度如何，广告系统每篇文章最多注入 2 个广告
4. 如果文章少于 5 个段落，则广告系统不应注入任何文章内广告

---

## 备注

本需求文档遵循：

1. **使用的 EARS 模式**：
   - 普遍性（THE...SHALL）
   - 事件驱动（WHEN...SHALL）
   - 状态驱动（WHILE...SHALL）
   - 异常事件（IF...THEN...SHALL）

2. **INCOSE 合规性**：
   - 全程使用主动语态
   - 具体、可衡量的条件（如"300×600 像素"、"200px 边距"）
   - 术语表中定义的术语
   - 每个需求一个思想

3. **可测试性考虑**：
   - 所有尺寸需求都是可衡量的
   - 所有状态变化都是可观察的
   - 配置需求支持属性测试
