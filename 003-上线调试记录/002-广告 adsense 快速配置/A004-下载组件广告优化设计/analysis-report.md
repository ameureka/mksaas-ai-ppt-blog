# 下载组件广告优化设计 - 综合分析报告

**分析日期**: 2025-12-04
**分析范围**: 下载组件、广告系统、积分系统、数据库、API 全链路
**分析深度**: 深度分析

---

## 一、现状分析

### 1.1 下载组件架构

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        下载组件架构总览                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  src/components/ppt/download/                                                │
│  ├── download-modal.tsx          # 主下载弹窗 (3步流程)                      │
│  │   ├── Step 1: 选择下载方式                                                │
│  │   │   ├── 🎁 首次免费下载 (条件: 首次)                                    │
│  │   │   ├── 💎 积分下载 (需要积分)                                          │
│  │   │   ├── 📺 观看广告下载 (30秒视频) ← 核心优化点                         │
│  │   │   └── 🎉 注册获得积分 (未登录用户)                                    │
│  │   ├── Step 2: 确认 (广告播放/积分扣除)                                    │
│  │   └── Step 3: 下载 (生成链接)                                             │
│  │                                                                           │
│  └── download-options-modal.tsx  # 备选下载弹窗 (卡片式选择)                 │
│      └── 类似功能，不同 UI 风格                                              │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 当前广告实现状态

| 功能 | 状态 | 说明 |
|------|------|------|
| 广告选项 UI | ✅ 已实现 | 显示"观看广告下载"选项 |
| 广告倒计时 | ✅ 已实现 | 30秒倒计时 + 进度条 |
| 广告完成检测 | ⚠️ Mock | 仅前端倒计时，无真实广告 |
| 广告 API 对接 | ❌ 未实现 | 无激励视频 SDK |
| 广告完成验证 | ❌ 未实现 | 后端无验证逻辑 |
| 积分发放 | ❌ 未实现 | 观看广告后未发放积分 |

### 1.3 关键代码分析

**download-modal.tsx 广告逻辑 (第 ~200-230 行)**:
```typescript
// 当前实现: 纯前端倒计时，无真实广告
useEffect(() => {
  if (selectedMethod === 'ad' && step === 2 && adCountdown > 0) {
    const timer = setInterval(() => {
      setAdCountdown((prev) => {
        if (prev <= 1) {
          setAdCompleted(true);  // ⚠️ 仅前端标记完成
          clearInterval(timer);
          return 0;
        }
        return prev - 1;
      });
    }, 1000);
    return () => clearInterval(timer);
  }
}, [selectedMethod, step, adCountdown]);
```

**问题**:
1. 无真实广告视频播放
2. 无后端验证广告观看
3. 无积分发放逻辑
4. 用户可通过刷新绕过

---

## 二、数据链路分析

### 2.1 下载 API 链路

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        下载 API 数据链路                                      │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  前端 (download-modal.tsx)                                                   │
│        │                                                                     │
│        ↓ POST /api/ppts/{id}/download                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  API Route (src/app/api/ppts/[id]/download/route.ts)                │    │
│  │                                                                      │    │
│  │  1. 检查 pptRequireLoginForDownload 开关                             │    │
│  │     └─ 当前: false (不需要登录)                                      │    │
│  │                                                                      │    │
│  │  2. 调用 getPPTById(id)                                              │    │
│  │     └─ 从数据库获取 PPT 详情                                         │    │
│  │                                                                      │    │
│  │  3. 调用 recordDownload(id)                                          │    │
│  │     └─ 记录下载次数 (best-effort)                                    │    │
│  │                                                                      │    │
│  │  4. 返回 { success: true, data: { fileUrl } }                        │    │
│  │                                                                      │    │
│  │  ⚠️ 缺失:                                                            │    │
│  │  - 无下载方式 (method) 参数处理                                      │    │
│  │  - 无积分扣除逻辑                                                    │    │
│  │  - 无广告验证逻辑                                                    │    │
│  │  - 无首次免费检查                                                    │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Actions (src/actions/ppt/ppt.ts)                                   │    │
│  │  ├── getPPTById(id) → 查询 ppt 表                                   │    │
│  │  └── recordDownload(id) → 更新 download_count                       │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│        │                                                                     │
│        ↓                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  Database (PostgreSQL via Drizzle)                                  │    │
│  │  ├── ppt 表: id, title, file_url, download_count, ...               │    │
│  │  └── ⚠️ 缺失: user_download_history 表 (记录用户下载历史)           │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 积分系统链路

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        积分系统数据链路                                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  配置层 (src/config/website.tsx)                                             │
│  └── credits: {                                                              │
│        enableCredits: false,  ← ⚠️ 当前禁用                                  │
│        registerGiftCredits: { enable: true, amount: 50 }                     │
│      }                                                                       │
│                                                                              │
│  类型定义 (src/credits/types.ts)                                             │
│  └── CREDIT_TRANSACTION_TYPE: {                                              │
│        REGISTER_GIFT,      // 注册赠送                                       │
│        PURCHASE_PACKAGE,   // 购买积分包                                     │
│        USAGE,              // 使用消耗                                       │
│        ...                                                                   │
│      }                                                                       │
│      ⚠️ 缺失: AD_REWARD (广告奖励) 类型                                      │
│                                                                              │
│  Hooks (src/hooks/use-credits.ts)                                            │
│  ├── useCreditBalance()     // 查询余额                                      │
│  ├── useCreditStats()       // 查询统计                                      │
│  └── useConsumeCredits()    // 消耗积分                                      │
│      ⚠️ 缺失: useEarnCredits() (获得积分，用于广告奖励)                      │
│                                                                              │
│  Actions                                                                     │
│  ├── getCreditBalanceAction                                                  │
│  ├── getCreditStatsAction                                                    │
│  └── consumeCreditsAction                                                    │
│      ⚠️ 缺失: earnCreditsAction (广告奖励积分)                               │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

### 2.3 数据库表结构分析

**现有表**:
- `ppt`: PPT 模板信息 (id, title, file_url, download_count, ...)
- `user`: 用户信息
- `user_credit`: 用户积分余额 (如果启用)
- `credit_transaction`: 积分交易记录 (如果启用)

**缺失表**:
- `user_download_history`: 用户下载历史 (用于首次免费检查)
- `ad_watch_record`: 广告观看记录 (用于防刷)

---

## 三、问题清单

### 3.1 核心问题

| 编号 | 问题 | 严重程度 | 影响 |
|------|------|----------|------|
| P1 | 无真实激励视频广告 | 🔴 高 | 无法产生广告收益 |
| P2 | 广告完成无后端验证 | 🔴 高 | 可被绕过，安全风险 |
| P3 | 积分系统未启用 | 🟡 中 | 积分下载功能无效 |
| P4 | 无用户下载历史 | 🟡 中 | 首次免费无法判断 |
| P5 | 下载 API 无方式区分 | 🟡 中 | 无法统计不同下载方式 |

### 3.2 技术债务

| 编号 | 问题 | 说明 |
|------|------|------|
| T1 | Mock 数据未清理 | fetchUserDownloadStatus 使用 mock 数据 |
| T2 | 两个下载组件重复 | download-modal 和 download-options-modal 功能重叠 |
| T3 | 硬编码配置 | 广告时长 30s、积分价格 5 等硬编码 |

---

## 四、广告方案选型

### 4.1 激励视频广告 SDK 对比

| SDK | 优点 | 缺点 | 适用场景 |
|-----|------|------|----------|
| **Google AdMob** | 填充率高、收益稳定 | 需要移动端 SDK | 移动 App |
| **Google AdSense** | 已集成、Web 原生 | 无激励视频格式 | Web 展示广告 |
| **Unity Ads** | 激励视频成熟 | 主要面向游戏 | 游戏应用 |
| **ironSource** | 激励视频专业 | 集成复杂 | 大型应用 |
| **自建广告系统** | 完全可控 | 开发成本高 | 自有广告资源 |

### 4.2 推荐方案: 渐进式实现

**阶段 1: 模拟广告 + 积分系统** (短期)
- 保持当前 30s 倒计时 UI
- 启用积分系统
- 实现广告观看 → 积分发放
- 添加后端验证

**阶段 2: 第三方广告 SDK** (中期)
- 集成 Google AdSense 视频广告 (如果支持)
- 或集成 Unity Ads Web SDK
- 实现真实广告播放

**阶段 3: 自建广告系统** (长期)
- 对接广告主
- 自建广告投放系统
- 完整的广告追踪

---

## 五、组件关系图

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                        组件关系图                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  PPT 详情页 (src/app/[locale]/(marketing)/ppt/[id]/page.tsx)                 │
│        │                                                                     │
│        ├─→ DownloadModal (主下载弹窗)                                        │
│        │     │                                                               │
│        │     ├─→ authClient.useSession() (获取登录状态)                      │
│        │     │                                                               │
│        │     ├─→ fetchUserDownloadStatus() (获取下载状态) ← Mock             │
│        │     │                                                               │
│        │     ├─→ POST /api/ppts/{id}/download (生成下载链接)                 │
│        │     │     │                                                         │
│        │     │     ├─→ getPPTById() (查询 PPT)                               │
│        │     │     └─→ recordDownload() (记录下载)                           │
│        │     │                                                               │
│        │     └─→ 广告播放 (当前: 前端倒计时 Mock)                            │
│        │                                                                     │
│        └─→ DownloadOptionsModal (备选弹窗，功能类似)                         │
│                                                                              │
│  依赖关系:                                                                   │
│  ├── @/components/ui/* (UI 组件)                                             │
│  ├── @/lib/auth-client (认证)                                                │
│  └── @/hooks/use-credits (积分，未使用)                                      │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、配置依赖分析

### 6.1 关键配置项

```typescript
// src/config/website.tsx

websiteConfig.features.pptRequireLoginForDownload = false
// 影响: 下载 API 是否需要登录
// 当前: 不需要登录即可下载

websiteConfig.credits.enableCredits = false
// 影响: 积分系统是否启用
// 当前: 禁用，积分下载功能无效

websiteConfig.credits.registerGiftCredits = { enable: true, amount: 50 }
// 影响: 注册赠送积分
// 当前: 启用，但积分系统禁用所以无效
```

### 6.2 环境变量依赖

```bash
# 广告相关 (已配置)
NEXT_PUBLIC_ADSENSE_ENABLED
NEXT_PUBLIC_ADSENSE_PUBLISHER_ID
NEXT_PUBLIC_ADSENSE_*_SLOT

# 积分相关 (无专门环境变量，通过 websiteConfig 控制)

# 下载相关 (无专门环境变量)
```

---

## 七、安全风险分析

### 7.1 当前风险

| 风险 | 严重程度 | 说明 |
|------|----------|------|
| 广告绕过 | 🔴 高 | 用户可刷新页面绕过广告倒计时 |
| 积分刷取 | 🟡 中 | 如果启用积分，无防刷机制 |
| 下载滥用 | 🟡 中 | 无下载频率限制 |

### 7.2 建议防护措施

1. **广告验证 Token**: 后端生成 token，广告完成后验证
2. **IP 限制**: 同一 IP 每日广告观看次数限制
3. **用户限制**: 同一用户每日广告观看次数限制
4. **下载频率限制**: 每日下载次数限制

---

## 八、下一步行动建议

### 短期 (1-2 天) - 阶段 1

1. **启用积分系统**
   - 修改 `websiteConfig.credits.enableCredits = true`
   - 验证积分相关功能正常

2. **添加广告奖励积分类型**
   - 在 `CREDIT_TRANSACTION_TYPE` 添加 `AD_REWARD`
   - 实现 `earnCreditsAction` 用于广告奖励

3. **完善下载 API**
   - 添加 `method` 参数支持
   - 实现不同下载方式的处理逻辑

4. **添加广告验证 Token**
   - 生成广告观看 token
   - 后端验证 token 有效性

### 中期 (1 周) - 阶段 2

1. **创建用户下载历史表**
   - 记录用户下载历史
   - 实现首次免费检查

2. **集成真实广告 SDK**
   - 评估可用的 Web 激励视频 SDK
   - 实现广告播放和回调

3. **添加防刷机制**
   - IP 限制
   - 用户限制
   - 频率限制

### 长期 (持续优化) - 阶段 3

1. **广告效果分析**
   - 广告观看完成率
   - 广告收益统计

2. **A/B 测试**
   - 不同广告时长测试
   - 不同积分奖励测试

---

**分析完成时间**: 2025-12-04
**分析结论**: 下载组件广告功能框架已搭建，但核心的广告播放、后端验证、积分发放均未实现，需要分阶段完善。
