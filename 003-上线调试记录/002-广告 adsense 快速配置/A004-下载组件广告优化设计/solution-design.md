# ä¸‹è½½ç»„ä»¶å¹¿å‘Šä¼˜åŒ–è®¾è®¡ - è§£å†³æ–¹æ¡ˆ

**è®¾è®¡æ—¥æœŸ**: 2025-12-04
**ç‰ˆæœ¬**: 1.0

---

## ä¸€ã€è§£å†³æ–¹æ¡ˆæ¦‚è¿°

### 1.1 ç›®æ ‡

å°†ä¸‹è½½ç»„ä»¶çš„"è§‚çœ‹å¹¿å‘Šä¸‹è½½"åŠŸèƒ½ä» Mock å®ç°å‡çº§ä¸ºå¯ç”¨çš„ç”Ÿäº§çº§åŠŸèƒ½ï¼Œå®ç°ï¼š
1. å¹¿å‘Šè§‚çœ‹ â†’ ç§¯åˆ†å¥–åŠ± â†’ ä¸‹è½½è§£é”
2. åç«¯éªŒè¯é˜²æ­¢ç»•è¿‡
3. é˜²åˆ·æœºåˆ¶ä¿æŠ¤

### 1.2 æ–¹æ¡ˆé€‰æ‹©

**æ¨èæ–¹æ¡ˆ: ç§¯åˆ†å¥–åŠ±æ¨¡å¼ (æ— çœŸå®å¹¿å‘Š)**

ç”±äº Web ç«¯æ¿€åŠ±è§†é¢‘å¹¿å‘Š SDK é€‰æ‹©æœ‰é™ä¸”é›†æˆå¤æ‚ï¼Œå»ºè®®é‡‡ç”¨"æ¨¡æ‹Ÿå¹¿å‘Š + ç§¯åˆ†å¥–åŠ±"æ¨¡å¼ï¼š
- ä¿æŒå½“å‰ 30s å€’è®¡æ—¶ UI
- ç”¨æˆ·è§‚çœ‹å®Œæˆåè·å¾—ç§¯åˆ†å¥–åŠ±
- ç§¯åˆ†å¯ç”¨äºä¸‹è½½ PPT

**ä¼˜åŠ¿**:
- å¼€å‘æˆæœ¬ä½
- ç”¨æˆ·ä½“éªŒä¸€è‡´
- å¯éšæ—¶å‡çº§ä¸ºçœŸå®å¹¿å‘Š

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ä¼˜åŒ–åçš„ä¸‹è½½æµç¨‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  ç”¨æˆ·ç‚¹å‡»ä¸‹è½½                                                                â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â†“                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 1: é€‰æ‹©ä¸‹è½½æ–¹å¼                                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚    â”‚
â”‚  â”‚  â”‚ ğŸ é¦–æ¬¡å…è´¹ä¸‹è½½  â”‚ â”‚ ğŸ’ ç§¯åˆ†ä¸‹è½½     â”‚ â”‚ ğŸ“º è§‚çœ‹å¹¿å‘Šä¸‹è½½  â”‚        â”‚    â”‚
â”‚  â”‚  â”‚ (æ£€æŸ¥ä¸‹è½½å†å²)  â”‚ â”‚ (æ£€æŸ¥ç§¯åˆ†ä½™é¢)  â”‚ â”‚ (30ç§’ç­‰å¾…)      â”‚        â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â†“ é€‰æ‹© "è§‚çœ‹å¹¿å‘Šä¸‹è½½"                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 2: å¹¿å‘Šè§‚çœ‹                                                    â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  1. å‰ç«¯è¯·æ±‚ POST /api/ad/start-watch                                â”‚    â”‚
â”‚  â”‚     â””â”€ åç«¯ç”Ÿæˆ watchToken + è®°å½•å¼€å§‹æ—¶é—´                            â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  2. å‰ç«¯æ˜¾ç¤º 30s å€’è®¡æ—¶ + å¹¿å‘Šå†…å®¹                                   â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  3. å€’è®¡æ—¶ç»“æŸï¼Œè¯·æ±‚ POST /api/ad/complete-watch                     â”‚    â”‚
â”‚  â”‚     â””â”€ åç«¯éªŒè¯:                                                     â”‚    â”‚
â”‚  â”‚        - watchToken æœ‰æ•ˆæ€§                                           â”‚    â”‚
â”‚  â”‚        - æ—¶é—´é—´éš” >= 30s                                             â”‚    â”‚
â”‚  â”‚        - ç”¨æˆ·ä»Šæ—¥è§‚çœ‹æ¬¡æ•° < é™åˆ¶                                     â”‚    â”‚
â”‚  â”‚     â””â”€ éªŒè¯é€šè¿‡: å‘æ”¾ç§¯åˆ† + è¿”å› downloadToken                       â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚        â”‚                                                                     â”‚
â”‚        â†“ å¹¿å‘Šå®Œæˆ                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Step 3: ä¸‹è½½                                                        â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  è¯·æ±‚ POST /api/ppts/{id}/download                                   â”‚    â”‚
â”‚  â”‚  â””â”€ body: { method: 'ad', downloadToken }                            â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â”‚  åç«¯éªŒè¯ downloadToken â†’ è¿”å› fileUrl                               â”‚    â”‚
â”‚  â”‚                                                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ•°æ®åº“è®¾è®¡

#### æ–°å¢è¡¨: ad_watch_record (å¹¿å‘Šè§‚çœ‹è®°å½•)

```sql
CREATE TABLE ad_watch_record (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user(id),
  ip_address VARCHAR(45),
  watch_token VARCHAR(64) UNIQUE NOT NULL,
  download_token VARCHAR(64),
  started_at TIMESTAMP NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMP,
  status VARCHAR(20) NOT NULL DEFAULT 'pending', -- pending, completed, expired
  credits_awarded INTEGER DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_ad_watch_user_id ON ad_watch_record(user_id);
CREATE INDEX idx_ad_watch_ip ON ad_watch_record(ip_address);
CREATE INDEX idx_ad_watch_token ON ad_watch_record(watch_token);
CREATE INDEX idx_ad_watch_created ON ad_watch_record(created_at);
```

#### æ–°å¢è¡¨: user_download_history (ç”¨æˆ·ä¸‹è½½å†å²)

```sql
CREATE TABLE user_download_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES user(id),
  ppt_id VARCHAR(64) NOT NULL,
  download_method VARCHAR(20) NOT NULL, -- firstFree, credits, ad
  credits_spent INTEGER DEFAULT 0,
  ip_address VARCHAR(45),
  downloaded_at TIMESTAMP NOT NULL DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_download_user_ppt ON user_download_history(user_id, ppt_id);
CREATE INDEX idx_download_user ON user_download_history(user_id);
```

### 2.3 API è®¾è®¡

#### POST /api/ad/start-watch

**è¯·æ±‚**:
```typescript
{
  pptId: string;  // è¦ä¸‹è½½çš„ PPT ID
}
```

**å“åº”**:
```typescript
{
  success: boolean;
  data?: {
    watchToken: string;    // è§‚çœ‹ä»¤ç‰Œ
    duration: number;      // éœ€è¦è§‚çœ‹çš„ç§’æ•° (30)
    expiresAt: string;     // ä»¤ç‰Œè¿‡æœŸæ—¶é—´
  };
  error?: string;
}
```

**é€»è¾‘**:
1. æ£€æŸ¥ç”¨æˆ·ä»Šæ—¥è§‚çœ‹æ¬¡æ•° (IP + userId)
2. ç”Ÿæˆ watchToken (JWT æˆ–éšæœºå­—ç¬¦ä¸²)
3. è®°å½•åˆ° ad_watch_record è¡¨
4. è¿”å› watchToken

#### POST /api/ad/complete-watch

**è¯·æ±‚**:
```typescript
{
  watchToken: string;
  pptId: string;
}
```

**å“åº”**:
```typescript
{
  success: boolean;
  data?: {
    downloadToken: string;  // ä¸‹è½½ä»¤ç‰Œ
    creditsAwarded: number; // è·å¾—çš„ç§¯åˆ†
    newBalance: number;     // æ–°ç§¯åˆ†ä½™é¢
  };
  error?: string;
}
```

**é€»è¾‘**:
1. éªŒè¯ watchToken æœ‰æ•ˆæ€§
2. æ£€æŸ¥æ—¶é—´é—´éš” >= 30s
3. æ£€æŸ¥æ˜¯å¦å·²å®Œæˆ
4. å‘æ”¾ç§¯åˆ† (å¦‚æœå¯ç”¨)
5. ç”Ÿæˆ downloadToken
6. æ›´æ–° ad_watch_record çŠ¶æ€

#### POST /api/ppts/{id}/download (ä¿®æ”¹)

**è¯·æ±‚**:
```typescript
{
  method: 'firstFree' | 'credits' | 'ad';
  downloadToken?: string;  // ad æ–¹å¼å¿…éœ€
}
```

**å“åº”**:
```typescript
{
  success: boolean;
  data?: {
    fileUrl: string;
    expiresAt: string;
  };
  error?: string;
}
```

**é€»è¾‘**:
```typescript
switch (method) {
  case 'firstFree':
    // æ£€æŸ¥æ˜¯å¦é¦–æ¬¡ä¸‹è½½æ­¤ PPT
    // æ£€æŸ¥ç”¨æˆ·ä¸‹è½½å†å²
    break;
  case 'credits':
    // æ£€æŸ¥ç§¯åˆ†ä½™é¢
    // æ‰£é™¤ç§¯åˆ†
    break;
  case 'ad':
    // éªŒè¯ downloadToken
    // æ£€æŸ¥ token æ˜¯å¦å·²ä½¿ç”¨
    break;
}
// è®°å½•ä¸‹è½½å†å²
// è¿”å› fileUrl
```

### 2.4 å‰ç«¯ä¿®æ”¹

#### download-modal.tsx ä¿®æ”¹

```typescript
// æ–°å¢çŠ¶æ€
const [watchToken, setWatchToken] = useState<string | null>(null);
const [downloadToken, setDownloadToken] = useState<string | null>(null);

// å¼€å§‹è§‚çœ‹å¹¿å‘Š
const handleStartAdWatch = async () => {
  try {
    const res = await fetch('/api/ad/start-watch', {
      method: 'POST',
      body: JSON.stringify({ pptId: ppt.id }),
    });
    const json = await res.json();
    if (json.success) {
      setWatchToken(json.data.watchToken);
      setStep(2);
      // å¼€å§‹å€’è®¡æ—¶
    } else {
      toast.error(json.error);
    }
  } catch (err) {
    toast.error('å¯åŠ¨å¹¿å‘Šå¤±è´¥');
  }
};

// å¹¿å‘Šè§‚çœ‹å®Œæˆ
const handleAdComplete = async () => {
  try {
    const res = await fetch('/api/ad/complete-watch', {
      method: 'POST',
      body: JSON.stringify({ watchToken, pptId: ppt.id }),
    });
    const json = await res.json();
    if (json.success) {
      setDownloadToken(json.data.downloadToken);
      setAdCompleted(true);
      toast.success(`è·å¾— ${json.data.creditsAwarded} ç§¯åˆ†ï¼`);
    } else {
      toast.error(json.error);
    }
  } catch (err) {
    toast.error('éªŒè¯å¹¿å‘Šå¤±è´¥');
  }
};

// ç”Ÿæˆä¸‹è½½é“¾æ¥
const handleGenerateLink = async () => {
  const body: any = { method: selectedMethod };
  if (selectedMethod === 'ad') {
    body.downloadToken = downloadToken;
  }

  const res = await fetch(`/api/ppts/${ppt.id}/download`, {
    method: 'POST',
    body: JSON.stringify(body),
  });
  // ...
};
```

### 2.5 ç§¯åˆ†ç³»ç»Ÿä¿®æ”¹

#### æ·»åŠ å¹¿å‘Šå¥–åŠ±ç±»å‹

```typescript
// src/credits/types.ts
export enum CREDIT_TRANSACTION_TYPE {
  // ... ç°æœ‰ç±»å‹
  AD_REWARD = 'AD_REWARD',  // æ–°å¢: å¹¿å‘Šå¥–åŠ±
}
```

#### æ·»åŠ è·å¾—ç§¯åˆ† Action

```typescript
// src/actions/earn-credits.ts
export async function earnCreditsAction({
  amount,
  type,
  description,
}: {
  amount: number;
  type: CREDIT_TRANSACTION_TYPE;
  description: string;
}) {
  // 1. è·å–å½“å‰ç”¨æˆ·
  // 2. å¢åŠ ç§¯åˆ†ä½™é¢
  // 3. è®°å½•äº¤æ˜“
  // 4. è¿”å›æ–°ä½™é¢
}
```

### 2.6 é…ç½®ä¿®æ”¹

```typescript
// src/config/website.tsx
websiteConfig.credits.enableCredits = true;  // å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ

// æ–°å¢å¹¿å‘Šé…ç½®
websiteConfig.adReward = {
  enable: true,
  creditsPerWatch: 5,        // æ¯æ¬¡è§‚çœ‹è·å¾—ç§¯åˆ†
  watchDuration: 30,         // è§‚çœ‹æ—¶é•¿ (ç§’)
  dailyLimitPerUser: 10,     // æ¯ç”¨æˆ·æ¯æ—¥é™åˆ¶
  dailyLimitPerIP: 20,       // æ¯ IP æ¯æ—¥é™åˆ¶
};
```

---

## ä¸‰ã€é˜²åˆ·æœºåˆ¶

### 3.1 å¤šå±‚é˜²æŠ¤

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é˜²åˆ·æœºåˆ¶                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Layer 1: å‰ç«¯é˜²æŠ¤                                                           â”‚
â”‚  â”œâ”€â”€ å€’è®¡æ—¶ä¸å¯è·³è¿‡                                                          â”‚
â”‚  â”œâ”€â”€ é¡µé¢åˆ‡æ¢æ£€æµ‹ (visibilitychange)                                         â”‚
â”‚  â””â”€â”€ ç¦ç”¨å¼€å‘è€…å·¥å…·ä¿®æ”¹ (åŸºç¡€)                                               â”‚
â”‚                                                                              â”‚
â”‚  Layer 2: Token éªŒè¯                                                         â”‚
â”‚  â”œâ”€â”€ watchToken ä¸€æ¬¡æ€§ä½¿ç”¨                                                   â”‚
â”‚  â”œâ”€â”€ downloadToken ä¸€æ¬¡æ€§ä½¿ç”¨                                                â”‚
â”‚  â””â”€â”€ Token è¿‡æœŸæ—¶é—´ (5åˆ†é’Ÿ)                                                  â”‚
â”‚                                                                              â”‚
â”‚  Layer 3: æ—¶é—´éªŒè¯                                                           â”‚
â”‚  â”œâ”€â”€ æœåŠ¡ç«¯è®°å½•å¼€å§‹æ—¶é—´                                                      â”‚
â”‚  â”œâ”€â”€ å®Œæˆæ—¶éªŒè¯æ—¶é—´é—´éš” >= 30s                                               â”‚
â”‚  â””â”€â”€ å…è®¸ Â±5s è¯¯å·®                                                           â”‚
â”‚                                                                              â”‚
â”‚  Layer 4: é¢‘ç‡é™åˆ¶                                                           â”‚
â”‚  â”œâ”€â”€ æ¯ç”¨æˆ·æ¯æ—¥é™åˆ¶ (10æ¬¡)                                                   â”‚
â”‚  â”œâ”€â”€ æ¯ IP æ¯æ—¥é™åˆ¶ (20æ¬¡)                                                   â”‚
â”‚  â””â”€â”€ å…¨å±€æ¯å°æ—¶é™åˆ¶ (å¯é€‰)                                                   â”‚
â”‚                                                                              â”‚
â”‚  Layer 5: å¼‚å¸¸æ£€æµ‹ (å¯é€‰)                                                    â”‚
â”‚  â”œâ”€â”€ å¼‚å¸¸å¿«é€Ÿå®Œæˆæ£€æµ‹                                                        â”‚
â”‚  â”œâ”€â”€ æ‰¹é‡è¯·æ±‚æ£€æµ‹                                                            â”‚
â”‚  â””â”€â”€ è®¾å¤‡æŒ‡çº¹æ£€æµ‹                                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 å®ç°ä»£ç 

```typescript
// src/lib/ad-watch-limiter.ts

const DAILY_LIMIT_PER_USER = 10;
const DAILY_LIMIT_PER_IP = 20;
const MIN_WATCH_DURATION = 25; // å…è®¸ 5s è¯¯å·®

export async function checkAdWatchLimit(userId?: string, ip?: string) {
  const today = new Date().toISOString().split('T')[0];

  // æ£€æŸ¥ç”¨æˆ·é™åˆ¶
  if (userId) {
    const userCount = await db.query(
      `SELECT COUNT(*) FROM ad_watch_record
       WHERE user_id = $1 AND DATE(created_at) = $2 AND status = 'completed'`,
      [userId, today]
    );
    if (userCount >= DAILY_LIMIT_PER_USER) {
      return { allowed: false, reason: 'ä»Šæ—¥è§‚çœ‹æ¬¡æ•°å·²è¾¾ä¸Šé™' };
    }
  }

  // æ£€æŸ¥ IP é™åˆ¶
  if (ip) {
    const ipCount = await db.query(
      `SELECT COUNT(*) FROM ad_watch_record
       WHERE ip_address = $1 AND DATE(created_at) = $2 AND status = 'completed'`,
      [ip, today]
    );
    if (ipCount >= DAILY_LIMIT_PER_IP) {
      return { allowed: false, reason: 'å½“å‰ç½‘ç»œè§‚çœ‹æ¬¡æ•°å·²è¾¾ä¸Šé™' };
    }
  }

  return { allowed: true };
}

export function validateWatchDuration(startedAt: Date, completedAt: Date) {
  const duration = (completedAt.getTime() - startedAt.getTime()) / 1000;
  return duration >= MIN_WATCH_DURATION;
}
```

---

## å››ã€æ–‡ä»¶å˜æ›´æ¸…å•

### 4.1 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/app/api/ad/start-watch/route.ts` | å¼€å§‹è§‚çœ‹å¹¿å‘Š API |
| `src/app/api/ad/complete-watch/route.ts` | å®Œæˆè§‚çœ‹å¹¿å‘Š API |
| `src/db/schema/ad-watch.ts` | å¹¿å‘Šè§‚çœ‹è®°å½•è¡¨ schema |
| `src/db/schema/download-history.ts` | ä¸‹è½½å†å²è¡¨ schema |
| `src/actions/ad/start-watch.ts` | å¼€å§‹è§‚çœ‹ action |
| `src/actions/ad/complete-watch.ts` | å®Œæˆè§‚çœ‹ action |
| `src/actions/earn-credits.ts` | è·å¾—ç§¯åˆ† action |
| `src/lib/ad-watch-limiter.ts` | é˜²åˆ·é™åˆ¶å™¨ |

### 4.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `src/config/website.tsx` | æ·»åŠ å¹¿å‘Šå¥–åŠ±é…ç½® |
| `src/credits/types.ts` | æ·»åŠ  AD_REWARD ç±»å‹ |
| `src/app/api/ppts/[id]/download/route.ts` | æ·»åŠ  method å‚æ•°å¤„ç† |
| `src/components/ppt/download/download-modal.tsx` | é›†æˆå¹¿å‘Š API |
| `src/hooks/use-credits.ts` | æ·»åŠ  useEarnCredits hook |

### 4.3 æ•°æ®åº“è¿ç§»

```bash
# ç”Ÿæˆè¿ç§»
pnpm db:generate

# æ‰§è¡Œè¿ç§»
pnpm db:migrate
```

---

## äº”ã€å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€è®¾æ–½ (Day 1)

1. åˆ›å»ºæ•°æ®åº“è¡¨
2. å®ç°å¹¿å‘Šè§‚çœ‹ API
3. å®ç°é˜²åˆ·é™åˆ¶å™¨

### Phase 2: ç§¯åˆ†é›†æˆ (Day 1-2)

1. å¯ç”¨ç§¯åˆ†ç³»ç»Ÿ
2. æ·»åŠ å¹¿å‘Šå¥–åŠ±ç±»å‹
3. å®ç°ç§¯åˆ†å‘æ”¾é€»è¾‘

### Phase 3: å‰ç«¯é›†æˆ (Day 2)

1. ä¿®æ”¹ download-modal.tsx
2. é›†æˆå¹¿å‘Š API
3. æ·»åŠ ç§¯åˆ†æ˜¾ç¤º

### Phase 4: æµ‹è¯•éªŒè¯ (Day 3)

1. åŠŸèƒ½æµ‹è¯•
2. é˜²åˆ·æµ‹è¯•
3. è¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## å…­ã€é£é™©ä¸å›æ»š

### 6.1 é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|------|--------|------|----------|
| ç§¯åˆ†ç³»ç»Ÿ bug | ä¸­ | é«˜ | å……åˆ†æµ‹è¯•ï¼Œç°åº¦å‘å¸ƒ |
| é˜²åˆ·è¢«ç»•è¿‡ | ä½ | ä¸­ | å¤šå±‚é˜²æŠ¤ï¼Œç›‘æ§å¼‚å¸¸ |
| ç”¨æˆ·ä½“éªŒä¸‹é™ | ä½ | ä¸­ | A/B æµ‹è¯•ï¼Œæ”¶é›†åé¦ˆ |

### 6.2 å›æ»šæ–¹æ¡ˆ

```bash
# 1. ç¦ç”¨å¹¿å‘Šå¥–åŠ±
websiteConfig.adReward.enable = false

# 2. å›æ»šä»£ç 
git revert <commit-hash>

# 3. å›æ»šæ•°æ®åº“ (å¦‚éœ€)
pnpm db:rollback
```

---

**è®¾è®¡å®Œæˆæ—¶é—´**: 2025-12-04
**é¢„ä¼°å·¥ä½œé‡**: 3-4 å¤©
**ä¼˜å…ˆçº§**: ğŸŸ¡ ä¸­
