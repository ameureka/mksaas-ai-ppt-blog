# 首页校验与深度系统架构分析报告

**日期**: 2025年12月3日
**状态**: 🔴 待修复 (Critical Fixes Required)
**分析范围**: PPT核心业务链路 (DB -> Action -> API -> Frontend)
**校验状态**: ✅ 已校验 (2025年12月3日)

---

## 0. 报告校验结论

> ⚠️ **重要更新**: 本报告经过深度代码校验，发现以下问题需要修正或补充。详细分析见 `03-PPTCategory类型定义技术债务深度分析报告.md`。

### 校验结果摘要

| 原报告内容 | 校验结果 | 说明 |
|------------|----------|------|
| 阻断点1: 分类常量不一致 | ✅ 正确 | API Route 确实缺少 `summary`, `proposal` 等分类 |
| 阻断点2: Tags 数据链路断裂 | ✅ 正确 | `toPPTDto` 确实未映射 `tags` 字段 |
| 阻断点3: 搜索能力有限 | ✅ 正确 | 仅搜索 `title` 和 `author` |
| 阻断点4: DTO 映射字段缺失 | ✅ 正确 | `description` 和 `file_size` 硬编码 |
| 建议引用 `src/lib/constants/ppt.ts` | ❌ **有问题** | 该文件是**死代码**，0处引用 |

### 新发现的严重问题

1. **🔴 前端页面完全绕过类型系统** - `ppt/page.tsx` 和 `categories/page.tsx` 硬编码分类，未引用任何共享类型
2. **🔴 分类页面传中文名** - `handleCategoryClick(category.name)` 传递中文名而非 slug
3. **🔴 首页 slug 映射错误** - "培训课件"映射到 `education`，"述职报告"映射到 `business`
4. **🟡 存在 5 处重复的 PPTCategory 定义** - 类型定义散落在多个文件中

---

## 1. 现状深度诊断

经过对 codebase 的深度扫描，发现目前的系统处于 **"混合开发"** 状态。

*   **数据库层**: Schema 已定义 (`src/db/schema.ts`)，表结构基本完善，但部分字段（如 `tags` 的前端处理、`description` 缺失）与前端需求不完全对齐。
*   **逻辑层 (Actions)**: `src/actions/ppt/ppt.ts` **不是 Mock 数据**，而是已经连接了真实数据库的 Drizzle 实现。这是一个意外的发现（优于预期），但其实现非常脆弱。
    *   **搜索逻辑**: 仅支持 `ilike` (大小写不敏感匹配)，性能较差且功能单一，不支持标签搜索。
    *   **字段映射**: `toPPTDto` 函数手动映射了数据库字段到前端类型，但 `category` 字段存在硬编码 fallback (`general`)，且没有处理 `tags` (DB 中是 text array，DTO 中未映射或被忽略)。
*   **接口层 (API)**: `src/app/api/ppts/route.ts` 包含硬编码的验证逻辑 (`VALID_CATEGORIES`)，这个列表与前端页面使用的分类**不一致**。这会导致合法的分类请求被 API 层拦截。
*   **前端层**:
    *   组件中充斥着对 `preview_url` vs `previewUrl` 的混用，且对空数据的处理不够鲁棒。
    *   **⚠️ 新发现**: 前端页面 (`ppt/page.tsx`, `categories/page.tsx`) 完全硬编码分类，未引用任何共享类型文件。

---

## 2. 关键阻断点分析 (Blockers)

### 🛑 阻断点 1: 分类常量不一致导致 API 拒收请求
*   **现象**: 前端请求 `/api/ppts?category=summary` (年终总结)。
*   **根因**: `src/app/api/ppts/route.ts` 中的 `VALID_CATEGORIES` 列表**不包含** `summary`, `proposal`, `training`, `report`, `plan`。
*   **结果**: API 路由会静默忽略 `category` 参数，导致返回所有数据或空数据，前端筛选失效。

### 🛑 阻断点 2: 标签 (Tags) 数据链路断裂
*   **现象**: 前端 `PPTCard` 需要显示标签，但现在显示为空或 fallback。
*   **根因**:
    1.  **DB**: `ppt` 表有 `tags` (text[]) 字段。
    2.  **Action**: `toPPTDto` 函数中，`tags` 根本没有被赋值！(代码显示 `description: undefined`, 且未看到 `tags` 的映射)。
*   **结果**: 数据库里的标签数据无法传送到前端。

### 🛑 阻断点 3: 搜索能力极其有限
*   **现象**: 搜索 "工作汇报" 可能搜不到相关内容，必须精确匹配标题。
*   **根因**: `src/actions/ppt/ppt.ts` 中的 `buildWhere` 仅对 `title` 和 `author` 做了 `ilike` 匹配。未对 `tags` 进行搜索，也未实现分词搜索。

### 🛑 阻断点 4: DTO 映射字段缺失
*   **现象**: 详情页可能缺少 `description` 和 `file_size`。
*   **根因**:
    *   `description`: Action 中直接硬编码为 `undefined`。
    *   `file_size`: Action 中硬编码为 `''`。
*   **风险**: 前端组件虽然做了 fallback，但长期看数据是缺失的。

### 🛑 阻断点 5: 前端页面分类与后端完全脱节 (新发现)
*   **现象**: 分类页面点击后无法正确筛选数据。
*   **根因**:
    1.  `categories/page.tsx` 中 `handleCategoryClick(category.name)` 传递**中文名**（如"商务汇报"）
    2.  API Route 期望的是**英文 slug**（如 `business`）
*   **结果**: 分类筛选完全失效。

### 🛑 阻断点 6: 首页分类 slug 映射错误 (新发现)
*   **现象**: 用户点击"培训课件"实际查询的是 `education` 分类。
*   **根因**: `ppt/page.tsx` 中的 slug 映射：
    ```typescript
    { name: t('training'), slug: 'education', ... },  // 培训课件 → education
    { name: t('report'), slug: 'business', ... },     // 述职报告 → business
    { name: t('plan'), slug: 'marketing', ... },      // 营销方案 → marketing
    ```
*   **结果**: 分类统计数据完全不准确，用户体验混乱。

---

## 3. 综合解决方案 (Comprehensive Solution Plan)

我们不需要完全重写，而是需要 **"对齐"** 和 **"补全"**。

### 阶段一：核心链路修复 (立即执行)

1.  **[前端] 修复分类页面传参问题** ⚠️ 优先级最高
    *   **操作**: 修改 `src/app/[locale]/(marketing)/ppt/categories/page.tsx`
    *   **细节**: 为 `allCategories` 添加 `slug` 字段，`handleCategoryClick` 改为传递 slug

2.  **[前端] 修复首页分类 slug 映射**
    *   **操作**: 修改 `src/app/[locale]/(marketing)/ppt/page.tsx`
    *   **细节**: 修正 `categories` 数组中的 slug 映射，确保每个分类有独立的 slug

3.  **[API] 扩展分类验证**
    *   **操作**: 修改 `src/app/api/ppts/route.ts`
    *   **细节**: 扩展 `VALID_CATEGORIES` 包含所有业务需要的分类，或改为动态验证

4.  **[Action] 补全 DTO 映射**
    *   **操作**: 修改 `src/actions/ppt/ppt.ts` 中的 `toPPTDto`
    *   **细节**:
        *   映射 `tags`: `tags: row.tags ?? []`
        *   映射 `description`: 暂时映射为空字符串或 title 的复用
        *   **Schema 修正**: DB 缺少 `description` 和 `file_size` 字段，需要迁移或临时处理

5.  **[Action] 增强搜索逻辑**
    *   **操作**: 修改 `src/actions/ppt/ppt.ts` 的 `buildWhere`
    *   **细节**: 增加对 `tags` 数组的搜索支持

### 阶段二：技术债务清理 (短期执行)

1.  **删除重复类型定义文件**
    *   删除 `src/types/ppt.ts`（迁移 `src/lib/query-keys.ts` 的 import）
    *   删除 `src/schemas/ppt.ts`（无引用）

2.  **评估 `src/lib/constants/ppt.ts`**
    *   该文件当前是死代码（0引用）
    *   决定是否作为单一数据源 (SSOT) 或删除

### 阶段三：数据库补全 (建议后续执行)

1.  **Schema Migration**
    *   向 `ppt` 表添加 `description` (text) 和 `file_size` (text) 字段
    *   运行 `drizzle-kit generate` 和 `drizzle-kit migrate`

---

## 4. 具体的代码修改建议

### A. 修复 `src/app/[locale]/(marketing)/ppt/categories/page.tsx`

```typescript
const allCategories = [
  {
    name: '商务汇报',
    slug: 'business',  // 添加 slug 字段
    count: 12345,
    icon: Briefcase,
    // ...
  },
  // ... 其他分类
];

const handleCategoryClick = (categorySlug: string) => {
  router.push(PublicRoutes.Category(categorySlug));  // 传递 slug 而非 name
};

// 使用时
onClick={() => handleCategoryClick(category.slug)}
```

### B. 修复 `src/app/[locale]/(marketing)/ppt/page.tsx`

```typescript
const categories = useMemo(
  () => [
    { name: t('business'), slug: 'business', ... },
    { name: t('education'), slug: 'education', ... },
    { name: t('marketing'), slug: 'marketing', ... },
    { name: t('summary'), slug: 'summary', ... },      // 独立 slug
    { name: t('proposal'), slug: 'proposal', ... },    // 独立 slug
    { name: t('training'), slug: 'training', ... },    // 独立 slug
    { name: t('report'), slug: 'report', ... },        // 独立 slug
    { name: t('plan'), slug: 'plan', ... },            // 独立 slug
  ],
  [t]
);
```

### C. 修复 `src/app/api/ppts/route.ts`

```typescript
// 扩展分类列表，包含所有业务需要的分类
const VALID_CATEGORIES: PPTCategory[] = [
  'business',
  'product',
  'education',
  'technology',
  'creative',
  'marketing',
  'medical',
  'finance',
  'hr',
  'lifestyle',
  'general',
  // 新增业务分类
  'summary',
  'proposal',
  'training',
  'report',
  'plan',
];
```

### D. 修复 `src/actions/ppt/ppt.ts` (DTO部分)

```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  // ...
  tags: row.tags ?? [], // 修复标签丢失
  description: row.title, // 临时 fallback，直到 DB 字段添加
  file_size: '未知', // 临时 fallback
  // ...
});
```

---

## 5. 相关文档

- `03-PPTCategory类型定义技术债务深度分析报告.md` - PPTCategory 类型定义的完整分析
