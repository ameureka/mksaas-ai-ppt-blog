# 首页校验与深度系统架构分析报告

**日期**: 2025年12月3日
**状态**: 🔴 待修复 (Critical Fixes Required)
**分析范围**: PPT核心业务链路 (DB -> Action -> API -> Frontend)
**校验状态**: ✅ 已校验 (2025年12月3日) / 🔄 补充校验 (当前代码同步后)

---

## 0. 报告校验结论

> ⚠️ **重要更新**: 本报告经过深度代码校验，发现以下问题需要修正或补充。详细分析见 `03-PPTCategory类型定义技术债务深度分析报告.md`。

### 校验结果摘要

| 原报告内容 | 校验结果 | 说明 |
|------------|----------|------|
| 阻断点1: 分类常量不一致 | 🟢 已修复 | API/类型/前端均引用常量（12 类） |
| 阻断点2: Tags 数据链路断裂 | 🟢 已修复 | `toPPTDto` 已映射 `tags`，前端可接收 |
| 阻断点3: 搜索能力有限 | ⚠️ 已改进 | 现搜索 `title`/`author`/`tags`，仍为简单 ilike |
| 阻断点4: DTO 映射字段缺失 | ⚠️ 已部分修复 | `description` 回填 title，`file_size` 回填“未知” |
| 建议引用 `src/lib/constants/ppt.ts` | 🟢 已落地 | 常量为唯一来源 |

### 新发现的严重问题

1. **🟢 分类源统一** - API/类型/首页/分类页/筛选均引用常量
2. **⚠️ 搜索仍为简单 ilike** - 未做分词/高阶排序
3. **🟡 重复类型/Schema** - 仍有多处定义待清理
4. **⚠️ file_size 无真实字段** - 仅前端回填“未知”，DB 未补列

---

## 1. 现状深度诊断

经过对 codebase 的深度扫描，发现目前的系统处于 **"混合开发"** 状态。

*   **数据库层**: Schema 已定义 (`src/db/schema.ts`)，表结构基本完善，但部分字段（如 `tags` 的前端处理、`description` 缺失）与前端需求不完全对齐。
*   **逻辑层 (Actions)**: `src/actions/ppt/ppt.ts` 已连接真实数据库的 Drizzle 实现，仍较脆弱。
    *   **搜索逻辑**: 仅支持 `ilike` (大小写不敏感匹配)，性能较差且功能单一，不支持标签搜索。
    *   **字段映射**: `toPPTDto` 现映射 `tags` 与 `language`，`description` 回填 title，`file_size` 仍为空串。
*   **接口层 (API)**: 基于 `PPT_CATEGORY_VALUES`（12 类）校验；前端传未知 slug 会被忽略。
*   **前端层**:
    *   组件中仍有 `preview_url` vs `previewUrl` 混用，对空数据处理不足。
    *   首页/分类页/筛选已引用常量，分类源统一。

---

## 2. 关键阻断点分析 (Blockers)

### 🟢 阻断点 1: 分类常量已统一
*   **现状**: API/类型/前端均引用常量（12 类）。
*   **剩余**: 若常量调整需同步文案/翻译。

### 🟢 阻断点 2: 标签 (Tags) 数据链路已补齐
*   **现状**: `toPPTDto` 已映射 `tags`，前端可接收。
*   **风险**: 前端组件若未展示/校验 tags，需要跟进。

### 🟠 阻断点 3: 搜索能力仍有限
*   **现状**: `buildWhere` 匹配 `title`/`author`/`tags`，但仅简单 ilike，未做分词/排序强化。

### 🟠 阻断点 4: DTO 映射字段仍不完整
*   **现状**: `description` 回填 title；`file_size` 回填“未知”；语言已映射。
*   **风险**: 需要 DB 字段补全或前端做空值兼容。

---

## 3. 综合解决方案 (Comprehensive Solution Plan)

我们不需要完全重写，而是需要 **"对齐"** 和 **"补全"**。

### 阶段一：核心链路修复 (立即执行)

1.  **[前端] 修复分类页面传参问题** ✅ 已完成
    *   `allCategories` 添加 slug，`handleCategoryClick` 传递 slug

2.  **[前端] 修复首页分类 slug 映射** ✅ 已完成
    *   培训/述职/计划 slug 已纠正

3.  **[API] 扩展分类验证** ✅ 已完成
    *   改为引用 `PPT_CATEGORY_VALUES`

4.  **[Action] 补全 DTO 映射** ⚠️ 已部分完成
    *   映射 `tags`/`language`，`description` 回填 title，`file_size` 仍为空

5.  **[Action] 增强搜索逻辑** ⏳ 未做
    *   仍仅匹配 `title`/`author`，未覆盖 `tags`

### 阶段二：技术债务清理 (短期执行)

1.  **删除重复类型定义文件**
    *   删除 `src/types/ppt.ts`（迁移 `src/lib/query-keys.ts` 的 import）
    *   删除 `src/schemas/ppt.ts`（无引用）

2.  **评估 `src/lib/constants/ppt.ts`**
    *   该文件当前是死代码（0引用）
    *   决定是否作为单一数据源 (SSOT) 或删除

### 阶段三：数据库补全 (建议后续执行)

1.  **Schema Migration**
    *   向 `ppt` 表添加 `description` (text) 和 `file_size` (text) 字段
    *   运行 `drizzle-kit generate` 和 `drizzle-kit migrate`

---

## 4. 具体的代码修改建议

### A. 分类与路由（已落地）
- 首页/分类页/筛选基于 `PPT_CATEGORIES` 生成分类，点击传 slug。
- API 校验使用 `PPT_CATEGORY_VALUES`（12 类）。

### B. DTO（部分落地）
- `tags`/`language` 映射，`description` 回填 title，`file_size` 回填“未知”（建议补库字段）。

### C. 搜索（已改进）
- `buildWhere` 匹配 title/author/tags（ilike），可按需增强分词/排序。

---

## 5. 后续行动提示

- 统一前端分类源到 `src/lib/constants/ppt.ts`，消除硬编码。
- 扩展搜索支持 `tags`，必要时增加 DB 字段 `description`/`file_size` 并回填。
- 清理重复类型定义文件，收敛到单一来源。
