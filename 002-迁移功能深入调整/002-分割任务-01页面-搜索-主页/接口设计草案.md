# /ppt 搜索主页改造 - 接口设计草案 (V2.0)

> **文档状态**: 2025-11-28 已校验更新
> **目标**: 定义真实的 Server Actions 接口签名与 DTO 结构，指导后端重构。

## 1. Server Action 接口定义
**文件路径**: `src/actions/ppt/ppt.ts`

### 1.1 查询列表 (getPPTs)
```typescript
export async function getPPTs(params?: {
  search?: string;
  category?: string;       // 必须支持唯一 slug
  language?: 'zh' | 'en';  // 新增：语言筛选
  status?: 'draft' | 'published' | 'archived';
  sortBy?: 'created_at' | 'download_count' | 'view_count' | 'title';
  sortOrder?: 'asc' | 'desc';
  page?: number;
  pageSize?: number;
}): Promise<ActionState<ListResult<PPT>>>;
```
- **变更**: 明确了 `language` 参数，修正了 `sortBy` 字段名（如 `downloads` -> `download_count` 以匹配 DB 或保持映射）。

### 1.2 单条详情 (getPPTById)
```typescript
export async function getPPTById(id: string): Promise<ActionState<PPT>>;
```

### 1.3 计数更新 (Atomic Updates)
```typescript
export async function recordDownload(id: string): Promise<ActionState<void>>;
export async function recordView(id: string): Promise<ActionState<void>>;
```
- **说明**: 执行 `UPDATE ppt SET download_count = download_count + 1 WHERE id = ...`。

### 1.4 管理端 CRUD (Admin Only)
```typescript
export async function createPPT(input: CreatePPTInput): Promise<ActionState<PPT>>;
export async function updatePPT(id: string, input: UpdatePPTInput): Promise<ActionState<PPT>>;
export async function deletePPT(id: string): Promise<ActionState<void>>;
```

---

## 2. 数据传输对象 (DTO)
**目标**: 统一前后端数据结构，解决字段缺失问题。

### 2.1 PPT 接口定义 (Shared Type)
```typescript
export interface PPT {
  id: string;
  title: string;
  category: string;      // slug
  author: string;
  description?: string;  // DB 缺失，需兜底
  slides_count: number;
  file_size?: string;    // DB 缺失，需兜底
  file_url: string;
  preview_url: string;   // 映射自 thumbnailUrl 或 coverImageUrl
  downloads: number;     // 映射自 download_count
  views: number;         // 映射自 view_count
  status: 'draft' | 'published' | 'archived';
  tags: string[];        // 新增：必须返回
  language: string;      // 新增：必须返回 (zh/en)
  created_at: string;    // ISO String
  updated_at: string;    // ISO String
}
```

### 2.2 字段映射逻辑 (DB -> DTO)
```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  // ... (基础字段直接映射)
  tags: row.tags ?? [],              // 确保数组不为 null
  language: row.language ?? 'zh',    // 默认中文
  // 图片回退策略: Thumbnail -> Cover -> Placeholder
  // 注意: 必须确保 public/placeholder.svg 存在
  preview_url: row.thumbnailUrl ?? row.coverImageUrl ?? '/placeholder.svg',
  description: '',                   // 数据库无此字段，返回空串，UI 需处理
  file_size: '',                     // 数据库无此字段，返回空串，UI 需隐藏
  downloads: row.downloadCount ?? 0,
  views: row.viewCount ?? 0,
});
```

---

## 3. 配置与常量 (Constants)
**文件路径**: `src/lib/constants/ppt.ts` (建议新建)

### 3.1 分类配置 (Categories)
**修正目标**: 消除 Slug 重复，确保 URL 唯一性。

```typescript
export const PPT_CATEGORIES = [
  { slug: 'business', label: '商务汇报', icon: 'Briefcase' },
  { slug: 'education', label: '教育培训', icon: 'GraduationCap' },
  { slug: 'marketing', label: '产品营销', icon: 'TrendingUp' },
  { slug: 'general', label: '年终总结', icon: 'Calendar' },
  { slug: 'proposal', label: '项目提案', icon: 'Target' },    // 原 creative -> proposal
  { slug: 'training', label: '培训课件', icon: 'FileText' },  // 原 education -> training
  { slug: 'report', label: '述职报告', icon: 'Presentation' }, // 原 business -> report
  { slug: 'plan', label: '营销方案', icon: 'Users' },         // 原 marketing -> plan
];
```

---

## 4. API 路由设计 (BFF Layer)
**文件路径**: `src/app/api/ppts/route.ts`

- **职责**: 解析 URL Query -> 调用 Server Action -> 返回 JSON。
- **关键参数解析**:
  ```typescript
  const params = {
    // ...
    language: searchParams.get('language') as 'zh' | 'en',
    tags: searchParams.get('tags')?.split(','), // 支持标签过滤
  };
  ```

---

## 5. 变更总结
1.  **Action 签名**: 显式增加 `language` 和 `tags` 参数。
2.  **DTO 结构**: 补全缺失字段，增加兜底逻辑。
3.  **分类配置**: 重构分类 Slug，彻底解决重复问题。