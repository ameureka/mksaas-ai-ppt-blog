# /ppt 搜索主页改造 - 工程方案 (V2.1)

> **文档状态**: 2025-11-28 已更新下载交互逻辑
> **目标**: 修复 Mock 问题，迁移至真实后端，并**收敛下载入口至详情页**。

## 1. 核心问题与目标 (Why)

经过审查，当前实现存在阻断性问题（Mock 数据、客户端过滤、参数丢失等）。且原计划的列表页直接下载逻辑不利于增加浏览深度。

**本次改造目标**:
1.  **去 Mock 化**: 打通数据库 -> Server Action -> 前端的真实数据流。
2.  **交互优化**: 列表页仅作为展示和入口，**所有下载动作跳转至详情页执行**。

---

## 2. 实施方案

### 2.1 数据层 (Server Actions)
**文件**: `src/actions/ppt/ppt.ts`

需重写该文件，对接 Drizzle ORM：
- **`getPPTs(params)`**: 支持全量筛选 (`language`, `tags`, `sort`) 和分页，返回完整 DTO。
- **`getPPTById(id)`**: 详情页专用接口。
- **`downloadPPT(id)`**: **核心下载逻辑**。
    - 检查权限 (登录开关)。
    - 记录下载 (`download_count + 1`)。
    - 返回文件直链。

### 2.2 前端层 (UI Components)

#### A. 列表页 (`/ppt`)
- **重构**:
    - 移除 `useMemo` 客户端过滤，筛选条件直接触发 API 请求。
    - 修复 `categories` Slug 重复问题。
- **交互变更**:
    - 点击卡片或“立即下载”按钮 -> **跳转** `/ppt/[id]`。
    - **移除**列表页的直接下载 API 调用逻辑。

#### B. 详情页 (`/ppt/[id]`)
- **重构**:
    - 使用真实数据 (`getPPTById`)。
- **交互**:
    - “免费下载”按钮 -> 调用 `downloadPPT` Action。
    - 处理未登录拦截和下载成功后的文件打开。

### 2.3 配置修正
**分类 Slug 映射表**:
```typescript
const categories = [
  { name: '商务汇报', slug: 'business' },
  { name: '教育培训', slug: 'education' },
  { name: '产品营销', slug: 'marketing' },
  { name: '年终总结', slug: 'general' },
  { name: '项目提案', slug: 'proposal' },
  { name: '培训课件', slug: 'training' },
  { name: '述职报告', slug: 'report' },
  { name: '营销方案', slug: 'plan' },
];
```

---

## 3. 任务执行清单 (Checklist)

### 阶段零：前置修复 (Priority: Critical)
- [ ] **资源补全**: 创建或确认 `public/placeholder.svg`，防止 UI 裂图。
- [ ] **配置更新**: 将 `aippt.guochunlin.com` 加入 `next.config.ts` 的 `remotePatterns`。
- [ ] **常量定义**: 创建 `src/lib/constants/ppt.ts`，确保 Category Slug 覆盖数据库现有值。

### 阶段一：后端重构 (Priority: High)
- [ ] **Action 重写**: 实现 `getPPTs` (筛选/分页) 和 `downloadPPT` (鉴权/计数)。
- [ ] **DTO 修复**: 补全 `tags`, `language`，**增加 `description` 和 `file_size` 的空值兜底**。
- [ ] **API 适配**: `route.ts` 透传参数。

### 阶段二：前端列表页 (Priority: High)
- [ ] **交互简化**: 将所有点击动作改为 `Link` 跳转详情页。
- [ ] **筛选对接**: 移除客户端过滤，对接新 API。
- [ ] **UI 容错**: 处理图片加载失败的回退逻辑 (Thumbnail -> Cover -> Placeholder)。

### 阶段三：详情页下载 (Priority: High)
- [ ] **下载实现**: 详情页按钮绑定 `downloadPPT` Action。
- [ ] **鉴权处理**: 处理未登录状态 (Toast/Redirect)。

---

## 4. 风险控制
- **数据兼容**: 数据库缺少 `file_size` 和 `description`，前端需做好 UI 兜底（隐藏或显示默认文本）。
- **视觉完整性**: 外部图片链接可能失效，必须在 DTO 层和前端层双重保证占位图的回退机制。
- **配置遗漏**: `next.config.ts` 必须包含图片域名白名单，否则会导致应用报错。
