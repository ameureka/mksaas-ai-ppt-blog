# 05 - ä»£ç å®ç°è®°å½•

## å®ç°æ¦‚è¿°

åœ¨ç”¨æˆ·ç¡®è®¤ **"å¥½çš„ï¼ŒæŒ‰ç…§ä½ è®¾è®¡ç›®æ ‡ç°åœ¨å¼€å§‹çš„æ¥å…¥å§"** åï¼Œå¼€å§‹ä»£ç å®ç°ã€‚

## å®ç°é˜¶æ®µ

### é˜¶æ®µ 1: Schema æ›´æ–° âœ…

#### æ–‡ä»¶: `src/db/schema.ts`

**ä¿®æ”¹å†…å®¹**:
```typescript
export const ppt = pgTable('ppt', {
  // åŸºç¡€å­—æ®µ
  id: text("id").primaryKey(),
  tenantId: text("tenant_id"),
  title: text("title").notNull(),
  author: text("author"),

  // å†…å®¹å­—æ®µ
  slidesCount: integer("slides_count").default(0),
  fileUrl: text("file_url").notNull(),
  coverImageUrl: text("cover_image_url"),    // âœ… æ–°å¢
  thumbnailUrl: text("thumbnail_url"),       // âœ… æ–°å¢

  // åˆ†ç±»å’Œæ ‡ç­¾
  category: text("category"),
  tags: text("tags").array(),                // âœ… æ–°å¢
  language: text("language"),                // âœ… æ–°å¢

  // çŠ¶æ€å’Œå¯è§æ€§
  status: text("status").default('draft'),
  visibility: text("visibility"),            // âœ… æ–°å¢

  // ç»Ÿè®¡å­—æ®µï¼ˆå­—æ®µåä¿®æ­£ï¼‰
  downloadCount: integer("download_count").default(0),   // âœ… ä¿®æ­£
  viewCount: integer("view_count").default(0),           // âœ… ä¿®æ­£

  // æ—¶é—´æˆ³
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
}, (table) => ({
  // æ€§èƒ½ç´¢å¼•
  pptCategoryIdx: index("ppt_category_idx").on(table.category),
  pptDownloadsIdx: index("ppt_download_count_idx").on(table.downloadCount),
  pptViewsIdx: index("ppt_view_count_idx").on(table.viewCount),
  pptCreatedAtIdx: index("ppt_created_at_idx").on(table.createdAt),
}));
```

**å…³é”®ä¿®æ”¹ç‚¹**:
1. âœ… å­—æ®µåå¯¹é½æ•°æ®åº“ï¼š`downloadCount` â†’ `download_count`
2. âœ… å­—æ®µåå¯¹é½æ•°æ®åº“ï¼š`viewCount` â†’ `view_count`
3. âœ… æ–°å¢å­—æ®µï¼š`coverImageUrl`, `thumbnailUrl`, `tags`, `language`, `visibility`, `tenantId`
4. âœ… æ·»åŠ ç´¢å¼•å®šä¹‰
5. âŒ ç§»é™¤ä¸å­˜åœ¨çš„å­—æ®µï¼š`description`, `fileSize`, `previewUrl`

**éªŒè¯**:
```bash
# ç”Ÿæˆè¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
pnpm db:generate

# æ¨é€åˆ°æ•°æ®åº“ï¼ˆè°¨æ…ä½¿ç”¨ï¼‰
# pnpm db:push
```

---

### é˜¶æ®µ 2: Server Actions å®ç° âœ…

#### æ–‡ä»¶: `src/actions/ppt/ppt.ts`

**æ ¸å¿ƒå‡½æ•°å®ç°**:

##### 1. DTO è½¬æ¢å‡½æ•°
```typescript
const toPPTDto = (row: typeof pptTable.$inferSelect): PPT => ({
  id: row.id,
  title: row.title,
  category: (row.category ?? 'general') as PPT['category'],
  author: row.author ?? 'Unknown',
  description: undefined,                    // DB ä¸å­˜åœ¨
  slides_count: row.slidesCount ?? 0,
  file_size: '',                             // DB ä¸å­˜åœ¨
  file_url: row.fileUrl,
  preview_url: row.thumbnailUrl ?? row.coverImageUrl ?? undefined,
  downloads: row.downloadCount ?? 0,         // âœ… å­—æ®µåæ˜ å°„
  views: row.viewCount ?? 0,                 // âœ… å­—æ®µåæ˜ å°„
  status: (row.status ?? 'draft') as PPT['status'],
  uploaded_at: row.createdAt?.toISOString(),
  created_at: row.createdAt?.toISOString(),
  updated_at: row.updatedAt?.toISOString(),
});
```

##### 2. åˆ—è¡¨æŸ¥è¯¢ `getPPTs`
```typescript
export async function getPPTs(
  params?: PPTListParams
): Promise<ServerActionResult<ListResult<PPT>>> {
  try {
    const db = await getDb();
    const { page, pageSize } = normalizePagination(params?.page, params?.pageSize);

    // æ„å»º WHERE æ¡ä»¶
    const where = buildWhere(params);

    // æ„å»º ORDER BY
    const orderBy = resolveOrder(params?.sortBy, params?.sortOrder);

    // æŸ¥è¯¢æ€»æ•°
    const totalResult = await db
      .select({ count: count() })
      .from(pptTable)
      .where(where);
    const total = totalResult[0]?.count ?? 0;

    // æŸ¥è¯¢æ•°æ®
    const rows = await db
      .select()
      .from(pptTable)
      .where(where)
      .orderBy(orderBy)
      .limit(pageSize)
      .offset((page - 1) * pageSize);

    return successResult(
      createListResult(rows.map(toPPTDto), total, page, pageSize)
    );
  } catch (error) {
    console.error('getPPTs error:', error);
    return errorResult('Failed to fetch PPTs');
  }
}
```

**WHERE æ¡ä»¶æ„å»º**:
```typescript
function buildWhere(params?: PPTListParams) {
  const conditions = [];

  // æœç´¢æ¡ä»¶
  if (params?.search) {
    conditions.push(ilike(pptTable.title, `%${params.search}%`));
  }

  // åˆ†ç±»è¿‡æ»¤
  if (params?.category) {
    conditions.push(eq(pptTable.category, params.category));
  }

  // è¯­è¨€è¿‡æ»¤
  if (params?.language) {
    conditions.push(eq(pptTable.language, params.language));
  }

  // çŠ¶æ€è¿‡æ»¤
  if (params?.status) {
    conditions.push(eq(pptTable.status, params.status));
  }

  // æ—¥æœŸèŒƒå›´è¿‡æ»¤
  if (params?.fromDate) {
    conditions.push(gte(pptTable.createdAt, new Date(params.fromDate)));
  }
  if (params?.toDate) {
    conditions.push(lte(pptTable.createdAt, new Date(params.toDate)));
  }

  return conditions.length > 0 ? and(...conditions) : undefined;
}
```

**æ’åºæ„å»º**:
```typescript
function resolveOrder(sortBy?: string, sortOrder?: 'asc' | 'desc') {
  const order = sortOrder === 'asc' ? asc : desc;

  switch (sortBy) {
    case 'title':
      return order(pptTable.title);
    case 'downloads':
      return order(pptTable.downloadCount);
    case 'views':
      return order(pptTable.viewCount);
    case 'created_at':
    default:
      return desc(pptTable.createdAt);
  }
}
```

##### 3. è¯¦æƒ…æŸ¥è¯¢ `getPPTById`
```typescript
export async function getPPTById(
  id: string
): Promise<ServerActionResult<PPT>> {
  try {
    const db = await getDb();
    const rows = await db
      .select()
      .from(pptTable)
      .where(eq(pptTable.id, id))
      .limit(1);

    if (rows.length === 0) {
      return errorResult('PPT not found', 'NOT_FOUND');
    }

    return successResult(toPPTDto(rows[0]));
  } catch (error) {
    console.error('getPPTById error:', error);
    return errorResult('Failed to fetch PPT');
  }
}
```

##### 4. åˆ›å»º `createPPT`
```typescript
export async function createPPT(
  data: Omit<PPT, 'id' | 'created_at' | 'updated_at'>
): Promise<ServerActionResult<PPT>> {
  try {
    const db = await getDb();
    const id = nanoid();

    const insertData = {
      id,
      title: data.title,
      author: data.author ?? null,
      category: data.category ?? null,
      slidesCount: data.slides_count ?? 0,
      fileUrl: data.file_url,
      thumbnailUrl: data.preview_url ?? null,
      status: data.status ?? 'draft',
      downloadCount: 0,
      viewCount: 0,
    };

    await db.insert(pptTable).values(insertData);

    const result = await getPPTById(id);
    return result;
  } catch (error) {
    console.error('createPPT error:', error);
    return errorResult('Failed to create PPT');
  }
}
```

##### 5. æ›´æ–° `updatePPT`
```typescript
export async function updatePPT(
  id: string,
  data: Partial<PPT>
): Promise<ServerActionResult<PPT>> {
  try {
    const db = await getDb();

    const updateData: Record<string, any> = {
      updatedAt: new Date(),
    };

    if (data.title !== undefined) updateData.title = data.title;
    if (data.author !== undefined) updateData.author = data.author;
    if (data.category !== undefined) updateData.category = data.category;
    // ... å…¶ä»–å­—æ®µ

    await db
      .update(pptTable)
      .set(updateData)
      .where(eq(pptTable.id, id));

    return getPPTById(id);
  } catch (error) {
    console.error('updatePPT error:', error);
    return errorResult('Failed to update PPT');
  }
}
```

##### 6. åˆ é™¤ `deletePPT`
```typescript
export async function deletePPT(
  id: string
): Promise<ServerActionResult<void>> {
  try {
    const db = await getDb();
    await db.delete(pptTable).where(eq(pptTable.id, id));
    return successResult(undefined);
  } catch (error) {
    console.error('deletePPT error:', error);
    return errorResult('Failed to delete PPT');
  }
}
```

##### 7. è®°å½•ä¸‹è½½ `recordDownload`
```typescript
export async function recordDownload(
  id: string
): Promise<ServerActionResult<void>> {
  try {
    const db = await getDb();
    await db
      .update(pptTable)
      .set({
        downloadCount: sql`${pptTable.downloadCount} + 1`,
        updatedAt: new Date(),
      })
      .where(eq(pptTable.id, id));
    return successResult(undefined);
  } catch (error) {
    console.error('recordDownload error:', error);
    return errorResult('Failed to record download');
  }
}
```

##### 8. è®°å½•æµè§ˆ `recordView`
```typescript
export async function recordView(
  id: string
): Promise<ServerActionResult<void>> {
  try {
    const db = await getDb();
    await db
      .update(pptTable)
      .set({
        viewCount: sql`${pptTable.viewCount} + 1`,
        updatedAt: new Date(),
      })
      .where(eq(pptTable.id, id));
    return successResult(undefined);
  } catch (error) {
    console.error('recordView error:', error);
    return errorResult('Failed to record view');
  }
}
```

#### æ–‡ä»¶: `src/actions/ppt/stats.ts`

**ç»Ÿè®¡æŸ¥è¯¢å®ç°**:

```typescript
export async function getPPTStats(): Promise<ServerActionResult<PPTStats>> {
  try {
    const db = await getDb();

    // æ€»æ•°ç»Ÿè®¡
    const totalResult = await db.select({ count: count() }).from(pptTable);
    const total = totalResult[0]?.count ?? 0;

    // æ€»ä¸‹è½½é‡
    const downloadsResult = await db
      .select({ sum: sum(pptTable.downloadCount) })
      .from(pptTable);
    const totalDownloads = Number(downloadsResult[0]?.sum ?? 0);

    // æ€»æµè§ˆé‡
    const viewsResult = await db
      .select({ sum: sum(pptTable.viewCount) })
      .from(pptTable);
    const totalViews = Number(viewsResult[0]?.sum ?? 0);

    // æŒ‰åˆ†ç±»ç»Ÿè®¡
    const categoryStats = await db
      .select({
        category: pptTable.category,
        count: count(),
      })
      .from(pptTable)
      .groupBy(pptTable.category);

    return successResult({
      total,
      totalDownloads,
      totalViews,
      categoryStats,
    });
  } catch (error) {
    console.error('getPPTStats error:', error);
    return errorResult('Failed to fetch stats');
  }
}
```

---

### é˜¶æ®µ 3: API Routes å®ç° âœ…

#### æ–‡ä»¶: `src/app/api/ppts/route.ts`

**GET åˆ—è¡¨ç«¯ç‚¹**:
```typescript
import { NextRequest } from 'next/server';
import { getPPTs } from '@/actions/ppt/ppt';

export async function GET(req: NextRequest) {
  const { searchParams } = new URL(req.url);

  const params = {
    search: searchParams.get('search') ?? undefined,
    category: searchParams.get('category') ?? undefined,
    language: searchParams.get('language') ?? undefined,
    status: searchParams.get('status') ?? undefined,
    fromDate: searchParams.get('fromDate') ?? undefined,
    toDate: searchParams.get('toDate') ?? undefined,
    sortBy: searchParams.get('sortBy') ?? undefined,
    sortOrder: (searchParams.get('sortOrder') as 'asc' | 'desc') ?? undefined,
    page: searchParams.get('page') ? Number(searchParams.get('page')) : undefined,
    pageSize: searchParams.get('pageSize') ? Number(searchParams.get('pageSize')) : undefined,
  };

  const result = await getPPTs(params);

  return Response.json(result, {
    status: result.success ? 200 : 400,
  });
}
```

#### æ–‡ä»¶: `src/app/api/ppts/[id]/route.ts`

**GET è¯¦æƒ…ç«¯ç‚¹**:
```typescript
import { getPPTById } from '@/actions/ppt/ppt';

export async function GET(
  _req: Request,
  { params }: { params: { id: string } }
) {
  const result = await getPPTById(params.id);

  return Response.json(result, {
    status: result.success ? 200 : result.code === 'NOT_FOUND' ? 404 : 400,
  });
}
```

#### æ–‡ä»¶: `src/app/api/ppts/[id]/download/route.ts`

**POST ä¸‹è½½ç«¯ç‚¹**:
```typescript
import { NextResponse } from 'next/server';
import { getPPTById, recordDownload } from '@/actions/ppt/ppt';
import { websiteConfig } from '@/config/website';

export async function POST(
  _req: Request,
  { params }: { params: { id: string } }
) {
  // æ£€æŸ¥ä¸‹è½½ç™»å½•è¦æ±‚
  if (websiteConfig.features.pptRequireLoginForDownload) {
    // TODO: æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
    // const session = await auth();
    // if (!session) {
    //   return NextResponse.json(
    //     { success: false, error: 'Login required' },
    //     { status: 401 }
    //   );
    // }
    return NextResponse.json(
      { success: false, error: 'Login required' },
      { status: 401 }
    );
  }

  // è·å– PPT è¯¦æƒ…
  const detail = await getPPTById(params.id);

  if (!detail.success) {
    return NextResponse.json(detail, {
      status: detail.code === 'NOT_FOUND' ? 404 : 400,
    });
  }

  // è®°å½•ä¸‹è½½
  await recordDownload(params.id);

  // è¿”å›æ–‡ä»¶ URL
  return NextResponse.json({
    success: true,
    data: {
      fileUrl: detail.data.file_url,
    },
  });
}
```

---

### é˜¶æ®µ 4: Config æ›´æ–° âœ…

#### æ–‡ä»¶: `src/config/website.tsx`

**æ·»åŠ åŠŸèƒ½å¼€å…³**:
```typescript
export const websiteConfig = {
  // ... å…¶ä»–é…ç½®

  features: {
    // ... å…¶ä»–åŠŸèƒ½å¼€å…³
    pptRequireLoginForDownload: false,  // âœ… æ–°å¢ï¼šé»˜è®¤ä¸éœ€è¦ç™»å½•
  },
};
```

#### æ–‡ä»¶: `src/types/index.d.ts`

**ç±»å‹å®šä¹‰æ›´æ–°**:
```typescript
interface WebsiteConfig {
  // ... å…¶ä»–ç±»å‹
  features: {
    // ... å…¶ä»–åŠŸèƒ½
    pptRequireLoginForDownload: boolean;  // âœ… æ–°å¢
  };
}
```

---

### é˜¶æ®µ 5: å‰ç«¯é›†æˆ ğŸ”„

#### æ–‡ä»¶: `src/app/[locale]/(marketing)/ppt/page.tsx`

**ä¿®æ”¹è¦ç‚¹**:
```typescript
'use client';

import { useEffect, useState } from 'react';
import type { PPT } from '@/types';

export default function PPTPage() {
  const [featuredPPTs, setFeaturedPPTs] = useState<PPT[]>([]);

  useEffect(() => {
    const loadPPTs = async () => {
      const res = await fetch('/api/ppts?page=1&pageSize=12&sortBy=created_at&sortOrder=desc');
      const json = await res.json();

      if (json.success) {
        const items = json.data.items ?? [];
        const transformed = items.map((item: any) => ({
          id: item.id,
          title: item.title,
          downloads: item.downloads ?? 0,
          views: item.views ?? 0,
          previewUrl: item.preview_url ?? '/placeholder.svg',
          category: item.category ?? 'general',
          author: item.author ?? 'Unknown',
        }));
        setFeaturedPPTs(transformed.slice(0, 8));
      }
    };

    loadPPTs();
  }, []);

  return (
    <div>
      {/* Hero Section */}
      {/* Search Bar */}
      {/* Featured PPTs */}
      <PPTGrid ppts={featuredPPTs} />
    </div>
  );
}
```

#### æ–‡ä»¶: `src/app/[locale]/(marketing)/ppt/[id]/page.tsx`

**ä¿®æ”¹è¦ç‚¹**:
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import type { PPT } from '@/types';

export default function PPTDetailPage() {
  const params = useParams();
  const id = params.id as string;
  const [ppt, setPPT] = useState<PPT | null>(null);

  useEffect(() => {
    const loadPPT = async () => {
      const res = await fetch(`/api/ppts/${id}`);
      const json = await res.json();

      if (json.success) {
        setPPT(json.data);
      }
    };

    loadPPT();
  }, [id]);

  if (!ppt) return <div>Loading...</div>;

  return (
    <div>
      <h1>{ppt.title}</h1>
      <p>ä½œè€…: {ppt.author}</p>
      <p>ä¸‹è½½é‡: {ppt.downloads}</p>
      <p>æµè§ˆé‡: {ppt.views}</p>
      <button onClick={handleDownload}>ä¸‹è½½</button>
    </div>
  );
}
```

#### æ–‡ä»¶: `src/app/[locale]/(marketing)/ppt/category/[name]/page.tsx`

**ä¿®æ”¹è¦ç‚¹**:
```typescript
'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import type { PPT } from '@/types';

// åˆ†ç±» slug æ˜ å°„
const CATEGORY_SLUG_MAP: Record<string, string> = {
  'business': 'å•†åŠ¡æ±‡æŠ¥',
  'education': 'æ•™è‚²åŸ¹è®­',
  'marketing': 'äº§å“è¥é”€',
  // ... å…¶ä»–åˆ†ç±»
};

export default function CategoryPage() {
  const params = useParams();
  const slug = decodeURIComponent(params.name as string);
  const categoryName = CATEGORY_SLUG_MAP[slug] ?? slug;

  const [ppts, setPPTs] = useState<PPT[]>([]);

  useEffect(() => {
    const loadPPTs = async () => {
      // ä½¿ç”¨ slug æŸ¥è¯¢
      const res = await fetch(`/api/ppts?category=${encodeURIComponent(slug)}&page=1&pageSize=12`);
      const json = await res.json();

      if (json.success) {
        setPPTs(json.data.items ?? []);
      }
    };

    loadPPTs();
  }, [slug]);

  return (
    <div>
      <h1>{categoryName}</h1>
      <PPTGrid ppts={ppts} />
    </div>
  );
}
```

---

## å®ç°æ€»ç»“

### âœ… å·²å®Œæˆçš„éƒ¨åˆ†
1. âœ… Schema æ›´æ–°å’Œå­—æ®µå¯¹é½
2. âœ… Server Actions å®Œæ•´å®ç°
3. âœ… API Routes åˆ›å»º
4. âœ… Config æ›´æ–°ï¼ˆä¸‹è½½å¼€å…³ï¼‰
5. ğŸ”„ å‰ç«¯é¡µé¢é›†æˆï¼ˆéƒ¨åˆ†å®Œæˆï¼‰

### ğŸ”„ è¿›è¡Œä¸­çš„éƒ¨åˆ†
1. ğŸ”„ ä¸‹è½½æŒ‰é’®è¿æ¥ API
2. ğŸ”„ æœç´¢åŠŸèƒ½å®Œæ•´é›†æˆ
3. ğŸ”„ åˆ†ç±»ç­›é€‰å™¨é›†æˆ

### â³ å¾…å®ç°çš„éƒ¨åˆ†
1. â³ ä¸‹è½½æ¨¡æ€æ¡†ç»„ä»¶
2. â³ ç™»å½•æ¨¡æ€æ¡†é›†æˆ
3. â³ ç®¡ç†åå°é›†æˆ
4. â³ çƒ­é—¨å…³é”®è¯åŠ¨æ€ç»Ÿè®¡

### ğŸ› å·²çŸ¥é—®é¢˜
1. âš ï¸ æœç´¢è¾“å…¥æ¡†äº¤äº’é—®é¢˜ï¼ˆå‰ç«¯ï¼‰
2. âš ï¸ ä¸‹è½½æŒ‰é’®æœªè¿æ¥åˆ° APIï¼ˆå‰ç«¯ï¼‰
3. âš ï¸ åˆ†ç±»é“¾æ¥é”™è¯¯ **å·²ä¿®å¤**

### ğŸ“Š ä»£ç è´¨é‡
- âœ… TypeScript ç±»å‹å®‰å…¨
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… Server Actions è§„èŒƒ
- âœ… API å“åº”æ ¼å¼ç»Ÿä¸€
- âœ… æ€§èƒ½ç´¢å¼•é½å…¨

### ğŸ¯ ä¸‹ä¸€æ­¥
1. å®Œæˆä¸‹è½½æ¨¡æ€æ¡†å®ç°
2. è¿æ¥ä¸‹è½½æŒ‰é’®åˆ° API
3. ä¼˜åŒ–æœç´¢äº¤äº’
4. ç®¡ç†åå°é›†æˆ
