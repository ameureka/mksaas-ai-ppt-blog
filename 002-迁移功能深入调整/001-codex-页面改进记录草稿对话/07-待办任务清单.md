# 07 - 待办任务清单

## 当前状态总览

### ✅ 已完成
1. ✅ 项目架构分析
2. ✅ CLAUDE.md 创建和更新
3. ✅ 前端验证报告学习
4. ✅ 设计文档创建（spec.md, PLAN.md, 工程方案.md 等）
5. ✅ 数据库验证（68条记录确认）
6. ✅ Schema 更新和字段对齐
7. ✅ Server Actions 完整实现
8. ✅ API Routes 创建
9. ✅ 下载开关配置
10. ✅ 下载组件设计文档
11. ✅ 分类链接错误修复

### 🔄 进行中
1. 🔄 前端页面与 API 集成
2. 🔄 下载按钮连接实现

### ⏳ 待完成
1. ⏳ 下载模态框组件实现
2. ⏳ 搜索功能完整集成
3. ⏳ 热门关键词动态实现
4. ⏳ 管理后台集成

---

## 详细任务分解

### 阶段 1: 核心功能完善 (高优先级)

#### 任务 1.1: 下载按钮集成 ⏳
**优先级**: 🔴 高

**当前状态**:
- ✅ API 端点已实现 (`/api/ppts/[id]/download`)
- ✅ 下载逻辑已设计
- ❌ 前端按钮未连接到 API

**需要完成**:
1. 在 `src/app/[locale]/(marketing)/ppt/[id]/page.tsx` 中实现 `handleDownload` 函数
2. 调用 `/api/ppts/[id]/download` API
3. 处理响应（成功/失败）
4. 触发文件下载

**代码草案**:
```typescript
// src/app/[locale]/(marketing)/ppt/[id]/page.tsx
const handleDownload = async () => {
  try {
    const res = await fetch(`/api/ppts/${ppt.id}/download`, {
      method: 'POST',
    });

    const data = await res.json();

    if (data.success) {
      // 触发下载
      window.location.href = data.data.fileUrl;
      toast.success('开始下载...');
    } else {
      if (data.error === 'Login required') {
        // 显示登录模态框
        setShowLoginModal(true);
      } else {
        toast.error(data.error || '下载失败');
      }
    }
  } catch (error) {
    toast.error('下载失败，请稍后重试');
  }
};
```

**验收标准**:
- [ ] 点击下载按钮能成功触发下载
- [ ] 下载计数正确增加
- [ ] 错误提示正确显示
- [ ] 登录拦截正常工作（如开启）

---

#### 任务 1.2: 搜索功能完善 ⏳
**优先级**: 🔴 高

**当前问题**:
- ⚠️ 搜索输入框无法直接输入（验证报告中提到）
- ✅ 热门关键词功能正常

**需要调查**:
1. 检查搜索输入框的表单元素索引
2. 检查 `editable` 属性
3. 检查是否有 JavaScript 事件冲突

**需要完成**:
1. 修复搜索输入框交互问题
2. 确保搜索提交正常工作
3. 添加空搜索验证提示

**验收标准**:
- [ ] 搜索框可以正常输入
- [ ] 搜索提交后正确跳转/刷新
- [ ] 空搜索显示错误提示
- [ ] 搜索结果正确显示

---

#### 任务 1.3: 导航栏 PPT 链接添加 ⏳
**优先级**: 🟡 中

**当前状态**:
- ❌ 导航栏没有 PPT 链接
- ✅ PPT 页面可直接访问 `/ppt`

**需要修改的文件**:
1. `src/config/navbar-config.tsx`
2. `messages/en.json`
3. `messages/zh.json`

**修改内容**:
```typescript
// src/config/navbar-config.tsx
export function useNavbarLinks(): NestedMenuItem[] {
  const t = useTranslations('Marketing.navbar');

  return [
    // ✅ 添加 PPT 链接（首位）
    {
      title: t('ppt.title'),
      href: Routes.PPT,
      external: false,
    },
    {
      title: t('blog.title'),
      href: Routes.Blog,
      external: false,
    },
    {
      title: t('pages.items.about.title'),
      description: t('pages.items.about.description'),
      icon: <BuildingIcon className="size-4 shrink-0" />,
      href: Routes.About,
      external: false,
    },
  ];
}
```

```json
// messages/en.json
{
  "Marketing": {
    "navbar": {
      "ppt": {
        "title": "PPT Templates"
      }
    }
  }
}

// messages/zh.json
{
  "Marketing": {
    "navbar": {
      "ppt": {
        "title": "PPT模板"
      }
    }
  }
}
```

**验收标准**:
- [ ] 导航栏显示 PPT 链接
- [ ] 点击链接正确跳转到 `/ppt`
- [ ] 双语切换正常
- [ ] 移动端导航正常

---

### 阶段 2: 下载模态框实现 (中优先级)

#### 任务 2.1: 下载模态框组件 ⏳
**优先级**: 🟡 中

**需要创建的组件**:
```
src/components/ppt/download/
├── download-button.tsx           # 下载触发按钮
├── download-modal.tsx            # 主下载流程模态框
├── download-options-modal.tsx    # 下载方式选择（未来）
├── download-link-display.tsx     # 下载链接展示
└── index.ts                      # 导出
```

**基础版本（第一阶段）**:
- 简单的下载模态框
- 显示下载进度/状态
- 成功后显示下载链接
- 失败显示错误信息

**未来扩展（第二阶段）**:
- 下载方式选择
- 积分兑换
- 广告激励
- 步骤指示器

**验收标准**:
- [ ] 点击下载按钮弹出模态框
- [ ] 模态框显示下载状态
- [ ] 成功后显示下载链接
- [ ] 错误时显示错误信息
- [ ] 可以关闭模态框

---

#### 任务 2.2: 登录模态框集成 ⏳
**优先级**: 🟡 中

**当前状态**:
- ✅ Better Auth 登录功能已实现
- ❌ 下载流程中未集成登录模态框

**需要完成**:
1. 创建或复用登录模态框组件
2. 在下载流程中调用
3. 登录成功后继续下载

**流程设计**:
```
点击下载
  ↓
检查登录要求
  ├─ 不需要 → 直接下载
  └─ 需要 → 检查登录状态
       ├─ 已登录 → 下载
       └─ 未登录 → 显示登录模态框
            ↓
            用户登录成功
            ↓
            继续下载流程
```

**验收标准**:
- [ ] 未登录时显示登录模态框
- [ ] 登录成功后自动继续下载
- [ ] 取消登录时关闭模态框
- [ ] 已登录用户直接下载

---

### 阶段 3: 管理后台集成 (低优先级)

#### 任务 3.1: PPT 管理列表页 ⏳
**优先级**: 🟢 低

**页面**: `/admin/ppt/list`

**当前状态**:
- ✅ Server Actions 已实现
- ❌ 前端仍使用 Mock 数据

**需要完成**:
1. 使用 TanStack Query hooks
2. 连接到 Server Actions
3. 实现搜索和过滤
4. 实现分页
5. 实现排序

**验收标准**:
- [ ] 显示真实的 PPT 数据
- [ ] 搜索功能正常
- [ ] 分页功能正常
- [ ] 排序功能正常
- [ ] 编辑/删除按钮正常工作

---

#### 任务 3.2: PPT 编辑页 ⏳
**优先级**: 🟢 低

**页面**: `/admin/ppt/list/[id]/edit`

**需要完成**:
1. 表单字段映射到 schema
2. 使用 `useUpdatePPT` hook
3. 表单验证
4. 文件上传（如果支持）

**验收标准**:
- [ ] 表单显示现有数据
- [ ] 提交后成功更新
- [ ] 表单验证正常
- [ ] 错误提示正确

---

#### 任务 3.3: PPT 创建页 ⏳
**优先级**: 🟢 低

**页面**: `/admin/ppt/list/new` 或在列表页添加按钮

**需要完成**:
1. 创建表单
2. 使用 `useCreatePPT` hook
3. 文件上传集成
4. 表单验证

**验收标准**:
- [ ] 表单可以填写
- [ ] 提交后成功创建
- [ ] 创建后跳转到列表页或详情页
- [ ] 表单验证正常

---

#### 任务 3.4: 统计页面集成 ⏳
**优先级**: 🟢 低

**页面**: `/admin/ppt` 或 `/admin/stats`

**需要完成**:
1. 使用 `useGetDashboardStats` hook
2. 连接到 `getPPTStats` action
3. 图表渲染
4. 数据可视化

**验收标准**:
- [ ] 显示真实统计数据
- [ ] 图表渲染正常
- [ ] 数据准确
- [ ] 响应式设计

---

### 阶段 4: 功能增强 (未来)

#### 任务 4.1: 热门关键词动态统计 ⏳
**优先级**: 🟢 低

**当前实现**: 静态配置

**未来方案**:
1. 创建 `search_logs` 表
2. 记录搜索关键词
3. 定期统计（每小时/每天）
4. 展示热门关键词

**数据模型**:
```sql
CREATE TABLE search_logs (
  id TEXT PRIMARY KEY,
  keyword TEXT NOT NULL,
  user_id TEXT,
  result_count INTEGER,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX search_logs_keyword_idx ON search_logs(keyword);
CREATE INDEX search_logs_created_at_idx ON search_logs(created_at);
```

**统计查询**:
```sql
SELECT
  keyword,
  COUNT(*) as search_count
FROM search_logs
WHERE created_at > NOW() - INTERVAL '7 days'
GROUP BY keyword
ORDER BY search_count DESC
LIMIT 10;
```

---

#### 任务 4.2: 积分系统实现 ⏳
**优先级**: 🟢 低（未来）

**子任务**:
1. 创建积分数据表
2. 实现积分获取逻辑
3. 实现积分扣除逻辑
4. 积分交易记录
5. 积分余额展示
6. 积分历史记录

**参考**: 06-下载组件设计.md

---

#### 任务 4.3: 广告激励下载 ⏳
**优先级**: 🟢 低（未来）

**子任务**:
1. 接入广告 SDK（Google AdMob / Unity Ads）
2. 实现激励视频广告
3. 广告观看验证
4. 广告下载流程

**参考**: 06-下载组件设计.md

---

#### 任务 4.4: 签名 URL 防盗链 ⏳
**优先级**: 🟢 低（未来）

**子任务**:
1. 实现签名 URL 生成
2. 验证签名 URL
3. 设置过期时间
4. 下载次数限制

**参考**: 06-下载组件设计.md

---

#### 任务 4.5: 数据库字段扩展 ⏳
**优先级**: 🟢 低（未来）

**缺失字段**:
- `description` - PPT 描述
- `file_size` - 文件大小

**迁移计划**:
```sql
-- 添加描述字段
ALTER TABLE ppt ADD COLUMN description TEXT;

-- 添加文件大小字段
ALTER TABLE ppt ADD COLUMN file_size TEXT;

-- 为现有记录生成默认描述
UPDATE ppt
SET description = '这是一个' || category || '模板'
WHERE description IS NULL;
```

---

## 任务优先级总结

### 🔴 高优先级（立即处理）
1. 下载按钮集成 → **当前最重要**
2. 搜索功能完善
3. 导航栏 PPT 链接

### 🟡 中优先级（近期完成）
4. 下载模态框组件
5. 登录模态框集成

### 🟢 低优先级（未来规划）
6. 管理后台集成
7. 热门关键词动态统计
8. 积分系统
9. 广告激励
10. 签名 URL
11. 数据库字段扩展

---

## 下一步行动建议

### 立即开始 (1-2天)
1. **下载按钮集成**
   - 在详情页实现 `handleDownload` 函数
   - 连接到 `/api/ppts/[id]/download`
   - 测试下载流程
   - 验证下载计数

2. **搜索功能修复**
   - 调查搜索输入框问题
   - 修复交互问题
   - 添加空搜索验证

### 短期完成 (3-5天)
3. **导航栏更新**
   - 添加 PPT 链接
   - 更新翻译文件
   - 测试双语切换

4. **下载模态框**
   - 创建基础模态框组件
   - 实现下载状态展示
   - 集成到详情页

### 中期规划 (1-2周)
5. **管理后台集成**
   - PPT 列表页
   - PPT 编辑页
   - 统计页面

### 长期规划 (1个月+)
6. **功能增强**
   - 积分系统
   - 广告激励
   - 签名 URL
   - 热门关键词统计

---

## 验收检查清单

### Phase 1: 基础功能 ✅
- [ ] 下载按钮工作正常
- [ ] 下载计数正确增加
- [ ] 搜索功能正常
- [ ] 导航栏显示 PPT 链接
- [ ] 所有页面可访问

### Phase 2: 用户体验 ⏳
- [ ] 下载模态框正常
- [ ] 登录模态框正常
- [ ] 错误提示友好
- [ ] 加载状态明确
- [ ] 响应式设计完善

### Phase 3: 管理功能 ⏳
- [ ] 管理列表显示真实数据
- [ ] 编辑功能正常
- [ ] 创建功能正常
- [ ] 删除功能正常
- [ ] 统计数据准确

### Phase 4: 高级功能 ⏳
- [ ] 积分系统工作正常
- [ ] 广告激励正常
- [ ] 签名 URL 防盗链
- [ ] 热门关键词动态更新

---

## 风险提示

### 技术风险
1. ⚠️ **搜索输入框问题**：可能涉及深层次的表单状态问题
2. ⚠️ **积分并发**：积分系统需要处理并发扣费问题
3. ⚠️ **广告集成**：第三方 SDK 可能存在兼容性问题

### 业务风险
1. ⚠️ **用户流失**：下载流程过于复杂可能导致用户流失
2. ⚠️ **盗链问题**：未实施签名 URL 前，文件链接可被复制

### 时间风险
1. ⚠️ **功能优先级**：建议优先完成核心功能，避免功能蔓延
2. ⚠️ **测试时间**：预留足够的测试时间

---

## 资源需求

### 开发资源
- 前端开发：3-5 天（核心功能）
- 后端开发：已完成
- 测试：2 天
- 文档：1 天

### 第三方服务
- 广告平台（未来）：Google AdMob / Unity Ads
- CDN（未来）：Cloudflare / AWS CloudFront

### 监控工具
- 错误追踪：Sentry（推荐）
- 性能监控：Vercel Analytics / New Relic
- 用户行为：PostHog（已配置）
