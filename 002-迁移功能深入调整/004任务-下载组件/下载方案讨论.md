# 下载方案讨论（/ppt 详情页）

> 梳理下载链路的开关、权限、组件形态、未来扩展，并给出当前 UI 结构示意。暂不改代码。

## 1. 开关与权限
- 配置开关：`websiteConfig.features.pptRequireLoginForDownload`
  - `false`（默认）：允许未登录直接尝试下载。
  - `true`：点击下载先检查登录，未登录弹登录框（LoginModal），不调用下载接口。
- 未来权限扩展：订阅/积分/次数限制可在下载接口里做校验；首免策略也在接口判断。

## 2. 首免/积分策略（当前/未来）
- 当前：首免按钮/积分按钮可共用同一下载接口，接口返回 `fileUrl` 直链；无真实积分扣减。
- 未来：在下载接口中分支：
  - 首免：首免标记/次数校验 -> 通过后返回直链。
  - 积分：检查余额 -> 扣减 -> 记录 download_record -> 返回直链。
  - 订阅：检查订阅有效期 -> 通过后返回直链。

## 3. 接口与链接
- 接口：`POST /api/ppts/[id]/download`（或 server action `downloadPPT`）
  - 步骤：检查登录开关 -> 查 PPT -> 可选计费/积分/首免逻辑 -> `recordDownload` -> 返回 `{ fileUrl }`（或 302）。
  - 链接有效性：首版直接返回存储直链（未签名）。未来可返回短期签名 URL（如 S3 presign）或走后端代理防盗链。
- 记录：当前仅自增 `download_count`；未来可写 `download_record`（user_id/ip_hash/ua/time）。

## 4. UI 组件形态（现有）
- 详情页弹窗组件：
  - `src/components/ppt/download/download-modal.tsx`
  - `src/components/ppt/download/download-options-modal.tsx`
- 结构（ASCII）：
```
[DownloadModal]
 ├─ Title/说明（首免/积分）
 ├─ [首免下载按钮]
 ├─ 分隔符（或）
 └─ [积分下载按钮]
```
- 现状：按钮逻辑未接下载 API；需改为调用 `/api/ppts/[id]/download`，处理 loading/错误/成功触发下载。

## 5. 登录拦截
- 点击下载：
  - 若开关为 true 且未登录 -> 弹 LoginModal，阻断 API 调用。
  - 若开关为 false 或已登录 -> 调下载接口；返回错误则 toast。

## 6. 防盗链/签名（后续）
- 方案 A：存储层签名 URL（S3/R2 presign），接口生成短期 URL 返回。
- 方案 B：后端代理文件流，校验用户/开关后再拉取存储，成本较高。
- 频控：在下载接口加速率限制（按 user/IP）。

## 7. 容错与提示
- 缺失 `file_url`：接口返回错误，前端提示“资源不可用”并禁用下载按钮。
- file_size/description 缺失：前端显示“未知”/“暂无”，不阻断下载。

## 8. 落地建议（后续执行）
1) 在下载 modal 按钮接入 `/api/ppts/[id]/download`（或 action），处理登录开关、loading、成功触发下载/新窗口。
2) 详情页注入 `pptRequireLoginForDownload`，控制未登录拦截。
3) 下载接口内可留积分/订阅校验 TODO，当前仅返回直链 + 计数。
4) QA：开关双态、未登录/已登录、无 file_url、接口失败的提示。***
