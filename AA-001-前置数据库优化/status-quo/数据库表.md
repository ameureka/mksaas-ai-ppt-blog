# 数据库表结构

> 更新时间: 2025-12-06
> 数据库: Neon PostgreSQL

## 1. user (用户表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | 用户 ID |
| name | text | NOT NULL | 用户名 |
| email | text | NOT NULL, UNIQUE | 邮箱 |
| email_verified | boolean | NOT NULL | 邮箱验证状态 |
| image | text | | 头像 URL |
| role | text | | 角色 |
| banned | boolean | | 封禁状态 |
| ban_reason | text | | 封禁原因 |
| ban_expires | timestamp | | 封禁过期时间 |
| customer_id | text | | Stripe 客户 ID |
| deleted_at | timestamp | | 软删除时间 ✨新增 |
| created_at | timestamp | NOT NULL | 创建时间 |
| updated_at | timestamp | NOT NULL | 更新时间 |

## 2. ppt (PPT 模板表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | PPT ID |
| tenant_id | text | | 租户 ID |
| title | text | NOT NULL | 标题 |
| author | text | | 作者 |
| slides_count | integer | DEFAULT 0 | 幻灯片数量 |
| file_url | text | NOT NULL | 文件 URL |
| cover_image_url | text | | 封面图 URL |
| thumbnail_url | text | | 缩略图 URL |
| category | text | | 分类 |
| tags | text[] | | 标签数组 |
| language | text | | 语言 |
| status | text | DEFAULT 'draft' | 状态 |
| visibility | text | | 可见性 |
| download_count | integer | DEFAULT 0 | 下载次数 |
| view_count | integer | DEFAULT 0 | 浏览次数 |
| embedding_id | text | | 向量 ID |
| embedding_model | text | | 向量模型 |
| review_status | text | | 审核状态 |
| deleted_at | timestamp | | 软删除时间 ✨新增 |
| description | text | | 描述 ✨新增 |
| file_size | integer | | 文件大小 ✨新增 |
| file_format | text | DEFAULT 'pptx' | 文件格式 ✨新增 |
| created_at | timestamp | DEFAULT NOW | 创建时间 |
| updated_at | timestamp | DEFAULT NOW | 更新时间 |

## 3. user_credit (用户积分表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | 记录 ID |
| user_id | text | NOT NULL, UNIQUE, FK→user.id | 用户 ID ✨新增唯一约束 |
| current_credits | integer | NOT NULL, DEFAULT 0 | 当前积分 |
| created_at | timestamp | NOT NULL, DEFAULT NOW | 创建时间 |
| updated_at | timestamp | NOT NULL, DEFAULT NOW | 更新时间 |

## 4. credit_transaction (积分交易表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | 交易 ID |
| user_id | text | NOT NULL, FK→user.id | 用户 ID |
| type | text | NOT NULL | 交易类型 |
| description | text | | 描述 |
| amount | integer | NOT NULL | 金额 |
| remaining_amount | integer | | 剩余金额 |
| stripe_invoice_id | text | | Stripe Invoice ID ✨重命名 |
| expiration_date | timestamp | | 过期时间 |
| expiration_date_processed_at | timestamp | | 过期处理时间 |
| created_at | timestamp | NOT NULL, DEFAULT NOW | 创建时间 |
| updated_at | timestamp | NOT NULL, DEFAULT NOW | 更新时间 |

## 5. ad_watch_record (广告观看记录表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | 记录 ID |
| user_id | text | FK→user.id (CASCADE) | 用户 ID |
| ip_address | text | | IP 地址 |
| ppt_id | text | FK→ppt.id (SET NULL) ✨新增 | PPT ID |
| watch_token | text | NOT NULL, UNIQUE | 观看 Token |
| download_token | text | | 下载 Token |
| started_at | timestamp | NOT NULL, DEFAULT NOW | 开始时间 |
| completed_at | timestamp | | 完成时间 |
| status | text | NOT NULL, DEFAULT 'pending' | 状态 |
| credits_awarded | integer | DEFAULT 0 | 奖励积分 |
| created_at | timestamp | NOT NULL, DEFAULT NOW | 创建时间 |

## 6. user_download_history (下载历史表)

| 字段 | 类型 | 约束 | 说明 |
|------|------|------|------|
| id | text | PK | 记录 ID |
| user_id | text | FK→user.id (CASCADE) | 用户 ID |
| ppt_id | text | NOT NULL, FK→ppt.id (CASCADE) ✨新增 | PPT ID |
| download_method | text | NOT NULL | 下载方式 |
| credits_spent | integer | DEFAULT 0 | 消耗积分 |
| ip_address | text | | IP 地址 |
| downloaded_at | timestamp | NOT NULL, DEFAULT NOW | 下载时间 |

## 7. 其他表

### session (会话表)
- id, expires_at, token (UNIQUE), user_id (FK), ip_address, user_agent, impersonated_by, created_at, updated_at

### account (OAuth 账户表)
- id, account_id, provider_id, user_id (FK), access_token, refresh_token, id_token, scope, password, created_at, updated_at

### verification (验证码表)
- id, identifier, value, expires_at, created_at, updated_at

### payment (支付表)
- id, price_id, type, scene, interval, user_id (FK), customer_id, subscription_id, session_id, invoice_id (UNIQUE), status, paid, period_start, period_end, cancel_at_period_end, trial_start, trial_end, created_at, updated_at

### slide (幻灯片表)
- id, ppt_id (FK), slide_number, title, content, image_url, thumbnail_url, notes, created_at, updated_at

### category (分类表)
- id, name, slug (UNIQUE), description, parent_id (FK), sort_order, created_at, updated_at
