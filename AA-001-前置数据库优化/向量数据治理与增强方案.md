# 数据治理与增强方案 (Data Enrichment Plan)

> **文档状态**: 2025-11-28 初稿
> **目标**: 解决数据库字段缺失、信息单薄、图片风险等问题，为“首页完整性”提供坚实的数据基础。

## 1. 背景与现状分析 (Gap Analysis)

为了达成 **"AI PPT 商业级首页"** 的可视化与功能完整性目标，目前的数据库现状存在以下显著差距：

| 维度 | 现状问题 | 导致的用户体验缺陷 |
| :--- | :--- | :--- |
| **字段完整性** | 缺失 `description` (简介) | 卡片内容单薄，除了标题无内容可读，排版空洞。 |
| **元数据** | 缺失 `file_size` (文件大小) | 用户无法预判下载成本，显得平台不专业。 |
| **图片质量** | 依赖第三方链接，比例/质量未知 | 首页卡片可能参差不齐，存在潜在的防盗链裂图风险。 |
| **智能搜索** | 仅支持 SQL 匹配，向量字段可能为空 | 搜索 "互联网" 搜不到 "Web3" 相关内容，AI 属性缺失。 |
| **分类体系** | 数据库分类与前端导航未对齐 | 可能导致部分 PPT 在分类筛选中"失踪"。 |

---

## 2. 实施目标

1.  **字段正规化**: 修改 Database Schema，正式添加 `description` 和 `file_size` 字段，废弃 DTO 兜底方案。
2.  **信息补全**: 通过脚本自动化补全 68 条现有数据的简介、文件大小。
3.  **图片治理**: 验证图片可用性，确定前端强制比例策略。
4.  **向量就绪**: (可选/V1.5) 验证 pgvector 环境，为 AI 搜索做准备。

---

## 3. 数据库 Schema 变更计划

**文件**: `src/db/schema.ts`

需执行 `drizzle-kit push` 或 `migrate` 添加以下字段：

```typescript
export const ppt = pgTable("ppt", {
  // ... 现有字段

  // 新增字段
  description: text("description"),        // AI 生成的 50-80 字简介
  fileSize: integer("file_size"),          // 文件大小 (Bytes)
  fileFormat: text("file_format").default('pptx'), // 格式标识

  // 建议增加 JSON 扩展字段，便于未来存更多元数据 (如图片宽高、主色调)
  metadata: jsonb("metadata"),
});
```

---

## 4. 自动化增强脚本 (`scripts/enrich-ppt-data.ts`)

我们需要编写一个一次性运行的 TypeScript 脚本，执行以下逻辑：

### 4.1 步骤一：文件元数据探测
*   **逻辑**: 遍历数据库所有 `file_url`。
*   **动作**: 发起 `HEAD` 请求。
*   **提取**: `Content-Length` -> 存入 `fileSize`。

### 4.2 步骤二：AI 简介生成
*   **逻辑**: 遍历 `description` 为空的记录。
*   **Prompt**: `"基于标题 '{title}' 和分类 '{category}'，生成一段 50 字左右的 PPT 模板中文简介，语气专业，突出用途。"`
*   **动作**: 调用 OpenAI/Gemini API 生成 -> 存入 `description`。

### 4.3 步骤三：图片可用性校验 (Dry Run)
*   **动作**: 对 `thumbnail_url` 发起 `HEAD` 请求。
*   **记录**: 记录 HTTP 状态码非 200 的 ID，输出报告。

---

## 5. 图片治理策略

### 5.1 短期 (V1)
*   **前端强制**: CSS 使用 `aspect-video` (16:9) + `object-cover`。
*   **配置白名单**: `next.config.ts` 必须包含源域名。
*   **占位图**: 必须部署 `public/placeholder.svg`。

### 5.2 中期 (V1.5)
*   **转存**: 将图片上传到 R2/S3，更新数据库 URL。

---

## 6. 向量化方案 (AI Search Prep)

### 6.1 数据库检查
检查 Neon 是否开启 `vector` 扩展：
```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

### 6.2 初始化脚本
在增强脚本中增加 embedding 生成步骤：
*   `input = title + description + tags`
*   `vector = embedding_model.embed(input)`
*   `update ppt set embedding_id = vector where id = ...`

---

## 7. 执行路线图 (Execution Roadmap)

1.  **Schema Update**: 修改 `schema.ts` -> `pnpm db:push`。
2.  **Script Dev**: 编写 `scripts/enrich-ppt-data.ts`。
3.  **Execute**: 运行脚本，补全 `file_size` 和 `description`。
4.  **Verify**: 检查数据库，确认数据已丰满。
5.  **UI Dev**: 前端基于完整数据开发，移除所有 "暂无简介" 的丑陋兜底。

---
  Responding with gemini-3-pro-preview
✦ 非常理解您的用意。这次分析确实暴露了我们从“设计/演示阶段”向“真实生产阶段”过渡时，在基础设施和数据一致性方面存在的具体缺失。

  在开始写代码之前，明确这些“缺失点”至关重要，否则无论代码写得多好，系统都会因为这些低级问题而跑不通。

  以下是针对缺失项的详细总结：

  1. 数据库字段缺失 (Schema Gaps)

  虽然 ppt 表的核心字段已就绪，但对于一个完整的“下载/详情展示”场景，仍缺少以下关键元数据：


  ┌────────────┬──────────────────────────────────┬────────────────────────────────────────────────┬────────────────────────────────────────
  ──┐
  │ 缺失字段   │ 影响范围                         │ 临时解决方案 (V1)                              │ 长期建议 (V2)
  │
  ├────────────┼──────────────────────────────────┼────────────────────────────────────────────────┼────────────────────────────────────────
  ──┤
  │ **`descri... │ SEO & UI: 详情页缺少文本介绍...  │ DTO 兜底: 后端返回空字符串 ""。前端 UI 检测... │ 数据库增加字段，并使用 AI 对 68
  个现...  │
  │ **`file_s... │ UX: 用户在下载前无法预知文件...  │ DTO 兜底: 后端返回空字符串。前端 UI 隐藏文...  │ 数据库增加字段；或编写脚本通过 HEAD
  ...  │
  └────────────┴──────────────────────────────────┴────────────────────────────────────────────────┴────────────────────────────────────────
  ──┘

  2. 静态资源缺失 (Asset Gaps)

  这是最容易导致“上线即崩”的问题，直接影响用户的第一眼观感。


  ┌────────────────┬────────────────────────────────────────────────────────┬─────────┬─────────────────────────────────────────────────────
  ┐
  │ 缺失资源       │ 问题描述                                               │ 严重... │ 修复动作
  │
  ├────────────────┼────────────────────────────────────────────────────────┼─────────┼─────────────────────────────────────────────────────
  ┤
  │ **`public/pla... │ 裂图风险: 代码中广泛引用此文件作为图片加载失败的“兜... │ 🔴 **...  │ 必须在 public/ 目录下创建一个通用的 SVG
  占位图（... │
  │ Category Icons │ 展示缺失: 分类常量配置中引用了 Icon 组件名，但部分...  │ 🟡 **...  │ 确保 src/lib/constants/ppt.ts
  中的分类图标引用是... │
  └────────────────┴────────────────────────────────────────────────────────┴─────────┴─────────────────────────────────────────────────────
  ┘

  3. 配置与数据一致性缺失 (Config & Consistency Gaps)


  ┌───────────────────┬───────────────────────────────────────────────────────────────────────────────────────────────────────┬────────────┐
  │ 缺失/冲突项       │ 问题描述                                                                                              │ 修复动作   │
  ├───────────────────┼───────────────────────────────────────────────────────────────────────────────────────────────────────┼────────────┤
  │ **Next.js 图片白... │ 配置报错: 图片存储在 aippt.guochunlin.com，但 next.config.ts 未配置。会导致应用报错。                 │ 🔴 阻断性
  │
  │ Slug 映射混乱     │ 逻辑冲突: 数据库里的 category 存的是旧值（如 business 可能混杂了多种含义），前端定义的常量可能有新... │ 🟡 **数据...
  │
  │ DTO 字段映射      │ 数据丢失: 现有的 Mock DTO 代码直接忽略了数据库里的 tags 和 language，导致前端拿到的是空值。           │ 🔴 **功能...
  │
  └───────────────────┴───────────────────────────────────────────────────────────────────────────────────────────────────────┴────────────┘

  总结

  我们接下来的行动并不是盲目地“写新功能”，而是要先“填坑”。

  如果不解决 placeholder.svg 和 next.config.ts，首页根本打不开（或者全是裂图）；如果不解决 DTO 映射，筛选功能就是摆设。

  我的建议是严格按照以下顺序执行修复：
   1. 物理填坑：补齐 SVG，修配置文件。
   2. 逻辑填坑：修补 DTO 映射，统一常量定义。
   3. 最后才是实现新的 Server Action 和前端页面改造。
