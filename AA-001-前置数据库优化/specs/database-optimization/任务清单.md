 PostgreSQL 数据治理 - 完整问题清单与深度分析
基于文档和代码的全面分析，以下是所有问题的完整清单：

🔴 P0 - 阻断性/高风险问题 (5个)
问题 1: 外键约束缺失 - ad_watch_record.ppt_id
| 维度 | 详情 | |------|------| | 现状 | pptId: text("ppt_id") 纯文本，无外键 | | 代码影响 | token-service.ts:generateWatchToken() 写入时不校验 PPT 是否存在 | | 风险 | PPT 删除后，广告观看记录变成僵尸数据，统计失真 | | 修复方案 | .references(() => ppt.id, { onDelete: 'set null' }) | | 迁移前置 | 需清洗指向不存在 PPT 的记录 |

问题 2: 外键约束缺失 - user_download_history.ppt_id
| 维度 | 详情 | |------|------| | 现状 | pptId: text("ppt_id").notNull() 无外键 | | 代码影响 | download-status.ts:getDownloadStatusAction() 查询时无法保证 pptId 有效 | | 风险 | 下载历史引用已删除的 PPT，首次免费判断逻辑可能出错 | | 修复方案 | .references(() => ppt.id, { onDelete: 'cascade' }) | | 迁移前置 | 需清洗孤儿记录 |

问题 3: Schema 与数据库不一致
| 维度 | 详情 | |------|------| | 现状 | ppt.title 和 ppt.file_url 在 schema 定义 notNull()，但数据库实际允许 NULL | | 证据 | Neon 查询显示 is_nullable: YES | | 风险 | 可能插入无效 PPT 数据，前端展示崩溃 | | 修复方案 | 1) 清洗 NULL 数据 2) 重新执行迁移强制约束 |

问题 4: 重复索引 (3对)
| 保留 (Drizzle) | 删除 (手动) | 定义 | |----------------|-------------|------| | ppt_category_idx | idx_ppt_category | btree(category) | | ppt_language_idx | idx_ppt_language | btree(language) | | ppt_created_at_idx | idx_ppt_created_at | btree(created_at DESC) | | import_batch_status_idx | idx_import_batch_status | btree(status) |

影响: 每次写入维护两份索引，浪费约 200KB 存储

问题 5: user_credit 无唯一约束
| 维度 | 详情 | |------|------| | 现状 | userId 只有索引，无 UNIQUE 约束 | | 代码影响 | credits.ts:addCredits() 先查后写，存在并发竞态 | | 风险 | 并发场景可能创建多条同一用户的积分记录 | | 修复方案 | 添加 UNIQUE(user_id) 约束 |

🟡 P1 - 中优先级问题 (6个)
问题 6: 字段命名歧义 - credit_transaction.payment_id
| 维度 | 详情 | |------|------| | 现状 | 字段名 paymentId，实际存储 invoiceId | | 证据 | schema.ts 注释: // field name is paymentId, but actually it's invoiceId | | 代码影响 | stripe.ts:827 写入 paymentId: invoice.id | | 风险 | 新人维护误解，错误联表查询 | | 修复方案 | 重命名为 stripeInvoiceId 或 invoiceId |

问题 7: 缺失关键索引 - slide 表
| 维度 | 详情 | |------|------| | 现状 | slide 表 36,497 条记录，无 ppt_id 索引 | | 风险 | 按 PPT 查幻灯片是高频操作，全表扫描性能差 | | 修复方案 | CREATE INDEX idx_slide_ppt_id ON slide(ppt_id) |

问题 8: 冗余索引
| 表 | 索引 | 问题 | |----|------|------| | user | user_id_idx | 主键已是索引，完全重复 | | session | session_token_idx | 已有 token UNIQUE 约束 |

问题 9: 软删除缺失
| 维度 | 详情 | |------|------| | 现状 | ppt 和 user 表无 deleted_at 字段 | | 风险 | 运营误删数据物理消失，无法恢复 | | 修复方案 | 添加 deletedAt: timestamp("deleted_at") |

问题 10: 废弃字段未清理
| 维度 | 详情 | |------|------| | 现状 | user_credit.last_refresh_at 标记 // deprecated 但仍保留 | | 风险 | Schema 冗余，干扰维护 | | 修复方案 | 迁移删除该字段 |

问题 11: download_record 表状态不明
| 维度 | 详情 | |------|------| | 现状 | Neon 显示表存在且有索引，但 schema.ts 未定义 | | 证据 | 数据库对话显示 download_record 数据为 0 | | 风险 | 与 user_download_history 职责重叠，代码可能引用不存在的表 | | 修复方案 | 明确用途：保留则补 schema，否则删除 |

🟢 P2 - 低优先级建议 (5个)
问题 12: 数据类型可优化
| 字段 | 当前 | 建议 | |------|------|------| | ppt.status | text | varchar(20) 或 enum | | ppt.language | text | varchar(10) | | ad_watch_record.status | text | varchar(20) 或 enum |

问题 13: 缺失元数据字段
| 字段 | 影响 | |------|------| | ppt.description | 卡片内容单薄，SEO 差 | | ppt.file_size | 用户无法预判下载成本 | | ppt.file_format | 格式标识缺失 |

问题 14: 测试表未清理
| 维度 | 详情 | |------|------| | 现状 | playing_with_neon 表存在 | | 修复 | DROP TABLE playing_with_neon |

问题 15: 缺失复合索引
| 表 | 建议索引 | 用途 | |----|----------|------| | slide | (ppt_id, slide_number) | 获取 PPT 幻灯片列表 | | user_download_history | (download_method, downloaded_at) | 按方式+日期统计 | | ppt | (status, created_at DESC) | 发布状态+时间排序 |

问题 16: 向量化准备缺失
| 维度 | 详情 | |------|------| | 现状 | ppt.embedding_id 存在但 pgvector 扩展未确认 | | 建议 | CREATE EXTENSION IF NOT EXISTS vector |

📊 数据链路风险图

┌─────────────────────────────────────────────────────────────────────┐
│                         数据完整性风险链                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  user ──FK──> session ✅                                            │
│    │                                                                │
│    ├──FK──> account ✅                                              │
│    │                                                                │
│    ├──FK──> payment ✅                                              │
│    │                                                                │
│    ├──FK──> user_credit ⚠️ (无唯一约束，并发风险)                    │
│    │           │                                                    │
│    │           └──> credit_transaction ⚠️ (paymentId 命名歧义)       │
│    │                                                                │
│    ├──FK──> ad_watch_record ❌ (ppt_id 无外键)                       │
│    │                                                                │
│    └──FK──> user_download_history ❌ (ppt_id 无外键)                 │
│                                                                     │
│  ppt ──────────────────────────────────────────────────────────────│
│    │                                                                │
│    ├──❌──> ad_watch_record.ppt_id (无外键，孤儿数据风险)            │
│    │                                                                │
│    ├──❌──> user_download_history.ppt_id (无外键，孤儿数据风险)      │
│    │                                                                │
│    └──?──> slide.ppt_id (无索引，性能风险)                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
🛠️ 执行优先级矩阵
| 优先级 | 任务 | 风险 | 工作量 | 依赖 | |--------|------|------|--------|------| | P0-1 | 删除重复索引 | 无 | 5分钟 | 无 | | P0-2 | 添加 slide.ppt_id 索引 | 无 | 5分钟 | 无 | | P0-3 | 删除测试表 | 无 | 1分钟 | 无 | | P1-1 | 清洗孤儿 ppt_id 数据 | 低 | 30分钟 | 无 | | P1-2 | 添加外键约束 | 中 | 1小时 | P1-1 | | P1-3 | 添加 user_credit 唯一约束 | 中 | 30分钟 | 清洗重复 | | P2-1 | 字段重命名 paymentId | 中 | 2小时 | 代码配合 | | P2-2 | 添加软删除 | 低 | 1小时 | 代码配合 | | P2-3 | 补充元数据字段 | 低 | 2小时 | 数据填充 |

需要我针对某个具体问题展开讨论，或者生成具体的迁移 SQL 吗？
