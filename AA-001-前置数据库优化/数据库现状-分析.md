

当前数据库设计梳理（基于 src/db/schema.ts，未生成新文件）：

  - Auth/Session
      - user: 基础用户档，含角色/封禁字段与邮箱唯一索引。
      - session: 登录会话（token 唯一），含 IP/UserAgent，级联删除随 user。
      - account: 社交/本地账号绑定，provider/accountId 唯一组合无约束但有索引，依赖 user。
      - verification: 通用验证码/验证令牌，未与用户强绑定。
  - 支付与订阅
      - payment: Stripe 事件落库；包含 priceId/type/scene/status/paid 标识，invoiceId 唯一防重复；用户级联删除。
  - 积分体系（默认关闭）
      - user_credit: 当前积分余额，user_id 唯一索引（非唯一约束）。
      - credit_transaction: 积分流水；paymentId 字段注释为 invoiceId；可设过期时间与处理时间戳。
  - PPT 内容
      - ppt: 模板主体，含分类/标签/语言/状态/可见性、下载/浏览计数、embedding 信息；分类/语言/状态建立索引，未强制外键。
  - 广告解锁与下载
      - ad_watch_record: 看广告记录，user_id 可空，watch_token 唯一，状态 pending/completed/expired，含下载 token、耗时/奖励积分字段；用户级联删除。
      - user_download_history: 下载历史，method=firstFree/credits/ad，含 IP、积分消耗；user_id 可空，user_id+ppt_id 建索引但不唯一；用户级联删除。
      - 统计表 download_record 仅在代码中引用为“按天聚合”占位，未定义字段（需留意迁移是否存在）。

  关系与链路要点：

  - Auth 模块依赖 user/session/account/verification；社交登录缺失 clientId/secret 仅影响登录，不影响其他表。
  - 广告解锁流程依赖 ad_watch_record 与 user_download_history；与积分表解耦，可在积分关闭时独立运行。
  - 积分消费/奖励需联动 credit_transaction 与 user_credit，但无数据库级唯一约束防重复写入，需业务侧幂等。
  - 支付表与积分表松耦合（paymentId 字段仅备注），无外键；补登/对账需按 invoiceId 唯一键处理。
  - PPT 主数据未设外键到下载/广告表，依赖业务校验 pptId；可重复下载记录。

  风险/建议（不改文件）：

  - 确认迁移是否包含 download_record 定义，否则相关统计调用会 500。
  - 如需防重复发币/下载，可考虑在业务层增加 user_download_history 唯一判断（user+ppt+method）。
  - user_credit 未设唯一约束，依赖应用层保证一人一行；注意并发写入。
  - payment.payment_id 注释与字段名不一致，后续迁移时可统一命名以免歧义。

 梳理到的数据库设计信息（未改文件）：

  - 实际表与字段（以 src/db/schema.ts + Drizzle 迁移为准）
      - Auth/Session：user、session、account、verification
      - 支付：payment（price/type/scene/invoiceId/paid 等，外键 user，多个索引）
      - 积分：user_credit、credit_transaction（payment_id 实际存 invoice_id，last_refresh_at 标记废弃）
      - PPT 主表：ppt（分类/标签/语言/计数/embedding 等，均为 text/array）
      - 广告/下载：ad_watch_record、user_download_history；download_record 仅在文档中提及，未在 schema/migration 中定义
  - SQL 迁移：src/db/migrations/0000-0006 覆盖上述表与索引；migrations/create_ad_tables.sql 是 Neon 控制台版，仅创建广告与下载两张表（无 download_record）。
  - 其他数据库设计文档
      - AA-001-前置数据库优化/PostgreSQL数据治理与增强方案.md：建议为 ppt_id 加外键、重命名 credit_transaction.payment_id、清理 last_refresh_at、补软删除等。
      - AA-001-前置数据库优化/向量数据治理与增强方案.md：建议补充 description/file_size、图片治理、向量准备等。
      - AA-001-前置数据库优化/status-quo/数据库现状.md 当前为空。

  潜在缺口/关注点（尚未改动）：

  - download_record 未落库；如有统计调用可能 500。
  - ppt_id 在广告/下载表未设外键，删除 PPT 可能留下孤儿数据。
  - user_credit 无唯一约束，依赖业务保证一人一行；并发需幂等。
  - credit_transaction.payment_id 命名与用途不一致（实际 invoice_id），后续迁移可统一。


› 针对数据库这块你有什么的建议信息的


• 这里给出可行动的数据库建议（不改代码）：

  - 增强完整性
      - 为 ad_watch_record.ppt_id、user_download_history.ppt_id 增加外键到 ppt.id，避免孤儿记录。
      - 在 user_credit 上添加唯一约束 (user_id UNIQUE)，并配合事务/乐观锁处理并发扣减。
      - credit_transaction.payment_id 建议重命名为 invoice_id 或新增列并逐步迁移，减少语义歧义。
  - 补齐缺表/字段
      - 如果需要日聚合下载统计，补建 download_record（例如字段：id, ppt_id FK, date, downloads, created_at），否则移除调用避免 500。
      - 按计划补充 ppt.description、ppt.file_size 字段，减少前端兜底逻辑。
  - 性能与索引
      - 若前端常以 ppt.category、ppt.language 过滤，目前已有索引；若按 ppt.status='published' 与时间排序高频，可考虑复合索引 (status, created_at desc)。
      - 对 user_download_history 如需按 download_method + 日期统计，补复合索引 (download_method, downloaded_at)。
  - 数据安全与可恢复
      - 为核心表（ppt, user）考虑 deleted_at 软删除，避免误删不可恢复。
      - 广告流水与下载历史保留周期可配置（分区或归档），避免无限膨胀。
  - 迁移与幂等
      - 在迁移前跑现有 pnpm db:migrate，确保基础表存在；新增约束前先清洗孤儿数据。
      - 对积分/下载的写入接口增加幂等校验（例如 user_id + ppt_id + method 唯一判重）以防重复写。
